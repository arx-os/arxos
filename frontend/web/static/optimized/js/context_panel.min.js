class ContextPanel{constructor(){this.panel=document.getElementById('context-panel');this.content=this.panel?this.panel.querySelector('#context-panel-content'):null;this.selectedObjects=new Set();this.isVisible=false;this.init();}
init(){if(!this.panel||!this.content)return;this.setupEventListeners();}
setupEventListeners(){const closeBtn=this.panel.querySelector('#close-context-panel');if(closeBtn){closeBtn.addEventListener('click',()=>this.hide());}
document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.isVisible)this.hide();});document.addEventListener('click',(e)=>{if(!this.panel.contains(e.target)&&this.isVisible)this.hide();});}
updateSelection(selectedObjects){this.selectedObjects=selectedObjects;if(selectedObjects.size===0){this.hide();return;}
if(selectedObjects.size===1){this.showSingleObjectPanel(Array.from(selectedObjects)[0]);}else{this.showMultiObjectPanel(selectedObjects);}}
showSingleObjectPanel(object){this.isVisible=true;this.panel.classList.remove('hidden');const objectData=this.extractObjectData(object);const floorInfo=this.getFloorInfo(objectData.floor_id);this.content.innerHTML=`
            <div class="space-y-4">
                ${objectData.type === 'connector' ? `<div class="flex items-center space-x-2"><span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">Floor:${floorInfo?floorInfo.name||floorInfo.id:'N/A'}</span></div>` : ''}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="object-name" value="${objectData.name || ''}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="object-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="device" ${objectData.type === 'device' ? 'selected' : ''}>Device</option>
                        <option value="room" ${objectData.type === 'room' ? 'selected' : ''}>Room</option>
                        <option value="panel" ${objectData.type === 'panel' ? 'selected' : ''}>Panel</option>
                        <option value="connector" ${objectData.type === 'connector' ? 'selected' : ''}>Connector</option>
                        <option value="label" ${objectData.type === 'label' ? 'selected' : ''}>Label</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">System</label>
                    <select id="object-system" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="electrical" ${objectData.system === 'electrical' ? 'selected' : ''}>Electrical</option>
                        <option value="hvac" ${objectData.system === 'hvac' ? 'selected' : ''}>HVAC</option>
                        <option value="plumbing" ${objectData.system === 'plumbing' ? 'selected' : ''}>Plumbing</option>
                        <option value="fire" ${objectData.system === 'fire' ? 'selected' : ''}>Fire Alarm</option>
                        <option value="security" ${objectData.system === 'security' ? 'selected' : ''}>Security</option>
                        <option value="av" ${objectData.system === 'av' ? 'selected' : ''}>Audio/Video</option>
                        <option value="network" ${objectData.system === 'network' ? 'selected' : ''}>Network</option>
                        <option value="lighting" ${objectData.system === 'lighting' ? 'selected' : ''}>Lighting</option>
                    </select>
                </div>

                <!-- Floor Selection (for all objects) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                    <select id="object-floor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select Floor --</option>
                        ${this.getFloorOptions(objectData.floor_id)}
                    </select>
                </div>

                <!-- Connector-specific fields -->
                <div id="connector-fields" class="space-y-3 ${objectData.type === 'connector' ? '' : 'hidden'}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connector Type</label>
                        <select id="connector-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="electrical" ${objectData.connector_type === 'electrical' ? 'selected' : ''}>Electrical</option>
                            <option value="plumbing" ${objectData.connector_type === 'plumbing' ? 'selected' : ''}>Plumbing</option>
                            <option value="hvac" ${objectData.connector_type === 'hvac' ? 'selected' : ''}>HVAC</option>
                            <option value="data" ${objectData.connector_type === 'data' ? 'selected' : ''}>Data</option>
                            <option value="av" ${objectData.connector_type === 'av' ? 'selected' : ''}>Audio/Video</option>
                            <option value="fire" ${objectData.connector_type === 'fire' ? 'selected' : ''}>Fire Alarm</option>
                            <option value="security" ${objectData.connector_type === 'security' ? 'selected' : ''}>Security</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connection Type</label>
                        <select id="connection-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="male" ${objectData.connection_type === 'male' ? 'selected' : ''}>Male</option>
                            <option value="female" ${objectData.connection_type === 'female' ? 'selected' : ''}>Female</option>
                            <option value="both" ${objectData.connection_type === 'both' ? 'selected' : ''}>Both</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connection Status</label>
                        <select id="connection-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="connected" ${objectData.connection_status === 'connected' ? 'selected' : ''}>Connected</option>
                            <option value="disconnected" ${objectData.connection_status === 'disconnected' ? 'selected' : ''}>Disconnected</option>
                            <option value="pending" ${objectData.connection_status === 'pending' ? 'selected' : ''}>Pending</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Capacity</label>
                            <input type="number" id="max-capacity" value="${objectData.max_capacity || ''}" step="0.1" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Load</label>
                            <input type="number" id="current-load" value="${objectData.current_load || ''}" step="0.1" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="object-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active" ${objectData.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${objectData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        <option value="maintenance" ${objectData.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="retired" ${objectData.status === 'retired' ? 'selected' : ''}>Retired</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">X Position</label>
                        <input type="number" id="object-x" value="${objectData.x || 0}" step="0.1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Y Position</label>
                        <input type="number" id="object-y" value="${objectData.y || 0}" step="0.1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rotation</label>
                    <input type="number" id="object-rotation" value="${objectData.rotation || 0}" step="1" min="0" max="360"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input type="text" id="object-tags" value="${objectData.tags || ''}"
                           placeholder="Enter tags separated by commas"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="object-description" rows="3"
                              placeholder="Enter description"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${objectData.description || ''}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Funding Source</label>
                    <input type="text" id="object-funding-source" value="${objectData.funding_source || ''}"
                           placeholder="e.g., Capital Budget, Grant, Operating Budget"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex space-x-2 pt-4">
                    <button id="save-object" class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Save
                    </button>
                    <button id="delete-object" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Delete
                    </button>
                </div>
            </div>
        `;this.setupFormEventListeners(object);}
showMultiObjectPanel(selectedObjects){this.isVisible=true;this.panel.classList.remove('hidden');this.content.innerHTML=`
            <div class="space-y-4">
                <div class="text-center">
                    <h4 class="font-medium text-gray-800">${selectedObjects.size} Objects Selected</h4>
                    <p class="text-sm text-gray-500">Batch operations</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">System (apply to all)</label>
                    <select id="batch-system" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No change</option>
                        <option value="electrical">Electrical</option>
                        <option value="hvac">HVAC</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="fire">Fire Alarm</option>
                        <option value="security">Security</option>
                        <option value="av">Audio/Video</option>
                        <option value="network">Network</option>
                        <option value="lighting">Lighting</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status (apply to all)</label>
                    <select id="batch-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No change</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="retired">Retired</option>
                    </select>
                </div>

                <div class="flex space-x-2">
                    <button id="batch-save" class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Apply Changes
                    </button>
                    <button id="batch-delete" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Delete All
                    </button>
                </div>
            </div>
        `;this.setupBatchEventListeners(selectedObjects);}
setupFormEventListeners(object){const saveBtn=this.panel.querySelector('#save-object');const deleteBtn=this.panel.querySelector('#delete-object');const typeSelect=this.panel.querySelector('#object-type');saveBtn.addEventListener('click',()=>this.saveObjectChanges(object));deleteBtn.addEventListener('click',()=>{if(confirm('Are you sure you want to delete this object?')){this.deleteObject(object);}});typeSelect.addEventListener('change',()=>{const connectorFields=this.panel.querySelector('#connector-fields');if(typeSelect.value==='connector'){connectorFields.classList.remove('hidden');}else{connectorFields.classList.add('hidden');}});const xInput=this.panel.querySelector('#object-x');const yInput=this.panel.querySelector('#object-y');const rotationInput=this.panel.querySelector('#object-rotation');xInput.addEventListener('input',()=>{const x=parseFloat(xInput.value)||0;const y=parseFloat(yInput.value)||0;this.updateObjectPosition(object,x,y);});yInput.addEventListener('input',()=>{const x=parseFloat(xInput.value)||0;const y=parseFloat(yInput.value)||0;this.updateObjectPosition(object,x,y);});rotationInput.addEventListener('input',()=>{const rotation=parseFloat(rotationInput.value)||0;this.updateObjectRotation(object,rotation);});}
setupBatchEventListeners(selectedObjects){const batchSaveBtn=this.panel.querySelector('#batch-save');const batchDeleteBtn=this.panel.querySelector('#batch-delete');batchSaveBtn.addEventListener('click',()=>this.saveBatchChanges(selectedObjects));batchDeleteBtn.addEventListener('click',()=>{if(confirm(`Are you sure you want to delete ${selectedObjects.size} objects?`)){this.deleteBatchObjects(selectedObjects);}});}
extractObjectData(object){return{id:object.getAttribute('data-id'),name:object.getAttribute('data-name')||'',type:object.getAttribute('data-type')||'device',system:object.getAttribute('data-system')||'electrical',status:object.getAttribute('data-status')||'active',x:parseFloat(object.getAttribute('data-x')||0),y:parseFloat(object.getAttribute('data-y')||0),rotation:parseFloat(object.getAttribute('data-rotation')||0),tags:object.getAttribute('data-tags')||'',description:object.getAttribute('data-description')||'',floor_id:object.getAttribute('data-floor-id')||'',connector_type:object.getAttribute('data-connector-type')||'',connection_type:object.getAttribute('data-connection-type')||'',connection_status:object.getAttribute('data-connection-status')||'',max_capacity:parseFloat(object.getAttribute('data-max-capacity')||''),current_load:parseFloat(object.getAttribute('data-current-load')||''),funding_source:object.getAttribute('data-funding-source')||''};}
async saveObjectChanges(object){const formData=this.getFormData();try{const response=await fetch(`/api/bim/objects/${object.getAttribute('data-id')}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){this.updateObjectAttributes(object,formData);this.showNotification('Object saved successfully','success');}else{throw new Error('Failed to save object');}}catch(error){console.error('Error saving object:',error);this.showNotification('Failed to save object','error');}}
async saveBatchChanges(selectedObjects){const batchData=this.getBatchFormData();const objectIds=Array.from(selectedObjects).map(obj=>obj.getAttribute('data-id'));try{const response=await fetch('/api/bim/objects/bulk-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({object_ids:objectIds,updates:batchData})});if(response.ok){selectedObjects.forEach(obj=>this.updateObjectAttributes(obj,batchData));this.showNotification('Batch changes applied successfully','success');}else{throw new Error('Failed to apply batch changes');}}catch(error){console.error('Error applying batch changes:',error);this.showNotification('Failed to apply batch changes','error');}}
getFormData(){return{name:this.panel.querySelector('#object-name').value,type:this.panel.querySelector('#object-type').value,system:this.panel.querySelector('#object-system').value,status:this.panel.querySelector('#object-status').value,x:parseFloat(this.panel.querySelector('#object-x').value),y:parseFloat(this.panel.querySelector('#object-y').value),rotation:parseFloat(this.panel.querySelector('#object-rotation').value),tags:this.panel.querySelector('#object-tags').value.split(',').map(tag=>tag.trim()).filter(tag=>tag),description:this.panel.querySelector('#object-description').value,floor_id:this.panel.querySelector('#object-floor').value,connector_type:this.panel.querySelector('#connector-type').value,connection_type:this.panel.querySelector('#connection-type').value,connection_status:this.panel.querySelector('#connection-status').value,max_capacity:parseFloat(this.panel.querySelector('#max-capacity').value),current_load:parseFloat(this.panel.querySelector('#current-load').value),funding_source:this.panel.querySelector('#object-funding-source').value};}
getBatchFormData(){const data={};const system=this.panel.querySelector('#batch-system').value;const status=this.panel.querySelector('#batch-status').value;if(system)data.system=system;if(status)data.status=status;return data;}
updateObjectAttributes(object,data){if(data.name)object.setAttribute('data-name',data.name);if(data.type)object.setAttribute('data-type',data.type);if(data.system)object.setAttribute('data-system',data.system);if(data.status)object.setAttribute('data-status',data.status);if(data.tags)object.setAttribute('data-tags',data.tags.join(','));if(data.description)object.setAttribute('data-description',data.description);if(data.floor_id)object.setAttribute('data-floor-id',data.floor_id);if(data.connector_type)object.setAttribute('data-connector-type',data.connector_type);if(data.connection_type)object.setAttribute('data-connection-type',data.connection_type);if(data.connection_status)object.setAttribute('data-connection-status',data.connection_status);if(data.max_capacity)object.setAttribute('data-max-capacity',data.max_capacity);if(data.current_load)object.setAttribute('data-current-load',data.current_load);if(data.funding_source)object.setAttribute('data-funding-source',data.funding_source);}
updateObjectPosition(object,x,y){object.setAttribute('data-x',x);object.setAttribute('data-y',y);const rotation=object.getAttribute('data-rotation')||0;object.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);}
updateObjectRotation(object,rotation){object.setAttribute('data-rotation',rotation);const x=object.getAttribute('data-x')||0;const y=object.getAttribute('data-y')||0;object.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);}
deleteObject(object){object.remove();this.hide();this.showNotification('Object deleted','success');}
deleteBatchObjects(selectedObjects){selectedObjects.forEach(obj=>obj.remove());this.hide();this.showNotification(`${selectedObjects.size} objects deleted`,'success');}
showNotification(message,type){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>notification.remove(),3000);}
hide(){this.isVisible=false;this.panel.classList.add('hidden');}
getFloorOptions(selectedFloorId=''){const floors=[{id:1,name:'Ground Floor'},{id:2,name:'First Floor'},{id:3,name:'Second Floor'},{id:4,name:'Third Floor'},{id:5,name:'Basement'}];return floors.map(floor=>`<option value="${floor.id}" ${floor.id.toString() === selectedFloorId.toString() ? 'selected' : ''}>${floor.name}</option>`).join('');}
getFloorInfo(floorId){if(!floorId)return null;const floors=[{id:1,name:'Ground Floor'},{id:2,name:'First Floor'},{id:3,name:'Second Floor'},{id:4,name:'Third Floor'},{id:5,name:'Basement'}];return floors.find(floor=>floor.id.toString()===floorId.toString());}
async loadFloorsFromAPI(buildingId){try{const response=await fetch(`/api/buildings/${buildingId}/floors`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();return floors;}else{console.error('Failed to load floors:',response.statusText);return[];}}catch(error){console.error('Error loading floors:',error);return[];}}}
document.addEventListener('DOMContentLoaded',()=>{window.contextPanel=new ContextPanel();});
