groups:
  - name: arxos-system-alerts
    rules:
      # CPU Usage Alerts
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          team: platform
          service: system
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 80% for more than 5 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/high-cpu-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      - alert: CriticalCPUUsage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 2m
        labels:
          severity: critical
          team: platform
          service: system
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 90% for more than 2 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/critical-cpu-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      # Memory Usage Alerts
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          team: platform
          service: system
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 85% for more than 5 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/high-memory-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      - alert: CriticalMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 95
        for: 2m
        labels:
          severity: critical
          team: platform
          service: system
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 95% for more than 2 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/critical-memory-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      # Disk Usage Alerts
      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 > 85
        for: 10m
        labels:
          severity: warning
          team: platform
          service: system
        annotations:
          summary: "High disk usage on {{ $labels.instance }}"
          description: "Disk usage is above 85% for more than 10 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/high-disk-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      - alert: CriticalDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 > 95
        for: 5m
        labels:
          severity: critical
          team: platform
          service: system
        annotations:
          summary: "Critical disk usage on {{ $labels.instance }}"
          description: "Disk usage is above 95% for more than 5 minutes on {{ $labels.instance }}. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/critical-disk-usage"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

      # Network Alerts
      - alert: HighNetworkErrors
        expr: rate(node_network_receive_errs_total[5m]) + rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          team: platform
          service: system
        annotations:
          summary: "High network errors on {{ $labels.instance }}"
          description: "Network error rate is high on {{ $labels.instance }}. Current value: {{ $value }} errors/sec"
          runbook_url: "https://arxos.com/runbooks/high-network-errors"
          dashboard_url: "https://grafana.arxos.com/d/system-overview"

  - name: arxos-application-alerts
    rules:
      # API Performance Alerts
      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, rate(arxos_api_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          team: backend
          service: api
        annotations:
          summary: "High API response time"
          description: "95th percentile API response time is above 2 seconds. Current value: {{ $value }}s"
          runbook_url: "https://arxos.com/runbooks/high-api-response-time"
          dashboard_url: "https://grafana.arxos.com/d/api-performance"

      - alert: CriticalAPIResponseTime
        expr: histogram_quantile(0.95, rate(arxos_api_request_duration_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: critical
          team: backend
          service: api
        annotations:
          summary: "Critical API response time"
          description: "95th percentile API response time is above 5 seconds. Current value: {{ $value }}s"
          runbook_url: "https://arxos.com/runbooks/critical-api-response-time"
          dashboard_url: "https://grafana.arxos.com/d/api-performance"

      # API Error Rate Alerts
      - alert: HighAPIErrorRate
        expr: rate(arxos_api_errors_total[5m]) / rate(arxos_api_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
          team: backend
          service: api
        annotations:
          summary: "High API error rate"
          description: "API error rate is above 5% for more than 5 minutes. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/high-api-error-rate"
          dashboard_url: "https://grafana.arxos.com/d/api-performance"

      - alert: CriticalAPIErrorRate
        expr: rate(arxos_api_errors_total[5m]) / rate(arxos_api_requests_total[5m]) * 100 > 10
        for: 2m
        labels:
          severity: critical
          team: backend
          service: api
        annotations:
          summary: "Critical API error rate"
          description: "API error rate is above 10% for more than 2 minutes. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/critical-api-error-rate"
          dashboard_url: "https://grafana.arxos.com/d/api-performance"

      # Export Job Alerts
      - alert: ExportJobFailure
        expr: rate(arxos_export_job_errors_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          team: backend
          service: export
        annotations:
          summary: "Export job failures detected"
          description: "Export jobs are failing. Current failure rate: {{ $value }} failures/sec"
          runbook_url: "https://arxos.com/runbooks/export-job-failure"
          dashboard_url: "https://grafana.arxos.com/d/export-jobs"

      - alert: HighExportJobDuration
        expr: histogram_quantile(0.95, rate(arxos_export_job_duration_seconds_bucket[5m])) > 300
        for: 5m
        labels:
          severity: warning
          team: backend
          service: export
        annotations:
          summary: "High export job duration"
          description: "95th percentile export job duration is above 5 minutes. Current value: {{ $value }}s"
          runbook_url: "https://arxos.com/runbooks/high-export-job-duration"
          dashboard_url: "https://grafana.arxos.com/d/export-jobs"

      # Database Alerts
      - alert: HighDatabaseConnections
        expr: arxos_database_connections > 80
        for: 5m
        labels:
          severity: warning
          team: backend
          service: database
        annotations:
          summary: "High database connections"
          description: "Database connection count is above 80. Current value: {{ $value }}"
          runbook_url: "https://arxos.com/runbooks/high-database-connections"
          dashboard_url: "https://grafana.arxos.com/d/database-performance"

      - alert: DatabaseConnectionExhausted
        expr: arxos_database_connections > 95
        for: 2m
        labels:
          severity: critical
          team: backend
          service: database
        annotations:
          summary: "Database connections exhausted"
          description: "Database connection count is above 95. Current value: {{ $value }}"
          runbook_url: "https://arxos.com/runbooks/database-connection-exhausted"
          dashboard_url: "https://grafana.arxos.com/d/database-performance"

  - name: arxos-security-alerts
    rules:
      # Security Alerts
      - alert: HighSecurityAlerts
        expr: rate(arxos_security_alerts_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          team: security
          service: security
        annotations:
          summary: "High security alert rate"
          description: "Security alert rate is above 5 alerts per minute. Current value: {{ $value }} alerts/sec"
          runbook_url: "https://arxos.com/runbooks/high-security-alerts"
          dashboard_url: "https://grafana.arxos.com/d/security-monitoring"

      - alert: CriticalSecurityAlerts
        expr: rate(arxos_security_alerts_total[5m]) > 20
        for: 2m
        labels:
          severity: critical
          team: security
          service: security
        annotations:
          summary: "Critical security alert rate"
          description: "Security alert rate is above 20 alerts per minute. Current value: {{ $value }} alerts/sec"
          runbook_url: "https://arxos.com/runbooks/critical-security-alerts"
          dashboard_url: "https://grafana.arxos.com/d/security-monitoring"

      # Rate Limiting Alerts
      - alert: HighRateLimitHits
        expr: rate(arxos_rate_limit_hits_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          team: security
          service: security
        annotations:
          summary: "High rate limit hits"
          description: "Rate limit hits are above 10 per minute. Current value: {{ $value }} hits/sec"
          runbook_url: "https://arxos.com/runbooks/high-rate-limit-hits"
          dashboard_url: "https://grafana.arxos.com/d/security-monitoring"

      - alert: CriticalRateLimitHits
        expr: rate(arxos_rate_limit_hits_total[5m]) > 50
        for: 2m
        labels:
          severity: critical
          team: security
          service: security
        annotations:
          summary: "Critical rate limit hits"
          description: "Rate limit hits are above 50 per minute. Current value: {{ $value }} hits/sec"
          runbook_url: "https://arxos.com/runbooks/critical-rate-limit-hits"
          dashboard_url: "https://grafana.arxos.com/d/security-monitoring"

  - name: arxos-business-alerts
    rules:
      # Business Metrics Alerts
      - alert: LowActiveUsers
        expr: arxos_active_users < 10
        for: 10m
        labels:
          severity: warning
          team: product
          service: business
        annotations:
          summary: "Low active users"
          description: "Active user count is below 10 for more than 10 minutes. Current value: {{ $value }}"
          runbook_url: "https://arxos.com/runbooks/low-active-users"
          dashboard_url: "https://grafana.arxos.com/d/business-metrics"

      - alert: NoActiveUsers
        expr: arxos_active_users == 0
        for: 5m
        labels:
          severity: critical
          team: product
          service: business
        annotations:
          summary: "No active users"
          description: "No active users detected for more than 5 minutes. Current value: {{ $value }}"
          runbook_url: "https://arxos.com/runbooks/no-active-users"
          dashboard_url: "https://grafana.arxos.com/d/business-metrics"

      # Service Availability Alerts
      - alert: ServiceDown
        expr: up{job="arxos-api"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
          service: api
        annotations:
          summary: "Service is down"
          description: "Service {{ $labels.job }} is down on {{ $labels.instance }}"
          runbook_url: "https://arxos.com/runbooks/service-down"
          dashboard_url: "https://grafana.arxos.com/d/service-overview"

      - alert: ServiceUnhealthy
        expr: up{job="arxos-api"} == 0
        for: 30s
        labels:
          severity: warning
          team: platform
          service: api
        annotations:
          summary: "Service is unhealthy"
          description: "Service {{ $labels.job }} is unhealthy on {{ $labels.instance }}"
          runbook_url: "https://arxos.com/runbooks/service-unhealthy"
          dashboard_url: "https://grafana.arxos.com/d/service-overview"

  - name: arxos-infrastructure-alerts
    rules:
      # Kubernetes Alerts
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: warning
          team: platform
          service: kubernetes
        annotations:
          summary: "Pod is crash looping"
          description: "Pod {{ $labels.pod }} is crash looping in namespace {{ $labels.namespace }}"
          runbook_url: "https://arxos.com/runbooks/pod-crash-looping"
          dashboard_url: "https://grafana.arxos.com/d/kubernetes-overview"

      - alert: PodNotReady
        expr: kube_pod_status_phase{phase="Running"} == 0
        for: 5m
        labels:
          severity: warning
          team: platform
          service: kubernetes
        annotations:
          summary: "Pod is not ready"
          description: "Pod {{ $labels.pod }} is not ready in namespace {{ $labels.namespace }}"
          runbook_url: "https://arxos.com/runbooks/pod-not-ready"
          dashboard_url: "https://grafana.arxos.com/d/kubernetes-overview"

      # Node Alerts
      - alert: NodeNotReady
        expr: kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
          team: platform
          service: kubernetes
        annotations:
          summary: "Node is not ready"
          description: "Node {{ $labels.node }} is not ready"
          runbook_url: "https://arxos.com/runbooks/node-not-ready"
          dashboard_url: "https://grafana.arxos.com/d/kubernetes-overview"

      - alert: NodeDiskPressure
        expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
        for: 5m
        labels:
          severity: warning
          team: platform
          service: kubernetes
        annotations:
          summary: "Node has disk pressure"
          description: "Node {{ $labels.node }} has disk pressure"
          runbook_url: "https://arxos.com/runbooks/node-disk-pressure"
          dashboard_url: "https://grafana.arxos.com/d/kubernetes-overview"

      - alert: NodeMemoryPressure
        expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
        for: 5m
        labels:
          severity: warning
          team: platform
          service: kubernetes
        annotations:
          summary: "Node has memory pressure"
          description: "Node {{ $labels.node }} has memory pressure"
          runbook_url: "https://arxos.com/runbooks/node-memory-pressure"
          dashboard_url: "https://grafana.arxos.com/d/kubernetes-overview"

  - name: arxos-deployment-alerts
    rules:
      # Deployment Alerts
      - alert: DeploymentNotAvailable
        expr: kube_deployment_status_replicas_available / kube_deployment_spec_replicas < 0.8
        for: 5m
        labels:
          severity: warning
          team: platform
          service: deployment
        annotations:
          summary: "Deployment not fully available"
          description: "Deployment {{ $labels.deployment }} in namespace {{ $labels.namespace }} is not fully available"
          runbook_url: "https://arxos.com/runbooks/deployment-not-available"
          dashboard_url: "https://grafana.arxos.com/d/deployment-overview"

      - alert: DeploymentFailed
        expr: kube_deployment_status_replicas_available / kube_deployment_spec_replicas == 0
        for: 10m
        labels:
          severity: critical
          team: platform
          service: deployment
        annotations:
          summary: "Deployment failed"
          description: "Deployment {{ $labels.deployment }} in namespace {{ $labels.namespace }} has failed"
          runbook_url: "https://arxos.com/runbooks/deployment-failed"
          dashboard_url: "https://grafana.arxos.com/d/deployment-overview"

      # Service Alerts
      - alert: ServiceNoEndpoints
        expr: kube_service_spec_type{type="ClusterIP"} == 1 and kube_service_endpoints_endpoints < 1
        for: 5m
        labels:
          severity: warning
          team: platform
          service: deployment
        annotations:
          summary: "Service has no endpoints"
          description: "Service {{ $labels.service }} in namespace {{ $labels.namespace }} has no endpoints"
          runbook_url: "https://arxos.com/runbooks/service-no-endpoints"
          dashboard_url: "https://grafana.arxos.com/d/deployment-overview"

  - name: arxos-custom-alerts
    rules:
      # Custom Application Alerts
      - alert: SVGProcessingHighLatency
        expr: histogram_quantile(0.95, rate(arxos_svg_processing_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
          team: backend
          service: svg-parser
        annotations:
          summary: "High SVG processing latency"
          description: "95th percentile SVG processing time is above 10 seconds. Current value: {{ $value }}s"
          runbook_url: "https://arxos.com/runbooks/high-svg-processing-latency"
          dashboard_url: "https://grafana.arxos.com/d/svg-processing"

      - alert: SymbolLibrarySyncFailure
        expr: rate(arxos_symbol_library_sync_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          team: backend
          service: symbol-library
        annotations:
          summary: "Symbol library sync failures"
          description: "Symbol library synchronization is failing. Current error rate: {{ $value }} errors/sec"
          runbook_url: "https://arxos.com/runbooks/symbol-library-sync-failure"
          dashboard_url: "https://grafana.arxos.com/d/symbol-library"

      - alert: BIMExportHighLatency
        expr: histogram_quantile(0.95, rate(arxos_bim_export_duration_seconds_bucket[5m])) > 60
        for: 5m
        labels:
          severity: warning
          team: backend
          service: bim-export
        annotations:
          summary: "High BIM export latency"
          description: "95th percentile BIM export time is above 60 seconds. Current value: {{ $value }}s"
          runbook_url: "https://arxos.com/runbooks/high-bim-export-latency"
          dashboard_url: "https://grafana.arxos.com/d/bim-export"

      # Database Performance Alerts
      - alert: DatabaseSlowQueries
        expr: rate(arxos_database_slow_queries_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          team: backend
          service: database
        annotations:
          summary: "High number of slow database queries"
          description: "Slow query rate is above 5 per minute. Current value: {{ $value }} queries/sec"
          runbook_url: "https://arxos.com/runbooks/database-slow-queries"
          dashboard_url: "https://grafana.arxos.com/d/database-performance"

      - alert: DatabaseConnectionPoolExhausted
        expr: arxos_database_connection_pool_available / arxos_database_connection_pool_total < 0.1
        for: 5m
        labels:
          severity: critical
          team: backend
          service: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "Database connection pool is less than 10% available. Current value: {{ $value }}%"
          runbook_url: "https://arxos.com/runbooks/database-connection-pool-exhausted"
          dashboard_url: "https://grafana.arxos.com/d/database-performance"

  - name: arxos-escalation-alerts
    rules:
      # Escalation Alerts (for alerts that haven't been resolved)
      - alert: UnresolvedCriticalAlert
        expr: time() - alertmanager_alerts{severity="critical",state="firing"} > 300
        for: 5m
        labels:
          severity: critical
          team: platform
          service: escalation
        annotations:
          summary: "Critical alert unresolved for more than 5 minutes"
          description: "Critical alert has been firing for more than 5 minutes and requires immediate attention"
          runbook_url: "https://arxos.com/runbooks/unresolved-critical-alert"
          dashboard_url: "https://grafana.arxos.com/d/alert-management"

      - alert: UnresolvedWarningAlert
        expr: time() - alertmanager_alerts{severity="warning",state="firing"} > 900
        for: 15m
        labels:
          severity: warning
          team: platform
          service: escalation
        annotations:
          summary: "Warning alert unresolved for more than 15 minutes"
          description: "Warning alert has been firing for more than 15 minutes and requires attention"
          runbook_url: "https://arxos.com/runbooks/unresolved-warning-alert"
          dashboard_url: "https://grafana.arxos.com/d/alert-management"
