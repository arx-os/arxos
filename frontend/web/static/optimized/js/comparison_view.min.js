class ComparisonView{constructor(containerId,options={}){this.containerId=containerId;this.container=document.getElementById(containerId);this.options={floorId:null,showExportButton:true,showDiffHighlighting:true,showChangeCounts:true,showTimeline:true,maxChanges:1000,...options};this.comparison=null;this.currentView='side-by-side';this.selectedChanges=[];this.render();this.initializeEventListeners();}
render(){this.container.innerHTML=`
            <div class="comparison-view bg-white rounded-lg shadow-md border">
                <!-- Header -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-gray-900">Version Comparison</h3>
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <span id="change-count">0 changes</span>
                                <span>â€¢</span>
                                <span id="comparison-status">No comparison loaded</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="view-mode" class="border border-gray-300 rounded px-3 py-1 text-sm">
                                <option value="side-by-side">Side by Side</option>
                                <option value="unified">Unified</option>
                                <option value="timeline">Timeline</option>
                            </select>
                            ${this.options.showExportButton ? `<button id="export-comparison"class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm"><i class="fas fa-download mr-2"></i>Export</button>` : ''}
                            <button id="close-comparison" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-times mr-2"></i>Close
                            </button>
                        </div>
                    </div>
                    
                    <!-- Version Info -->
                    <div id="version-info" class="mt-4 grid grid-cols-2 gap-4" style="display: none;">
                        <div class="from-version bg-gray-50 p-3 rounded-md">
                            <h4 class="font-medium text-gray-900 mb-2">From Version</h4>
                            <div id="from-version-details" class="text-sm text-gray-600"></div>
                        </div>
                        <div class="to-version bg-gray-50 p-3 rounded-md">
                            <h4 class="font-medium text-gray-900 mb-2">To Version</h4>
                            <div id="to-version-details" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Content -->
                <div id="comparison-content" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-exchange-alt text-3xl mb-4"></i>
                        <p>Select versions to compare</p>
                    </div>
                </div>
                
                <!-- Change Summary -->
                <div id="change-summary" class="p-4 border-t border-gray-200 bg-gray-50" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-sm">
                            <span class="flex items-center">
                                <span class="change-indicator change-added mr-2"></span>
                                <span id="added-count">0 added</span>
                            </span>
                            <span class="flex items-center">
                                <span class="change-indicator change-removed mr-2"></span>
                                <span id="removed-count">0 removed</span>
                            </span>
                            <span class="flex items-center">
                                <span class="change-indicator change-modified mr-2"></span>
                                <span id="modified-count">0 modified</span>
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="select-all-changes" class="text-blue-600 hover:text-blue-800 text-sm">
                                Select All
                            </button>
                            <button id="deselect-all-changes" class="text-gray-600 hover:text-gray-800 text-sm">
                                Deselect All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;}
initializeEventListeners(){document.getElementById('view-mode').addEventListener('change',(e)=>{this.currentView=e.target.value;this.renderComparison();});if(this.options.showExportButton){document.getElementById('export-comparison').addEventListener('click',()=>{this.exportComparison();});}
document.getElementById('close-comparison').addEventListener('click',()=>{this.close();});document.getElementById('select-all-changes').addEventListener('click',()=>{this.selectAllChanges();});document.getElementById('deselect-all-changes').addEventListener('click',()=>{this.deselectAllChanges();});}
async loadComparison(fromVersionId,toVersionId){if(!this.options.floorId){this.showError('No floor selected');return;}
try{this.showLoading();const response=await fetch(`/api/floors/${this.options.floorId}/versions/compare`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from_version_id:fromVersionId,to_version_id:toVersionId})});if(response.ok){this.comparison=await response.json();this.renderComparison();this.updateChangeCounts();}else{throw new Error('Failed to load comparison');}}catch(error){this.showError('Error loading comparison: '+error.message);}}
renderComparison(){if(!this.comparison){this.showEmptyState();return;}
const content=document.getElementById('comparison-content');switch(this.currentView){case'side-by-side':content.innerHTML=this.renderSideBySideView();break;case'unified':content.innerHTML=this.renderUnifiedView();break;case'timeline':content.innerHTML=this.renderTimelineView();break;}
this.renderVersionInfo();this.showChangeSummary();this.initializeChangeSelection();}
renderSideBySideView(){const{from_data,to_data,changes}=this.comparison;return`
            <div class="grid grid-cols-2 gap-6 h-96">
                <div class="comparison-panel border border-gray-200 rounded-md overflow-hidden">
                    <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900">From Version</h4>
                    </div>
                    <div class="comparison-content p-4 h-80 overflow-y-auto">
                        ${this.renderDiffContent(from_data, changes, 'from')}
                    </div>
                </div>
                
                <div class="comparison-panel border border-gray-200 rounded-md overflow-hidden">
                    <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900">To Version</h4>
                    </div>
                    <div class="comparison-content p-4 h-80 overflow-y-auto">
                        ${this.renderDiffContent(to_data, changes, 'to')}
                    </div>
                </div>
            </div>
        `;}
renderUnifiedView(){const{changes}=this.comparison;return`
            <div class="unified-view border border-gray-200 rounded-md overflow-hidden">
                <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                    <h4 class="font-medium text-gray-900">Unified Changes</h4>
                </div>
                <div class="comparison-content p-4 h-96 overflow-y-auto">
                    ${this.renderUnifiedChanges(changes)}
                </div>
            </div>
        `;}
renderTimelineView(){const{changes}=this.comparison;return`
            <div class="timeline-view">
                <div class="timeline-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                    <h4 class="font-medium text-gray-900">Change Timeline</h4>
                </div>
                <div class="timeline-content p-4 h-96 overflow-y-auto">
                    ${this.renderTimelineChanges(changes)}
                </div>
            </div>
        `;}
renderDiffContent(data,changes,side){if(!data)return'<div class="text-gray-500">No data available</div>';let html='<div class="space-y-2">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;if(side==='from'&&change.type==='removed'){html+=`
                    <div class="diff-item diff-removed p-2 rounded border-l-4 border-red-500 bg-red-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-red-700">${change.old_value}</span>
                    </div>
                `;}else if(side==='to'&&change.type==='added'){html+=`
                    <div class="diff-item diff-added p-2 rounded border-l-4 border-green-500 bg-green-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-green-700">${change.new_value}</span>
                    </div>
                `;}else if(change.type==='modified'){const value=side==='from'?change.old_value:change.new_value;html+=`
                    <div class="diff-item diff-modified p-2 rounded border-l-4 border-yellow-500 bg-yellow-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-yellow-700">${value}</span>
                    </div>
                `;}else if(change.type==='unchanged'){html+=`
                    <div class="diff-item p-2 rounded">
                        ${checkbox}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-gray-600">${change.value}</span>
                    </div>
                `;}});html+='</div>';return html;}
renderUnifiedChanges(changes){let html='<div class="space-y-3">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;switch(change.type){case'added':html+=`
                        <div class="unified-item diff-added p-3 rounded border-l-4 border-green-500 bg-green-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-green-600 text-sm">+ Added</span>
                            </div>
                            <div class="mt-1 text-green-700">${change.new_value}</div>
                        </div>
                    `;break;case'removed':html+=`
                        <div class="unified-item diff-removed p-3 rounded border-l-4 border-red-500 bg-red-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-red-600 text-sm">- Removed</span>
                            </div>
                            <div class="mt-1 text-red-700">${change.old_value}</div>
                        </div>
                    `;break;case'modified':html+=`
                        <div class="unified-item diff-modified p-3 rounded border-l-4 border-yellow-500 bg-yellow-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-yellow-600 text-sm">~ Modified</span>
                            </div>
                            <div class="mt-2 space-y-1">
                                <div class="text-red-700 text-sm">- ${change.old_value}</div>
                                <div class="text-green-700 text-sm">+ ${change.new_value}</div>
                            </div>
                        </div>
                    `;break;case'unchanged':html+=`
                        <div class="unified-item p-3 rounded border border-gray-200">
                            ${checkbox}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-gray-500 text-sm">No change</span>
                            </div>
                            <div class="mt-1 text-gray-600">${change.value}</div>
                        </div>
                    `;break;}});html+='</div>';return html;}
renderTimelineChanges(changes){let html='<div class="space-y-4">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;html+=`
                <div class="timeline-item flex items-start space-x-3">
                    <div class="timeline-marker flex-shrink-0 w-3 h-3 rounded-full ${changeClass === 'change-added' ? 'bg-green-500' : changeClass === 'change-removed' ? 'bg-red-500' : 'bg-yellow-500'} mt-2"></div>
                    <div class="timeline-content flex-1">
                        <div class="bg-white border border-gray-200 rounded-md p-3">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    change.type === 'added' ? 'bg-green-100 text-green-800' :
                                    change.type === 'removed' ? 'bg-red-100 text-red-800' :
                                    change.type === 'modified' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                }">${change.type}</span>
                            </div>
                            ${this.renderTimelineChangeDetails(change)}
                        </div>
                    </div>
                </div>
            `;});html+='</div>';return html;}
renderTimelineChangeDetails(change){switch(change.type){case'added':return`<div class="text-green-700 text-sm">${change.new_value}</div>`;case'removed':return`<div class="text-red-700 text-sm">${change.old_value}</div>`;case'modified':return`
                    <div class="space-y-1">
                        <div class="text-red-700 text-sm">- ${change.old_value}</div>
                        <div class="text-green-700 text-sm">+ ${change.new_value}</div>
                    </div>
                `;case'unchanged':return`<div class="text-gray-600 text-sm">${change.value}</div>`;default:return'';}}
getChangeClass(type){const classes={'added':'change-added','removed':'change-removed','modified':'change-modified','unchanged':'change-unchanged'};return classes[type]||'';}
renderVersionInfo(){const{from_version,to_version}=this.comparison;document.getElementById('from-version-details').innerHTML=`
            <div class="space-y-1">
                <div><strong>Description:</strong> ${from_version.description || 'Untitled'}</div>
                <div><strong>Created by:</strong> ${from_version.created_by}</div>
                <div><strong>Date:</strong> ${new Date(from_version.created_at).toLocaleString()}</div>
                <div><strong>Type:</strong> ${this.formatVersionType(from_version.type)}</div>
            </div>
        `;document.getElementById('to-version-details').innerHTML=`
            <div class="space-y-1">
                <div><strong>Description:</strong> ${to_version.description || 'Untitled'}</div>
                <div><strong>Created by:</strong> ${to_version.created_by}</div>
                <div><strong>Date:</strong> ${new Date(to_version.created_at).toLocaleString()}</div>
                <div><strong>Type:</strong> ${this.formatVersionType(to_version.type)}</div>
            </div>
        `;document.getElementById('version-info').style.display='grid';}
formatVersionType(type){const types={'manual':'Manual Snapshot','auto-save':'Auto Save','branch':'Branch','restored':'Restored'};return types[type]||type;}
updateChangeCounts(){if(!this.comparison)return;const{changes}=this.comparison;const counts={added:changes.filter(c=>c.type==='added').length,removed:changes.filter(c=>c.type==='removed').length,modified:changes.filter(c=>c.type==='modified').length};document.getElementById('added-count').textContent=`${counts.added} added`;document.getElementById('removed-count').textContent=`${counts.removed} removed`;document.getElementById('modified-count').textContent=`${counts.modified} modified`;document.getElementById('change-count').textContent=`${changes.length} changes`;document.getElementById('comparison-status').textContent='Comparison loaded';}
showChangeSummary(){document.getElementById('change-summary').style.display='block';}
initializeChangeSelection(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.addEventListener('change',(e)=>{const index=parseInt(e.target.dataset.changeIndex);if(e.target.checked){this.selectedChanges.push(index);}else{this.selectedChanges=this.selectedChanges.filter(i=>i!==index);}});});}
selectAllChanges(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.checked=true;const index=parseInt(checkbox.dataset.changeIndex);if(!this.selectedChanges.includes(index)){this.selectedChanges.push(index);}});}
deselectAllChanges(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.checked=false;});this.selectedChanges=[];}
async exportComparison(){if(!this.comparison){this.showError('No comparison to export');return;}
try{const response=await fetch(`/api/floors/${this.options.floorId}/versions/export-comparison`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({comparison:this.comparison,selected_changes:this.selectedChanges,format:'pdf'})});if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`comparison-${Date.now()}.pdf`;a.click();window.URL.revokeObjectURL(url);this.showSuccess('Comparison exported successfully');}else{throw new Error('Failed to export comparison');}}catch(error){this.showError('Error exporting comparison: '+error.message);}}
showLoading(){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                <p>Loading comparison...</p>
            </div>
        `;}
showEmptyState(){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-exchange-alt text-3xl mb-4"></i>
                <p>Select versions to compare</p>
            </div>
        `;}
showError(message){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-red-500 py-8">
                <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                <p>${message}</p>
            </div>
        `;}
showSuccess(message){console.log('Success:',message);}
close(){this.comparison=null;this.selectedChanges=[];this.showEmptyState();document.getElementById('version-info').style.display='none';document.getElementById('change-summary').style.display='none';document.getElementById('change-count').textContent='0 changes';document.getElementById('comparison-status').textContent='No comparison loaded';}
getSelectedChanges(){return this.selectedChanges;}
getComparison(){return this.comparison;}
updateFloorId(floorId){this.options.floorId=floorId;}
destroy(){if(this.container){this.container.innerHTML='';}}}
if(typeof module!=='undefined'&&module.exports){module.exports=ComparisonView;}