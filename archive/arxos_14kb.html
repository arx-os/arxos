<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Arxos 14KB</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font:14px/1.5 sans-serif;background:#000;color:#fff;overflow:hidden}
.c{display:grid;grid-template-columns:200px 1fr;height:100vh}
.s{background:#111;padding:10px;overflow-y:auto}
.v{position:relative}
#c{width:100%;height:100%;cursor:grab}
#c:active{cursor:grabbing}
.t{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.8);padding:5px 10px;border-radius:4px}
.b{width:100%;padding:5px;margin:5px 0;background:#246;color:#fff;border:0;border-radius:3px;cursor:pointer}
.b:hover{background:#357}
.l{margin:10px 0}
.l input{margin-right:5px}
.f{background:#222;margin:5px 0;padding:5px;border-radius:3px;cursor:pointer}
.f:hover{background:#333}
.f.a{background:#246}
.m{position:absolute;bottom:10px;left:10px;font-size:12px;opacity:0.7}
input[type=range]{width:100%}
.g{stroke:#333;stroke-width:0.5;fill:none}
.w{stroke:#fff;stroke-width:2;fill:rgba(100,100,100,0.3)}
.w:hover{stroke:#4af;stroke-width:3}
.r{fill:rgba(100,200,255,0.1);stroke:#4af;stroke-width:1}
.d{stroke:#fa0;stroke-width:3;fill:none}
.o{fill:#ff0;stroke:#000;r:5}
.x{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.8);padding:10px;border-radius:4px}
.x button{margin:0 2px;padding:2px 8px;background:#333;color:#fff;border:0;border-radius:2px;cursor:pointer}
.x button:hover{background:#555}
</style>
</head>
<body>
<div class="c">
<div class="s">
<h3>Arxos BIM</h3>
<div class="l">
<b>Tools</b><br>
<button class="b" onclick="A.tool='select'">Select</button>
<button class="b" onclick="A.tool='wall'">Wall</button>
<button class="b" onclick="A.tool='door'">Door</button>
<button class="b" onclick="A.tool='outlet'">Outlet</button>
</div>
<div class="l">
<b>View</b><br>
<button class="b" onclick="A.mode='2d'">2D</button>
<button class="b" onclick="A.mode='3d'">3D</button>
<label>Zoom<input type="range" min="0.1" max="3" step="0.1" value="1" oninput="A.zoom=this.value"></label>
<label>Angle<input type="range" min="0" max="360" value="30" oninput="A.angle=this.value"></label>
</div>
<div class="l">
<b>Floors</b><br>
<div id="floors"></div>
</div>
<div class="l">
<b>Systems</b><br>
<label><input type="checkbox" checked onchange="A.sys.e=this.checked">Electrical</label><br>
<label><input type="checkbox" checked onchange="A.sys.h=this.checked">HVAC</label><br>
<label><input type="checkbox" checked onchange="A.sys.p=this.checked">Plumbing</label>
</div>
<div class="l">
<b>Stats</b><br>
<span id="stats">0 objects</span>
</div>
</div>
<div class="v">
<canvas id="c"></canvas>
<div class="t" id="info">Floor 1</div>
<div class="x">
<button onclick="A.fit()">Fit</button>
<button onclick="A.clear()">Clear</button>
<button onclick="A.save()">Save</button>
</div>
<div class="m" id="pos">0, 0</div>
</div>
</div>
<script>
// Arxos BIM Engine - Ultra Minimal
const A = {
 // State
 mode: '2d',
 tool: 'select',
 zoom: 1,
 angle: 30,
 floor: 1,
 sys: {e:1, h:1, p:1},
 
 // Data
 floors: [{id:1,name:'Floor 1',h:0,walls:[],doors:[],outlets:[]}],
 sel: null,
 drag: 0,
 draw: null,
 pan: {x:0, y:0},
 mouse: {x:0, y:0},
 
 // Init
 init() {
  this.c = document.getElementById('c');
  this.ctx = this.c.getContext('2d');
  this.c.width = this.c.offsetWidth;
  this.c.height = this.c.offsetHeight;
  
  // Events
  this.c.onmousedown = e => this.down(e);
  this.c.onmousemove = e => this.move(e);
  this.c.onmouseup = e => this.up(e);
  this.c.onwheel = e => this.wheel(e);
  window.onresize = () => {
   this.c.width = this.c.offsetWidth;
   this.c.height = this.c.offsetHeight;
  };
  
  // UI
  this.updateUI();
  this.render();
 },
 
 // Input
 down(e) {
  const p = this.getPoint(e);
  
  if (e.shiftKey) {
   this.drag = 2; // Pan
   return;
  }
  
  switch(this.tool) {
   case 'select':
    this.sel = this.pick(p);
    if (this.sel) this.drag = 1;
    break;
   case 'wall':
    this.draw = {type:'wall', x1:p.x, y1:p.y, x2:p.x, y2:p.y};
    break;
   case 'door':
    const w = this.pickWall(p);
    if (w) this.addDoor(w, p);
    break;
   case 'outlet':
    const w2 = this.pickWall(p);
    if (w2) this.addOutlet(w2, p);
    break;
  }
 },
 
 move(e) {
  const p = this.getPoint(e);
  document.getElementById('pos').textContent = `${p.x|0}, ${p.y|0}`;
  
  if (this.drag === 2) {
   this.pan.x += e.movementX;
   this.pan.y += e.movementY;
  } else if (this.drag === 1 && this.sel) {
   this.sel.x1 += e.movementX / this.zoom;
   this.sel.y1 += e.movementY / this.zoom;
   this.sel.x2 += e.movementX / this.zoom;
   this.sel.y2 += e.movementY / this.zoom;
  } else if (this.draw) {
   this.draw.x2 = p.x;
   this.draw.y2 = p.y;
  }
  
  this.render();
 },
 
 up(e) {
  if (this.draw && this.tool === 'wall') {
   const d = Math.hypot(this.draw.x2 - this.draw.x1, this.draw.y2 - this.draw.y1);
   if (d > 20) {
    this.floors[this.floor-1].walls.push({...this.draw});
    this.updateStats();
   }
   this.draw = null;
  }
  this.drag = 0;
  this.render();
 },
 
 wheel(e) {
  e.preventDefault();
  this.zoom *= e.deltaY > 0 ? 0.9 : 1.1;
  this.zoom = Math.max(0.1, Math.min(3, this.zoom));
  this.render();
 },
 
 // Utils
 getPoint(e) {
  const r = this.c.getBoundingClientRect();
  return {
   x: (e.clientX - r.left - this.c.width/2 - this.pan.x) / this.zoom,
   y: (e.clientY - r.top - this.c.height/2 - this.pan.y) / this.zoom
  };
 },
 
 pick(p) {
  const f = this.floors[this.floor-1];
  for (let w of f.walls) {
   if (this.nearLine(p, w, 10)) return w;
  }
  return null;
 },
 
 pickWall(p) {
  const f = this.floors[this.floor-1];
  let min = Infinity, best = null;
  for (let w of f.walls) {
   const d = this.distToLine(p, w);
   if (d < min && d < 20) {
    min = d;
    best = w;
   }
  }
  return best;
 },
 
 nearLine(p, l, t) {
  return this.distToLine(p, l) < t;
 },
 
 distToLine(p, l) {
  const A = p.x - l.x1, B = p.y - l.y1;
  const C = l.x2 - l.x1, D = l.y2 - l.y1;
  const dot = A*C + B*D;
  const len = C*C + D*D;
  let t = len ? dot/len : -1;
  t = Math.max(0, Math.min(1, t));
  const x = l.x1 + t*C, y = l.y1 + t*D;
  return Math.hypot(p.x - x, p.y - y);
 },
 
 addDoor(w, p) {
  const t = this.projectPoint(p, w);
  this.floors[this.floor-1].doors.push({wall:w, t:t});
  this.updateStats();
  this.render();
 },
 
 addOutlet(w, p) {
  const t = this.projectPoint(p, w);
  this.floors[this.floor-1].outlets.push({wall:w, t:t});
  this.updateStats();
  this.render();
 },
 
 projectPoint(p, l) {
  const A = p.x - l.x1, B = p.y - l.y1;
  const C = l.x2 - l.x1, D = l.y2 - l.y1;
  const len = C*C + D*D;
  return len ? (A*C + B*D) / len : 0;
 },
 
 // Rendering
 render() {
  const ctx = this.ctx;
  ctx.clearRect(0, 0, this.c.width, this.c.height);
  
  ctx.save();
  ctx.translate(this.c.width/2 + this.pan.x, this.c.height/2 + this.pan.y);
  ctx.scale(this.zoom, this.zoom);
  
  if (this.mode === '2d') {
   this.render2D(ctx);
  } else {
   this.render3D(ctx);
  }
  
  ctx.restore();
 },
 
 render2D(ctx) {
  const f = this.floors[this.floor-1];
  
  // Grid
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 0.5;
  for (let i = -10; i <= 10; i++) {
   ctx.beginPath();
   ctx.moveTo(i*100, -1000);
   ctx.lineTo(i*100, 1000);
   ctx.moveTo(-1000, i*100);
   ctx.lineTo(1000, i*100);
   ctx.stroke();
  }
  
  // Walls
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 3;
  for (let w of f.walls) {
   if (w === this.sel) ctx.strokeStyle = '#4af';
   ctx.beginPath();
   ctx.moveTo(w.x1, w.y1);
   ctx.lineTo(w.x2, w.y2);
   ctx.stroke();
   if (w === this.sel) ctx.strokeStyle = '#fff';
  }
  
  // Doors
  ctx.strokeStyle = '#fa0';
  for (let d of f.doors) {
   const x = d.wall.x1 + d.t * (d.wall.x2 - d.wall.x1);
   const y = d.wall.y1 + d.t * (d.wall.y2 - d.wall.y1);
   ctx.beginPath();
   ctx.arc(x, y, 30, 0, Math.PI*2);
   ctx.stroke();
  }
  
  // Outlets
  if (this.sys.e) {
   ctx.fillStyle = '#ff0';
   for (let o of f.outlets) {
    const x = o.wall.x1 + o.t * (o.wall.x2 - o.wall.x1);
    const y = o.wall.y1 + o.t * (o.wall.y2 - o.wall.y1);
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI*2);
    ctx.fill();
   }
  }
  
  // Drawing
  if (this.draw) {
   ctx.strokeStyle = '#4af';
   ctx.setLineDash([5, 5]);
   ctx.beginPath();
   ctx.moveTo(this.draw.x1, this.draw.y1);
   ctx.lineTo(this.draw.x2, this.draw.y2);
   ctx.stroke();
   ctx.setLineDash([]);
  }
 },
 
 render3D(ctx) {
  const f = this.floors[this.floor-1];
  const a = this.angle * Math.PI / 180;
  
  // 3D projection
  const p3d = (x, y, z) => {
   const rx = x * Math.cos(a) - y * Math.sin(a);
   const ry = x * Math.sin(a) + y * Math.cos(a);
   return {
    x: (rx - ry) * 0.866,
    y: (rx + ry) * 0.5 - z
   };
  };
  
  // Floor
  ctx.fillStyle = 'rgba(50,50,50,0.5)';
  ctx.beginPath();
  const c1 = p3d(-500, -500, f.h);
  const c2 = p3d(500, -500, f.h);
  const c3 = p3d(500, 500, f.h);
  const c4 = p3d(-500, 500, f.h);
  ctx.moveTo(c1.x, c1.y);
  ctx.lineTo(c2.x, c2.y);
  ctx.lineTo(c3.x, c3.y);
  ctx.lineTo(c4.x, c4.y);
  ctx.closePath();
  ctx.fill();
  
  // Walls 3D
  ctx.fillStyle = 'rgba(150,150,150,0.8)';
  ctx.strokeStyle = '#fff';
  for (let w of f.walls) {
   const b1 = p3d(w.x1, w.y1, f.h);
   const b2 = p3d(w.x2, w.y2, f.h);
   const t1 = p3d(w.x1, w.y1, f.h + 300);
   const t2 = p3d(w.x2, w.y2, f.h + 300);
   
   ctx.beginPath();
   ctx.moveTo(b1.x, b1.y);
   ctx.lineTo(b2.x, b2.y);
   ctx.lineTo(t2.x, t2.y);
   ctx.lineTo(t1.x, t1.y);
   ctx.closePath();
   ctx.fill();
   ctx.stroke();
  }
 },
 
 // UI
 updateUI() {
  const fs = document.getElementById('floors');
  fs.innerHTML = this.floors.map((f, i) => 
   `<div class="f ${i===this.floor-1?'a':''}" onclick="A.setFloor(${i+1})">${f.name}</div>`
  ).join('');
  
  document.getElementById('info').textContent = this.floors[this.floor-1].name;
  this.updateStats();
 },
 
 updateStats() {
  const f = this.floors[this.floor-1];
  const n = f.walls.length + f.doors.length + f.outlets.length;
  document.getElementById('stats').textContent = `${n} objects`;
 },
 
 setFloor(n) {
  this.floor = n;
  this.updateUI();
  this.render();
 },
 
 // Actions
 fit() {
  this.pan = {x:0, y:0};
  this.zoom = 1;
  this.render();
 },
 
 clear() {
  if (confirm('Clear floor?')) {
   const f = this.floors[this.floor-1];
   f.walls = [];
   f.doors = [];
   f.outlets = [];
   this.updateStats();
   this.render();
  }
 },
 
 save() {
  const data = JSON.stringify(this.floors);
  localStorage.setItem('arxos', data);
  alert('Saved to localStorage');
 },
 
 load() {
  const data = localStorage.getItem('arxos');
  if (data) {
   this.floors = JSON.parse(data);
   this.updateUI();
   this.render();
  }
 }
};

// Start
A.init();
A.load();

// Server sync (progressive enhancement)
if (window.htmx) {
 // HTMX available - sync with server
 document.body.setAttribute('hx-ext', 'ws');
 document.body.setAttribute('ws-connect', '/ws');
}
</script>
</body>
</html>