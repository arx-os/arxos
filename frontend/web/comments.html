<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comments - Arx</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <!-- DOMPurify for XSS protection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
  <script src="static/js/session.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">Comments</h1>
    <div class="flex gap-4 items-center">
      <a href="svg_view.html" class="text-blue-600 font-semibold">Back to SVG</a>
      <div x-data="{ open: false }" class="relative">
        <button @click="open = !open" class="flex items-center px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">
          <span id="user-info" class="mr-2 text-gray-700"></span>
          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-50">
          <div class="px-4 py-2 text-gray-700 border-b">Profile</div>
          <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">Logout</button>
        </div>
      </div>
    </div>
  </header>
  <main id="comments-main" class="flex-1 p-4">
    <div id="feedback" class="mb-2 text-center text-sm"></div>
    <!-- Comments will be loaded here via HTMX -->
    <div class="mb-4 text-gray-500">No comments yet. Select an object to view or add comments.</div>
    <div id="comments-list"></div>
    <div id="comments-spinner" class="flex justify-center my-4 hidden">
      <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
    </div>
    <form class="bg-white p-4 rounded shadow flex flex-col gap-2" hx-post="/comments" hx-target="#comments-main" hx-swap="outerHTML" hx-indicator="#comments-spinner">
      <textarea class="w-full border rounded p-2" name="comment" rows="3" placeholder="Add a comment (Markdown supported)..." required></textarea>
      <button class="self-end bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Post</button>
    </form>
  </main>
  <script>
    if (!localStorage.getItem('arx_jwt')) {
      window.location = 'login.html';
    }
    // Fetch current user ID for comment ownership
    function fetchCurrentUserId() {
      const token = localStorage.getItem('arx_jwt');
      if (!token) return;
      fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(user => { window.currentUserId = user.id; });
    }
    fetchCurrentUserId();
    // Render comments with edit/delete for own comments
    function renderComments(comments) {
      const listDiv = document.getElementById('comments-list');
      if (!comments.length) {
        listDiv.innerHTML = DOMPurify.sanitize('<div class="text-gray-400">No comments yet.</div>');
        return;
      }
      const commentsHtml = comments.map(c =>
        `<div class="mb-2 p-2 rounded border bg-gray-50">
          <div class="text-sm text-gray-700" id="comment-content-${c.id}">${escapeHTML(c.content)}</div>
          <div class="text-xs text-gray-400">User: ${c.user_id || ''} | ${c.created_at ? new Date(c.created_at).toLocaleString() : ''}</div>
          ${window.currentUserId == c.user_id ? `
            <button onclick="editComment(${c.id}, '${escapeHTML(c.content)}')" class="text-blue-600 text-xs mr-2">Edit</button>
            <button onclick="deleteComment(${c.id})" class="text-red-600 text-xs">Delete</button>
          ` : ''}
        </div>`
      ).join('');
      listDiv.innerHTML = DOMPurify.sanitize(commentsHtml);
    }
    // Escape HTML for safe rendering
    function escapeHTML(str) {
      return str.replace(/[&<>'"]/g, function(tag) {
        const charsToReplace = {
          '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
        };
        return charsToReplace[tag] || tag;
      });
    }
    // Edit comment in place
    function editComment(id, content) {
      const div = document.getElementById(`comment-content-${id}`);
      const editHtml = `<textarea id="edit-comment-text-${id}" class="w-full border rounded p-1 mb-1">${content}</textarea>
        <button onclick="saveComment(${id})" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Save</button>
        <button onclick="cancelEditComment(${id}, '${content}')" class="bg-gray-400 text-white px-2 py-1 rounded text-xs">Cancel</button>`;
      div.innerHTML = DOMPurify.sanitize(editHtml);
    }
    function cancelEditComment(id, content) {
      document.getElementById(`comment-content-${id}`).textContent = content;
    }
    // Fetch and render comments for the current object
    function fetchAndRenderComments(objectId) {
      fetch(`/api/object/${objectId}/comments`, {
        headers: localStorage.getItem('arx_jwt') ? { 'Authorization': 'Bearer ' + localStorage.getItem('arx_jwt') } : {}
      })
      .then(res => res.json())
      .then(comments => renderComments(comments))
      .catch(err => {
        console.error('Error fetching comments:', err);
        document.getElementById('comments-list').innerHTML = DOMPurify.sanitize('<div class="text-red-500">Error loading comments</div>');
      });
    }
    // Save edited comment
    function saveComment(id) {
      const textarea = document.getElementById(`edit-comment-text-${id}`);
      const content = textarea.value;
      fetch(`/api/comments/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('arx_jwt')
        },
        body: JSON.stringify({ content })
      })
      .then(res => res.json())
      .then(comment => {
        document.getElementById(`comment-content-${id}`).textContent = comment.content;
      })
      .catch(err => {
        console.error('Error saving comment:', err);
        alert('Error saving comment');
      });
    }
    // Delete comment
    function deleteComment(id) {
      if (!confirm('Are you sure you want to delete this comment?')) return;
      fetch(`/api/comments/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('arx_jwt') }
      })
      .then(() => {
        // Remove comment from DOM
        const commentDiv = document.querySelector(`[id^="comment-content-${id}"]`).parentElement;
        commentDiv.remove();
        // Check if no comments left
        if (document.getElementById('comments-list').children.length === 0) {
          document.getElementById('comments-list').innerHTML = DOMPurify.sanitize('<div class="text-gray-400">No comments yet.</div>');
        }
      })
      .catch(err => {
        console.error('Error deleting comment:', err);
        alert('Error deleting comment');
      });
    }
    // Load user info
    function loadUserInfo() {
      const token = localStorage.getItem('arx_jwt');
      if (!token) return;
      fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => res.json())
        .then(user => {
          document.getElementById('user-info').textContent = user.username || user.email || 'User';
        })
        .catch(err => console.error('Error loading user info:', err));
    }
    loadUserInfo();
  </script>
</body>
</html>
