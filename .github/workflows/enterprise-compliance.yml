name: Enterprise Compliance & Quality Assurance

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans weekly
    - cron: '0 2 * * 1'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  GO_VERSION: '1.21'

jobs:
  # Security and Compliance Scanning
  security-scan:
    name: üîí Security & Compliance Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for security scanning
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety semgrep
    
    - name: Run Bandit security scan
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt -o bandit-report.txt
    
    - name: Run Safety vulnerability scan
      run: |
        safety check --json --output safety-report.json || true
        safety check --output safety-report.txt
    
    - name: Run Semgrep security scan
      run: |
        semgrep ci --json --output semgrep-report.json || true
        semgrep ci --output semgrep-report.txt
    
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy-results.sarif
    
    - name: Comment security findings
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          let comment = '## üîí Security Scan Results\n\n';
          
          try {
            const banditReport = JSON.parse(fs.readFileSync('bandit-report.json', 'utf8'));
            const issues = banditReport.results || [];
            comment += `### Bandit Security Scan: ${issues.length} issues found\n`;
            issues.slice(0, 5).forEach(issue => {
              comment += `- **${issue.severity}**: ${issue.issue_text} (${issue.filename}:${issue.line_number})\n`;
            });
          } catch (e) {
            comment += '### Bandit Security Scan: No issues found\n';
          }
          
          try {
            const safetyReport = JSON.parse(fs.readFileSync('safety-report.json', 'utf8'));
            const vulnerabilities = safetyReport.vulnerabilities || [];
            comment += `\n### Safety Vulnerability Scan: ${vulnerabilities.length} vulnerabilities found\n`;
            vulnerabilities.slice(0, 5).forEach(vuln => {
              comment += `- **${vuln.severity}**: ${vuln.package} ${vuln.installed_version} - ${vuln.description}\n`;
            });
          } catch (e) {
            comment += '\n### Safety Vulnerability Scan: No vulnerabilities found\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Quality Assurance
  quality-assurance:
    name: üß™ Quality Assurance
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock black flake8 mypy
    
    - name: Run code formatting check
      run: |
        black --check --diff .
    
    - name: Run linting
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
    
    - name: Run type checking
      run: |
        mypy . --ignore-missing-imports
    
    - name: Run unit tests with coverage
      run: |
        pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing
        coverage report --show-missing
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Enterprise Compliance Testing
  enterprise-compliance:
    name: üè¢ Enterprise Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
    
    - name: Run enterprise compliance tests
      run: |
        python -m pytest tests/svgx_engine/test_enterprise_compliance.py -v --tb=short
    
    - name: Run import compliance tests
      run: |
        python -m pytest tests/svgx_engine/test_import_compliance.py -v --tb=short
    
    - name: Run security compliance tests
      run: |
        python -m pytest tests/svgx_engine/test_access_control_migration.py -v --tb=short
    
    - name: Generate compliance report
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from tests.svgx_engine.test_enterprise_compliance import test_enterprise_compliance
        from tests.svgx_engine.test_import_compliance import test_svgx_import_compliance
        
        print('Running enterprise compliance tests...')
        enterprise_report = test_enterprise_compliance()
        
        print('Running import compliance tests...')
        import_report = test_svgx_import_compliance()
        
        # Save reports
        import json
        with open('enterprise-compliance-report.json', 'w') as f:
            json.dump(enterprise_report, f, indent=2)
        
        with open('import-compliance-report.json', 'w') as f:
            json.dump(import_report, f, indent=2)
        "
    
    - name: Upload compliance reports
      uses: actions/upload-artifact@v3
      with:
        name: compliance-reports
        path: |
          enterprise-compliance-report.json
          import-compliance-report.json

  # Performance Testing
  performance-test:
    name: ‚ö° Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust pytest-benchmark
    
    - name: Run performance benchmarks
      run: |
        python -m pytest tests/svgx_engine/test_performance.py -v --benchmark-only
    
    - name: Run load testing
      run: |
        locust -f tests/load/locustfile.py --headless --users 10 --spawn-rate 2 --run-time 60s --html=load-test-report.html

  # Integration Testing
  integration-test:
    name: üîó Integration Testing
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-asyncio httpx
    
    - name: Run integration tests
      run: |
        python -m pytest tests/integration/ -v --tb=short
    
    - name: Run API tests
      run: |
        python -m pytest tests/api/ -v --tb=short

  # Documentation Quality
  documentation-quality:
    name: üìö Documentation Quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pydocstyle doc8
    
    - name: Check docstring quality
      run: |
        pydocstyle . --count --select=D100,D101,D102,D103,D104,D105,D106,D107,D200,D201,D202,D203,D204,D205,D206,D207,D208,D209,D210,D211,D212,D213,D214,D215,D300,D301,D302,D303,D304,D305,D306,D307,D400,D401,D402,D403,D404,D405,D406,D407,D408,D409,D410,D411,D412,D413,D414,D415,D416,D417,D418,D419,D420,D421,D422,D423,D424,D425,D426,D427,D428,D429,D430,D431,D432,D433,D434,D435,D436,D437,D438,D439,D440,D441,D442,D443,D444,D445,D446,D447,D448,D449,D450,D451,D452,D453,D454,D455,D456,D457,D458,D459,D460,D461,D462,D463,D464,D465,D466,D467,D468,D469,D470,D471,D472,D473,D474,D475,D476,D477,D478,D479,D480,D481,D482,D483,D484,D485,D486,D487,D488,D489,D490,D491,D492,D493,D494,D495,D496,D497,D498,D499,D500,D501,D502,D503,D504,D505,D506,D507,D508,D509,D510,D511,D512,D513,D514,D515,D516,D517,D518,D519,D520,D521,D522,D523,D524,D525,D526,D527,D528,D529,D530,D531,D532,D533,D534,D535,D536,D537,D538,D539,D540,D541,D542,D543,D544,D545,D546,D547,D548,D549,D550,D551,D552,D553,D554,D555,D556,D557,D558,D559,D560,D561,D562,D563,D564,D565,D566,D567,D568,D569,D570,D571,D572,D573,D574,D575,D576,D577,D578,D579,D580,D581,D582,D583,D584,D585,D586,D587,D588,D589,D590,D591,D592,D593,D594,D595,D596,D597,D598,D599,D600,D601,D602,D603,D604,D605,D606,D607,D608,D609,D610,D611,D612,D613,D614,D615,D616,D617,D618,D619,D620,D621,D622,D623,D624,D625,D626,D627,D628,D629,D630,D631,D632,D633,D634,D635,D636,D637,D638,D639,D640,D641,D642,D643,D644,D645,D646,D647,D648,D649,D650,D651,D652,D653,D654,D655,D656,D657,D658,D659,D660,D661,D662,D663,D664,D665,D666,D667,D668,D669,D670,D671,D672,D673,D674,D675,D676,D677,D678,D679,D680,D681,D682,D683,D684,D685,D686,D687,D688,D689,D690,D691,D692,D693,D694,D695,D696,D697,D698,D699,D700,D701,D702,D703,D704,D705,D706,D707,D708,D709,D710,D711,D712,D713,D714,D715,D716,D717,D718,D719,D720,D721,D722,D723,D724,D725,D726,D727,D728,D729,D730,D731,D732,D733,D734,D735,D736,D737,D738,D739,D740,D741,D742,D743,D744,D745,D746,D747,D748,D749,D750,D751,D752,D753,D754,D755,D756,D757,D758,D759,D760,D761,D762,D763,D764,D765,D766,D767,D768,D769,D770,D771,D772,D773,D774,D775,D776,D777,D778,D779,D780,D781,D782,D783,D784,D785,D786,D787,D788,D789,D790,D791,D792,D793,D794,D795,D796,D797,D798,D799,D800,D801,D802,D803,D804,D805,D806,D807,D808,D809,D810,D811,D812,D813,D814,D815,D816,D817,D818,D819,D820,D821,D822,D823,D824,D825,D826,D827,D828,D829,D830,D831,D832,D833,D834,D835,D836,D837,D838,D839,D840,D841,D842,D843,D844,D845,D846,D847,D848,D849,D850,D851,D852,D853,D854,D855,D856,D857,D858,D859,D860,D861,D862,D863,D864,D865,D866,D867,D868,D869,D870,D871,D872,D873,D874,D875,D876,D877,D878,D879,D880,D881,D882,D883,D884,D885,D886,D887,D888,D889,D890,D891,D892,D893,D894,D895,D896,D897,D898,D899,D900,D901,D902,D903,D904,D905,D906,D907,D908,D909,D910,D911,D912,D913,D914,D915,D916,D917,D918,D919,D920,D921,D922,D923,D924,D925,D926,D927,D928,D929,D930,D931,D932,D933,D934,D935,D936,D937,D938,D939,D940,D941,D942,D943,D944,D945,D946,D947,D948,D949,D950,D951,D952,D953,D954,D955,D956,D957,D958,D959,D960,D961,D962,D963,D964,D965,D966,D967,D968,D969,D970,D971,D972,D973,D974,D975,D976,D977,D978,D979,D980,D981,D982,D983,D984,D985,D986,D987,D988,D989,D990,D991,D992,D993,D994,D995,D996,D997,D998,D999
    
    - name: Check documentation formatting
      run: |
        doc8 docs/ || true

  # Final Compliance Report
  compliance-report:
    name: üìä Compliance Report
    runs-on: ubuntu-latest
    needs: [security-scan, quality-assurance, enterprise-compliance, performance-test, integration-test, documentation-quality]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download compliance reports
      uses: actions/download-artifact@v3
      with:
        name: compliance-reports
        path: reports/
    
    - name: Generate final compliance report
      run: |
        python -c "
        import json
        import os
        
        print('## üè¢ Enterprise Compliance Report')
        print()
        
        # Load reports if they exist
        enterprise_report = {}
        import_report = {}
        
        if os.path.exists('reports/enterprise-compliance-report.json'):
            with open('reports/enterprise-compliance-report.json', 'r') as f:
                enterprise_report = json.load(f)
        
        if os.path.exists('reports/import-compliance-report.json'):
            with open('reports/import-compliance-report.json', 'r') as f:
                import_report = json.load(f)
        
        # Enterprise compliance summary
        if enterprise_report:
            summary = enterprise_report.get('summary', {})
            print(f'### Enterprise Compliance: {summary.get(\"compliance_status\", \"UNKNOWN\")}')
            print(f'- Total Tests: {summary.get(\"total_tests\", 0)}')
            print(f'- Pass Rate: {summary.get(\"pass_rate\", 0):.1f}%')
            print(f'- Critical Failures: {summary.get(\"critical_failures\", 0)}')
            print()
        
        # Import compliance summary
        if import_report:
            summary = import_report.get('summary', {})
            print(f'### Import Compliance: {summary.get(\"compliance_status\", \"UNKNOWN\")}')
            print(f'- Total Tests: {summary.get(\"total_tests\", 0)}')
            print(f'- Success Rate: {summary.get(\"success_rate\", 0):.1f}%')
            print()
        
        # Overall status
        all_passed = True
        if enterprise_report:
            all_passed = all_passed and enterprise_report.get('summary', {}).get('compliance_status') == 'PASS'
        if import_report:
            all_passed = all_passed and import_report.get('summary', {}).get('compliance_status') == 'PASS'
        
        print(f'## Overall Status: {\"‚úÖ PASS\" if all_passed else \"‚ùå FAIL\"}')
        "
    
    - name: Comment compliance status
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          let comment = '## üè¢ Enterprise Compliance Status\n\n';
          
          try {
            const enterpriseReport = JSON.parse(fs.readFileSync('reports/enterprise-compliance-report.json', 'utf8'));
            const summary = enterpriseReport.summary || {};
            comment += `**Enterprise Compliance**: ${summary.compliance_status || 'UNKNOWN'}\n`;
            comment += `- Pass Rate: ${summary.pass_rate || 0}%\n`;
            comment += `- Critical Failures: ${summary.critical_failures || 0}\n\n`;
          } catch (e) {
            comment += '**Enterprise Compliance**: Not available\n\n';
          }
          
          try {
            const importReport = JSON.parse(fs.readFileSync('reports/import-compliance-report.json', 'utf8'));
            const summary = importReport.summary || {};
            comment += `**Import Compliance**: ${summary.compliance_status || 'UNKNOWN'}\n`;
            comment += `- Success Rate: ${summary.success_rate || 0}%\n\n`;
          } catch (e) {
            comment += '**Import Compliance**: Not available\n\n';
          }
          
          comment += '---\n';
          comment += 'This report was generated by the Enterprise Compliance & Quality Assurance workflow.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 