<!DOCTYPE html>
<html>
<head>
<title>Simple PDF Test</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<style>
body {
    font-family: sans-serif;
    max-width: 800px;
    margin: 50px auto;
    padding: 20px;
}
#status {
    padding: 20px;
    background: #f0f0f0;
    border-radius: 8px;
    margin: 20px 0;
}
.success { color: green; }
.error { color: red; }
.info { color: blue; }
canvas {
    border: 1px solid #ccc;
    margin: 10px 0;
    max-width: 100%;
}
</style>
</head>
<body>
<h1>Simple PDF Test</h1>
<p>This page tests if PDF.js is working correctly.</p>

<input type="file" id="file" accept=".pdf">
<div id="status"></div>
<div id="output"></div>

<script>
function log(message, type = 'info') {
    const status = document.getElementById('status');
    const entry = document.createElement('div');
    entry.className = type;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    status.appendChild(entry);
    console.log(message);
}

document.getElementById('file').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    document.getElementById('status').innerHTML = '';
    document.getElementById('output').innerHTML = '';
    
    log(`Loading file: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
    
    try {
        // Test 1: Load the file
        const arrayBuffer = await file.arrayBuffer();
        log(`✓ File loaded into memory`, 'success');
        
        // Test 2: Parse with PDF.js
        log(`Parsing PDF with PDF.js...`);
        const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
        
        loadingTask.onProgress = (progress) => {
            if (progress.total > 0) {
                const percent = (progress.loaded / progress.total * 100).toFixed(0);
                log(`Loading progress: ${percent}%`);
            }
        };
        
        const pdf = await loadingTask.promise;
        log(`✓ PDF parsed successfully! Pages: ${pdf.numPages}`, 'success');
        
        // Test 3: Render first page
        log(`Rendering page 1...`);
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 1.0});
        
        log(`Page dimensions: ${viewport.width}x${viewport.height}`);
        
        // Create canvas
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        // Render page
        await page.render({
            canvasContext: context,
            viewport: viewport
        }).promise;
        
        log(`✓ Page rendered successfully!`, 'success');
        
        // Display canvas
        document.getElementById('output').appendChild(canvas);
        
        // Test 4: Extract some image data
        const imageData = context.getImageData(0, 0, 100, 100);
        log(`✓ Image data extracted: ${imageData.data.length} bytes`, 'success');
        
        // Count dark pixels (simple wall detection test)
        let darkPixels = 0;
        for (let i = 0; i < imageData.data.length; i += 4) {
            const brightness = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
            if (brightness < 128) darkPixels++;
        }
        log(`Found ${darkPixels} dark pixels in 100x100 sample`);
        
        log(`✅ All tests passed! PDF.js is working correctly.`, 'success');
        
    } catch (error) {
        log(`❌ Error: ${error.message}`, 'error');
        console.error('Full error:', error);
    }
});

// Test PDF.js is loaded
if (typeof pdfjsLib !== 'undefined') {
    log(`✓ PDF.js library loaded (version ${pdfjsLib.version})`, 'success');
} else {
    log(`❌ PDF.js library not loaded!`, 'error');
}
</script>
</body>
</html>