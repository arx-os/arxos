package commands

import (
	"encoding/json"
	"fmt"
	"time"

	"github.com/arxos/arxos/core/internal/services/bilt"
	"github.com/spf13/cobra"
)

var biltEngine *bilt.BILTEngine

func init() {
	// Initialize BILT engine
	biltEngine = bilt.NewBILTEngine()
}

// BiltCmd is the main BILT token command
var BiltCmd = &cobra.Command{
	Use:   "bilt",
	Short: "BILT token management and rewards",
	Long: `Manage Building Infrastructure Labor Tokens (BILT) that reward
field workers for contributing building data.

The BILT system incentivizes accurate data collection by rewarding
tokens based on data quality, completeness, and importance.`,
}

// BiltEarnCmd simulates earning BILT tokens
var BiltEarnCmd = &cobra.Command{
	Use:   "earn",
	Short: "Simulate earning BILT tokens",
	Long: `Simulate a field worker earning BILT tokens by contributing data.

Examples:
  arxos bilt earn scan /electrical/panel --confidence 0.95
  arxos bilt earn validate /hvac/thermostat/t-101 --quick
  arxos bilt earn measure /electrical/main-panel/circuit-7/outlet-3`,
	RunE: runBiltEarn,
}

// BiltBalanceCmd shows BILT token balance
var BiltBalanceCmd = &cobra.Command{
	Use:   "balance [user]",
	Short: "Check BILT token balance",
	Long: `Display the current BILT token balance for a user.

Examples:
  arxos bilt balance              # Your balance
  arxos bilt balance fieldworker1 # Specific user's balance`,
	RunE: runBiltBalance,
}

// BiltHistoryCmd shows earning history
var BiltHistoryCmd = &cobra.Command{
	Use:   "history [user]",
	Short: "Show BILT earning history",
	Long: `Display the BILT token earning history for a user.

Examples:
  arxos bilt history              # Your history
  arxos bilt history --limit 20   # Last 20 transactions`,
	RunE: runBiltHistory,
}

// BiltRatesCmd shows earning rates
var BiltRatesCmd = &cobra.Command{
	Use:   "rates",
	Short: "Display BILT token earning rates",
	Long: `Show the current BILT token earning rates for different
types of data contributions.`,
	RunE: runBiltRates,
}

// BiltLeaderboardCmd shows top earners
var BiltLeaderboardCmd = &cobra.Command{
	Use:   "leaderboard",
	Short: "Show top BILT token earners",
	Long:  `Display the leaderboard of top BILT token earners.`,
	RunE:  runBiltLeaderboard,
}

func init() {
	// Add subcommands
	BiltCmd.AddCommand(BiltEarnCmd)
	BiltCmd.AddCommand(BiltBalanceCmd)
	BiltCmd.AddCommand(BiltHistoryCmd)
	BiltCmd.AddCommand(BiltRatesCmd)
	BiltCmd.AddCommand(BiltLeaderboardCmd)
	
	// Add flags
	BiltEarnCmd.Flags().Float64("confidence", 0.8, "Confidence level (0.0-1.0)")
	BiltEarnCmd.Flags().Bool("quick", false, "Quick scan (< 2 minutes)")
	BiltEarnCmd.Flags().Float64("gps-accuracy", 5.0, "GPS accuracy in meters")
	
	BiltHistoryCmd.Flags().Int("limit", 10, "Number of transactions to show")
	BiltLeaderboardCmd.Flags().Int("top", 10, "Number of top earners to show")
}

func runBiltEarn(cmd *cobra.Command, args []string) error {
	if len(args) < 2 {
		return fmt.Errorf("usage: arxos bilt earn <type> <path>")
	}
	
	dataType := args[0]
	objectPath := args[1]
	
	confidence, _ := cmd.Flags().GetFloat64("confidence")
	quick, _ := cmd.Flags().GetBool("quick")
	gpsAccuracy, _ := cmd.Flags().GetFloat64("gps-accuracy")
	
	// Simulate duration
	duration := 5 * time.Minute
	if quick {
		duration = 90 * time.Second
	}
	
	// Create contribution
	contribution := bilt.DataContribution{
		UserID:     getCurrentUser(),
		Timestamp:  time.Now(),
		ObjectPath: objectPath,
		DataType:   dataType,
		Data:       generateSampleData(dataType, objectPath),
		Confidence: confidence,
		Duration:   duration,
		DeviceType: "cli_simulator",
		Location: bilt.Location{
			Latitude:  37.7749,
			Longitude: -122.4194,
			Altitude:  50.0,
			Accuracy:  gpsAccuracy,
		},
	}
	
	// Process contribution
	result, err := biltEngine.ProcessContribution(contribution)
	if err != nil {
		return fmt.Errorf("failed to process contribution: %w", err)
	}
	
	// Display result
	fmt.Printf("\nğŸ¯ Contribution Processed!\n")
	fmt.Printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
	fmt.Printf("Path:          %s\n", result.ObjectPath)
	fmt.Printf("Type:          %s\n", result.DataType)
	fmt.Printf("Status:        %s\n", result.Status)
	fmt.Printf("\n")
	
	if result.TokensEarned > 0 {
		fmt.Printf("ğŸ’° Tokens Earned: %.4f BILT\n", result.TokensEarned)
		fmt.Printf("\n")
		fmt.Printf("Quality Score: %.2f/1.00\n", result.QualityScore.Overall)
		fmt.Printf("  Accuracy:     %.2f\n", result.QualityScore.Accuracy)
		fmt.Printf("  Completeness: %.2f\n", result.QualityScore.Completeness)
		fmt.Printf("  Consistency:  %.2f\n", result.QualityScore.Consistency)
		fmt.Printf("  Freshness:    %.2f\n", result.QualityScore.Freshness)
		fmt.Printf("  Validation:   %.2f\n", result.QualityScore.Validation)
		
		// Show new balance
		balance, _ := biltEngine.GetUserBalance(getCurrentUser())
		fmt.Printf("\n")
		fmt.Printf("New Balance: %.4f BILT\n", balance)
	} else {
		fmt.Printf("âŒ No tokens earned (quality below threshold)\n")
		fmt.Printf("Minimum quality required: 0.50\n")
		fmt.Printf("Your quality score: %.2f\n", result.QualityScore.Overall)
	}
	
	return nil
}

func runBiltBalance(cmd *cobra.Command, args []string) error {
	userID := getCurrentUser()
	if len(args) > 0 {
		userID = args[0]
	}
	
	balance, err := biltEngine.GetUserBalance(userID)
	if err != nil {
		return fmt.Errorf("failed to get balance: %w", err)
	}
	
	fmt.Printf("\nğŸ’° BILT Token Balance\n")
	fmt.Printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
	fmt.Printf("User:    %s\n", userID)
	fmt.Printf("Balance: %.4f BILT\n", balance)
	
	// Get earning summary
	ledger := bilt.NewLedger()
	if summary, err := ledger.GetEarningsSummary(userID); err == nil && summary.TransactionCount > 0 {
		fmt.Printf("\nğŸ“Š Statistics:\n")
		fmt.Printf("Total Earned:  %.4f BILT\n", summary.TotalEarned)
		fmt.Printf("Total Spent:   %.4f BILT\n", summary.TotalSpent)
		fmt.Printf("Transactions:  %d\n", summary.TransactionCount)
		fmt.Printf("Avg Earning:   %.4f BILT\n", summary.AverageEarning)
		
		if !summary.FirstTransaction.IsZero() {
			fmt.Printf("First Earn:    %s\n", summary.FirstTransaction.Format("Jan 2, 2006"))
			fmt.Printf("Last Earn:     %s\n", summary.LastTransaction.Format("Jan 2, 2006"))
		}
	}
	
	return nil
}

func runBiltHistory(cmd *cobra.Command, args []string) error {
	userID := getCurrentUser()
	if len(args) > 0 {
		userID = args[0]
	}
	
	limit, _ := cmd.Flags().GetInt("limit")
	
	history, err := biltEngine.GetUserHistory(userID, limit)
	if err != nil {
		return fmt.Errorf("failed to get history: %w", err)
	}
	
	fmt.Printf("\nğŸ“œ BILT Token History\n")
	fmt.Printf("User: %s\n", userID)
	fmt.Printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
	
	if len(history) == 0 {
		fmt.Println("No transactions found")
	} else {
		fmt.Printf("%-20s %-10s %-12s %s\n", "Time", "Type", "Amount", "Reason")
		fmt.Printf("%-20s %-10s %-12s %s\n", "â”€â”€â”€â”€", "â”€â”€â”€â”€", "â”€â”€â”€â”€â”€â”€", "â”€â”€â”€â”€â”€â”€")
		
		for _, tx := range history {
			timeStr := tx.Timestamp.Format("Jan 2 15:04:05")
			amountStr := fmt.Sprintf("%.4f BILT", tx.Amount)
			fmt.Printf("%-20s %-10s %-12s %s\n", timeStr, tx.Type, amountStr, tx.Reason)
		}
		
		fmt.Printf("\nShowing %d of %d transactions\n", len(history), len(history))
	}
	
	return nil
}

func runBiltRates(cmd *cobra.Command, args []string) error {
	fmt.Printf("\nğŸ’µ BILT Token Earning Rates\n")
	fmt.Printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
	
	rates := []struct {
		Type        string
		Rate        float64
		Description string
	}{
		{"scan", biltEngine.GetEarningRate("scan"), "3D/laser scanning"},
		{"measurement", biltEngine.GetEarningRate("measurement"), "Physical measurements"},
		{"validation", biltEngine.GetEarningRate("validation"), "Data validation"},
		{"photo", biltEngine.GetEarningRate("photo"), "Photo documentation"},
		{"annotation", biltEngine.GetEarningRate("annotation"), "Text annotations"},
		{"electrical_trace", biltEngine.GetEarningRate("electrical_trace"), "Circuit tracing"},
		{"hvac_mapping", biltEngine.GetEarningRate("hvac_mapping"), "HVAC system mapping"},
		{"floor_scan", biltEngine.GetEarningRate("floor_scan"), "Full floor scanning"},
		{"room_inventory", biltEngine.GetEarningRate("room_inventory"), "Room inventory"},
	}
	
	fmt.Printf("%-20s %-15s %s\n", "Process Type", "Base Rate", "Description")
	fmt.Printf("%-20s %-15s %s\n", "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€", "â”€â”€â”€â”€â”€â”€â”€â”€â”€", "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
	
	for _, r := range rates {
		rateStr := fmt.Sprintf("%.1f BILT", r.Rate)
		fmt.Printf("%-20s %-15s %s\n", r.Type, rateStr, r.Description)
	}
	
	fmt.Printf("\n")
	fmt.Println("Note: Actual rewards are adjusted based on:")
	fmt.Println("  â€¢ Data quality score (0.5 - 1.0x)")
	fmt.Println("  â€¢ Completeness bonus (up to 1.3x)")
	fmt.Println("  â€¢ Speed bonus (up to 1.5x)")
	fmt.Println("  â€¢ Special conditions (first scan, critical systems, etc.)")
	
	return nil
}

func runBiltLeaderboard(cmd *cobra.Command, args []string) error {
	limit, _ := cmd.Flags().GetInt("top")
	
	// Get a new ledger instance to access leaderboard
	ledger := bilt.NewLedger()
	
	// Simulate some data for demonstration
	simulateLeaderboardData(ledger)
	
	topEarners := ledger.GetTopEarners(limit)
	
	fmt.Printf("\nğŸ† BILT Token Leaderboard\n")
	fmt.Printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
	
	if len(topEarners) == 0 {
		fmt.Println("No earnings recorded yet")
	} else {
		fmt.Printf("%-5s %-20s %s\n", "Rank", "User", "Balance")
		fmt.Printf("%-5s %-20s %s\n", "â”€â”€â”€â”€", "â”€â”€â”€â”€", "â”€â”€â”€â”€â”€â”€â”€")
		
		for i, user := range topEarners {
			rank := fmt.Sprintf("#%d", i+1)
			balanceStr := fmt.Sprintf("%.4f BILT", user.Balance)
			
			// Add emoji for top 3
			if i == 0 {
				rank = "ğŸ¥‡"
			} else if i == 1 {
				rank = "ğŸ¥ˆ"
			} else if i == 2 {
				rank = "ğŸ¥‰"
			}
			
			fmt.Printf("%-5s %-20s %s\n", rank, user.UserID, balanceStr)
		}
		
		// Show total supply
		totalSupply := ledger.GetTotalSupply()
		fmt.Printf("\nTotal BILT in Circulation: %.4f\n", totalSupply)
	}
	
	return nil
}

// Helper functions

func getCurrentUser() string {
	// In production, get from authentication
	return "current_user"
}

func generateSampleData(dataType, objectPath string) map[string]interface{} {
	// Generate realistic sample data based on type and path
	if strings.Contains(objectPath, "outlet") {
		return map[string]interface{}{
			"voltage":  120.0,
			"load":     12.5,
			"type":     "NEMA 5-15R",
			"location": "North wall",
			"height":   "18 inches",
		}
	} else if strings.Contains(objectPath, "circuit") {
		return map[string]interface{}{
			"breaker_rating": "20A",
			"voltage":        120.0,
			"phase":          "A",
			"wire_gauge":     "12 AWG",
		}
	} else if strings.Contains(objectPath, "thermostat") {
		return map[string]interface{}{
			"model":        "Honeywell T6",
			"setpoint":     72.0,
			"current_temp": 71.0,
			"zone":         "Zone 1",
		}
	}
	
	// Generic data
	return map[string]interface{}{
		"status":   "active",
		"type":     dataType,
		"verified": true,
	}
}

func simulateLeaderboardData(ledger *bilt.Ledger) {
	// Add sample earnings for demonstration
	users := []struct {
		ID      string
		Earning float64
	}{
		{"alice_tech", 1250.75},
		{"bob_electric", 980.50},
		{"carol_hvac", 875.25},
		{"dave_scan", 650.00},
		{"eve_validate", 525.30},
		{"frank_measure", 420.15},
		{"grace_photo", 380.90},
		{"henry_trace", 295.60},
		{"iris_map", 250.40},
		{"jack_audit", 195.25},
	}
	
	for _, user := range users {
		tx := bilt.Transaction{
			ID:        fmt.Sprintf("demo_%s", user.ID),
			UserID:    user.ID,
			Amount:    user.Earning,
			Type:      "earning",
			Reason:    "Demo earnings",
			Timestamp: time.Now(),
			Status:    "completed",
		}
		ledger.RecordTransaction(tx)
	}
}