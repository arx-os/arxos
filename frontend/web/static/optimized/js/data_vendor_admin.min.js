class DataVendorAdmin{constructor(){this.currentTab='dashboard';this.apiKeys=[];this.usageData={};this.billingData={};this.init();}
async init(){await this.loadDashboard();this.setupEventListeners();this.setupCharts();}
setupEventListeners(){document.querySelectorAll('.tab-button').forEach(button=>{button.addEventListener('click',(e)=>{const tab=e.target.getAttribute('onclick').match(/showTab\('(.+)'\)/)[1];this.showTab(tab);});});document.getElementById('create-key-btn')?.addEventListener('click',()=>{this.showCreateKeyModal();});document.getElementById('date-range')?.addEventListener('change',()=>{this.loadUsageData();});document.getElementById('vendor-filter')?.addEventListener('click',()=>{this.loadUsageData();});document.getElementById('billing-month')?.addEventListener('change',()=>{this.loadBillingData();});}
async showTab(tabName){document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.remove('border-blue-500','text-blue-600');btn.classList.add('border-transparent','text-gray-500');});const activeButton=document.querySelector(`[onclick="showTab('${tabName}')"]`);if(activeButton){activeButton.classList.remove('border-transparent','text-gray-500');activeButton.classList.add('border-blue-500','text-blue-600');}
document.querySelectorAll('.tab-content').forEach(content=>{content.classList.add('hidden');});const selectedTab=document.getElementById(`${tabName}-tab`);if(selectedTab){selectedTab.classList.remove('hidden');}
this.currentTab=tabName;switch(tabName){case'dashboard':await this.loadDashboard();break;case'api-keys':await this.loadAPIKeys();break;case'usage':await this.loadUsageData();break;case'billing':await this.loadBillingData();break;}}
async loadDashboard(){try{const response=await fetch('/api/data-vendor-admin/dashboard',{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load dashboard');const data=await response.json();this.updateDashboardMetrics(data);this.updateUsageChart(data.usage_trends);this.updateTopVendors(data.top_vendors);this.updateRecentActivity(data.recent_activity);}catch(error){console.error('Error loading dashboard:',error);this.showNotification('Error loading dashboard data','error');}}
updateDashboardMetrics(data){document.getElementById('active-keys-count').textContent=data.active_keys;document.getElementById('today-requests').textContent=data.today_requests.toLocaleString();document.getElementById('monthly-revenue').textContent=`$${data.monthly_revenue.toLocaleString()}`;document.getElementById('rate-limit-hits').textContent=data.rate_limit_hits;}
updateUsageChart(usageTrends){const ctx=document.getElementById('usageChart');if(!ctx)return;const labels=usageTrends.map(item=>item.date);const data=usageTrends.map(item=>item.requests);new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'API Requests',data:data,borderColor:'rgb(59, 130, 246)',backgroundColor:'rgba(59, 130, 246, 0.1)',tension:0.1}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});}
updateTopVendors(vendors){const container=document.getElementById('top-vendors');if(!container)return;container.innerHTML=vendors.map(vendor=>`
            <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                <div>
                    <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                    <p class="text-sm text-gray-500">${vendor.access_level}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-gray-900">${vendor.request_count.toLocaleString()}</p>
                    <p class="text-sm text-gray-500">requests</p>
                </div>
            </div>
        `).join('');}
updateRecentActivity(activity){const container=document.getElementById('recent-activity');if(!container)return;container.innerHTML=activity.map(item=>`
            <li class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <span class="text-sm font-medium text-blue-600">${item.vendor_name.charAt(0)}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">${item.vendor_name}</p>
                            <p class="text-sm text-gray-500">${item.method} ${item.endpoint}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            item.status === 200 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${item.status}
                        </span>
                        <span class="ml-2 text-sm text-gray-500">${this.formatTime(item.created_at)}</span>
                    </div>
                </div>
            </li>
        `).join('');}
async loadAPIKeys(){try{const response=await fetch('/api/data-vendor-admin/api-keys',{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load API keys');this.apiKeys=await response.json();this.renderAPIKeysTable();}catch(error){console.error('Error loading API keys:',error);this.showNotification('Error loading API keys','error');}}
renderAPIKeysTable(){const tbody=document.getElementById('api-keys-table');if(!tbody)return;tbody.innerHTML=this.apiKeys.map(key=>`
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${key.vendor_name}</div>
                    <div class="text-sm text-gray-500">${key.email}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        this.getAccessLevelColor(key.access_level)
                    }">
                        ${key.access_level}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${key.rate_limit.toLocaleString()}/hour
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        key.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${key.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${key.last_used_at ? this.formatTime(key.last_used_at) : 'Never'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="dataVendorAdmin.viewAPIKey('${key.id}')" 
                            class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                    <button onclick="dataVendorAdmin.toggleAPIKeyStatus('${key.id}', ${!key.is_active})" 
                            class="text-${key.is_active ? 'red' : 'green'}-600 hover:text-${key.is_active ? 'red' : 'green'}-900">
                        ${key.is_active ? 'Deactivate' : 'Activate'}
                    </button>
                </td>
            </tr>
        `).join('');}
async loadUsageData(){try{const dateRange=document.getElementById('date-range')?.value||30;const vendor=document.getElementById('vendor-filter')?.value||'';const params=new URLSearchParams({date_range:dateRange,...(vendor&&{vendor})});const response=await fetch(`/api/data-vendor-admin/usage?${params}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load usage data');this.usageData=await response.json();this.renderUsageData();}catch(error){console.error('Error loading usage data:',error);this.showNotification('Error loading usage data','error');}}
renderUsageData(){document.getElementById('total-requests').textContent=this.usageData.total_requests.toLocaleString();document.getElementById('success-rate').textContent=`${this.usageData.success_rate}%`;document.getElementById('avg-response-time').textContent=`${this.usageData.avg_response_time}ms`;document.getElementById('rate-limit-hits-count').textContent=this.usageData.rate_limit_hits;const vendorContainer=document.getElementById('usage-by-vendor');if(vendorContainer&&this.usageData.usage_by_vendor){vendorContainer.innerHTML=this.usageData.usage_by_vendor.map(vendor=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                        <p class="text-sm text-gray-500">${vendor.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">${vendor.success_rate}%</p>
                        <p class="text-sm text-gray-500">success rate</p>
                    </div>
                </div>
            `).join('');}
const endpointContainer=document.getElementById('usage-by-endpoint');if(endpointContainer&&this.usageData.usage_by_endpoint){endpointContainer.innerHTML=this.usageData.usage_by_endpoint.map(endpoint=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${endpoint.endpoint}</h4>
                        <p class="text-sm text-gray-500">${endpoint.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">${endpoint.avg_response_time}ms</p>
                        <p class="text-sm text-gray-500">avg response</p>
                    </div>
                </div>
            `).join('');}}
async loadBillingData(){try{const month=document.getElementById('billing-month')?.value||'';const vendor=document.getElementById('billing-vendor-filter')?.value||'';const params=new URLSearchParams();if(month)params.append('month',month);if(vendor)params.append('vendor',vendor);const response=await fetch(`/api/data-vendor-admin/billing?${params}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load billing data');this.billingData=await response.json();this.renderBillingData();}catch(error){console.error('Error loading billing data:',error);this.showNotification('Error loading billing data','error');}}
renderBillingData(){document.getElementById('total-revenue').textContent=`$${this.billingData.total_revenue.toLocaleString()}`;const vendorContainer=document.getElementById('billing-by-vendor');if(vendorContainer&&this.billingData.billing_by_vendor){vendorContainer.innerHTML=this.billingData.billing_by_vendor.map(vendor=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                        <p class="text-sm text-gray-500">${vendor.access_level} - ${vendor.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">$${vendor.total_cost.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">$${vendor.base_cost} + $${vendor.per_request_cost}/request</p>
                    </div>
                </div>
            `).join('');}
const levelContainer=document.getElementById('billing-by-access-level');if(levelContainer&&this.billingData.billing_by_access_level){levelContainer.innerHTML=this.billingData.billing_by_access_level.map(level=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${level.access_level}</h4>
                        <p class="text-sm text-gray-500">${level.vendor_count} vendors</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">$${level.total_revenue.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">revenue</p>
                    </div>
                </div>
            `).join('');}}
showCreateKeyModal(){const modal=document.getElementById('create-key-modal');if(modal){modal.classList.remove('hidden');}}
hideCreateKeyModal(){const modal=document.getElementById('create-key-modal');if(modal){modal.classList.add('hidden');document.getElementById('create-key-form').reset();}}
async createAPIKey(formData){try{const response=await fetch('/api/data-vendor-admin/api-keys',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.getToken()}`},body:JSON.stringify(formData)});if(!response.ok)throw new Error('Failed to create API key');const newKey=await response.json();this.apiKeys.unshift(newKey);this.renderAPIKeysTable();this.hideCreateKeyModal();this.showNotification('API key created successfully','success');this.showAPIKeyDetails(newKey);}catch(error){console.error('Error creating API key:',error);this.showNotification('Error creating API key','error');}}
async viewAPIKey(keyId){try{const response=await fetch(`/api/data-vendor-admin/api-keys/${keyId}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load API key details');const keyData=await response.json();this.showAPIKeyDetails(keyData.key,keyData.stats);}catch(error){console.error('Error loading API key details:',error);this.showNotification('Error loading API key details','error');}}
showAPIKeyDetails(key,stats=null){const modal=document.getElementById('key-details-modal');if(!modal)return;document.getElementById('key-vendor-name').textContent=key.vendor_name;document.getElementById('key-email').textContent=key.email;document.getElementById('key-access-level').textContent=key.access_level;document.getElementById('key-rate-limit').textContent=`${key.rate_limit.toLocaleString()}/hour`;document.getElementById('key-status').textContent=key.is_active?'Active':'Inactive';document.getElementById('key-created').textContent=this.formatTime(key.created_at);document.getElementById('key-expires').textContent=this.formatTime(key.expires_at);if(stats){document.getElementById('key-total-requests').textContent=stats.total_requests.toLocaleString();document.getElementById('key-last-used').textContent=stats.last_used?this.formatTime(stats.last_used):'Never';document.getElementById('key-rate-limit-hits').textContent=stats.rate_limit_hits;}
const maskedKey=key.key.substring(0,8)+'...'+key.key.substring(key.key.length-4);document.getElementById('key-value').textContent=maskedKey;modal.classList.remove('hidden');}
hideKeyDetailsModal(){const modal=document.getElementById('key-details-modal');if(modal){modal.classList.add('hidden');}}
async toggleAPIKeyStatus(keyId,newStatus){try{const response=await fetch(`/api/data-vendor-admin/api-keys/${keyId}/status`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.getToken()}`},body:JSON.stringify({is_active:newStatus})});if(!response.ok)throw new Error('Failed to update API key status');const keyIndex=this.apiKeys.findIndex(key=>key.id==keyId);if(keyIndex!==-1){this.apiKeys[keyIndex].is_active=newStatus;this.renderAPIKeysTable();}
this.showNotification(`API key ${newStatus ? 'activated' : 'deactivated'} successfully`,'success');}catch(error){console.error('Error updating API key status:',error);this.showNotification('Error updating API key status','error');}}
getAccessLevelColor(level){switch(level.toLowerCase()){case'basic':return'bg-gray-100 text-gray-800';case'premium':return'bg-blue-100 text-blue-800';case'enterprise':return'bg-purple-100 text-purple-800';default:return'bg-gray-100 text-gray-800';}}
formatTime(timestamp){if(!timestamp)return'Never';return new Date(timestamp).toLocaleString();}
getToken(){return localStorage.getItem('authToken')||sessionStorage.getItem('authToken');}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove();},5000);}
setupCharts(){}}
let dataVendorAdmin;document.addEventListener('DOMContentLoaded',()=>{dataVendorAdmin=new DataVendorAdmin();});function showTab(tabName){dataVendorAdmin?.showTab(tabName);}
function showCreateKeyModal(){dataVendorAdmin?.showCreateKeyModal();}
function hideCreateKeyModal(){dataVendorAdmin?.hideCreateKeyModal();}
function hideKeyDetailsModal(){dataVendorAdmin?.hideKeyDetailsModal();}
document.getElementById('create-key-form')?.addEventListener('submit',(e)=>{e.preventDefault();const formData=new FormData(e.target);const data={vendor_name:formData.get('vendor_name'),email:formData.get('email'),access_level:formData.get('access_level'),rate_limit:parseInt(formData.get('rate_limit')),expires_at:formData.get('expires_at')};dataVendorAdmin?.createAPIKey(data);});