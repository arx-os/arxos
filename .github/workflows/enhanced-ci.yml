name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly tests at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_load_tests:
        description: 'Run load tests'
        required: false
        default: 'false'
      run_chaos_tests:
        description: 'Run chaos tests'
        required: false
        default: 'false'

env:
  GO_VERSION: '1.21'
  POSTGRES_VERSION: '16'
  POSTGIS_VERSION: '3.4'
  COVERAGE_THRESHOLD: 80

jobs:
  # Code quality and linting
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run golangci-lint
        run: golangci-lint run --timeout 5m --config .golangci.yml

      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run go fmt
        run: |
          go fmt ./...
          git diff --exit-code

      - name: Run go vet
        run: go vet ./...

  # Unit tests with coverage
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run unit tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
            exit 1
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage.out
            coverage.html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-unit

  # Integration tests with PostGIS
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgis/postgis:${{ env.POSTGRES_VERSION }}-${{ env.POSTGIS_VERSION }}
        env:
          POSTGRES_DB: arxos_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --name postgres
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Wait for PostgreSQL
        run: |
          until PGPASSWORD=test psql -h localhost -U test -d arxos_test -c '\q'; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Setup test database
        run: |
          PGPASSWORD=test psql -h localhost -U test -d arxos_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          PGPASSWORD=test psql -h localhost -U test -d arxos_test -c "CREATE EXTENSION IF NOT EXISTS postgis_topology;"

      - name: Run integration tests
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/arxos_test?sslmode=disable
          POSTGIS_HOST: localhost
          POSTGIS_PORT: 5432
          POSTGIS_DB: arxos_test
          POSTGIS_USER: test
          POSTGIS_PASSWORD: test
        run: |
          go test -v -tags=integration -timeout 30m -coverprofile=integration_coverage.out ./...
          go tool cover -func=integration_coverage.out

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: |
            integration_coverage.out
            **/*test*.log

  # Load testing (scheduled or manual)
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.run_load_tests == 'true' ||
      contains(github.event.head_commit.message, '[load-test]')
    needs: integration-tests
    services:
      postgres:
        image: postgis/postgis:${{ env.POSTGRES_VERSION }}-${{ env.POSTGIS_VERSION }}
        env:
          POSTGRES_DB: arxos_load_test
          POSTGRES_USER: arxos
          POSTGRES_PASSWORD: testpass
          POSTGRES_MAX_CONNECTIONS: 200
          POSTGRES_SHARED_BUFFERS: 256MB
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup PostGIS
        run: |
          PGPASSWORD=testpass psql -h localhost -U arxos -d arxos_load_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"

      - name: Run load tests
        env:
          DATABASE_URL: postgres://arxos:testpass@localhost:5432/arxos_load_test?sslmode=disable
        run: |
          go test -v -tags=load -timeout 60m ./test/load/... | tee load_test_results.log

      - name: Generate load test report
        if: always()
        run: |
          echo "# Load Test Results" > load_test_report.md
          echo "" >> load_test_report.md
          echo "## Summary" >> load_test_report.md
          grep -E "(Throughput|Latency|Operations)" load_test_results.log >> load_test_report.md || true

      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: |
            load_test_results.log
            load_test_report.md

  # Chaos testing (scheduled or manual)
  chaos-tests:
    name: Chaos Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.run_chaos_tests == 'true' ||
      contains(github.event.head_commit.message, '[chaos-test]')
    needs: integration-tests
    services:
      postgres:
        image: postgis/postgis:${{ env.POSTGRES_VERSION }}-${{ env.POSTGIS_VERSION }}
        env:
          POSTGRES_DB: arxos_chaos_test
          POSTGRES_USER: arxos
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup PostGIS
        run: |
          PGPASSWORD=testpass psql -h localhost -U arxos -d arxos_chaos_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"

      - name: Run chaos tests
        env:
          DATABASE_URL: postgres://arxos:testpass@localhost:5432/arxos_chaos_test?sslmode=disable
        run: |
          go test -v -tags=chaos -timeout 60m ./test/chaos/... | tee chaos_test_results.log

      - name: Generate chaos test report
        if: always()
        run: |
          echo "# Chaos Test Results" > chaos_test_report.md
          echo "" >> chaos_test_report.md
          echo "## Resilience Metrics" >> chaos_test_report.md
          grep -E "(Recovery Rate|Data Integrity|Failures)" chaos_test_results.log >> chaos_test_report.md || true

      - name: Upload chaos test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: chaos-test-results
          path: |
            chaos_test_results.log
            chaos_test_report.md

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gosec-results.sarif

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for vulnerable dependencies
        run: |
          go list -json -deps ./... | docker run --rm -i sonatypecorp/nancy:latest sleuth

  # Performance benchmarks
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: integration-tests
    services:
      postgres:
        image: postgis/postgis:${{ env.POSTGRES_VERSION }}-${{ env.POSTGIS_VERSION }}
        env:
          POSTGRES_DB: arxos_bench
          POSTGRES_USER: bench
          POSTGRES_PASSWORD: bench
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run benchmarks
        env:
          DATABASE_URL: postgres://bench:bench@localhost:5432/arxos_bench?sslmode=disable
        run: |
          go test -bench=. -benchmem -benchtime=10s ./... | tee bench_results.txt

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'go'
          output-file-path: bench_results.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: '150%'

  # Multi-platform build
  build:
    name: Multi-platform Build
    runs-on: ${{ matrix.os }}
    needs: [unit-tests, integration-tests]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21', '1.22']
        arch: [amd64, arm64]
        exclude:
          - os: windows-latest
            arch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-

      - name: Build binary
        env:
          GOOS: ${{ runner.os == 'Linux' && 'linux' || runner.os == 'macOS' && 'darwin' || 'windows' }}
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -v -ldflags="-s -w" -o arxos-${{ runner.os }}-${{ matrix.arch }}${{ runner.os == 'Windows' && '.exe' || '' }} ./cmd/arx

      - name: Test binary
        if: matrix.arch == 'amd64'  # Only test on native architecture
        run: |
          ./arxos-${{ runner.os }}-amd64${{ runner.os == 'Windows' && '.exe' || '' }} version

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: arxos-${{ runner.os }}-${{ matrix.arch }}-go${{ matrix.go-version }}
          path: arxos-*

  # Docker build and scan
  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: arxos:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy container scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: arxos:${{ github.sha }}
          format: 'sarif'
          output: 'container-scan-results.sarif'

      - name: Upload container scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'container-scan-results.sarif'

      - name: Test Docker image
        run: |
          docker run --rm arxos:${{ github.sha }} version

      - name: Login to GitHub Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GitHub Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}

  # Test report generation
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    if: always()
    needs: [unit-tests, integration-tests, load-tests, chaos-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate comprehensive report
        run: |
          echo "# Test Report - $(date)" > test_report.md
          echo "" >> test_report.md

          echo "## Unit Tests" >> test_report.md
          if [ -f coverage-reports/coverage.out ]; then
            echo "✅ Coverage: $(go tool cover -func=coverage-reports/coverage.out | grep total | awk '{print $3}')" >> test_report.md
          fi
          echo "" >> test_report.md

          echo "## Integration Tests" >> test_report.md
          if [ -f integration-test-results/integration_coverage.out ]; then
            echo "✅ Completed" >> test_report.md
          fi
          echo "" >> test_report.md

          echo "## Load Tests" >> test_report.md
          if [ -f load-test-results/load_test_report.md ]; then
            cat load-test-results/load_test_report.md >> test_report.md
          fi
          echo "" >> test_report.md

          echo "## Chaos Tests" >> test_report.md
          if [ -f chaos-test-results/chaos_test_report.md ]; then
            cat chaos-test-results/chaos_test_report.md >> test_report.md
          fi

      - name: Upload final report
        uses: actions/upload-artifact@v3
        with:
          name: final-test-report
          path: test_report.md

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, docker, security]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: dist/

      - name: Create Release
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}