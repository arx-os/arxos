openapi: 3.0.3
info:
  title: SVGX Engine API
  description: |
    Comprehensive API for the SVGX Engine, providing real-time collaborative SVG editing,
    user management, system monitoring, and advanced features.

    ## Features
    - Real-time collaborative editing with WebSocket support
    - Authentication and role-based access control
    - Canvas management and SVG processing
    - System monitoring and health checks
    - Backup and restore functionality
    - Horizontal scaling and load balancing

    ## Authentication
    All endpoints require JWT authentication except for login and health checks.
    Include the token in the Authorization header: `Bearer <token>`

    ## WebSocket Events
    Real-time collaboration is handled through WebSocket connections at `/runtime/events`

    ## Rate Limiting
    API endpoints are rate-limited per user. Check response headers for rate limit information.

    ## Error Handling
    All errors return consistent JSON responses with error codes and messages.
  version: 1.0.0
  contact:
    name: SVGX Engine Support
    email: support@svgx-engine.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.svgx-engine.com
    description: Production server

security:
  - BearerAuth: []

paths:
  # Authentication Endpoints
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and receive JWT tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  description: Username
                  example: "user@example.com"
                password:
                  type: string
                  description: Password
                  example: "securepassword123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: JWT access token
                  refresh_token:
                    type: string
                    description: JWT refresh token
                  expires_in:
                    type: integer
                    description: Token expiration time in seconds
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get new access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Refresh token
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  expires_in:
                    type: integer
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get information about the authenticated user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Runtime Endpoints
  /runtime/ui-event/:
    post:
      tags:
        - Runtime
      summary: Handle UI event
      description: Process UI events for collaborative editing
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - event_type
                - canvas_id
              properties:
                event_type:
                  type: string
                  enum: [select, edit, create, delete, move, resize, lock, unlock]
                  description: Type of UI event
                canvas_id:
                  type: string
                  description: Canvas identifier
                object_id:
                  type: string
                  description: Object identifier (if applicable)
                data:
                  type: object
                  description: Event-specific data
      responses:
        '200':
          description: Event processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success, error]
                  message:
                    type: string
                  data:
                    type: object
        '400':
          description: Invalid event data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /runtime/undo/:
    post:
      tags:
        - Runtime
      summary: Undo last action
      description: Undo the last action on the canvas
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - canvas_id
              properties:
                canvas_id:
                  type: string
                  description: Canvas identifier
      responses:
        '200':
          description: Action undone successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  objects:
                    type: array
                    items:
                      $ref: '#/components/schemas/CanvasObject'
        '400':
          description: Cannot undo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /runtime/redo/:
    post:
      tags:
        - Runtime
      summary: Redo last undone action
      description: Redo the last undone action on the canvas
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - canvas_id
              properties:
                canvas_id:
                  type: string
                  description: Canvas identifier
      responses:
        '200':
          description: Action redone successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  objects:
                    type: array
                    items:
                      $ref: '#/components/schemas/CanvasObject'
        '400':
          description: Cannot redo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Lock Management
  /runtime/lock/:
    post:
      tags:
        - Runtime
      summary: Acquire object lock
      description: Lock an object for exclusive editing
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - canvas_id
                - object_id
              properties:
                canvas_id:
                  type: string
                  description: Canvas identifier
                object_id:
                  type: string
                  description: Object identifier
      responses:
        '200':
          description: Lock acquired successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [lock_acquired, lock_failed]
                  expires_at:
                    type: string
                    format: date-time
        '409':
          description: Object already locked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /runtime/unlock/:
    post:
      tags:
        - Runtime
      summary: Release object lock
      description: Release a lock on an object
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - canvas_id
                - object_id
              properties:
                canvas_id:
                  type: string
                  description: Canvas identifier
                object_id:
                  type: string
                  description: Object identifier
      responses:
        '200':
          description: Lock released successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [lock_released, lock_failed]
        '404':
          description: Lock not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /runtime/lock-status/:
    get:
      tags:
        - Runtime
      summary: Get lock status
      description: Get lock status for objects on a canvas
      security:
        - BearerAuth: []
      parameters:
        - name: canvas_id
          in: query
          required: true
          schema:
            type: string
          description: Canvas identifier
        - name: object_ids
          in: query
          required: false
          schema:
            type: array
            items:
              type: string
          description: Object identifiers to check
      responses:
        '200':
          description: Lock status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  locks:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/LockInfo'

  # Canvas Management
  /runtime/canvases/:
    get:
      tags:
        - Canvas
      summary: List canvases
      description: Get list of all canvases accessible to the user
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Items per page
      responses:
        '200':
          description: Canvases retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  canvases:
                    type: array
                    items:
                      $ref: '#/components/schemas/Canvas'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer

    post:
      tags:
        - Canvas
      summary: Create canvas
      description: Create a new canvas
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  description: Canvas name
                description:
                  type: string
                  description: Canvas description
      responses:
        '201':
          description: Canvas created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Canvas'

  /runtime/canvases/{canvas_id}:
    get:
      tags:
        - Canvas
      summary: Get canvas
      description: Get canvas details and objects
      security:
        - BearerAuth: []
      parameters:
        - name: canvas_id
          in: path
          required: true
          schema:
            type: string
          description: Canvas identifier
      responses:
        '200':
          description: Canvas retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Canvas'

    delete:
      tags:
        - Canvas
      summary: Delete canvas
      description: Delete a canvas
      security:
        - BearerAuth: []
      parameters:
        - name: canvas_id
          in: path
          required: true
          schema:
            type: string
          description: Canvas identifier
      responses:
        '204':
          description: Canvas deleted successfully

  # Metrics and Monitoring
  /metrics/:
    get:
      tags:
        - Monitoring
      summary: Get system metrics
      description: Get comprehensive system metrics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Metrics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  requests_total:
                    type: integer
                  requests_per_second:
                    type: number
                  average_response_time:
                    type: number
                  error_rate:
                    type: number
                  active_connections:
                    type: integer
                  memory_usage:
                    type: number
                  cpu_usage:
                    type: number

  /metrics/prometheus:
    get:
      tags:
        - Monitoring
      summary: Get Prometheus metrics
      description: Get metrics in Prometheus format
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string

  # Health Checks
  /health/:
    get:
      tags:
        - Health
      summary: Health check
      description: Basic health check endpoint
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                  timestamp:
                    type: string
                    format: date-time

  /health/summary/:
    get:
      tags:
        - Health
      summary: Detailed health summary
      description: Get detailed system health information
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Health summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthSummary'

  # State Management
  /state/persist/:
    post:
      tags:
        - State Management
      summary: Persist state data
      description: Persist state data to storage backends
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - key
                - value
              properties:
                key:
                  type: string
                  description: State key
                value:
                  type: object
                  description: State value
                state_type:
                  type: string
                  default: "default"
                  description: State type
                version:
                  type: integer
                  default: 1
                  description: State version
                metadata:
                  type: object
                  description: Additional metadata
      responses:
        '200':
          description: State persisted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success, error]
                  key:
                    type: string
                  checksum:
                    type: string

  /state/retrieve/{key}:
    get:
      tags:
        - State Management
      summary: Retrieve state data
      description: Retrieve state data from storage backends
      security:
        - BearerAuth: []
      parameters:
        - name: key
          in: path
          required: true
          schema:
            type: string
          description: State key
        - name: state_type
          in: query
          schema:
            type: string
          description: State type
      responses:
        '200':
          description: State retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success, not_found]
                  key:
                    type: string
                  value:
                    type: object
        '404':
          description: State not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Security and Rate Limiting
  /security/rate-limits/analytics/:
    get:
      tags:
        - Security
      summary: Get rate limiting analytics
      description: Get comprehensive rate limiting analytics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Analytics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitAnalytics'

  /security/rate-limits/config/:
    put:
      tags:
        - Security
      summary: Update rate limit configuration
      description: Update rate limiting configuration (admin only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RateLimitConfig'
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [success, error]

  # WebSocket Endpoint
  /runtime/events:
    get:
      tags:
        - WebSocket
      summary: WebSocket connection
      description: |
        WebSocket endpoint for real-time collaboration.

        ## Connection Parameters
        - `canvas_id`: Canvas identifier
        - `session_id`: Session identifier
        - `token`: JWT access token

        ## Event Types
        - `handshake`: Initial connection handshake
        - `edit_operation`: Object edit operations
        - `lock_request`: Object lock requests
        - `lock_release`: Object lock releases
        - `user_activity`: User activity notifications
        - `navigation`: Canvas navigation events
        - `annotation`: Annotation events

        ## Message Format
        ```json
        {
          "event_type": "edit_operation",
          "canvas_id": "canvas_123",
          "object_id": "obj_456",
          "data": { ... }
        }
        ```
      parameters:
        - name: canvas_id
          in: query
          required: true
          schema:
            type: string
          description: Canvas identifier
        - name: session_id
          in: query
          required: true
          schema:
            type: string
          description: Session identifier
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: JWT access token
      responses:
        '101':
          description: WebSocket connection established

# Components
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          description: Unique user identifier
        username:
          type: string
          description: Username
        email:
          type: string
          format: email
          description: User email
        role:
          type: string
          enum: [admin, editor, viewer]
          description: User role
        permissions:
          type: array
          items:
            type: string
          description: User permissions
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp
        last_login:
          type: string
          format: date-time
          description: Last login timestamp

    Canvas:
      type: object
      properties:
        id:
          type: string
          description: Canvas identifier
        name:
          type: string
          description: Canvas name
        description:
          type: string
          description: Canvas description
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
        created_by:
          type: string
          description: Creator user ID
        objects:
          type: array
          items:
            $ref: '#/components/schemas/CanvasObject'
          description: Canvas objects
        collaborators:
          type: array
          items:
            type: string
          description: Collaborator user IDs

    CanvasObject:
      type: object
      properties:
        id:
          type: string
          description: Object identifier
        type:
          type: string
          enum: [rect, circle, line, text, group]
          description: Object type
        x:
          type: number
          description: X coordinate
        y:
          type: number
          description: Y coordinate
        width:
          type: number
          description: Width (for rectangles)
        height:
          type: number
          description: Height (for rectangles)
        radius:
          type: number
          description: Radius (for circles)
        points:
          type: array
          items:
            type: number
          description: Points array (for lines)
        text:
          type: string
          description: Text content (for text objects)
        fill:
          type: string
          description: Fill color
        stroke:
          type: string
          description: Stroke color
        strokeWidth:
          type: number
          description: Stroke width
        fontSize:
          type: number
          description: Font size (for text)
        fontFamily:
          type: string
          description: Font family (for text)
        locked:
          type: boolean
          description: Whether object is locked
        lockedBy:
          type: string
          description: User ID who locked the object
        children:
          type: array
          items:
            $ref: '#/components/schemas/CanvasObject'
          description: Child objects (for groups)

    LockInfo:
      type: object
      properties:
        session_id:
          type: string
          description: Session identifier
        user_id:
          type: string
          description: User identifier
        timestamp:
          type: string
          format: date-time
          description: Lock timestamp
        timeout_seconds:
          type: integer
          description: Lock timeout in seconds

    HealthSummary:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall health status
        uptime:
          type: number
          description: System uptime in seconds
        version:
          type: string
          description: System version
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
        components:
          type: object
          properties:
            database:
              type: string
              enum: [healthy, degraded, unhealthy]
            redis:
              type: string
              enum: [healthy, degraded, unhealthy]
            websocket:
              type: string
              enum: [healthy, degraded, unhealthy]
        metrics:
          type: object
          properties:
            requests_per_second:
              type: number
            average_response_time:
              type: number
            error_rate:
              type: number
            memory_usage:
              type: number
            cpu_usage:
              type: number

    RateLimitAnalytics:
      type: object
      properties:
        total_requests:
          type: integer
          description: Total requests in time period
        blocked_requests:
          type: integer
          description: Number of blocked requests
        unique_clients:
          type: integer
          description: Number of unique clients
        top_endpoints:
          type: array
          items:
            type: object
            properties:
              endpoint:
                type: string
              requests:
                type: integer
              blocked:
                type: integer
        top_clients:
          type: array
          items:
            type: object
            properties:
              client_id:
                type: string
              requests:
                type: integer
              blocked:
                type: integer

    RateLimitConfig:
      type: object
      properties:
        requests_per_minute:
          type: integer
          description: Requests per minute limit
        burst_size:
          type: integer
          description: Burst size limit
        window_size:
          type: integer
          description: Time window in seconds
        enabled:
          type: boolean
          description: Whether rate limiting is enabled

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time
          description: Error timestamp
