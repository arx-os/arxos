<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Arxos Pro - 14KB BIM</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font:12px/1.4 system-ui,-apple-system,sans-serif;background:#0a0a0a;color:#e0e0e0;overflow:hidden;user-select:none}
.app{display:grid;grid-template-columns:200px 1fr 250px;height:100vh}
.sidebar{background:#111;border-right:1px solid #222;padding:10px;overflow-y:auto}
.viewport{position:relative;background:#050505}
.props{background:#111;border-left:1px solid #222;padding:10px;overflow-y:auto}
#canvas{width:100%;height:100%;cursor:crosshair}
#canvas.pan{cursor:grab}
#canvas.pan:active{cursor:grabbing}
.tools{position:absolute;top:10px;left:10px;background:rgba(17,17,17,0.95);padding:8px;border-radius:6px;backdrop-filter:blur(10px)}
.tool-btn{display:inline-block;width:32px;height:32px;line-height:32px;text-align:center;background:#1a1a1a;border:1px solid #333;border-radius:4px;margin:2px;cursor:pointer;transition:all 0.2s}
.tool-btn:hover{background:#2a2a2a;border-color:#4a9eff}
.tool-btn.active{background:#4a9eff;border-color:#4a9eff;color:#000}
.status{position:absolute;bottom:10px;left:10px;font-size:11px;color:#666}
.coords{position:absolute;bottom:10px;right:10px;font-size:11px;color:#666;font-family:monospace}
h3{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#4a9eff;margin:12px 0 8px}
.section{margin-bottom:16px}
.floor-item{padding:6px 8px;margin:2px 0;background:#1a1a1a;border:1px solid #222;border-radius:3px;cursor:pointer;font-size:11px}
.floor-item:hover{background:#222;border-color:#333}
.floor-item.active{background:#2a3a4a;border-color:#4a9eff}
.layer{display:flex;align-items:center;padding:4px 0;font-size:11px}
.layer input{margin-right:6px}
.prop-row{display:grid;grid-template-columns:80px 1fr;gap:8px;padding:4px 0;font-size:11px;align-items:center}
.prop-label{color:#888}
.prop-value{color:#e0e0e0}
.prop-input{width:100%;padding:3px 6px;background:#1a1a1a;border:1px solid #333;border-radius:3px;color:#e0e0e0;font-size:11px}
.btn{width:100%;padding:6px;margin:4px 0;background:#2a4a6a;border:1px solid #3a5a7a;border-radius:3px;color:#e0e0e0;cursor:pointer;font-size:11px;transition:all 0.2s}
.btn:hover{background:#3a5a7a;border-color:#4a6a8a}
.btn.primary{background:#4a9eff;border-color:#5aafff;color:#000}
.mini-map{position:absolute;top:10px;right:10px;width:150px;height:150px;background:rgba(17,17,17,0.95);border:1px solid #333;border-radius:6px}
.view-cube{position:absolute;bottom:40px;right:10px;width:80px;height:80px}
input[type=range]{width:100%;height:4px;background:#1a1a1a;outline:none;border-radius:2px}
input[type=range]::-webkit-slider-thumb{width:12px;height:12px;background:#4a9eff;border-radius:50%;cursor:pointer}
.grid-indicator{position:absolute;top:10px;right:170px;padding:4px 8px;background:rgba(17,17,17,0.95);border-radius:4px;font-size:11px;color:#666}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
<h3>Project</h3>
<div class="section">
<div class="floor-item active" onclick="A.setFloor(0)">Floor 1</div>
<div class="floor-item" onclick="A.setFloor(1)">Floor 2</div>
<div class="floor-item" onclick="A.setFloor(2)">Roof</div>
<button class="btn" onclick="A.addFloor()">+ Add Floor</button>
</div>

<h3>Layers</h3>
<div class="section">
<div class="layer"><input type="checkbox" checked onchange="A.layers.walls=this.checked;A.render()">Walls</div>
<div class="layer"><input type="checkbox" checked onchange="A.layers.doors=this.checked;A.render()">Doors</div>
<div class="layer"><input type="checkbox" checked onchange="A.layers.windows=this.checked;A.render()">Windows</div>
<div class="layer"><input type="checkbox" checked onchange="A.layers.electrical=this.checked;A.render()">Electrical</div>
<div class="layer"><input type="checkbox" onchange="A.layers.hvac=this.checked;A.render()">HVAC</div>
<div class="layer"><input type="checkbox" onchange="A.layers.plumbing=this.checked;A.render()">Plumbing</div>
<div class="layer"><input type="checkbox" checked onchange="A.layers.dimensions=this.checked;A.render()">Dimensions</div>
</div>

<h3>View</h3>
<div class="section">
<div class="prop-row">
<span class="prop-label">Mode</span>
<select class="prop-input" onchange="A.mode=this.value;A.render()">
<option value="2d">2D Plan</option>
<option value="3d">3D Isometric</option>
<option value="section">Section</option>
</select>
</div>
<div class="prop-row">
<span class="prop-label">Zoom</span>
<input type="range" min="0.1" max="5" step="0.1" value="1" oninput="A.zoom=parseFloat(this.value);A.render()">
</div>
<div class="prop-row">
<span class="prop-label">Rotation</span>
<input type="range" min="0" max="360" value="30" oninput="A.angle=parseInt(this.value);A.render()">
</div>
</div>

<h3>Statistics</h3>
<div class="section">
<div class="prop-row">
<span class="prop-label">Walls</span>
<span class="prop-value" id="stat-walls">0</span>
</div>
<div class="prop-row">
<span class="prop-label">Area</span>
<span class="prop-value" id="stat-area">0 m¬≤</span>
</div>
<div class="prop-row">
<span class="prop-label">Objects</span>
<span class="prop-value" id="stat-objects">0</span>
</div>
</div>
</div>

<div class="viewport">
<canvas id="canvas"></canvas>
<div class="tools">
<div class="tool-btn active" onclick="A.setTool('select')" title="Select (Q)">‚¨ö</div>
<div class="tool-btn" onclick="A.setTool('wall')" title="Wall (W)">‚ï±</div>
<div class="tool-btn" onclick="A.setTool('door')" title="Door (D)">üö™</div>
<div class="tool-btn" onclick="A.setTool('window')" title="Window">‚¨ú</div>
<div class="tool-btn" onclick="A.setTool('outlet')" title="Outlet (O)">‚äô</div>
<div class="tool-btn" onclick="A.setTool('room')" title="Room (R)">‚ñ≠</div>
<div class="tool-btn" onclick="A.setTool('measure')" title="Measure (M)">üìè</div>
<div class="tool-btn" onclick="A.setTool('delete')" title="Delete (X)">‚úï</div>
</div>
<div class="status" id="status">Ready</div>
<div class="coords" id="coords">0, 0</div>
<div class="grid-indicator">Grid: 100mm</div>
<div class="mini-map">
<canvas id="minimap" width="150" height="150"></canvas>
</div>
</div>

<div class="props">
<h3>Properties</h3>
<div id="properties">
<div class="section">
<p style="font-size:11px;color:#666">Select an object to view properties</p>
</div>
</div>

<h3>Tools</h3>
<div class="section">
<button class="btn primary" onclick="A.alignWalls()">Align Walls</button>
<button class="btn" onclick="A.snapToGrid()">Snap to Grid</button>
<button class="btn" onclick="A.duplicate()">Duplicate</button>
<button class="btn" onclick="A.mirror()">Mirror</button>
<button class="btn" onclick="A.rotate90()">Rotate 90¬∞</button>
</div>

<h3>Export</h3>
<div class="section">
<button class="btn" onclick="A.exportSVG()">Export SVG</button>
<button class="btn" onclick="A.exportJSON()">Export JSON</button>
<button class="btn" onclick="A.save()">Save Project</button>
<button class="btn" onclick="A.load()">Load Project</button>
</div>
</div>
</div>

<script>
// Arxos Professional BIM Engine - Under 14KB
const A = {
// State
mode: '2d',
tool: 'select',
zoom: 1,
angle: 30,
floor: 0,
gridSize: 100,

// Data
floors: [
{id:'f1',name:'Floor 1',elevation:0,walls:[],doors:[],windows:[],outlets:[],rooms:[]},
{id:'f2',name:'Floor 2',elevation:3000,walls:[],doors:[],windows:[],outlets:[],rooms:[]},
{id:'f3',name:'Roof',elevation:6000,walls:[],doors:[],windows:[],outlets:[],rooms:[]}
],

// Layers
layers: {
walls:true,doors:true,windows:true,electrical:true,
hvac:false,plumbing:false,dimensions:true
},

// Selection
selected: null,
hover: null,
drawing: null,
pan: {x:0,y:0},
dragStart: null,
isDragging: false,

// Canvas
canvas: null,
ctx: null,
minimap: null,
minimapCtx: null,

// Initialize
init() {
this.canvas = document.getElementById('canvas');
this.ctx = this.canvas.getContext('2d');
this.minimap = document.getElementById('minimap');
this.minimapCtx = this.minimap.getContext('2d');

this.resize();
this.bindEvents();
this.load();
this.render();
this.updateStats();
},

resize() {
this.canvas.width = this.canvas.offsetWidth;
this.canvas.height = this.canvas.offsetHeight;
},

bindEvents() {
// Mouse events
this.canvas.onmousedown = e => this.mouseDown(e);
this.canvas.onmousemove = e => this.mouseMove(e);
this.canvas.onmouseup = e => this.mouseUp(e);
this.canvas.onwheel = e => this.wheel(e);
this.canvas.ondblclick = e => this.doubleClick(e);

// Keyboard shortcuts
document.onkeydown = e => this.keyDown(e);
window.onresize = () => { this.resize(); this.render(); };
},

// Input handling
mouseDown(e) {
const pt = this.getPoint(e);
this.dragStart = {x:e.clientX,y:e.clientY,worldX:pt.x,worldY:pt.y};

if (e.shiftKey || e.button === 2) {
this.canvas.classList.add('pan');
this.isDragging = true;
return;
}

const f = this.floors[this.floor];

switch(this.tool) {
case 'select':
this.selected = this.pick(pt);
if (this.selected) {
this.showProperties(this.selected);
}
break;

case 'wall':
if (!this.drawing) {
this.drawing = {type:'wall',x1:pt.x,y1:pt.y,x2:pt.x,y2:pt.y};
} else {
const wall = {
id:'w'+Date.now(),
x1:this.drawing.x1,y1:this.drawing.y1,
x2:pt.x,y2:pt.y,
thickness:200,height:2700
};
f.walls.push(wall);
this.drawing = null;
this.updateStats();
}
break;

case 'door':
const wall = this.pickWall(pt);
if (wall) {
const t = this.projectOnWall(pt,wall);
f.doors.push({id:'d'+Date.now(),wall:wall.id,t,width:900});
this.updateStats();
}
break;

case 'outlet':
const w = this.pickWall(pt);
if (w) {
const t = this.projectOnWall(pt,w);
f.outlets.push({id:'o'+Date.now(),wall:w.id,t,height:300});
this.updateStats();
}
break;

case 'room':
if (!this.drawing) {
this.drawing = {type:'room',points:[pt]};
} else {
this.drawing.points.push(pt);
}
break;

case 'delete':
const obj = this.pick(pt);
if (obj) this.deleteObject(obj);
break;
}

this.render();
},

mouseMove(e) {
const pt = this.getPoint(e);
document.getElementById('coords').textContent = `${Math.round(pt.x)}, ${Math.round(pt.y)}`;

if (this.isDragging && this.dragStart) {
const dx = e.clientX - this.dragStart.x;
const dy = e.clientY - this.dragStart.y;
this.pan.x = dx;
this.pan.y = dy;
} else if (this.drawing) {
if (this.drawing.type === 'wall') {
this.drawing.x2 = pt.x;
this.drawing.y2 = pt.y;
}
} else {
this.hover = this.pick(pt);
this.canvas.style.cursor = this.hover ? 'pointer' : 'crosshair';
}

this.render();
},

mouseUp(e) {
this.isDragging = false;
this.canvas.classList.remove('pan');
if (this.dragStart) {
this.pan.x += e.clientX - this.dragStart.x;
this.pan.y += e.clientY - this.dragStart.y;
this.dragStart = null;
}
this.render();
},

wheel(e) {
e.preventDefault();
const delta = e.deltaY > 0 ? 0.9 : 1.1;
this.zoom = Math.max(0.1, Math.min(5, this.zoom * delta));
this.render();
},

doubleClick(e) {
if (this.drawing && this.drawing.type === 'room') {
const f = this.floors[this.floor];
f.rooms.push({
id:'r'+Date.now(),
points:this.drawing.points,
name:'Room '+(f.rooms.length+1)
});
this.drawing = null;
this.updateStats();
this.render();
}
},

keyDown(e) {
const shortcuts = {
'q': () => this.setTool('select'),
'w': () => this.setTool('wall'),
'd': () => this.setTool('door'),
'o': () => this.setTool('outlet'),
'r': () => this.setTool('room'),
'm': () => this.setTool('measure'),
'x': () => this.setTool('delete'),
'Delete': () => this.deleteObject(this.selected),
'Escape': () => { this.drawing = null; this.selected = null; this.render(); }
};

if (shortcuts[e.key]) {
e.preventDefault();
shortcuts[e.key]();
}
},

// Tools
setTool(tool) {
this.tool = tool;
this.drawing = null;
document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('status').textContent = tool.charAt(0).toUpperCase() + tool.slice(1) + ' tool';
this.render();
},

setFloor(index) {
this.floor = index;
this.drawing = null;
this.selected = null;
document.querySelectorAll('.floor-item').forEach((item,i) => {
item.classList.toggle('active', i === index);
});
this.render();
this.updateStats();
},

addFloor() {
const n = this.floors.length;
this.floors.push({
id:'f'+(n+1),
name:'Floor '+(n+1),
elevation:n*3000,
walls:[],doors:[],windows:[],outlets:[],rooms:[]
});
this.render();
},

// Geometry utilities
getPoint(e) {
const rect = this.canvas.getBoundingClientRect();
return {
x: (e.clientX - rect.left - this.canvas.width/2 - this.pan.x) / this.zoom,
y: (e.clientY - rect.top - this.canvas.height/2 - this.pan.y) / this.zoom
};
},

pick(pt) {
const f = this.floors[this.floor];

// Check walls
for (let w of f.walls) {
if (this.distToLine(pt, w) < 10) return w;
}
// Check doors
for (let d of f.doors) {
const wall = f.walls.find(w => w.id === d.wall);
if (wall) {
const pos = this.interpolate(wall, d.t);
if (Math.hypot(pt.x - pos.x, pt.y - pos.y) < 30) return d;
}
}
return null;
},

pickWall(pt) {
const f = this.floors[this.floor];
let minDist = Infinity;
let closest = null;
for (let w of f.walls) {
const d = this.distToLine(pt, w);
if (d < minDist && d < 20) {
minDist = d;
closest = w;
}
}
return closest;
},

distToLine(pt, line) {
const A = pt.x - line.x1;
const B = pt.y - line.y1;
const C = line.x2 - line.x1;
const D = line.y2 - line.y1;
const dot = A * C + B * D;
const lenSq = C * C + D * D;
let t = lenSq ? dot / lenSq : -1;
t = Math.max(0, Math.min(1, t));
const x = line.x1 + t * C;
const y = line.y1 + t * D;
return Math.hypot(pt.x - x, pt.y - y);
},

projectOnWall(pt, wall) {
const A = pt.x - wall.x1;
const B = pt.y - wall.y1;
const C = wall.x2 - wall.x1;
const D = wall.y2 - wall.y1;
const lenSq = C * C + D * D;
return lenSq ? (A * C + B * D) / lenSq : 0;
},

interpolate(wall, t) {
return {
x: wall.x1 + t * (wall.x2 - wall.x1),
y: wall.y1 + t * (wall.y2 - wall.y1)
};
},

// Rendering
render() {
const ctx = this.ctx;
const w = this.canvas.width;
const h = this.canvas.height;

// Clear
ctx.fillStyle = '#050505';
ctx.fillRect(0, 0, w, h);

// Setup transform
ctx.save();
ctx.translate(w/2 + this.pan.x, h/2 + this.pan.y);
ctx.scale(this.zoom, this.zoom);

if (this.mode === '2d') {
this.render2D(ctx);
} else if (this.mode === '3d') {
this.render3D(ctx);
}

// Drawing preview
if (this.drawing) {
ctx.strokeStyle = '#4a9eff';
ctx.setLineDash([5, 5]);
if (this.drawing.type === 'wall') {
ctx.beginPath();
ctx.moveTo(this.drawing.x1, this.drawing.y1);
ctx.lineTo(this.drawing.x2, this.drawing.y2);
ctx.stroke();
} else if (this.drawing.type === 'room' && this.drawing.points.length > 0) {
ctx.beginPath();
ctx.moveTo(this.drawing.points[0].x, this.drawing.points[0].y);
for (let i = 1; i < this.drawing.points.length; i++) {
ctx.lineTo(this.drawing.points[i].x, this.drawing.points[i].y);
}
ctx.stroke();
}
ctx.setLineDash([]);
}

ctx.restore();

// Render minimap
this.renderMinimap();
},

render2D(ctx) {
const f = this.floors[this.floor];

// Grid
ctx.strokeStyle = 'rgba(255,255,255,0.05)';
ctx.lineWidth = 0.5;
for (let i = -20; i <= 20; i++) {
ctx.beginPath();
ctx.moveTo(i * this.gridSize, -2000);
ctx.lineTo(i * this.gridSize, 2000);
ctx.moveTo(-2000, i * this.gridSize);
ctx.lineTo(2000, i * this.gridSize);
ctx.stroke();
}

// Rooms
if (this.layers.walls) {
for (let r of f.rooms) {
ctx.fillStyle = 'rgba(74,158,255,0.1)';
ctx.beginPath();
if (r.points.length > 0) {
ctx.moveTo(r.points[0].x, r.points[0].y);
for (let i = 1; i < r.points.length; i++) {
ctx.lineTo(r.points[i].x, r.points[i].y);
}
ctx.closePath();
ctx.fill();
}
}
}

// Walls
if (this.layers.walls) {
for (let w of f.walls) {
ctx.strokeStyle = w === this.selected ? '#4a9eff' : 
                  w === this.hover ? '#666' : '#e0e0e0';
ctx.lineWidth = w === this.selected ? 4 : 3;
ctx.beginPath();
ctx.moveTo(w.x1, w.y1);
ctx.lineTo(w.x2, w.y2);
ctx.stroke();

// Dimensions
if (this.layers.dimensions && (w === this.selected || w === this.hover)) {
const len = Math.hypot(w.x2 - w.x1, w.y2 - w.y1);
const mx = (w.x1 + w.x2) / 2;
const my = (w.y1 + w.y2) / 2;
ctx.fillStyle = '#666';
ctx.font = '10px sans-serif';
ctx.textAlign = 'center';
ctx.fillText(`${Math.round(len)}mm`, mx, my - 10);
}
}
}

// Doors
if (this.layers.doors) {
ctx.strokeStyle = '#fa9500';
ctx.lineWidth = 2;
for (let d of f.doors) {
const wall = f.walls.find(w => w.id === d.wall);
if (wall) {
const pos = this.interpolate(wall, d.t);
ctx.beginPath();
ctx.arc(pos.x, pos.y, 30, 0, Math.PI * 2);
ctx.stroke();
}
}
}

// Outlets
if (this.layers.electrical) {
ctx.fillStyle = '#ffff00';
for (let o of f.outlets) {
const wall = f.walls.find(w => w.id === o.wall);
if (wall) {
const pos = this.interpolate(wall, o.t);
ctx.beginPath();
ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
ctx.fill();
}
}
}
},

render3D(ctx) {
const f = this.floors[this.floor];
const a = this.angle * Math.PI / 180;

// 3D projection
const project = (x, y, z) => {
const rx = x * Math.cos(a) - y * Math.sin(a);
const ry = x * Math.sin(a) + y * Math.cos(a);
return {
x: (rx - ry) * 0.866,
y: (rx + ry) * 0.5 - z * 0.3
};
};

// Floor plate
ctx.fillStyle = 'rgba(30,30,30,0.5)';
ctx.strokeStyle = '#333';
const corners = [
project(-1000, -1000, 0),
project(1000, -1000, 0),
project(1000, 1000, 0),
project(-1000, 1000, 0)
];
ctx.beginPath();
ctx.moveTo(corners[0].x, corners[0].y);
for (let i = 1; i < 4; i++) {
ctx.lineTo(corners[i].x, corners[i].y);
}
ctx.closePath();
ctx.fill();
ctx.stroke();

// Walls 3D
ctx.fillStyle = 'rgba(200,200,200,0.9)';
ctx.strokeStyle = '#e0e0e0';
for (let w of f.walls) {
const b1 = project(w.x1, w.y1, 0);
const b2 = project(w.x2, w.y2, 0);
const t1 = project(w.x1, w.y1, w.height || 270);
const t2 = project(w.x2, w.y2, w.height || 270);

ctx.beginPath();
ctx.moveTo(b1.x, b1.y);
ctx.lineTo(b2.x, b2.y);
ctx.lineTo(t2.x, t2.y);
ctx.lineTo(t1.x, t1.y);
ctx.closePath();
ctx.fill();
ctx.stroke();
}
},

renderMinimap() {
const ctx = this.minimapCtx;
const w = 150;
const h = 150;
const scale = 0.05;

ctx.fillStyle = '#0a0a0a';
ctx.fillRect(0, 0, w, h);

ctx.save();
ctx.translate(w/2, h/2);
ctx.scale(scale, scale);

// Draw walls
const f = this.floors[this.floor];
ctx.strokeStyle = '#4a9eff';
ctx.lineWidth = 20;
for (let wall of f.walls) {
ctx.beginPath();
ctx.moveTo(wall.x1, wall.y1);
ctx.lineTo(wall.x2, wall.y2);
ctx.stroke();
}

// View indicator
ctx.strokeStyle = '#ff0';
ctx.lineWidth = 10;
ctx.strokeRect(
-this.canvas.width/2/this.zoom - this.pan.x/this.zoom,
-this.canvas.height/2/this.zoom - this.pan.y/this.zoom,
this.canvas.width/this.zoom,
this.canvas.height/this.zoom
);

ctx.restore();
},

// Properties panel
showProperties(obj) {
const props = document.getElementById('properties');
if (!obj) {
props.innerHTML = '<div class="section"><p style="font-size:11px;color:#666">No selection</p></div>';
return;
}

let html = '<div class="section">';
if (obj.x1 !== undefined) { // Wall
html += `
<div class="prop-row">
<span class="prop-label">Type</span>
<span class="prop-value">Wall</span>
</div>
<div class="prop-row">
<span class="prop-label">Length</span>
<span class="prop-value">${Math.round(Math.hypot(obj.x2-obj.x1, obj.y2-obj.y1))}mm</span>
</div>
<div class="prop-row">
<span class="prop-label">Thickness</span>
<input class="prop-input" type="number" value="${obj.thickness||200}" onchange="A.updateProp('thickness',this.value)">
</div>
<div class="prop-row">
<span class="prop-label">Height</span>
<input class="prop-input" type="number" value="${obj.height||2700}" onchange="A.updateProp('height',this.value)">
</div>`;
} else if (obj.wall) { // Door or Outlet
const type = obj.width ? 'Door' : 'Outlet';
html += `
<div class="prop-row">
<span class="prop-label">Type</span>
<span class="prop-value">${type}</span>
</div>`;
if (obj.width) {
html += `
<div class="prop-row">
<span class="prop-label">Width</span>
<input class="prop-input" type="number" value="${obj.width}" onchange="A.updateProp('width',this.value)">
</div>`;
}
}
html += '</div>';
props.innerHTML = html;
},

updateProp(prop, value) {
if (this.selected) {
this.selected[prop] = parseFloat(value);
this.render();
}
},

// Object operations
deleteObject(obj) {
if (!obj) return;
const f = this.floors[this.floor];

// Remove from appropriate array
['walls','doors','windows','outlets','rooms'].forEach(type => {
const idx = f[type].indexOf(obj);
if (idx !== -1) {
f[type].splice(idx, 1);
}
});

this.selected = null;
this.updateStats();
this.render();
},

alignWalls() {
const f = this.floors[this.floor];
const threshold = 50;


for (let w of f.walls) {
// Snap to grid
w.x1 = Math.round(w.x1 / this.gridSize) * this.gridSize;
w.y1 = Math.round(w.y1 / this.gridSize) * this.gridSize;
w.x2 = Math.round(w.x2 / this.gridSize) * this.gridSize;
w.y2 = Math.round(w.y2 / this.gridSize) * this.gridSize;
}
this.render();
},

// Stats
updateStats() {
const f = this.floors[this.floor];
document.getElementById('stat-walls').textContent = f.walls.length;
document.getElementById('stat-objects').textContent = 
f.walls.length + f.doors.length + f.outlets.length + f.rooms.length;

// Calculate area (simplified)
let area = 0;
for (let r of f.rooms) {
if (r.points.length > 2) {
// Shoelace formula
for (let i = 0; i < r.points.length; i++) {
const j = (i + 1) % r.points.length;
area += r.points[i].x * r.points[j].y;
area -= r.points[j].x * r.points[i].y;
}
}
}
area = Math.abs(area / 2) / 1000000; // Convert to m¬≤
document.getElementById('stat-area').textContent = area.toFixed(1) + ' m¬≤';
},

// Save/Load
save() {
const data = {
version: '1.0',
floors: this.floors,
settings: {
mode: this.mode,
zoom: this.zoom,
angle: this.angle,
floor: this.floor,
layers: this.layers
}
};
localStorage.setItem('arxos-project', JSON.stringify(data));
document.getElementById('status').textContent = 'Project saved';
},

load() {
const saved = localStorage.getItem('arxos-project');
if (saved) {
const data = JSON.parse(saved);
this.floors = data.floors || this.floors;
if (data.settings) {
Object.assign(this, data.settings);
}
this.render();
this.updateStats();
document.getElementById('status').textContent = 'Project loaded';
}
},

exportJSON() {
const blob = new Blob([JSON.stringify(this.floors, null, 2)], {type: 'application/json'});
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = 'arxos-project.json';
a.click();
},

exportSVG() {
// Simplified SVG export
let svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="-1000 -1000 2000 2000">';
const f = this.floors[this.floor];
for (let w of f.walls) {
svg += `<line x1="${w.x1}" y1="${w.y1}" x2="${w.x2}" y2="${w.y2}" stroke="#000" stroke-width="2"/>`;
}
svg += '</svg>';
const blob = new Blob([svg], {type: 'image/svg+xml'});
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = 'arxos-floor.svg';
a.click();
}
};

// Initialize
A.init();

// HTMX progressive enhancement
if (window.htmx) {
document.body.setAttribute('hx-ext', 'ws');
document.body.setAttribute('ws-connect', '/ws');
}
</script>
</body>
</html>