# ArxOS Makefile for Unix/Linux/macOS
# Provides comprehensive commands for development, testing, and deployment

.PHONY: all build clean test test-unit test-integration test-coverage \
        lint fmt vet validate-openapi docker-build docker-up docker-down \
        dev run migrate seed help install-deps ci

# Variables
BINARY_NAME=arx
MAIN_PATH=./cmd/arx
BUILD_DIR=bin
DOCKER_IMAGE=arxos:latest
COVERAGE_DIR=coverage

# Default target
all: clean lint test build

# Build the application
build:
	@echo "ğŸ”¨ Building ArxOS..."
	@mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… Build complete: $(BUILD_DIR)/$(BINARY_NAME)"

# Build with version info
build-release:
	@echo "ğŸš€ Building ArxOS release..."
	@mkdir -p $(BUILD_DIR)
	go build -ldflags="-s -w" -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… Release build complete"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)/
	rm -f $(BINARY_NAME)
	rm -rf $(COVERAGE_DIR)/
	@echo "âœ… Clean complete"

# Run all tests
test: test-unit
	@echo "âœ… All tests passed"

# Run unit tests
test-unit:
	@echo "ğŸ§ª Running unit tests..."
	go test -v -race -timeout 30s ./...

# Run tests with coverage
test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	@mkdir -p $(COVERAGE_DIR)
	go test -v -race -coverprofile=$(COVERAGE_DIR)/coverage.out -covermode=atomic ./...
	go tool cover -html=$(COVERAGE_DIR)/coverage.out -o $(COVERAGE_DIR)/coverage.html
	go tool cover -func=$(COVERAGE_DIR)/coverage.out
	@echo "âœ… Coverage report: $(COVERAGE_DIR)/coverage.html"

# Run integration tests
test-integration:
	@echo "ğŸ”— Running integration tests..."
	go test -v -tags=integration ./test/...

# Run linter
lint:
	@echo "ğŸ” Running linter..."
	@which golangci-lint > /dev/null || (echo "âš ï¸  Installing golangci-lint..." && go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest)
	golangci-lint run --timeout 5m || true
	@echo "âœ… Lint complete"

# Format code
fmt:
	@echo "âœ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Format complete"

# Run go vet
vet:
	@echo "ğŸ” Running go vet..."
	go vet ./...
	@echo "âœ… Vet complete"

# Validate OpenAPI specifications
validate-openapi:
	@echo "ğŸ“‹ Validating OpenAPI specifications..."
	@which spectral > /dev/null || (echo "âš ï¸  Spectral not installed. Run: npm install -g @stoplight/spectral-cli")
	@spectral lint api/openapi/openapi.yaml 2>/dev/null || echo "âš ï¸  v1 spec validation skipped"
	@spectral lint api/openapi/openapi-v2.yaml 2>/dev/null || echo "âš ï¸  v2 spec validation skipped"
	@echo "âœ… OpenAPI validation complete"

# Run development server
dev: build
	@echo "ğŸš€ Starting development server..."
	$(BUILD_DIR)/$(BINARY_NAME) server

# Run the application
run: build
	@echo "â–¶ï¸  Running ArxOS..."
	$(BUILD_DIR)/$(BINARY_NAME)

# Run database migrations
migrate:
	@echo "ğŸ“¦ Running database migrations..."
	$(BUILD_DIR)/$(BINARY_NAME) migrate
	@echo "âœ… Migrations complete"

# Seed test data
seed:
	@echo "ğŸŒ± Seeding test data..."
	go run scripts/seed_test_data.go 2>/dev/null || echo "âš ï¸  Seed script not found"
	@echo "âœ… Seed complete"

# Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(DOCKER_IMAGE) .
	@echo "âœ… Docker image built: $(DOCKER_IMAGE)"

# Start Docker Compose stack
docker-up:
	@echo "ğŸ³ Starting Docker Compose stack..."
	docker-compose up -d
	@echo "âœ… Docker stack started"
	@echo "ğŸ“Š Services:"
	@docker-compose ps

# Stop Docker Compose stack
docker-down:
	@echo "ğŸ³ Stopping Docker Compose stack..."
	docker-compose down
	@echo "âœ… Docker stack stopped"

# View Docker logs
docker-logs:
	@echo "ğŸ“‹ Viewing Docker logs..."
	docker-compose logs -f

# Docker clean (remove volumes)
docker-clean:
	@echo "ğŸ§¹ Cleaning Docker resources..."
	docker-compose down -v
	@echo "âœ… Docker cleanup complete"

# Install development dependencies
install-deps:
	@echo "ğŸ“¦ Installing development dependencies..."
	@echo "Installing golangci-lint..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "Installing swag..."
	@go install github.com/swaggo/swag/cmd/swag@latest
	@echo "âœ… Dependencies installed"
	@echo ""
	@echo "Optional tools (install manually):"
	@echo "  - Spectral: npm install -g @stoplight/spectral-cli"
	@echo "  - OpenAPI Generator: npm install -g @openapitools/openapi-generator-cli"

# Generate API documentation
generate-docs:
	@echo "ğŸ“š Generating API documentation..."
	@which swag > /dev/null || (echo "Installing swag..." && go install github.com/swaggo/swag/cmd/swag@latest)
	swag init -g cmd/arx/main.go -o api/docs
	@echo "âœ… Documentation generated"

# Run all checks (CI pipeline)
ci: clean fmt vet lint test-coverage
	@echo "âœ… All CI checks passed"

# Quick check before commit
pre-commit: fmt vet test
	@echo "âœ… Pre-commit checks passed"

# Display help
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘              ArxOS Development Commands                â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ Build Commands:"
	@echo "  make build           - Build the ArxOS binary"
	@echo "  make build-release   - Build optimized release binary"
	@echo "  make clean           - Remove build artifacts"
	@echo ""
	@echo "ğŸ§ª Test Commands:"
	@echo "  make test            - Run all tests"
	@echo "  make test-unit       - Run unit tests with race detection"
	@echo "  make test-coverage   - Run tests with coverage report"
	@echo "  make test-integration- Run integration tests"
	@echo ""
	@echo "âœ¨ Code Quality:"
	@echo "  make lint            - Run linter (golangci-lint)"
	@echo "  make fmt             - Format code (go fmt)"
	@echo "  make vet             - Run go vet"
	@echo "  make validate-openapi- Validate OpenAPI specs"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  make dev             - Start development server"
	@echo "  make run             - Run the application"
	@echo "  make migrate         - Run database migrations"
	@echo "  make seed            - Seed test data"
	@echo "  make pre-commit      - Run checks before commit"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  make docker-build    - Build Docker image"
	@echo "  make docker-up       - Start Docker Compose stack"
	@echo "  make docker-down     - Stop Docker Compose stack"
	@echo "  make docker-logs     - View Docker logs"
	@echo "  make docker-clean    - Clean Docker resources"
	@echo ""
	@echo "ğŸ› ï¸  Utilities:"
	@echo "  make install-deps    - Install development dependencies"
	@echo "  make generate-docs   - Generate API documentation"
	@echo "  make ci              - Run all CI checks"
	@echo "  make help            - Display this help message"
	@echo ""
	@echo "ğŸ’¡ Quick Start:"
	@echo "  1. make install-deps  # Install tools"
	@echo "  2. make docker-up     # Start database"
	@echo "  3. make migrate       # Run migrations"
	@echo "  4. make dev           # Start server"
	@echo ""

.DEFAULT_GOAL := help

