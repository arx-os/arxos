class CollaborationSystem{constructor(options={}){this.options={floorLockTimeout:300000,conflictCheckInterval:10000,userActivityTimeout:60000,showUserPresence:true,enableFloorLocking:true,enableConflictResolution:true,enableCollaborativeIndicators:true,...options};this.currentUser=null;this.currentFloor=null;this.floorLock=null;this.activeUsers=new Map();this.userActivity=new Map();this.conflictQueue=[];this.isProcessing=false;this.lockTimer=null;this.activityTimer=null;this.conflictTimer=null;this.presenceTimer=null;this.initializeSystem();}
initializeSystem(){this.initializeCurrentUser();this.setupEventListeners();this.startTimers();this.initializeUI();}
initializeCurrentUser(){this.currentUser={id:localStorage.getItem('user_id')||this.generateUserId(),name:localStorage.getItem('user_name')||'Unknown User',email:localStorage.getItem('user_email')||'',avatar:localStorage.getItem('user_avatar')||null,sessionId:this.generateSessionId()};if(!localStorage.getItem('user_id')){localStorage.setItem('user_id',this.currentUser.id);}}
setupEventListeners(){document.addEventListener('floorSelected',(event)=>{this.handleFloorSelection(event.detail);});document.addEventListener('mousedown',()=>this.updateUserActivity());document.addEventListener('keydown',()=>this.updateUserActivity());document.addEventListener('touchstart',()=>this.updateUserActivity());document.addEventListener('visibilitychange',()=>{if(document.hidden){this.handlePageHidden();}else{this.handlePageVisible();}});window.addEventListener('beforeunload',()=>{this.releaseFloorLock();});document.addEventListener('versionRestoreStarted',()=>{this.handleVersionRestoreStarted();});document.addEventListener('versionRestoreCompleted',()=>{this.handleVersionRestoreCompleted();});document.addEventListener('versionRestoreFailed',()=>{this.handleVersionRestoreFailed();});}
startTimers(){this.startLockTimer();this.startActivityTimer();this.startConflictTimer();this.startPresenceTimer();}
startLockTimer(){this.lockTimer=setInterval(()=>{this.refreshFloorLock();},this.options.floorLockTimeout/2);}
startActivityTimer(){this.activityTimer=setInterval(()=>{this.checkUserActivity();},this.options.userActivityTimeout);}
startConflictTimer(){this.conflictTimer=setInterval(()=>{this.checkForConflicts();},this.options.conflictCheckInterval);}
startPresenceTimer(){this.presenceTimer=setInterval(()=>{this.updateUserPresence();},30000);}
initializeUI(){this.createCollaborationUI();this.updateCollaborationStatus();}
createCollaborationUI(){const statusBar=document.createElement('div');statusBar.id='collaboration-status-bar';statusBar.className='fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-2 text-sm z-50';statusBar.innerHTML=`
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center space-x-4">
                    <div id="floor-lock-status" class="flex items-center space-x-2">
                        <i class="fas fa-lock text-green-400"></i>
                        <span>Floor unlocked</span>
                    </div>
                    <div id="active-users" class="flex items-center space-x-2">
                        <i class="fas fa-users text-blue-400"></i>
                        <span>0 active users</span>
                    </div>
                    <div id="conflict-status" class="flex items-center space-x-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                        <span>Conflicts detected</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="user-activity" class="flex items-center space-x-2">
                        <i class="fas fa-circle text-green-400"></i>
                        <span>Active</span>
                    </div>
                    <button id="collaboration-settings" class="text-gray-300 hover:text-white">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        `;document.body.appendChild(statusBar);const presencePanel=document.createElement('div');presencePanel.id='user-presence-panel';presencePanel.className='fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-50 max-w-xs';presencePanel.style.display='none';presencePanel.innerHTML=`
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Active Users</h3>
                <button id="close-presence-panel" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="user-list" class="space-y-2">
                <!-- User list will be populated here -->
            </div>
        `;document.body.appendChild(presencePanel);const conflictModal=document.createElement('div');conflictModal.id='conflict-resolution-modal';conflictModal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';conflictModal.style.display='none';conflictModal.innerHTML=`
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Conflict Resolution</h3>
                    <button id="close-conflict-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="conflict-list" class="space-y-4 mb-4">
                    <!-- Conflicts will be listed here -->
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="resolve-conflicts" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Resolve Conflicts
                    </button>
                    <button id="ignore-conflicts" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Ignore
                    </button>
                </div>
            </div>
        `;document.body.appendChild(conflictModal);this.setupUIEventListeners();}
setupUIEventListeners(){document.getElementById('collaboration-settings')?.addEventListener('click',()=>{this.showCollaborationSettings();});document.getElementById('active-users')?.addEventListener('click',()=>{this.togglePresencePanel();});document.getElementById('close-presence-panel')?.addEventListener('click',()=>{this.hidePresencePanel();});document.getElementById('close-conflict-modal')?.addEventListener('click',()=>{this.hideConflictModal();});document.getElementById('resolve-conflicts')?.addEventListener('click',()=>{this.resolveConflicts();});document.getElementById('ignore-conflicts')?.addEventListener('click',()=>{this.ignoreConflicts();});}
async handleFloorSelection(floorData){const previousFloor=this.currentFloor;this.currentFloor=floorData;if(previousFloor&&previousFloor.id!==floorData.id){await this.releaseFloorLock();}
if(this.options.enableFloorLocking){await this.requestFloorLock();}
this.updateCollaborationStatus();this.updateUserPresence();}
async requestFloorLock(){if(!this.currentFloor||!this.options.enableFloorLocking)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/lock`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,lock_type:'version_control',expires_at:new Date(Date.now()+this.options.floorLockTimeout).toISOString()})});if(response.ok){const lockData=await response.json();this.floorLock=lockData;this.updateFloorLockStatus(true);console.log('Floor lock acquired successfully');}else if(response.status===409){const lockInfo=await response.json();this.handleFloorLockedByOther(lockInfo);}else{throw new Error('Failed to acquire floor lock');}}catch(error){console.error('Error requesting floor lock:',error);this.handleFloorLockError(error);}}
async refreshFloorLock(){if(!this.floorLock||!this.currentFloor)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/lock/refresh`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,expires_at:new Date(Date.now()+this.options.floorLockTimeout).toISOString()})});if(response.ok){const lockData=await response.json();this.floorLock=lockData;console.log('Floor lock refreshed successfully');}else{this.handleFloorLockExpired();}}catch(error){console.error('Error refreshing floor lock:',error);this.handleFloorLockError(error);}}
async releaseFloorLock(){if(!this.floorLock||!this.currentFloor)return;try{await fetch(`/api/floors/${this.currentFloor.id}/lock/release`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId})});this.floorLock=null;this.updateFloorLockStatus(false);console.log('Floor lock released successfully');}catch(error){console.error('Error releasing floor lock:',error);}}
handleFloorLockedByOther(lockInfo){this.updateFloorLockStatus(false,lockInfo.locked_by);this.showNotification(`Floor is locked by ${lockInfo.locked_by_name || 'another user'}`,'warning');this.emitEvent('floorLockedByOther',lockInfo);}
handleFloorLockExpired(){this.floorLock=null;this.updateFloorLockStatus(false);this.showNotification('Floor lock expired','warning');setTimeout(()=>{this.requestFloorLock();},1000);this.emitEvent('floorLockExpired');}
handleFloorLockError(error){this.floorLock=null;this.updateFloorLockStatus(false);this.showNotification('Failed to acquire floor lock','error');this.emitEvent('floorLockError',error);}
updateFloorLockStatus(locked,lockedBy=null){const statusElement=document.getElementById('floor-lock-status');if(!statusElement)return;if(locked){statusElement.innerHTML=`
                <i class="fas fa-lock text-green-400"></i>
                <span>Floor locked</span>
            `;}else if(lockedBy){statusElement.innerHTML=`
                <i class="fas fa-lock text-red-400"></i>
                <span>Locked by ${lockedBy}</span>
            `;}else{statusElement.innerHTML=`
                <i class="fas fa-unlock text-gray-400"></i>
                <span>Floor unlocked</span>
            `;}}
updateUserActivity(){this.userActivity.set(this.currentUser.id,Date.now());const activityElement=document.getElementById('user-activity');if(activityElement){activityElement.innerHTML=`
                <i class="fas fa-circle text-green-400"></i>
                <span>Active</span>
            `;}}
checkUserActivity(){const now=Date.now();const inactiveThreshold=this.options.userActivityTimeout;const lastActivity=this.userActivity.get(this.currentUser.id);if(lastActivity&&(now-lastActivity)>inactiveThreshold){this.handleUserInactive();}
for(const[userId,lastActivity]of this.userActivity.entries()){if(userId!==this.currentUser.id&&(now-lastActivity)>inactiveThreshold){this.handleUserBecameInactive(userId);}}}
handleUserInactive(){const activityElement=document.getElementById('user-activity');if(activityElement){activityElement.innerHTML=`
                <i class="fas fa-circle text-gray-400"></i>
                <span>Inactive</span>
            `;}
this.emitEvent('userInactive',{userId:this.currentUser.id});}
handleUserBecameInactive(userId){this.activeUsers.delete(userId);this.userActivity.delete(userId);this.updatePresencePanel();this.emitEvent('userBecameInactive',{userId});}
async updateUserPresence(){if(!this.currentFloor)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/presence`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,user_name:this.currentUser.name,user_email:this.currentUser.email,user_avatar:this.currentUser.avatar,last_activity:Date.now()})});if(response.ok){const presenceData=await response.json();this.updateActiveUsers(presenceData.active_users);}}catch(error){console.error('Error updating user presence:',error);}}
updateActiveUsers(users){this.activeUsers.clear();users.forEach(user=>{if(user.user_id!==this.currentUser.id){this.activeUsers.set(user.user_id,user);this.userActivity.set(user.user_id,user.last_activity);}});this.updateActiveUsersCount();this.updatePresencePanel();}
updateActiveUsersCount(){const countElement=document.getElementById('active-users');if(countElement){const count=this.activeUsers.size;countElement.innerHTML=`
                <i class="fas fa-users text-blue-400"></i>
                <span>${count} active user${count !== 1 ? 's' : ''}</span>
            `;}}
updatePresencePanel(){const userList=document.getElementById('user-list');if(!userList)return;userList.innerHTML='';this.activeUsers.forEach(user=>{const userElement=document.createElement('div');userElement.className='flex items-center space-x-3 p-2 bg-gray-50 rounded';userElement.innerHTML=`
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                    ${user.user_name ? user.user_name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${user.user_name || 'Unknown User'}</div>
                    <div class="text-sm text-gray-500">${user.user_email || ''}</div>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-xs text-gray-500">Active</span>
                </div>
            `;userList.appendChild(userElement);});}
togglePresencePanel(){const panel=document.getElementById('user-presence-panel');if(panel){panel.style.display=panel.style.display==='none'?'block':'none';}}
hidePresencePanel(){const panel=document.getElementById('user-presence-panel');if(panel){panel.style.display='none';}}
async checkForConflicts(){if(!this.currentFloor||this.isProcessing)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/conflicts`);if(response.ok){const conflicts=await response.json();if(conflicts.length>0){this.handleConflictsDetected(conflicts);}}}catch(error){console.error('Error checking for conflicts:',error);}}
handleConflictsDetected(conflicts){this.conflictQueue=conflicts;const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='flex';conflictElement.innerHTML=`
                <i class="fas fa-exclamation-triangle text-red-400"></i>
                <span>${conflicts.length} conflict${conflicts.length !== 1 ? 's' : ''} detected</span>
            `;}
this.showNotification(`${conflicts.length} conflict(s) detected`,'warning');this.emitEvent('conflictsDetected',conflicts);}
showConflictModal(){const modal=document.getElementById('conflict-resolution-modal');const conflictList=document.getElementById('conflict-list');if(!modal||!conflictList)return;conflictList.innerHTML='';this.conflictQueue.forEach(conflict=>{const conflictElement=document.createElement('div');conflictElement.className='border border-red-200 bg-red-50 p-3 rounded';conflictElement.innerHTML=`
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium text-red-900">${conflict.type}</h4>
                    <span class="text-sm text-red-600">${conflict.severity}</span>
                </div>
                <p class="text-sm text-red-700 mb-2">${conflict.description}</p>
                <div class="text-xs text-red-600">
                    <strong>Affected:</strong> ${conflict.affected_objects.join(', ')}
                </div>
            `;conflictList.appendChild(conflictElement);});modal.style.display='flex';}
hideConflictModal(){const modal=document.getElementById('conflict-resolution-modal');if(modal){modal.style.display='none';}}
async resolveConflicts(){if(this.isProcessing)return;this.isProcessing=true;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/conflicts/resolve`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,conflicts:this.conflictQueue})});if(response.ok){const result=await response.json();this.handleConflictsResolved(result);}else{throw new Error('Failed to resolve conflicts');}}catch(error){console.error('Error resolving conflicts:',error);this.showNotification('Failed to resolve conflicts','error');}finally{this.isProcessing=false;}}
handleConflictsResolved(result){this.conflictQueue=[];const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='none';}
this.hideConflictModal();this.showNotification('Conflicts resolved successfully','success');this.emitEvent('conflictsResolved',result);}
ignoreConflicts(){this.conflictQueue=[];const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='none';}
this.hideConflictModal();this.showNotification('Conflicts ignored','info');this.emitEvent('conflictsIgnored');}
handleVersionRestoreStarted(){if(this.options.enableFloorLocking){this.requestFloorLock();}}
handleVersionRestoreCompleted(){setTimeout(()=>{this.releaseFloorLock();},5000);}
handleVersionRestoreFailed(){this.releaseFloorLock();}
handlePageHidden(){this.handleUserInactive();}
handlePageVisible(){this.updateUserActivity();}
showCollaborationSettings(){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Collaboration Settings</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">Floor Locking</label>
                        <input type="checkbox" id="enable-floor-locking" ${this.options.enableFloorLocking ? 'checked' : ''} class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">Conflict Resolution</label>
                        <input type="checkbox" id="enable-conflict-resolution" ${this.options.enableConflictResolution ? 'checked' : ''} class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">User Presence</label>
                        <input type="checkbox" id="show-user-presence" ${this.options.showUserPresence ? 'checked' : ''} class="rounded">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="collaborationSystem.saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Save Settings
                    </button>
                </div>
            </div>
        `;document.body.appendChild(modal);modal.querySelector('#enable-floor-locking').addEventListener('change',(e)=>{this.options.enableFloorLocking=e.target.checked;});modal.querySelector('#enable-conflict-resolution').addEventListener('change',(e)=>{this.options.enableConflictResolution=e.target.checked;});modal.querySelector('#show-user-presence').addEventListener('change',(e)=>{this.options.showUserPresence=e.target.checked;this.updateCollaborationStatus();});}
saveSettings(){localStorage.setItem('collaboration_settings',JSON.stringify({enableFloorLocking:this.options.enableFloorLocking,enableConflictResolution:this.options.enableConflictResolution,showUserPresence:this.options.showUserPresence}));document.querySelector('.fixed.inset-0').remove();this.showNotification('Settings saved successfully','success');}
updateCollaborationStatus(){this.updateFloorLockStatus(!!this.floorLock);this.updateActiveUsersCount();this.updateUserActivity();}
showNotification(message,type='info'){if(window.notificationSystem){window.notificationSystem.show(message,type);}else{console.log(`${type.toUpperCase()}: ${message}`);}}
generateUserId(){return'user_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
generateSessionId(){return'session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
emitEvent(eventName,data){const event=new CustomEvent(eventName,{detail:data,bubbles:true});document.dispatchEvent(event);}
getCollaborationStatistics(){return{currentUser:this.currentUser,currentFloor:this.currentFloor,floorLock:this.floorLock,activeUsers:Array.from(this.activeUsers.values()),activeUsersCount:this.activeUsers.size,conflictQueue:this.conflictQueue,userActivity:Object.fromEntries(this.userActivity)};}
destroy(){if(this.lockTimer)clearInterval(this.lockTimer);if(this.activityTimer)clearInterval(this.activityTimer);if(this.conflictTimer)clearInterval(this.conflictTimer);if(this.presenceTimer)clearInterval(this.presenceTimer);this.releaseFloorLock();const elements=['collaboration-status-bar','user-presence-panel','conflict-resolution-modal'];elements.forEach(id=>{const element=document.getElementById(id);if(element){element.remove();}});this.activeUsers.clear();this.userActivity.clear();this.conflictQueue=[];}}
const collaborationSystem=new CollaborationSystem();if(typeof module!=='undefined'&&module.exports){module.exports=CollaborationSystem;}
