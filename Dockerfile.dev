# ArxOS Development Dockerfile
# Optimized for development with hot reload and debugging capabilities

# Build arguments
ARG VERSION=dev
ARG COMMIT=dev
ARG BUILD_TIME=""

# Development build stage
FROM golang:1.21-alpine AS dev-builder

# Install development dependencies
RUN apk add --no-cache \
    git \
    ca-certificates \
    tzdata \
    make \
    bash \
    curl \
    postgresql-client

# Set working directory
WORKDIR /app

# Copy go mod files first for better layer caching
COPY go.mod go.sum ./

# Download dependencies with cache mount
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download && go mod verify

# Copy source code
COPY . .

# Build the application with development optimizations
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=linux go build \
    -a -installsuffix cgo \
    -ldflags="-s -w -X github.com/arx-os/arxos/cmd/arx.Version=${VERSION} -X github.com/arx-os/arxos/cmd/arx.Commit=${COMMIT} -X github.com/arx-os/arxos/cmd/arx.BuildTime=${BUILD_TIME}" \
    -o arx ./cmd/arx

# Development runtime stage
FROM alpine:3.19 AS dev-runtime

# Install development tools and dependencies
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    curl \
    postgresql-client \
    bash \
    make \
    git \
    # Spatial computing dependencies
    gdal \
    geos \
    proj \
    spatialite \
    sqlite \
    gdal-dev \
    geos-dev \
    proj-dev \
    sqlite-dev

# Create non-root user
RUN adduser -D -s /bin/bash arxos

# Set working directory
WORKDIR /app

# Copy binary from builder stage
COPY --from=dev-builder /app/arx .

# Copy configuration and scripts
COPY configs/ ./configs/
COPY scripts/ ./scripts/
COPY Makefile ./

# Set permissions
RUN chmod +x ./arx && \
    mkdir -p /app/data /app/logs /app/cache /tmp/arxos && \
    chown -R arxos:arxos /app && \
    chown -R arxos:arxos /tmp/arxos

# Switch to non-root user
USER arxos

# Expose ports
EXPOSE 8080 8081

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Default command for development
CMD ["./arx", "serve", "--config", "configs/environments/development.yml"]
