<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arxos Tests</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        .test-pass { color: #4CAF50; }
        .test-fail { color: #f44336; }
        .test-section { 
            margin: 20px 0; 
            padding: 15px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        h2 { color: #fff; }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Arxos Test Suite</h1>
    <div id="test-output"></div>
    <div id="test-summary" class="summary"></div>

    <!-- Load Arxos components -->
    <script src="../config/config.js"></script>
    <script src="../core/ingestion/ai_service.js"></script>

    <script>
        // Simple test framework
        class TestRunner {
            constructor() {
                this.passed = 0;
                this.failed = 0;
                this.output = document.getElementById('test-output');
                this.summary = document.getElementById('test-summary');
            }

            assert(condition, message) {
                if (!condition) {
                    throw new Error(message || 'Assertion failed');
                }
            }

            assertEqual(actual, expected, message) {
                if (actual !== expected) {
                    throw new Error(message || `Expected ${expected}, got ${actual}`);
                }
            }

            async runTest(name, testFn) {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-section';
                
                try {
                    await testFn(this);
                    testDiv.innerHTML = `<span class="test-pass">✅ ${name}</span>`;
                    this.passed++;
                } catch (error) {
                    testDiv.innerHTML = `<span class="test-fail">❌ ${name}<br>   ${error.message}</span>`;
                    this.failed++;
                    console.error(error);
                }
                
                this.output.appendChild(testDiv);
            }

            showSummary() {
                const total = this.passed + this.failed;
                this.summary.innerHTML = `
                    <h2>Test Results</h2>
                    <p>Total: ${total}</p>
                    <p class="test-pass">Passed: ${this.passed}</p>
                    <p class="test-fail">Failed: ${this.failed}</p>
                    ${this.failed === 0 ? '<p class="test-pass">✨ All tests passed!</p>' : ''}
                `;
            }
        }

        // Run tests
        async function runAllTests() {
            const runner = new TestRunner();

            // Configuration Tests
            await runner.runTest('Configuration loads with defaults', (t) => {
                t.assert(window.ARXOS_CONFIG, 'Configuration should be loaded');
                t.assertEqual(ARXOS_CONFIG.get('app.name'), 'Arxos');
                t.assertEqual(ARXOS_CONFIG.get('app.version'), '1.0.0');
            });

            await runner.runTest('Can get nested configuration values', (t) => {
                const aiProvider = ARXOS_CONFIG.get('ingestion.aiProvider');
                t.assertEqual(aiProvider, 'openai');
            });

            await runner.runTest('Feature flags work correctly', (t) => {
                const pdfEnabled = ARXOS_CONFIG.isFeatureEnabled('enablePDFIngestion');
                t.assertEqual(pdfEnabled, true);
            });

            await runner.runTest('Can set and get configuration values', (t) => {
                const original = ARXOS_CONFIG.get('test.value');
                ARXOS_CONFIG.set('test.value', 'test123');
                t.assertEqual(ARXOS_CONFIG.get('test.value'), 'test123');
            });

            // AI Service Tests
            await runner.runTest('AI Service initializes', (t) => {
                const service = new AIIngestionService();
                t.assert(service, 'Service should be created');
                t.assert(service.config, 'Service should have config');
            });

            await runner.runTest('Detects file types correctly', (t) => {
                const service = new AIIngestionService();
                
                const pdfFile = { name: 'floor.pdf' };
                const jpgFile = { name: 'photo.jpg' };
                const ifcFile = { name: 'model.ifc' };
                
                t.assertEqual(service.detectFileType(pdfFile), 'pdf');
                t.assertEqual(service.detectFileType(jpgFile), 'image');
                t.assertEqual(service.detectFileType(ifcFile), 'ifc');
            });

            await runner.runTest('Generates floor plan prompt', (t) => {
                const service = new AIIngestionService();
                const prompt = service.getFloorPlanPrompt();
                
                t.assert(prompt.includes('walls'), 'Prompt should mention walls');
                t.assert(prompt.includes('JSON'), 'Prompt should request JSON');
                t.assert(prompt.length > 100, 'Prompt should be detailed');
            });

            await runner.runTest('Converts wall data to ArxObject', (t) => {
                const service = new AIIngestionService();
                
                const wallData = {
                    x1: 0, y1: 0,
                    x2: 100, y2: 0,
                    type: 'exterior',
                    thickness: 'standard'
                };
                
                const arxObject = service.wallToArxObject(wallData, 0);
                
                t.assertEqual(arxObject.type, 'StructuralWall');
                t.assertEqual(arxObject.width, 0.2);
                t.assertEqual(arxObject.height, 3.0);
            });

            await runner.runTest('Validates file sizes', (t) => {
                const service = new AIIngestionService();
                
                const smallFile = { 
                    name: 'small.pdf', 
                    size: 1024 * 1024 // 1MB
                };
                
                const largeFile = {
                    name: 'large.pdf',
                    size: 100 * 1024 * 1024 // 100MB
                };
                
                // Should not throw for small file
                service.validateFile(smallFile);
                
                // Should throw for large file
                let thrown = false;
                try {
                    service.validateFile(largeFile);
                } catch (e) {
                    thrown = true;
                }
                t.assert(thrown, 'Should throw for large files');
            });

            // Show summary
            runner.showSummary();
        }

        // Run tests when page loads
        window.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>