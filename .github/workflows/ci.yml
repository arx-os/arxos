name: ArxOS CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.21'

jobs:
  # Go application testing and building
  test-go:
    name: Test Go Applications
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Install SQLite
      run: sudo apt-get update && sudo apt-get install -y sqlite3 libsqlite3-dev
      
    - name: Download dependencies
      run: go mod download
      
    - name: Verify dependencies
      run: go mod verify
      
    - name: Run go vet
      run: go vet ./...
      
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: go
        
    - name: Build binaries
      run: |
        go build -o bin/arx ./cmd/arx
        go build -o bin/arxd ./cmd/arxd  
        go build -o bin/arxos-server ./cmd/arxos-server
        
    - name: Test binaries
      run: |
        ./bin/arx --help
        ./bin/arxd --help
        ./bin/arxos-server --help

  # Security and code quality
  security-scan:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Run gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: './...'
        
    - name: Run go mod audit
      run: |
        go list -json -deps ./... | nancy sleuth
      continue-on-error: true

  # Mobile app testing
  test-mobile:
    name: Test Mobile App
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json
        
    - name: Install mobile dependencies
      working-directory: mobile
      run: npm ci
      
    - name: Run mobile tests
      working-directory: mobile
      run: npm test
      
    - name: Run mobile linting
      working-directory: mobile
      run: npm run lint
      
    - name: Type check mobile app
      working-directory: mobile
      run: npm run type-check

  # Integration testing
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-go]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Install SQLite
      run: sudo apt-get update && sudo apt-get install -y sqlite3 libsqlite3-dev
      
    - name: Build all binaries
      run: |
        go build -o bin/arx ./cmd/arx
        go build -o bin/arxd ./cmd/arxd
        go build -o bin/arxos-server ./cmd/arxos-server
        
    - name: Run integration tests
      run: |
        # Start server in background
        ./bin/arxos-server --port 8080 --db /tmp/test.db &
        SERVER_PID=$!
        sleep 5
        
        # Test API endpoints
        curl -f http://localhost:8080/health || exit 1
        curl -f http://localhost:8080/ready || exit 1
        
        # Test CLI integration
        ./bin/arx --help
        
        # Cleanup
        kill $SERVER_PID

  # Multi-platform build
  build-matrix:
    name: Multi-platform Build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        arch: [amd64]
        include:
          - os: ubuntu-latest
            arch: arm64
            
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Install SQLite (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get update && sudo apt-get install -y sqlite3 libsqlite3-dev
      
    - name: Install SQLite (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install sqlite3
      
    - name: Build binaries
      env:
        GOOS: ${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'macos-latest' && 'darwin' || 'windows' }}
        GOARCH: ${{ matrix.arch }}
      run: |
        go build -o bin/arx${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/arx
        go build -o bin/arxd${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/arxd
        go build -o bin/arxos-server${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/arxos-server

  # Documentation generation
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Generate Go docs
      run: |
        go doc -all ./... > docs/API_REFERENCE.md
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs

  # Release automation
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test-go, security-scan, test-mobile, integration-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Build release binaries
      run: |
        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o release/linux-amd64/arx ./cmd/arx
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o release/linux-amd64/arxd ./cmd/arxd
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o release/linux-amd64/arxos-server ./cmd/arxos-server
        
        # Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o release/linux-arm64/arx ./cmd/arx
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o release/linux-arm64/arxd ./cmd/arxd
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o release/linux-arm64/arxos-server ./cmd/arxos-server
        
        # macOS AMD64
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o release/darwin-amd64/arx ./cmd/arx
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o release/darwin-amd64/arxd ./cmd/arxd
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o release/darwin-amd64/arxos-server ./cmd/arxos-server
        
        # macOS ARM64 (Apple Silicon)
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o release/darwin-arm64/arx ./cmd/arx
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o release/darwin-arm64/arxd ./cmd/arxd
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o release/darwin-arm64/arxos-server ./cmd/arxos-server
        
        # Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o release/windows-amd64/arx.exe ./cmd/arx
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o release/windows-amd64/arxd.exe ./cmd/arxd
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o release/windows-amd64/arxos-server.exe ./cmd/arxos-server
        
    - name: Create release archives
      run: |
        cd release
        for dir in */; do
          platform=${dir%/}
          tar -czf "arxos-${platform}.tar.gz" "$platform"
        done
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Container build and push
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [test-go, security-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and push server image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.server
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/arxos-server:latest
          ghcr.io/${{ github.repository }}/arxos-server:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max