document.addEventListener('DOMContentLoaded',()=>{const tableBody=document.getElementById('cmms-table-body');const addBtn=document.getElementById('add-connection-btn');const modal=document.getElementById('cmms-modal');const closeModal=document.getElementById('close-modal');const form=document.getElementById('cmms-form');const toast=document.getElementById('toast');let editingId=null;function showToast(msg,isError=false){toast.textContent=msg;toast.className='toast'+(isError?' error':'');toast.classList.remove('hidden');setTimeout(()=>toast.classList.add('hidden'),3000);}
function showModal(edit=false,data={}){modal.classList.remove('hidden');document.getElementById('modal-title').textContent=edit?'Edit Connection':'Add Connection';form.reset();editingId=edit?data.id:null;document.getElementById('connection-id').value=data.id||'';document.getElementById('name').value=data.name||'';document.getElementById('type').value=data.type||'';document.getElementById('base-url').value=data.base_url||'';document.getElementById('auth-method').value=getAuthMethod(data)||'api_key';document.getElementById('api-key').value=data.api_key||'';document.getElementById('username').value=data.username||'';document.getElementById('password').value='';document.getElementById('oauth2-client-id').value=data.oauth2_client_id||'';document.getElementById('oauth2-secret').value='';document.getElementById('oauth2-token-url').value=data.oauth2_token_url||'';document.getElementById('oauth2-scope').value=data.oauth2_scope||'';document.getElementById('sync-interval').value=data.sync_interval_min||60;document.getElementById('is-active').checked=!!data.is_active;updateAuthFields();}
function hideModal(){modal.classList.add('hidden');}
function getAuthMethod(data){if(data.oauth2_client_id)return'oauth2';if(data.username)return'basic';return'api_key';}
function updateAuthFields(){const method=document.getElementById('auth-method').value;document.querySelectorAll('.auth-fields').forEach(div=>div.classList.add('hidden'));if(method==='api_key')document.getElementById('api-key-fields').classList.remove('hidden');if(method==='basic')document.getElementById('basic-fields').classList.remove('hidden');if(method==='oauth2')document.getElementById('oauth2-fields').classList.remove('hidden');}
document.getElementById('auth-method').addEventListener('change',updateAuthFields);addBtn.addEventListener('click',()=>showModal(false));closeModal.addEventListener('click',hideModal);window.onclick=e=>{if(e.target===modal)hideModal();};form.onsubmit=async e=>{e.preventDefault();const data={name:document.getElementById('name').value,type:document.getElementById('type').value,base_url:document.getElementById('base-url').value,api_key:document.getElementById('api-key').value,username:document.getElementById('username').value,password:document.getElementById('password').value,oauth2_client_id:document.getElementById('oauth2-client-id').value,oauth2_secret:document.getElementById('oauth2-secret').value,oauth2_token_url:document.getElementById('oauth2-token-url').value,oauth2_scope:document.getElementById('oauth2-scope').value,sync_interval_min:parseInt(document.getElementById('sync-interval').value,10),is_active:document.getElementById('is-active').checked};let url='/cmms/connections';let method='POST';if(editingId){url+='/'+editingId;method='PUT';}
const resp=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(resp.ok){showToast('Saved!');hideModal();loadConnections();}else{showToast('Error saving connection',true);}};async function loadConnections(){const resp=await fetch('/cmms/connections');if(!resp.ok)return;const{connections}=await resp.json();tableBody.innerHTML='';connections.forEach(conn=>{const tr=document.createElement('tr');tr.innerHTML=`
                <td>${conn.name}</td>
                <td>${conn.type}</td>
                <td>${conn.base_url}</td>
                <td>${getAuthMethod(conn)}</td>
                <td>${conn.sync_interval_min}</td>
                <td>${conn.last_sync ? new Date(conn.last_sync).toLocaleString() : ''}</td>
                <td>${conn.last_sync_status || ''}</td>
                <td>${conn.last_sync_error || ''}</td>
                <td>
                    <button class="btn btn-xs" onclick="window.editCMMS(${conn.id})">Edit</button>
                    <button class="btn btn-xs" onclick="window.deleteCMMS(${conn.id})">Delete</button>
                    <button class="btn btn-xs" onclick="window.testCMMS(${conn.id})">Test</button>
                    <button class="btn btn-xs" onclick="window.syncCMMS(${conn.id})">Sync Now</button>
                </td>
            `;tableBody.appendChild(tr);});}
window.editCMMS=async id=>{const resp=await fetch('/cmms/connections/'+id);if(!resp.ok)return showToast('Failed to load connection',true);const data=await resp.json();showModal(true,data);};window.deleteCMMS=async id=>{if(!confirm('Delete this connection?'))return;const resp=await fetch('/cmms/connections/'+id,{method:'DELETE'});if(resp.ok){showToast('Deleted');loadConnections();}else{showToast('Delete failed',true);}};window.testCMMS=async id=>{showToast('Testing...');const resp=await fetch(`/cmms/connections/${id}/test`,{method:'POST'});const data=await resp.json();if(data.success)showToast('Connection OK');else showToast('Test failed: '+(data.error||'Unknown error'),true);};window.syncCMMS=async id=>{showToast('Syncing...');const resp=await fetch(`/cmms/connections/${id}/sync`,{method:'POST'});const data=await resp.json();if(data.success)showToast('Sync started');else showToast('Sync failed: '+(data.error||'Unknown error'),true);};loadConnections();});
