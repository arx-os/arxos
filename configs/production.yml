# ArxOS Production Configuration
# This configuration uses PostGIS as primary database

# Core settings
mode: hybrid
version: "0.1.0"
environment: production
state_dir: "/data/.arxos"
cache_dir: "/data/.arxos/cache"

# PostGIS settings (Primary)
postgis:
  enabled: true
  host: "${POSTGIS_HOST}"
  port: ${POSTGIS_PORT:-5432}
  database: "${POSTGRES_DB}"
  user: "${POSTGRES_USER}"
  password: "${POSTGRES_PASSWORD}"
  ssl_mode: "${POSTGIS_SSL_MODE:-require}"

  # Spatial settings
  srid: 900913  # ArxOS Building Local coordinate system
  precision_mm: true  # Use millimeter precision

  # Connection pool
  max_connections: 100
  max_idle_conns: 10
  conn_max_lifetime: 1h

  # Performance
  enable_query_cache: true
  cache_ttl: 10m
  prepared_statements: true

# SQLite settings (Fallback - disabled in production)
sqlite:
  enabled: false
  path: "/data/.arxos/arxos.db"

# Database common settings
database:
  type: "${ARX_DB_TYPE:-postgis}"  # postgis only in production
  migrations_path: "/app/migrations"
  auto_migrate: true
  log_queries: false
  slow_query_threshold: 1s

# API Server settings
server:
  host: "${API_HOST:-0.0.0.0}"
  port: ${API_PORT:-8080}
  read_timeout: 30s
  write_timeout: 30s
  idle_timeout: 120s
  max_header_bytes: 1048576  # 1MB

  # Middleware
  enable_cors: true
  enable_gzip: true
  enable_rate_limit: true
  enable_request_id: true
  enable_recovery: true

  # Health checks
  health_check_path: "/health"
  ready_check_path: "/ready"
  metrics_path: "/metrics"

# Daemon settings
daemon:
  enabled: true
  watch_paths:
    - "/data/ifc"
    - "/data/imports"
  poll_interval: 30s
  auto_import: true
  auto_export: true
  max_workers: ${DAEMON_MAX_WORKERS:-8}

  # File processing
  supported_formats:
    - ifc
    - ifczip
    - ifcxml
  max_file_size_mb: 500

  # Export settings
  export_formats:
    - bim
    - csv
    - json
  export_path: "/data/exports"

# Security settings
security:
  jwt_secret: "${JWT_SECRET}"
  jwt_expiry: 1h
  session_timeout: 8h
  bcrypt_cost: 14  # Higher for production

  # Rate limiting
  rate_limit: 1000
  rate_limit_burst: 2000
  rate_limit_window: 1m

  # CORS
  allowed_origins:
    - "${FRONTEND_URL}"
    - "${API_URL}"
  allowed_methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowed_headers:
    - Content-Type
    - Authorization
    - X-Request-ID

  # TLS
  enable_tls: "${ARX_ENABLE_TLS:-true}"
  tls_cert_path: "${ARX_TLS_CERT_PATH:-/etc/ssl/certs/arxos.crt}"
  tls_key_path: "${ARX_TLS_KEY_PATH:-/etc/ssl/private/arxos.key}"

# Storage settings
storage:
  type: "${STORAGE_TYPE:-local}"
  local:
    base_path: "/data/storage"
    temp_path: "/tmp/arxos"

  # S3 (optional)
  s3:
    enabled: "${S3_ENABLED:-false}"
    bucket: "${S3_BUCKET}"
    region: "${AWS_REGION}"
    access_key: "${AWS_ACCESS_KEY_ID}"
    secret_key: "${AWS_SECRET_ACCESS_KEY}"
    endpoint: "${S3_ENDPOINT:-}"  # For S3-compatible services

# Cache settings
cache:
  type: "${CACHE_TYPE:-redis}"  # redis in production

  memory:
    max_size_mb: 512
    ttl: 30m
    cleanup_interval: 10m

  redis:
    enabled: true
    host: "${REDIS_HOST:-redis}"
    port: ${REDIS_PORT:-6379}
    password: "${REDIS_PASSWORD}"
    db: ${REDIS_DB:-0}
    ttl: 30m
    max_retries: 3
    pool_size: 10

# Logging
logging:
  level: "${ARX_LOG_LEVEL:-warn}"
  format: json  # json for production
  output: stdout
  file:
    enabled: true
    path: "/data/logs/arxos.log"
    max_size_mb: 500
    max_backups: 10
    max_age_days: 90
    compress: true

  # Log specific components
  components:
    database: warn
    api: info
    daemon: info
    converter: warn
    exporter: warn

# Monitoring
monitoring:
  metrics_enabled: true
  tracing_enabled: true
  profiling_enabled: false

  # Prometheus
  prometheus:
    enabled: true
    port: ${PROMETHEUS_PORT:-9090}
    path: "/metrics"

  # Jaeger
  jaeger:
    enabled: "${JAEGER_ENABLED:-true}"
    endpoint: "${JAEGER_ENDPOINT:-http://jaeger:14268/api/traces}"
    service_name: "arxos-prod"
    sample_rate: 0.1

  # Health monitoring
  health:
    liveness_probe: "/health/live"
    readiness_probe: "/health/ready"
    startup_probe: "/health/startup"

# Telemetry settings
telemetry:
  enabled: "${ARX_TELEMETRY:-true}"
  endpoint: "${TELEMETRY_ENDPOINT}"
  api_key: "${TELEMETRY_API_KEY}"
  sample_rate: 0.1
  batch_size: 100
  flush_interval: 30s

# Feature flags
features:
  # Core features
  enable_postgis: true
  enable_sqlite_fallback: false
  enable_hybrid_mode: false

  # Import/Export
  enable_ifc_import: true
  enable_bim_export: true
  enable_csv_export: true
  enable_json_export: true
  enable_pdf_export: "${ENABLE_PDF_EXPORT:-false}"

  # Advanced features
  enable_spatial_queries: true
  enable_version_control: true
  enable_conflict_resolution: true
  enable_compression: true

  # Production features
  enable_debug_endpoints: false
  enable_test_data: false
  enable_mock_mode: false

  # Beta features
  enable_ai_suggestions: "${ENABLE_AI:-false}"
  enable_cloud_sync: "${ENABLE_CLOUD_SYNC:-false}"
  enable_realtime_updates: "${ENABLE_REALTIME:-false}"

# Repository settings
repository:
  enable_versioning: true
  max_versions: 1000
  compression: true

  # Git-like features
  enable_branches: true
  enable_tags: true
  enable_merge: true
  default_branch: "main"

  # Cleanup
  auto_cleanup: true
  cleanup_after_days: 90
  keep_minimum_versions: 10

# Building/IFC settings
building:
  arxos_id_prefix: "${ARXOS_ID_PREFIX:-ARXOS}"
  max_building_size_mb: 1000
  max_floors: 500
  max_rooms_per_floor: 2000
  max_equipment_per_room: 1000

  # Spatial settings
  coordinate_precision_mm: 1
  area_precision_sqmm: 1
  volume_precision_cbmm: 1

# Performance tuning
performance:
  max_concurrent_imports: ${MAX_CONCURRENT_IMPORTS:-4}
  max_concurrent_exports: ${MAX_CONCURRENT_EXPORTS:-8}
  batch_size: 5000

  # Query optimization
  enable_query_cache: true
  query_cache_size: 1000
  prepared_statement_cache_size: 100

  # Worker pools
  worker_pool_size: ${WORKER_POOL_SIZE:-20}
  job_queue_size: 1000

  # Timeouts
  import_timeout: 30m
  export_timeout: 15m
  query_timeout: 60s

# Backup settings
backup:
  enabled: "${BACKUP_ENABLED:-true}"
  schedule: "${BACKUP_SCHEDULE:-0 2 * * *}"  # 2 AM daily
  retention_days: ${BACKUP_RETENTION_DAYS:-30}
  path: "/data/backups"

  # S3 backup (optional)
  s3:
    enabled: "${S3_BACKUP_ENABLED:-false}"
    bucket: "${S3_BACKUP_BUCKET}"
    prefix: "arxos-backups/"

# High availability
ha:
  enabled: "${HA_ENABLED:-false}"
  replicas: ${HA_REPLICAS:-3}

  # Load balancing
  load_balancer:
    type: "${LB_TYPE:-round_robin}"  # round_robin, least_conn, ip_hash
    health_check_interval: 10s
    health_check_timeout: 5s

  # Clustering
  cluster:
    enabled: "${CLUSTER_ENABLED:-false}"
    node_id: "${NODE_ID}"
    seeds: "${CLUSTER_SEEDS}"  # Comma-separated list

# Maintenance mode
maintenance:
  enabled: false
  message: "ArxOS is currently undergoing maintenance. Please try again later."
  allowed_ips:
    - "10.0.0.0/8"
    - "172.16.0.0/12"
    - "192.168.0.0/16"