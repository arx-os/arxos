let currentPage=1;let currentFilters={};document.addEventListener('DOMContentLoaded',function(){loadAuditLogs();const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-(30*24*60*60*1000));document.getElementById('dateFrom').value=thirtyDaysAgo.toISOString().split('T')[0];document.getElementById('dateTo').value=today.toISOString().split('T')[0];});function loadAuditLogs(){const filters=getCurrentFilters();const queryParams=new URLSearchParams({page:currentPage,page_size:20,...filters});fetch(`/api/audit-logs?${queryParams}`).then(response=>response.json()).then(data=>{displayAuditLogs(data.results);updatePagination(data);updateLogCount(data.total);}).catch(error=>{console.error('Error loading audit logs:',error);document.getElementById('auditLogsTable').innerHTML='<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">Error loading audit logs</td></tr>';});}
function getCurrentFilters(){const filters={};const objectType=document.getElementById('objectType').value;const action=document.getElementById('action').value;const dateFrom=document.getElementById('dateFrom').value;const dateTo=document.getElementById('dateTo').value;const userId=document.getElementById('userId').value;const assetId=document.getElementById('assetId').value;const buildingId=document.getElementById('buildingId').value;const ipAddress=document.getElementById('ipAddress').value;if(objectType)filters.object_type=objectType;if(action)filters.action=action;if(dateFrom)filters.date_from=dateFrom;if(dateTo)filters.date_to=dateTo;if(userId)filters.user_id=userId;if(assetId)filters.asset_id=assetId;if(buildingId)filters.building_id=buildingId;if(ipAddress)filters.ip_address=ipAddress;return filters;}
function displayAuditLogs(logs){const tbody=document.getElementById('auditLogsTable');if(logs.length===0){tbody.innerHTML='<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No audit logs found</td></tr>';return;}
tbody.innerHTML=logs.map(log=>`
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.user_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    ${getObjectTypeColor(log.object_type)}">
                    ${log.object_type}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${log.object_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    ${getActionColor(log.action)}">
                    ${log.action}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ip_address || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDate(log.created_at)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button onclick="showLogDetails('${log.id}')"
                        class="text-indigo-600 hover:text-indigo-900">
                    View Details
                </button>
            </td>
        </tr>
    `).join('');}
function getObjectTypeColor(objectType){switch(objectType){case'asset':return'bg-blue-100 text-blue-800';case'export':return'bg-green-100 text-green-800';case'user':return'bg-purple-100 text-purple-800';case'building':return'bg-yellow-100 text-yellow-800';default:return'bg-gray-100 text-gray-800';}}
function getActionColor(action){switch(action){case'create':return'bg-green-100 text-green-800';case'update':return'bg-blue-100 text-blue-800';case'delete':return'bg-red-100 text-red-800';case'export':return'bg-purple-100 text-purple-800';default:return'bg-gray-100 text-gray-800';}}
function formatDate(dateString){const date=new Date(dateString);return date.toLocaleString();}
function updatePagination(data){const totalPages=data.total_pages;const startRecord=((data.page-1)*data.page_size)+1;const endRecord=Math.min(data.page*data.page_size,data.total);document.getElementById('startRecord').textContent=startRecord;document.getElementById('endRecord').textContent=endRecord;document.getElementById('totalRecords').textContent=data.total;document.getElementById('pageInfo').textContent=`Page ${data.page} of ${totalPages}`;document.getElementById('prevBtn').disabled=data.page<=1;document.getElementById('nextBtn').disabled=data.page>=totalPages;if(data.page<=1){document.getElementById('prevBtn').classList.add('opacity-50','cursor-not-allowed');}else{document.getElementById('prevBtn').classList.remove('opacity-50','cursor-not-allowed');}
if(data.page>=totalPages){document.getElementById('nextBtn').classList.add('opacity-50','cursor-not-allowed');}else{document.getElementById('nextBtn').classList.remove('opacity-50','cursor-not-allowed');}}
function updateLogCount(total){document.getElementById('logCount').textContent=`Total: ${total} audit log entries`;}
function previousPage(){if(currentPage>1){currentPage--;loadAuditLogs();}}
function nextPage(){currentPage++;loadAuditLogs();}
function applyFilters(){currentPage=1;loadAuditLogs();}
function clearFilters(){document.getElementById('objectType').value='';document.getElementById('action').value='';document.getElementById('userId').value='';document.getElementById('assetId').value='';document.getElementById('buildingId').value='';document.getElementById('ipAddress').value='';const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-(30*24*60*60*1000));document.getElementById('dateFrom').value=thirtyDaysAgo.toISOString().split('T')[0];document.getElementById('dateTo').value=today.toISOString().split('T')[0];currentPage=1;loadAuditLogs();}
function exportLogs(){const format=document.getElementById('exportFormat').value;const filters=getCurrentFilters();const queryParams=new URLSearchParams({export:format,...filters});const link=document.createElement('a');link.href=`/api/audit-logs?${queryParams}`;link.download=`audit_logs_${new Date().toISOString().split('T')[0]}.${format}`;document.body.appendChild(link);link.click();document.body.removeChild(link);}
function showLogDetails(logId){fetch(`/api/audit-logs?object_id=${logId}`).then(response=>response.json()).then(data=>{if(data.results&&data.results.length>0){const log=data.results[0];displayLogDetails(log);document.getElementById('logDetailsModal').classList.remove('hidden');}}).catch(error=>{console.error('Error loading log details:',error);});}
function displayLogDetails(log){const content=document.getElementById('logDetailsContent');let fieldChangesHtml='';if(log.field_changes){try{const fieldChanges=JSON.parse(log.field_changes);if(Object.keys(fieldChanges).length>0){fieldChangesHtml=`
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-900">Field Changes:</h4>
                        <div class="mt-2 space-y-2">
                            ${Object.entries(fieldChanges).map(([field, change]) => `<div class="bg-gray-50 p-3 rounded"><div class="font-medium text-sm">${field}:</div><div class="text-sm text-gray-600"><div>Before:<span class="font-mono">${change.before||'null'}</span></div><div>After:<span class="font-mono">${change.after||'null'}</span></div></div></div>`).join('')}
                        </div>
                    </div>
                `;}}catch(e){console.error('Error parsing field changes:',e);}}
let payloadHtml='';if(log.payload){try{const payload=JSON.parse(log.payload);payloadHtml=`
                <div class="mt-4">
                    <h4 class="font-medium text-gray-900">Payload:</h4>
                    <pre class="mt-2 bg-gray-50 p-3 rounded text-sm overflow-x-auto">${JSON.stringify(payload, null, 2)}</pre>
                </div>
            `;}catch(e){console.error('Error parsing payload:',e);}}
content.innerHTML=`
        <div class="space-y-4">
            <div>
                <h4 class="font-medium text-gray-900">Basic Information</h4>
                <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                    <div><span class="font-medium">ID:</span> ${log.id}</div>
                    <div><span class="font-medium">User ID:</span> ${log.user_id}</div>
                    <div><span class="font-medium">Object Type:</span> ${log.object_type}</div>
                    <div><span class="font-medium">Object ID:</span> ${log.object_id}</div>
                    <div><span class="font-medium">Action:</span> ${log.action}</div>
                    <div><span class="font-medium">Timestamp:</span> ${formatDate(log.created_at)}</div>
                    <div><span class="font-medium">IP Address:</span> ${log.ip_address || 'N/A'}</div>
                    <div><span class="font-medium">User Agent:</span> ${log.user_agent || 'N/A'}</div>
                </div>
            </div>
            ${fieldChangesHtml}
            ${payloadHtml}
        </div>
    `;}
function closeLogDetails(){document.getElementById('logDetailsModal').classList.add('hidden');}
document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeLogDetails();}});document.getElementById('logDetailsModal').addEventListener('click',function(e){if(e.target===this){closeLogDetails();}});
