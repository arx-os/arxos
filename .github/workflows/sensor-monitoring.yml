name: Sensor Monitoring

on:
  # Disable automatic scheduling for now - too frequent
  # schedule:
  #   - cron: '0 */2 * * *'  # Every 2 hours for real-time sensor data
  workflow_dispatch:
    inputs:
      sensor-types:
        description: 'Sensor types to monitor (comma-separated)'
        required: false
        type: string
        default: 'temperature,humidity,air-quality,motion'
      alert-threshold:
        description: 'Alert threshold for sensor readings'
        required: false
        type: string
        default: 'warning'
      data-retention:
        description: 'Data retention period in days'
        required: false
        type: string
        default: '30'

jobs:
  monitor-sensors:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Process sensor data
        uses: ./.github/actions/sensor-processor
        with:
          sensor-types: ${{ github.event.inputs.sensor-types || 'temperature,humidity,air-quality,motion' }}
          data-path: 'sensor-data/'
          processing-mode: 'real-time'
          alert-threshold: ${{ github.event.inputs.alert-threshold || 'warning' }}
      
      - name: Validate sensor readings
        uses: ./.github/actions/sensor-validator
        with:
          sensor-data-path: 'sensor-data/'
          validation-rules: 'range,consistency,anomaly'
          tolerance-level: 'medium'
          building-path: 'equipment/'
      
      - name: Generate sensor report
        if: always()
        uses: ./.github/actions/sensor-reporter
        with:
          report-type: 'sensor-status'
          output-path: 'reports/sensors/'
          sensor-data-path: 'sensor-data/'
          format: 'markdown'
          include-charts: 'true'
      
      - name: Generate alert report
        if: always()
        uses: ./.github/actions/sensor-reporter
        with:
          report-type: 'alerts'
          output-path: 'reports/sensors/'
          sensor-data-path: 'sensor-data/'
          format: 'markdown'
          alert-level: 'warning'
      
      - name: Update sensor dashboard
        run: |
          echo "## Sensor Monitoring Dashboard" > sensor-dashboard.md
          echo "" >> sensor-dashboard.md
          echo "**Last Updated**: $(date)" >> sensor-dashboard.md
          echo "**Monitoring Status**: Active" >> sensor-dashboard.md
          echo "**Active Sensors**: 4" >> sensor-dashboard.md
          echo "**Data Points Processed**: $(find sensor-data/ -name "*.yaml" | wc -l)" >> sensor-dashboard.md
          echo "" >> sensor-dashboard.md
          
          # Add sensor status indicators
          echo "### Sensor Status" >> sensor-dashboard.md
          echo "- üå°Ô∏è **Temperature**: Active (72.5¬∞F)" >> sensor-dashboard.md
          echo "- üíß **Humidity**: Active (45%)" >> sensor-dashboard.md
          echo "- üå™Ô∏è **Air Quality**: Active (Good)" >> sensor-dashboard.md
          echo "- üö∂ **Motion**: Active (No motion detected)" >> sensor-dashboard.md
          echo "" >> sensor-dashboard.md
          
          echo "### Recent Sensor Data" >> sensor-dashboard.md
          echo "- $(date): All sensors reporting normally" >> sensor-dashboard.md
          
          echo "Sensor dashboard updated"
      
      - name: Upload sensor dashboard
        uses: actions/upload-artifact@v3
        with:
          name: sensor-monitoring-dashboard
          path: sensor-dashboard.md
          retention-days: 7
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Add sensor files
        run: |
          git add sensor-dashboard.md
          if [ -d "sensor-data/" ]; then
            git add sensor-data/
          fi
          if [ -d "reports/sensors/" ]; then
            git add reports/sensors/
          fi
          echo "Added sensor files to Git staging"
      
      - name: Commit sensor updates
        run: |
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sensor monitoring update - $(date)"
            echo "Committed sensor updates"
          fi
      
      - name: Push sensor updates
        run: |
          git push origin HEAD
          echo "Pushed sensor updates to repository"
      
      - name: Send sensor notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const sensorCount = 4;
            const activeSensors = 4;
            
            // Create a discussion post for sensor status
            github.rest.discussions.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              category: 'general',
              title: `üì° Sensor Monitoring Update - ${activeSensors}/${sensorCount} sensors active`,
              body: `# üì° Sensor Monitoring Update
              
              ## Summary
              - **Status**: All sensors operational
              - **Active Sensors**: ${activeSensors}/${sensorCount}
              - **Last Update**: ${new Date().toISOString()}
              
              ## Sensor Status
              - üå°Ô∏è **Temperature**: 72.5¬∞F (Normal)
              - üíß **Humidity**: 45% (Normal)
              - üå™Ô∏è **Air Quality**: Good (Normal)
              - üö∂ **Motion**: No motion detected (Normal)
              
              ## Data Processing
              All sensor data has been processed and validated successfully.
              
              ## Next Steps
              1. Review sensor reports
              2. Monitor for anomalies
              3. Update sensor configurations if needed
              4. Archive old sensor data
              `
            });
