name: Android Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'android/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'android/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-native:
    name: Build Android Native Library
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android
      
      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: '26.1.10909125'
          api-level: 21
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-android-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-android-cargo-
      
      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
      
      - name: Configure Android targets
        run: |
          # Set up Android NDK toolchain
          export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          
          # Configure cargo for Android builds
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          ar = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          
          [target.armv7-linux-androideabi]
          ar = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
          
          [target.i686-linux-android]
          ar = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang"
          
          [target.x86_64-linux-android]
          ar = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
          EOF
      
      - name: Build for Android ARM64
        run: cargo build --target aarch64-linux-android --release --lib
      
      - name: Build for Android ARMv7
        run: cargo build --target armv7-linux-androideabi --release --lib
      
      - name: Build for Android x86
        run: cargo build --target i686-linux-android --release --lib
      
      - name: Build for Android x86_64
        run: cargo build --target x86_64-linux-android --release --lib
      
      - name: Create JNI libraries directory structure
        run: |
          mkdir -p android/app/src/main/jniLibs/arm64-v8a
          mkdir -p android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p android/app/src/main/jniLibs/x86
          mkdir -p android/app/src/main/jniLibs/x86_64
      
      - name: Copy native libraries
        run: |
          cp target/aarch64-linux-android/release/libarxos.so android/app/src/main/jniLibs/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libarxos.so android/app/src/main/jniLibs/armeabi-v7a/
          cp target/i686-linux-android/release/libarxos.so android/app/src/main/jniLibs/x86/
          cp target/x86_64-linux-android/release/libarxos.so android/app/src/main/jniLibs/x86_64/
      
      - name: Upload native libraries
        uses: actions/upload-artifact@v3
        with:
          name: android-native-libs
          path: android/app/src/main/jniLibs/**/*.so
          retention-days: 30

  build-app:
    name: Build Android App
    runs-on: ubuntu-latest
    needs: build-native
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download native libraries
        uses: actions/download-artifact@v3
        with:
          name: android-native-libs
          path: android/app/src/main/jniLibs
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for Gradle wrapper
        run: chmod +x android/gradlew
      
      - name: Build debug APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --stacktrace
      
      - name: Build release AAB
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        run: |
          cd android
          ./gradlew bundleRelease --no-daemon --stacktrace
      
      - name: Upload debug APK
        uses: actions/upload-artifact@v3
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7
      
      - name: Upload release AAB
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v3
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload build reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: android-build-reports
          path: android/app/build/reports/**
          retention-days: 7
          if-no-files-found: ignore

