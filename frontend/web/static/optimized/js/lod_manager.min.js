class LODManager{constructor(options={}){this.lodLevels=options.lodLevels||{high:{minZoom:2.0,complexity:1.0,name:'High Detail'},medium:{minZoom:0.5,complexity:0.7,name:'Medium Detail'},low:{minZoom:0.1,complexity:0.4,name:'Low Detail'},minimal:{minZoom:0.0,complexity:0.2,name:'Minimal Detail'}};this.switchThreshold=options.switchThreshold||0.1;this.transitionDuration=options.transitionDuration||200;this.enableTransitions=options.enableTransitions!==false;this.currentLODLevel='medium';this.lastZoomLevel=1.0;this.switchingLOD=false;this.lodCache=new Map();this.symbolLODData=new Map();this.lodStats={totalSwitches:0,lastSwitchTime:0,averageSwitchTime:0,switchTimes:[]};this.eventHandlers=new Map();this.viewportManager=null;this.symbolScaler=null;this.initialize();}
initialize(){this.connectToViewportManager();this.connectToSymbolScaler();console.log('LODManager initialized');}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.viewportManager=window.viewportManager;console.log('LODManager connected to ViewportManager');this.viewportManager.addEventListener('zoomChanged',(data)=>{this.handleZoomChange(data.zoom);});this.viewportManager.addEventListener('viewReset',()=>{this.handleZoomChange(this.viewportManager.currentZoom);});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
connectToSymbolScaler(){const checkSymbolScaler=()=>{if(window.symbolScaler){this.symbolScaler=window.symbolScaler;console.log('LODManager connected to SymbolScaler');}else{setTimeout(checkSymbolScaler,100);}};checkSymbolScaler();}
handleZoomChange(zoomLevel){if(this.switchingLOD)return;const targetLOD=this.getLODLevelForZoom(zoomLevel);if(targetLOD!==this.currentLODLevel){this.switchLODLevel(targetLOD,zoomLevel);}
this.lastZoomLevel=zoomLevel;}
getLODLevelForZoom(zoomLevel){const levels=Object.keys(this.lodLevels).reverse();for(const level of levels){if(zoomLevel>=this.lodLevels[level].minZoom){return level;}}
return'minimal';}
switchLODLevel(newLevel,zoomLevel){if(this.switchingLOD||newLevel===this.currentLODLevel){return;}
this.switchingLOD=true;const startTime=performance.now();console.log(`LODManager: Switching from ${this.currentLODLevel} to ${newLevel} at zoom ${zoomLevel}`);this.updateAllSymbolsLOD(newLevel);this.currentLODLevel=newLevel;const switchTime=performance.now()-startTime;this.updateLODStats(switchTime);this.triggerEvent('lodChanged',{fromLevel:this.currentLODLevel,toLevel:newLevel,zoomLevel:zoomLevel,switchTime:switchTime});this.switchingLOD=false;}
updateAllSymbolsLOD(lodLevel){const symbols=document.querySelectorAll('.placed-symbol');const lodConfig=this.lodLevels[lodLevel];symbols.forEach(symbol=>{this.updateSymbolLOD(symbol,lodLevel,lodConfig);});}
updateSymbolLOD(symbolElement,lodLevel,lodConfig){if(!symbolElement)return;const symbolId=symbolElement.getAttribute('data-symbol-id');if(!symbolId)return;const lodData=this.getSymbolLODData(symbolId);if(!lodData)return;const svgContent=this.getLODSVG(lodData,lodLevel);if(!svgContent)return;this.updateSymbolSVG(symbolElement,svgContent,lodLevel,lodConfig);}
getSymbolLODData(symbolId){if(this.symbolLODData.has(symbolId)){return this.symbolLODData.get(symbolId);}
if(window.symbolLibrary){const symbol=window.symbolLibrary.symbols.find(s=>s.id===symbolId);if(symbol&&symbol.lodData){this.symbolLODData.set(symbolId,symbol.lodData);return symbol.lodData;}}
const defaultLODData=this.generateDefaultLODData(symbolId);this.symbolLODData.set(symbolId,defaultLODData);return defaultLODData;}
generateDefaultLODData(symbolId){const symbol=this.getSymbolById(symbolId);if(!symbol)return null;const originalSVG=symbol.svg||'';return{symbolId:symbolId,levels:{high:{svg:originalSVG,complexity:1.0,elementCount:this.countSVGElements(originalSVG)},medium:{svg:this.simplifySVG(originalSVG,0.7),complexity:0.7,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.7))},low:{svg:this.simplifySVG(originalSVG,0.4),complexity:0.4,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.4))},minimal:{svg:this.simplifySVG(originalSVG,0.2),complexity:0.2,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.2))}}};}
getSymbolById(symbolId){if(window.symbolLibrary){return window.symbolLibrary.symbols.find(s=>s.id===symbolId);}
return null;}
countSVGElements(svgContent){const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const svgElement=tempDiv.querySelector('svg');if(!svgElement)return 0;const elements=svgElement.querySelectorAll('path, rect, circle, ellipse, line, polyline, polygon, text');return elements.length;}
simplifySVG(svgContent,complexityFactor){const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const svgElement=tempDiv.querySelector('svg');if(!svgElement)return svgContent;const simplifiedSVG=svgElement.cloneNode(true);if(complexityFactor<0.5){const detailedElements=simplifiedSVG.querySelectorAll('text, path[d*="c"], path[d*="s"]');detailedElements.forEach(el=>el.remove());}
if(complexityFactor<0.3){const complexElements=simplifiedSVG.querySelectorAll('path:not([d*="M"]):not([d*="L"]), text, circle[r*="."]');complexElements.forEach(el=>el.remove());}
if(complexityFactor<0.2){const basicElements=simplifiedSVG.querySelectorAll('rect, circle, line');const allElements=simplifiedSVG.querySelectorAll('*');allElements.forEach(el=>{if(!basicElements.includes(el)&&el!==simplifiedSVG){el.remove();}});}
return simplifiedSVG.outerHTML;}
getLODSVG(lodData,lodLevel){if(!lodData||!lodData.levels||!lodData.levels[lodLevel]){return null;}
return lodData.levels[lodLevel].svg;}
updateSymbolSVG(symbolElement,svgContent,lodLevel,lodConfig){if(!symbolElement||!svgContent)return;const svgElement=symbolElement.querySelector('svg');if(!svgElement)return;const currentTransform=svgElement.getAttribute('transform')||'';const currentScale=symbolElement.getAttribute('data-scale')||'1';const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const newSVG=tempDiv.querySelector('svg');if(!newSVG)return;if(this.enableTransitions){svgElement.style.transition=`opacity ${this.transitionDuration}ms ease`;svgElement.style.opacity='0';setTimeout(()=>{svgElement.innerHTML=newSVG.innerHTML;svgElement.setAttribute('viewBox',newSVG.getAttribute('viewBox')||'0 0 20 20');svgElement.setAttribute('transform',currentTransform);svgElement.style.opacity='1';setTimeout(()=>{svgElement.style.transition='';},this.transitionDuration);},this.transitionDuration/2);}else{svgElement.innerHTML=newSVG.innerHTML;svgElement.setAttribute('viewBox',newSVG.getAttribute('viewBox')||'0 0 20 20');svgElement.setAttribute('transform',currentTransform);}
symbolElement.setAttribute('data-lod-level',lodLevel);symbolElement.setAttribute('data-lod-complexity',lodConfig.complexity);this.triggerEvent('symbolLODChanged',{symbolElement:symbolElement,lodLevel:lodLevel,complexity:lodConfig.complexity});}
updateLODStats(switchTime){this.lodStats.totalSwitches++;this.lodStats.lastSwitchTime=Date.now();this.lodStats.switchTimes.push(switchTime);if(this.lodStats.switchTimes.length>100){this.lodStats.switchTimes.shift();}
this.lodStats.averageSwitchTime=this.lodStats.switchTimes.reduce((a,b)=>a+b,0)/this.lodStats.switchTimes.length;}
getCurrentLODLevel(){return this.currentLODLevel;}
getLODConfig(){return{...this.lodLevels};}
setLODConfig(config){this.lodLevels={...config};console.log('LODManager: Configuration updated');}
forceLODLevel(level){if(!this.lodLevels[level]){console.warn(`LODManager: Invalid LOD level: ${level}`);return;}
this.switchLODLevel(level,this.lastZoomLevel);}
getLODStats(){return{...this.lodStats};}
clearLODCache(){this.lodCache.clear();this.symbolLODData.clear();console.log('LODManager: Cache cleared');}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in LOD manager event handler for ${event}:`,error);}});}}
setTransitionsEnabled(enabled){this.enableTransitions=enabled;console.log(`LODManager: Transitions ${enabled ? 'enabled' : 'disabled'}`);}
setTransitionDuration(duration){this.transitionDuration=duration;console.log(`LODManager: Transition duration set to ${duration}ms`);}
getPerformanceReport(){const report={currentLODLevel:this.currentLODLevel,totalSwitches:this.lodStats.totalSwitches,averageSwitchTime:this.lodStats.averageSwitchTime,lastSwitchTime:this.lodStats.lastSwitchTime,cacheSize:this.lodCache.size,symbolLODDataSize:this.symbolLODData.size,configuration:this.getLODConfig()};return report;}
destroy(){this.eventHandlers.clear();this.lodCache.clear();this.symbolLODData.clear();console.log('LODManager: Destroyed');}}
if(typeof module!=='undefined'&&module.exports){module.exports=LODManager;}else if(typeof window!=='undefined'){window.LODManager=LODManager;}
