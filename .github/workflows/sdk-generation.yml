name: SDK Generation and Publishing

on:
  push:
    branches: [main, develop]
    paths:
      - 'arx-docs/api/**'
      - 'sdk/**'
      - '.github/workflows/sdk-generation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'arx-docs/api/**'
      - 'sdk/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      service:
        description: 'Specific service to generate SDK for'
        required: false
        default: ''
      language:
        description: 'Specific language to generate SDK for'
        required: false
        default: ''

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  GO_VERSION: '1.21'
  JAVA_VERSION: '11'

jobs:
  validate-specs:
    name: Validate OpenAPI Specifications
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install OpenAPI tools
        run: |
          npm install -g @apidevtools/swagger-cli
          npm install -g @openapitools/openapi-generator-cli

      - name: Validate OpenAPI specs
        run: |
          echo "üîç Validating OpenAPI specifications..."

          # Validate all API specs
          for spec in arx-docs/api/*_api_spec.yaml; do
            if [ -f "$spec" ]; then
              echo "Validating $spec..."
              swagger-cli validate "$spec"
              if [ $? -eq 0 ]; then
                echo "‚úÖ $spec is valid"
              else
                echo "‚ùå $spec is invalid"
                exit 1
              fi
            fi
          done

          echo "üéâ All OpenAPI specifications are valid!"

  generate-sdks:
    name: Generate SDKs
    runs-on: ubuntu-latest
    needs: validate-specs
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."

          # Python dependencies
          pip install pyyaml jinja2 requests aiohttp pydantic

          # Node.js dependencies
          npm install -g @openapitools/openapi-generator-cli prettier

          # Go dependencies
          go install golang.org/x/tools/cmd/goimports@latest

          # Java dependencies
          # Maven is included with the Java setup

          echo "‚úÖ Dependencies installed"

      - name: Generate SDKs
        run: |
          echo "üöÄ Generating SDKs..."

          cd sdk

          # Generate based on workflow inputs
          if [ "${{ github.event.inputs.service }}" != "" ] && [ "${{ github.event.inputs.language }}" != "" ]; then
            echo "Generating ${{ github.event.inputs.language }} SDK for ${{ github.event.inputs.service }}..."
            python scripts/generate_sdks.py --service "${{ github.event.inputs.service }}" --language "${{ github.event.inputs.language }}"
          elif [ "${{ github.event.inputs.service }}" != "" ]; then
            echo "Generating all language SDKs for ${{ github.event.inputs.service }}..."
            python scripts/generate_sdks.py --service "${{ github.event.inputs.service }}"
          elif [ "${{ github.event.inputs.language }}" != "" ]; then
            echo "Generating ${{ github.event.inputs.language }} SDKs for all services..."
            python scripts/generate_sdks.py --language "${{ github.event.inputs.language }}"
          else
            echo "Generating all SDKs..."
            python scripts/generate_sdks.py
          fi

          echo "‚úÖ SDK generation completed"

      - name: Upload generated SDKs
        uses: actions/upload-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/
          retention-days: 7

  test-typescript:
    name: Test TypeScript SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx-backend, svgx-engine, arx-cmms, arx-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test TypeScript SDK
        run: |
          cd sdk/generated/typescript/${{ matrix.service }}

          echo "üß™ Testing TypeScript SDK for ${{ matrix.service }}..."

          # Check if directory exists
          if [ ! -d "sdk/generated/typescript/${{ matrix.service }}" ]; then
            echo "‚ö†Ô∏è SDK directory for ${{ matrix.service }} not found, skipping..."
            exit 0
          fi

          # Install dependencies
          npm install

          # Run tests
          npm test

          echo "‚úÖ TypeScript SDK tests passed for ${{ matrix.service }}"

  test-python:
    name: Test Python SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx_backend, svgx_engine, arx_cmms, arx_database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test Python SDK
        run: |
          cd sdk/generated/python/${{ matrix.service }}

          echo "üß™ Testing Python SDK for ${{ matrix.service }}..."

          # Install package
          pip install -e .

          # Run tests
          python -m pytest tests/ -v

          echo "‚úÖ Python SDK tests passed for ${{ matrix.service }}"

  test-go:
    name: Test Go SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx-backend, svgx-engine, arx-cmms, arx-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test Go SDK
        run: |
          cd sdk/generated/go/${{ matrix.service }}

          echo "üß™ Testing Go SDK for ${{ matrix.service }}..."

          # Initialize module
          go mod tidy

          # Run tests
          go test ./... -v

          echo "‚úÖ Go SDK tests passed for ${{ matrix.service }}"

  test-java:
    name: Test Java SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx-backend, svgx-engine, arx-cmms, arx-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test Java SDK
        run: |
          cd sdk/generated/java/${{ matrix.service }}

          echo "üß™ Testing Java SDK for ${{ matrix.service }}..."

          # Run tests
          mvn test

          echo "‚úÖ Java SDK tests passed for ${{ matrix.service }}"

  test-csharp:
    name: Test C# SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx-backend, svgx-engine, arx-cmms, arx-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test C# SDK
        run: |
          cd sdk/generated/csharp/${{ matrix.service }}

          echo "üß™ Testing C# SDK for ${{ matrix.service }}..."

          # Restore dependencies
          dotnet restore

          # Run tests
          dotnet test

          echo "‚úÖ C# SDK tests passed for ${{ matrix.service }}"

  test-php:
    name: Test PHP SDKs
    runs-on: ubuntu-latest
    needs: generate-sdks
    strategy:
      matrix:
        service: [arx-backend, svgx-engine, arx-cmms, arx-database]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pcre, session, simplexml, spl, standard, tokenizer, xmlreader, xmlwriter
          tools: composer

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Test PHP SDK
        run: |
          cd sdk/generated/php/${{ matrix.service }}

          echo "üß™ Testing PHP SDK for ${{ matrix.service }}..."

          # Install dependencies
          composer install

          # Run tests
          vendor/bin/phpunit

          echo "‚úÖ PHP SDK tests passed for ${{ matrix.service }}"

  build-packages:
    name: Build Packages
    runs-on: ubuntu-latest
    needs: [test-typescript, test-python, test-go, test-java, test-csharp, test-php]
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pcre, session, simplexml, spl, standard, tokenizer, xmlreader, xmlwriter
          tools: composer

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Build TypeScript packages
        run: |
          echo "üì¶ Building TypeScript packages..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/typescript/$service" ]; then
              cd sdk/generated/typescript/$service
              npm run build
              cd ../../../..
            fi
          done

      - name: Build Python packages
        run: |
          echo "üì¶ Building Python packages..."

          for service in arx_backend svgx_engine arx_cmms arx_database; do
            if [ -d "sdk/generated/python/$service" ]; then
              cd sdk/generated/python/$service
              python setup.py sdist bdist_wheel
              cd ../../../..
            fi
          done

      - name: Build Go packages
        run: |
          echo "üì¶ Building Go packages..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/go/$service" ]; then
              cd sdk/generated/go/$service
              go build ./...
              cd ../../../..
            fi
          done

      - name: Build Java packages
        run: |
          echo "üì¶ Building Java packages..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/java/$service" ]; then
              cd sdk/generated/java/$service
              mvn clean package
              cd ../../../..
            fi
          done

      - name: Build C# packages
        run: |
          echo "üì¶ Building C# packages..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/csharp/$service" ]; then
              cd sdk/generated/csharp/$service
              dotnet pack
              cd ../../../..
            fi
          done

      - name: Build PHP packages
        run: |
          echo "üì¶ Building PHP packages..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/php/$service" ]; then
              cd sdk/generated/php/$service
              composer install --no-dev --optimize-autoloader
              cd ../../../..
            fi
          done

      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/
          retention-days: 30

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: build-packages
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/

      - name: Publish TypeScript packages to npm
        run: |
          echo "üì§ Publishing TypeScript packages to npm..."

          # Validate token exists
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "‚ùå NPM_TOKEN not found"
            exit 1
          fi

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/typescript/$service" ]; then
              cd sdk/generated/typescript/$service
              npm publish --access public
              cd ../../../..
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build-packages
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/

      - name: Publish Python packages to PyPI
        run: |
          echo "üì§ Publishing Python packages to PyPI..."

          pip install twine

          for service in arx_backend svgx_engine arx_cmms arx_database; do
            if [ -d "sdk/generated/python/$service" ]; then
              cd sdk/generated/python/$service
              python -m twine upload dist/*
              cd ../../../..
            fi
          done
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}

  publish-maven:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: build-packages
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/

      - name: Publish Java packages to Maven Central
        run: |
          echo "üì§ Publishing Java packages to Maven Central..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/java/$service" ]; then
              cd sdk/generated/java/$service
              mvn deploy
              cd ../../../..
            fi
          done
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}

  publish-nuget:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: build-packages
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/

      - name: Publish C# packages to NuGet
        run: |
          echo "üì§ Publishing C# packages to NuGet..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/csharp/$service" ]; then
              cd sdk/generated/csharp/$service
              dotnet nuget push *.nupkg
              cd ../../../..
            fi
          done
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  publish-packagist:
    name: Publish to Packagist
    runs-on: ubuntu-latest
    needs: build-packages
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pcre, session, simplexml, spl, standard, tokenizer, xmlreader, xmlwriter
          tools: composer

      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          name: built-packages
          path: sdk/generated/

      - name: Publish PHP packages to Packagist
        run: |
          echo "üì§ Publishing PHP packages to Packagist..."

          for service in arx-backend svgx-engine arx-cmms arx-database; do
            if [ -d "sdk/generated/php/$service" ]; then
              cd sdk/generated/php/$service
              composer publish
              cd ../../../..
            fi
          done
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [test-typescript, test-python, test-go, test-java, test-csharp, test-php]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Download generated SDKs
        uses: actions/download-artifact@v4
        with:
          name: generated-sdks
          path: sdk/generated/

      - name: Generate documentation
        run: |
          echo "üìö Generating documentation..."

          cd sdk
          python scripts/generate_docs.py

          echo "‚úÖ Documentation generated"

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: sdk-documentation
          path: sdk/docs/
          retention-days: 30

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-pypi, publish-maven, publish-nuget, publish-packagist, generate-docs]
    if: always() && needs.publish-npm.result == 'success'
    steps:
      - name: Notify success
        run: |
          echo "üéâ SDK generation and publishing completed successfully!"
          echo "Published packages:"
          echo "- npm: @arxos/*"
          echo "- PyPI: arxos-*"
          echo "- Maven Central: com.arxos:*"
          echo "- NuGet: Arxos.*"
          echo "- Packagist: arxos/*"

  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-pypi, publish-maven, publish-nuget, publish-packagist]
    if: always() && needs.publish-npm.result == 'failure'
    steps:
      - name: Notify failure
        run: |
          echo "‚ùå SDK generation and publishing failed!"
          echo "Please check the logs for details."
