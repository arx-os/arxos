class ConnectorManager{constructor(){this.connectors=[];this.currentFloorId=null;this.filters={floor_id:null,system:null,connector_type:null,connection_status:null,status:null,search:null};this.init();}
init(){this.setupEventListeners();this.loadConnectors();}
setupEventListeners(){const floorFilter=document.getElementById('connector-floor-filter');if(floorFilter){floorFilter.addEventListener('change',(e)=>{this.filters.floor_id=e.target.value||null;this.loadConnectors();});}
const systemFilter=document.getElementById('connector-system-filter');if(systemFilter){systemFilter.addEventListener('change',(e)=>{this.filters.system=e.target.value||null;this.loadConnectors();});}
const typeFilter=document.getElementById('connector-type-filter');if(typeFilter){typeFilter.addEventListener('change',(e)=>{this.filters.connector_type=e.target.value||null;this.loadConnectors();});}
const searchFilter=document.getElementById('connector-search-filter');if(searchFilter){searchFilter.addEventListener('input',(e)=>{this.filters.search=e.target.value||null;this.loadConnectors();});}
const createBtn=document.getElementById('create-connector-btn');if(createBtn){createBtn.addEventListener('click',()=>this.showCreateConnectorModal());}
const bulkFloorBtn=document.getElementById('bulk-floor-assign-btn');if(bulkFloorBtn){bulkFloorBtn.addEventListener('click',()=>this.showBulkFloorAssignment());}}
async loadConnectors(){try{const params=new URLSearchParams();Object.entries(this.filters).forEach(([key,value])=>{if(value)params.append(key,value);});const response=await fetch(`/api/connectors?${params.toString()}`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const data=await response.json();this.connectors=data.results||[];this.renderConnectorList();this.updateConnectorStats();}else{console.error('Failed to load connectors:',response.statusText);this.showNotification('Failed to load connectors','error');}}catch(error){console.error('Error loading connectors:',error);this.showNotification('Error loading connectors','error');}}
renderConnectorList(){const container=document.getElementById('connector-list');if(!container)return;if(this.connectors.length===0){container.innerHTML=`
                <div class="text-center py-8 text-gray-500">
                    <p>No connectors found</p>
                    <button onclick="connectorManager.showCreateConnectorModal()" 
                            class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Create First Connector
                    </button>
                </div>
            `;return;}
const grouped=this.groupConnectorsByFloor();let html='';for(const[floorName,connectors]of Object.entries(grouped)){html+=`<div class="mb-6">
                <div class="text-lg font-bold text-blue-700 mb-2 flex items-center">
                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">${floorName}</span>
                    <span class="text-xs text-gray-400">(${connectors.length} connector${connectors.length !== 1 ? 's' : ''})</span>
                </div>
                <div>`;html+=connectors.map(connector=>`
                    <div class="connector-item bg-white border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                        ${connector.name}
                                        <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded bg-blue-50 text-blue-700 border border-blue-200">${connector.floor?.name || 'N/A'}</span>
                                    </h3>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${this.getStatusColor(connector.status)}">
                                        ${connector.status}
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                    <div><span class="font-medium">Type:</span> ${connector.connector_type || 'N/A'}</div>
                                    <div><span class="font-medium">System:</span> ${connector.system || 'N/A'}</div>
                                    <div><span class="font-medium">Connection:</span> ${connector.connection_type || 'N/A'}</div>
                                    <div><span class="font-medium">Status:</span> ${connector.connection_status || 'N/A'}</div>
                                    <div><span class="font-medium">Floor:</span> ${connector.floor?.name || 'N/A'}</div>
                                    <div><span class="font-medium">Capacity:</span> ${connector.current_load || 0}/${connector.max_capacity || '\u221e'}</div>
                                </div>
                                ${connector.description ? `<div class="mt-2 text-sm text-gray-500">${connector.description}</div>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="connectorManager.editConnector('${connector.object_id}')" class="bg-blue-500 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded">Edit</button>
                                <button onclick="connectorManager.deleteConnector('${connector.object_id}')" class="bg-red-500 hover:bg-red-700 text-white text-sm px-3 py-1 rounded">Delete</button>
                            </div>
                        </div>
                    </div>
            `).join('');html+=`</div></div>`;}
container.innerHTML=html;}
getStatusColor(status){switch(status){case'active':return'bg-green-100 text-green-800';case'inactive':return'bg-gray-100 text-gray-800';case'maintenance':return'bg-yellow-100 text-yellow-800';case'retired':return'bg-red-100 text-red-800';default:return'bg-gray-100 text-gray-800';}}
updateConnectorStats(){const statsContainer=document.getElementById('connector-stats');if(!statsContainer)return;const total=this.connectors.length;const active=this.connectors.filter(c=>c.status==='active').length;const connected=this.connectors.filter(c=>c.connection_status==='connected').length;const byFloor=this.groupConnectorsByFloor();statsContainer.innerHTML=`
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${total}</div>
                    <div class="text-sm text-blue-600">Total Connectors</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${active}</div>
                    <div class="text-sm text-green-600">Active</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">${connected}</div>
                    <div class="text-sm text-purple-600">Connected</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600">${Object.keys(byFloor).length}</div>
                    <div class="text-sm text-orange-600">Floors</div>
                </div>
            </div>
        `;}
groupConnectorsByFloor(){return this.connectors.reduce((groups,connector)=>{const floorName=connector.floor?.name||'Unknown Floor';if(!groups[floorName]){groups[floorName]=[];}
groups[floorName].push(connector);return groups;},{});}
showCreateConnectorModal(){const modal=document.getElementById('create-connector-modal');if(modal){modal.classList.remove('hidden');this.loadFloorsForModal();}}
hideCreateConnectorModal(){const modal=document.getElementById('create-connector-modal');if(modal){modal.classList.add('hidden');}}
async loadFloorsForModal(){try{const response=await fetch('/api/buildings/1/floors',{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();const floorSelect=document.getElementById('new-connector-floor');if(floorSelect){floorSelect.innerHTML='<option value="">-- Select Floor --</option>'+
floors.map(floor=>`<option value="${floor.id}">${floor.name}</option>`).join('');}}}catch(error){console.error('Error loading floors:',error);}}
async createConnector(formData){try{const response=await fetch('/api/connectors',{method:'POST',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){const connector=await response.json();this.showNotification('Connector created successfully','success');this.hideCreateConnectorModal();this.loadConnectors();return connector;}else{const error=await response.json();this.showNotification(`Failed to create connector: ${error.message}`,'error');return null;}}catch(error){console.error('Error creating connector:',error);this.showNotification('Error creating connector','error');return null;}}
async editConnector(connectorId){try{const response=await fetch(`/api/connectors/${connectorId}`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const connector=await response.json();this.showEditConnectorModal(connector);}else{this.showNotification('Failed to load connector details','error');}}catch(error){console.error('Error loading connector:',error);this.showNotification('Error loading connector','error');}}
showEditConnectorModal(connector){const modal=document.getElementById('edit-connector-modal');if(modal){document.getElementById('edit-connector-name').value=connector.name||'';document.getElementById('edit-connector-floor').value=connector.floor_id||'';document.getElementById('edit-connector-type').value=connector.connector_type||'';document.getElementById('edit-connection-type').value=connector.connection_type||'';document.getElementById('edit-connection-status').value=connector.connection_status||'';document.getElementById('edit-max-capacity').value=connector.max_capacity||'';document.getElementById('edit-current-load').value=connector.current_load||'';document.getElementById('edit-connector-description').value=connector.description||'';modal.setAttribute('data-connector-id',connector.object_id);modal.classList.remove('hidden');}}
async updateConnector(connectorId,formData){try{const response=await fetch(`/api/connectors/${connectorId}`,{method:'PUT',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){this.showNotification('Connector updated successfully','success');this.hideEditConnectorModal();this.loadConnectors();return true;}else{const error=await response.json();this.showNotification(`Failed to update connector: ${error.message}`,'error');return false;}}catch(error){console.error('Error updating connector:',error);this.showNotification('Error updating connector','error');return false;}}
async deleteConnector(connectorId){if(!confirm('Are you sure you want to delete this connector?')){return;}
try{const response=await fetch(`/api/connectors/${connectorId}`,{method:'DELETE',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){this.showNotification('Connector deleted successfully','success');this.loadConnectors();}else{this.showNotification('Failed to delete connector','error');}}catch(error){console.error('Error deleting connector:',error);this.showNotification('Error deleting connector','error');}}
showBulkFloorAssignment(){const modal=document.getElementById('bulk-floor-assignment-modal');if(modal){modal.classList.remove('hidden');this.loadFloorsForBulkAssignment();}}
async loadFloorsForBulkAssignment(){try{const response=await fetch('/api/buildings/1/floors',{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();const floorSelect=document.getElementById('bulk-assignment-floor');if(floorSelect){floorSelect.innerHTML='<option value="">-- Select Floor --</option>'+
floors.map(floor=>`<option value="${floor.id}">${floor.name}</option>`).join('');}}}catch(error){console.error('Error loading floors for bulk assignment:',error);}}
async assignConnectorsToFloor(connectorIds,floorId){try{const promises=connectorIds.map(connectorId=>fetch(`/api/connectors/${connectorId}`,{method:'PUT',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify({floor_id:parseInt(floorId)})}));const results=await Promise.allSettled(promises);const successful=results.filter(result=>result.status==='fulfilled'&&result.value.ok).length;const failed=results.length-successful;if(successful>0){this.showNotification(`Successfully assigned ${successful} connectors to floor`,'success');if(failed>0){this.showNotification(`${failed} connectors failed to update`,'warning');}
this.loadConnectors();}else{this.showNotification('Failed to assign connectors to floor','error');}}catch(error){console.error('Error in bulk floor assignment:',error);this.showNotification('Error assigning connectors to floor','error');}}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            type === 'warning' ? 'bg-yellow-500 text-white' :
            'bg-blue-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},3000);}
hideEditConnectorModal(){const modal=document.getElementById('edit-connector-modal');if(modal){modal.classList.add('hidden');}}}
document.addEventListener('DOMContentLoaded',()=>{window.connectorManager=new ConnectorManager();});