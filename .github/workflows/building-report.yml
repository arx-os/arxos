name: Weekly Building Report

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      report-type:
        description: 'Type of report to generate'
        required: false
        type: string
        default: 'comprehensive'
      format:
        description: 'Report format'
        required: false
        type: string
        default: 'markdown'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      BUILDING_DATA_PATH: ${{ vars.BUILDING_DATA_PATH || 'building-data' }}
      REPORTS_PATH: ${{ vars.REPORTS_PATH || 'reports' }}
      DEFAULT_FORMAT: ${{ vars.DEFAULT_FORMAT || 'markdown' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate comprehensive building report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          report-type: ${{ github.event.inputs.report-type || 'summary' }}
          output-format: ${{ github.event.inputs.format || env.DEFAULT_FORMAT }}
          commit-report: 'false'
      
      - name: Generate energy report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          report-type: 'energy'
          output-format: ${{ env.DEFAULT_FORMAT }}
          commit-report: 'false'
      
      - name: Generate equipment report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          report-type: 'equipment'
          output-format: ${{ env.DEFAULT_FORMAT }}
          commit-report: 'false'
      
      - name: Generate status report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          report-type: 'status'
          output-format: ${{ env.DEFAULT_FORMAT }}
          commit-report: 'false'
      
      - name: Monitor equipment status
        uses: ./.github/actions/equipment-monitor
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          alert-thresholds: '{"temperature": {"min": 15, "max": 25}, "humidity": {"min": 30, "max": 70}}'
          create-issues: 'true'
          dry-run: 'false'
      
      - name: Validate spatial data
        uses: ./.github/actions/spatial-validator
        with:
          data-path: ${{ env.BUILDING_DATA_PATH }}
          tolerance: '0.1'
          check-coordinate-systems: 'true'
          check-universal-paths: 'true'
          fail-on-errors: 'false'
      
      - name: Generate executive summary
        run: |
          echo "# Weekly Building Report - Executive Summary" > executive-summary.md
          echo "" >> executive-summary.md
          echo "**Report Date**: $(date)" >> executive-summary.md
          echo "**Report Period**: Weekly" >> executive-summary.md
          echo "" >> executive-summary.md
          
          echo "## Key Metrics" >> executive-summary.md
          echo "- **Equipment Count**: N/A" >> executive-summary.md
          echo "- **Monitoring Status**: Completed" >> executive-summary.md
          echo "- **Validation Status**: Completed" >> executive-summary.md
          echo "- **Critical Issues**: N/A" >> executive-summary.md
          echo "- **Warning Issues**: N/A" >> executive-summary.md
          echo "" >> executive-summary.md
          
          echo "## Report Sections" >> executive-summary.md
          echo "1. **Comprehensive Report**: Generated" >> executive-summary.md
          echo "2. **Energy Report**: Generated" >> executive-summary.md
          echo "3. **Maintenance Report**: Generated" >> executive-summary.md
          echo "4. **Spatial Report**: Generated" >> executive-summary.md
          echo "" >> executive-summary.md
          
          echo "## Recommendations" >> executive-summary.md
          echo "- üìä **Regular Monitoring**: Continue equipment monitoring" >> executive-summary.md
          echo "- üîß **Maintenance**: Schedule regular maintenance checks" >> executive-summary.md
          echo "- üìà **Performance**: Monitor energy efficiency metrics" >> executive-summary.md
          
          echo "" >> executive-summary.md
          echo "## Next Steps" >> executive-summary.md
          echo "1. Review detailed reports in the reports/ directory" >> executive-summary.md
          echo "2. Address any critical or warning issues" >> executive-summary.md
          echo "3. Schedule maintenance as needed" >> executive-summary.md
          echo "4. Update equipment status and documentation" >> executive-summary.md
          
          echo "Executive summary generated"
      
      - name: Upload all reports
        uses: actions/upload-artifact@v3
        with:
          name: weekly-building-reports
          path: |
            reports/
            executive-summary.md
          retention-days: 30
      
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Add report files
        run: |
          git add reports/
          git add executive-summary.md
          echo "Added report files to Git staging"
      
      - name: Commit report files
        run: |
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Weekly building report - $(date +%Y-%m-%d)"
            echo "Committed report files"
          fi
      
      - name: Push report files
        run: |
          git push origin HEAD
          echo "Pushed report files to repository"
      
      - name: Create weekly report issue
        uses: actions/github-script@v6
        with:
          script: |
            const equipmentCount = 'N/A';
            const monitoringStatus = 'Completed';
            const validationStatus = 'Completed';
            const criticalCount = 'N/A';
            const warningsCount = 'N/A';
            
            let title = `Weekly Building Report - ${new Date().toLocaleDateString()}`;
            let statusIcon = 'üìä';
            
            if (monitoringStatus === 'critical') {
              statusIcon = 'üö®';
              title = `üö® Weekly Building Report - ${criticalCount} Critical Issues`;
            } else if (monitoringStatus === 'warning') {
              statusIcon = '‚ö†Ô∏è';
              title = `‚ö†Ô∏è Weekly Building Report - ${warningsCount} Warnings`;
            }
            
            let body = `# ${statusIcon} Weekly Building Report\n\n`;
            body += `**Report Date**: ${new Date().toLocaleDateString()}\n`;
            body += `**Report Period**: Weekly\n\n`;
            
            body += `## Key Metrics\n`;
            body += `- Equipment Count: ${equipmentCount}\n`;
            body += `- Monitoring Status: ${monitoringStatus}\n`;
            body += `- Validation Status: ${validationStatus}\n`;
            body += `- Critical Issues: ${criticalCount}\n`;
            body += `- Warning Issues: ${warningsCount}\n\n`;
            
            body += `## Report Sections\n`;
            body += `1. **Comprehensive Report**: Generated\n`;
            body += `2. **Energy Report**: Generated\n`;
            body += `3. **Maintenance Report**: Generated\n`;
            body += `4. **Spatial Report**: Generated\n\n`;
            
            body += `## Recommendations\n`;
            if (monitoringStatus === 'critical') {
              body += `- üö® **Immediate Action Required**: Address critical equipment issues\n`;
            } else if (monitoringStatus === 'warning') {
              body += `- ‚ö†Ô∏è **Attention Needed**: Review warning-level equipment issues\n`;
            } else {
              body += `- ‚úÖ **All Systems Operational**: Continue regular maintenance schedule\n`;
            }
            
            if (validationStatus === 'failed') {
              body += `- üîß **Spatial Data Issues**: Resolve validation failures\n`;
            }
            
            body += `\n## Next Steps\n`;
            body += `1. Review detailed reports in the reports/ directory\n`;
            body += `2. Address any critical or warning issues\n`;
            body += `3. Schedule maintenance as needed\n`;
            body += `4. Update equipment status and documentation\n`;
            
      - name: Monitor workflow status
        if: always()
        uses: ./.github/actions/workflow-monitor
        with:
          workflow-name: "Weekly Building Report"
          workflow-status: ${{ job.status }}
          failure-reason: ${{ steps.generate-report.outputs.error || 'Building report generation failed' }}
          notification-webhook: ${{ secrets.WORKFLOW_FAILURE_WEBHOOK }}
          create-issue: 'true'
          issue-labels: 'building-report,workflow-failure'
