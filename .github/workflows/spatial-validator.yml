name: Spatial Validator Action

on:
  workflow_call:
    inputs:
      building-path:
        description: 'Path to building data directory'
        required: false
        type: string
        default: 'equipment/'
      validation-level:
        description: 'Validation level (basic, standard, strict)'
        required: false
        type: string
        default: 'standard'
      coordinate-system:
        description: 'Expected coordinate system'
        required: false
        type: string
        default: 'building_local'
      tolerance:
        description: 'Spatial tolerance for validation'
        required: false
        type: string
        default: '0.1'

jobs:
  validate-spatial:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build ArxOS CLI
        run: |
          cargo build --release
          echo "ArxOS CLI built successfully"
      
      - name: Verify building data exists
        run: |
          if [ ! -d "${{ inputs.building-path }}" ]; then
            echo "Error: Building data directory '${{ inputs.building-path }}' not found"
            exit 1
          fi
          
          # Check if there are any YAML files
          if [ -z "$(find "${{ inputs.building-path }}" -name "*.yml" -o -name "*.yaml")" ]; then
            echo "Error: No YAML files found in '${{ inputs.building-path }}'"
            exit 1
          fi
          
          echo "Building data directory verified: ${{ inputs.building-path }}"
      
      - name: Validate spatial coordinates
        id: validate-coordinates
        run: |
          echo "Validating spatial coordinates..."
          
          issues=0
          warnings=0
          
          # Validate each YAML file
          for file in $(find "${{ inputs.building-path }}" -name "*.yml" -o -name "*.yaml"); do
            echo "Validating coordinates in: $file"
            
            # Extract position data using ArxOS CLI
            if ./target/release/arxos validate --spatial --file "$file" --coordinate-system "${{ inputs.coordinate-system }}" --tolerance "${{ inputs.tolerance }}"; then
              echo "✓ Coordinates valid in $file"
            else
              echo "✗ Coordinate validation failed in $file"
              ((issues++))
            fi
          done
          
          echo "coordinate-issues=$issues" >> $GITHUB_OUTPUT
          echo "Coordinate validation completed with $issues issues"
      
      - name: Validate universal paths
        id: validate-paths
        run: |
          echo "Validating universal paths..."
          
          issues=0
          warnings=0
          
          # Validate path structure
          for file in $(find "${{ inputs.building-path }}" -name "*.yml" -o -name "*.yaml"); do
            echo "Validating paths in: $file"
            
            if ./target/release/arxos validate --paths --file "$file"; then
              echo "✓ Paths valid in $file"
            else
              echo "✗ Path validation failed in $file"
              ((issues++))
            fi
          done
          
          echo "path-issues=$issues" >> $GITHUB_OUTPUT
          echo "Path validation completed with $issues issues"
      
      - name: Validate equipment placement
        id: validate-placement
        run: |
          echo "Validating equipment placement..."
          
          issues=0
          warnings=0
          
          # Check for overlapping equipment
          if ./target/release/arxos validate --placement --path "${{ inputs.building-path }}" --tolerance "${{ inputs.tolerance }}"; then
            echo "✓ No overlapping equipment found"
          else
            echo "✗ Equipment placement conflicts detected"
            ((issues++))
          fi
          
          # Check for equipment outside building bounds
          if ./target/release/arxos validate --bounds --path "${{ inputs.building-path }}"; then
            echo "✓ All equipment within building bounds"
          else
            echo "⚠ Equipment outside building bounds detected"
            ((warnings++))
          fi
          
          echo "placement-issues=$issues" >> $GITHUB_OUTPUT
          echo "placement-warnings=$warnings" >> $GITHUB_OUTPUT
          echo "Equipment placement validation completed with $issues issues and $warnings warnings"
      
      - name: Validate spatial relationships
        id: validate-relationships
        run: |
          echo "Validating spatial relationships..."
          
          issues=0
          warnings=0
          
          # Validate room-equipment relationships
          if ./target/release/arxos validate --relationships --path "${{ inputs.building-path }}"; then
            echo "✓ Spatial relationships valid"
          else
            echo "✗ Spatial relationship validation failed"
            ((issues++))
          fi
          
          # Check for orphaned equipment
          orphaned_count=$(./target/release/arxos validate --orphaned --path "${{ inputs.building-path }}" --count-only)
          if [ "$orphaned_count" -gt 0 ]; then
            echo "⚠ Found $orphaned_count orphaned equipment items"
            ((warnings++))
          fi
          
          echo "relationship-issues=$issues" >> $GITHUB_OUTPUT
          echo "relationship-warnings=$warnings" >> $GITHUB_OUTPUT
          echo "Spatial relationship validation completed with $issues issues and $warnings warnings"
      
      - name: Generate validation summary
        id: validate
        run: |
          # Calculate totals
          total_issues=$(({{ steps.validate-coordinates.outputs.coordinate-issues }} + {{ steps.validate-paths.outputs.path-issues }} + {{ steps.validate-placement.outputs.placement-issues }} + {{ steps.validate-relationships.outputs.relationship-issues }}))
          total_warnings=$(({{ steps.validate-placement.outputs.placement-warnings }} + {{ steps.validate-relationships.outputs.relationship-warnings }}))
          
          # Determine overall status
          if [ $total_issues -eq 0 ]; then
            if [ $total_warnings -eq 0 ]; then
              status="passed"
            else
              status="warnings"
            fi
          else
            status="failed"
          fi
          
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "issues-count=$total_issues" >> $GITHUB_OUTPUT
          echo "warnings-count=$total_warnings" >> $GITHUB_OUTPUT
          
          echo "Validation Summary:"
          echo "- Status: $status"
          echo "- Issues: $total_issues"
          echo "- Warnings: $total_warnings"
      
      - name: Generate validation report
        run: |
          echo "## Spatial Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "- **Building Path**: ${{ inputs.building-path }}" >> validation-report.md
          echo "- **Validation Level**: ${{ inputs.validation-level }}" >> validation-report.md
          echo "- **Coordinate System**: ${{ inputs.coordinate-system }}" >> validation-report.md
          echo "- **Tolerance**: ${{ inputs.tolerance }}" >> validation-report.md
          echo "- **Overall Status**: ${{ steps.validate.outputs.validation-status }}" >> validation-report.md
          echo "- **Issues Found**: ${{ steps.validate.outputs.issues-count }}" >> validation-report.md
          echo "- **Warnings Found**: ${{ steps.validate.outputs.warnings-count }}" >> validation-report.md
          echo "- **Validation Time**: $(date)" >> validation-report.md
          echo "" >> validation-report.md
          
          echo "### Validation Details:" >> validation-report.md
          echo "- **Coordinate Issues**: ${{ steps.validate-coordinates.outputs.coordinate-issues }}" >> validation-report.md
          echo "- **Path Issues**: ${{ steps.validate-paths.outputs.path-issues }}" >> validation-report.md
          echo "- **Placement Issues**: ${{ steps.validate-placement.outputs.placement-issues }}" >> validation-report.md
          echo "- **Relationship Issues**: ${{ steps.validate-relationships.outputs.relationship-issues }}" >> validation-report.md
          echo "" >> validation-report.md
          
          echo "Validation report generated"
      
      - name: Upload validation report
        uses: actions/upload-artifact@v3
        with:
          name: spatial-validation-report
          path: validation-report.md
          retention-days: 30
      
      - name: Create validation issue
        if: steps.validate.outputs.validation-status == 'failed'
        uses: actions/github-script@v6
        with:
          script: |
            const issues = ${{ steps.validate.outputs.issues-count }};
            const warnings = ${{ steps.validate.outputs.warnings-count }};
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Spatial Validation Failed - ${issues} issues, ${warnings} warnings`,
              body: `# Spatial Validation Failed
              
              ## Summary
              - **Status**: Failed
              - **Issues**: ${issues}
              - **Warnings**: ${warnings}
              - **Validation Time**: ${new Date().toISOString()}
              
              ## Details
              Please review the validation report and fix the identified issues.
              
              ## Next Steps
              1. Review the validation report
              2. Fix identified issues
              3. Re-run validation
              `,
              labels: ['validation', 'spatial', 'bug']
            });
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ steps.validate.outputs.validation-status }}';
            const issues = ${{ steps.validate.outputs.issues-count }};
            const warnings = ${{ steps.validate.outputs.warnings-count }}';
            
            let comment = `## Spatial Validation Results\n\n`;
            
            if (status === 'passed') {
              comment += `✅ **Validation Passed** - No issues found\n`;
            } else if (status === 'warnings') {
              comment += `⚠️ **Validation Passed with Warnings** - ${warnings} warnings found\n`;
            } else {
              comment += `❌ **Validation Failed** - ${issues} issues, ${warnings} warnings\n`;
            }
            
            comment += `\n- Issues: ${issues}\n`;
            comment += `- Warnings: ${warnings}\n`;
            comment += `- Validation Time: ${new Date().toISOString()}\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
