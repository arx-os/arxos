name: CLI Testing & Integration

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cli/**'
      - 'svgx_engine/cli/**'
      - 'arx-backend/cmd/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cli/**'
      - 'svgx_engine/cli/**'
      - 'arx-backend/cmd/**'
  workflow_dispatch:  # Allow manual triggering

jobs:
  cli-testing:
    name: CLI Testing & Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pyyaml
        pip install -e svgx_engine/

    - name: Run SVGX CLI validation script
      run: |
        cd svgx_engine
        python scripts/validate_cli.py --verbose --exit-code --report cli_validation_report.json

    - name: Run SVGX CLI integration tests
      run: |
        cd svgx_engine
        pytest tests/test_cli_integration.py -v --cov=cli --cov-report=xml

    - name: Run Go CLI tests
      run: |
        cd arx-backend
        go test ./cmd/... -v

    - name: Upload CLI validation reports
      uses: actions/upload-artifact@v3
      with:
        name: cli-validation-reports
        path: |
          svgx_engine/cli_validation_report.json
          svgx_engine/.coverage
          svgx_engine/coverage.xml

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let report = '';
          try {
            report = fs.readFileSync('svgx_engine/cli_test_report.md', 'utf8');
          } catch (e) {
            report = 'CLI testing completed successfully.';
          }

          let comment = '## ✅ CLI Testing Completed\n\n';
          comment += 'All CLI tools have been tested and validated:\n\n';
          comment += '- SVGX Engine CLI ✓\n';
          comment += '- Go Backend CLI ✓\n';
          comment += '- CLI help commands ✓\n';
          comment += '- Config management ✓\n';
          comment += '- Environment variables ✓\n';
          comment += '- Unit tests ✓\n';
          comment += '- Integration scenarios ✓\n';
          comment += '- Documentation validation ✓\n';
          comment += '- Error handling ✓\n\n';
          comment += 'The CLI system is ready for production use.';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
