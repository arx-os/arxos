name: Spatial Validation Workflow

on:
  workflow_dispatch:
    inputs:
      data_path:
        description: 'Path to building data to validate'
        required: true
        default: 'building-data'
      tolerance:
        description: 'Spatial validation tolerance in meters'
        required: false
        default: '0.1'
      fail_on_errors:
        description: 'Fail workflow on validation errors'
        required: false
        default: 'true'
  
  push:
    paths:
      - 'building-data/**/*.yaml'
      - 'building-data/**/*.yml'
      - 'test-repo/**/*.yaml'
      - 'test-repo/**/*.yml'
  
  pull_request:
    paths:
      - 'building-data/**/*.yaml'
      - 'building-data/**/*.yml'
      - 'test-repo/**/*.yaml'
      - 'test-repo/**/*.yml'
  
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  validate-spatial:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Validate Spatial Data
    
    steps:
      - name: Validate spatial coordinates
        uses: ./.github/actions/spatial-validator
        with:
          data-path: ${{ github.event.inputs.data_path || 'building-data' }}
          tolerance: ${{ github.event.inputs.tolerance || '0.1' }}
          check-coordinate-systems: 'true'
          check-universal-paths: 'true'
          fail-on-errors: ${{ github.event.inputs.fail_on_errors || 'true' }}
      
      - name: Generate validation report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ github.event.inputs.data_path || 'building-data' }}
          report-type: 'status'
          output-format: 'markdown'
          commit-report: 'false'

  notify-validation-results:
    runs-on: ubuntu-latest
    needs: validate-spatial
    if: always()
    
    steps:
      - name: Notify validation results
        run: |
          if [ "${{ needs.validate-spatial.result }}" == "success" ]; then
            echo "✅ Spatial validation passed successfully!"
          else
            echo "❌ Spatial validation failed - check the logs for details"
          fi
