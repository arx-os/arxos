openapi: 3.0.3
info:
  title: ArxOS API
  version: 2.0.0
  description: |
    # ArxOS Building Management System API
    
    The ArxOS API provides comprehensive building management capabilities with
    advanced spatial queries, real-time monitoring, and workflow automation.
    
    ## Version Information
    
    - **Current Version**: v1 (stable)
    - **Latest Version**: v2 (beta)
    - **Supported Versions**: v1, v2
    
    ## Version Selection
    
    Clients can specify the API version using one of the following methods (in order of precedence):
    
    1. **URL Path**: `/api/v2/buildings`
    2. **Accept Header**: `Accept: application/vnd.arxos.v2+json`
    3. **Custom Header**: `X-API-Version: v2`
    4. **Query Parameter**: `?version=v2`
    5. **Default**: v1 (if no version specified)
    
    ## Authentication
    
    All endpoints require JWT authentication except `/auth/login` and `/auth/register`.
    
    Include the JWT token in the `Authorization` header:
    ```
    Authorization: Bearer <your_jwt_token>
    ```
    
    ## Rate Limiting
    
    API requests are rate-limited to protect service availability:
    
    - **Free Tier**: 100 requests/minute
    - **Starter Tier**: 1,000 requests/minute
    - **Professional Tier**: 10,000 requests/minute
    - **Enterprise Tier**: Custom limits
    
    Rate limit information is included in response headers:
    - `X-RateLimit-Limit`: Maximum requests per window
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Time when the rate limit resets (Unix timestamp)
    
    ## Caching
    
    Responses include cache-control headers:
    - `Cache-Control`: Caching directives
    - `ETag`: Entity tag for conditional requests
    - `Last-Modified`: Last modification timestamp
    
    Use `If-None-Match` and `If-Modified-Since` headers for conditional requests.
    
    ## Spatial Queries
    
    Spatial queries use WGS84 coordinates (SRID 4326). All distances are in meters.
    All 3D positions use building-local coordinates with millimeter precision.
    
    ## Validation
    
    Request validation uses go-playground/validator with custom ArxOS rules:
    - `arxos_id`: ArxOS ID format (e.g., ARXOS-001)
    - `building_path`: Building path format (e.g., /B1/3/A/301)
    - `equipment_status`: Valid equipment status
    - `building_status`: Valid building status
    
    Validation errors return detailed field-level error messages.
    
    ## Deprecation Policy
    
    Deprecated API versions include warning headers:
    - `Warning`: Deprecation notice
    - `Sunset`: Sunset date (RFC 8594)
    - `Link`: Link to successor version
    
    API versions are maintained for a minimum of 12 months after deprecation.
    
  contact:
    name: ArxOS Support
    email: support@arxos.io
    url: https://arxos.io/support
  license:
    name: Proprietary
    url: https://arxos.io/license

servers:
  - url: https://api.arxos.io/v2
    description: Production server (v2)
  - url: https://api.arxos.io/v1
    description: Production server (v1 - stable)
  - url: https://staging-api.arxos.io/v2
    description: Staging server (v2)
  - url: http://localhost:8080/api/v2
    description: Local development (v2)
  - url: http://localhost:8080/api/v1
    description: Local development (v1)

tags:
  - name: Authentication
    description: User authentication and authorization with JWT tokens
  - name: Users
    description: User account management
  - name: Organizations
    description: Organization and team management
  - name: Buildings
    description: Building lifecycle management with spatial awareness
  - name: Equipment
    description: Equipment tracking and management
  - name: Spatial
    description: Advanced spatial queries and proximity search
  - name: Workflows
    description: Workflow automation and orchestration
  - name: Import
    description: Data import from IFC, PDF, and other formats
  - name: Export
    description: Data export to various formats
  - name: Sync
    description: Data synchronization for offline-first clients
  - name: Health
    description: Service health and monitoring endpoints

x-tagGroups:
  - name: Core API
    tags:
      - Authentication
      - Users
      - Organizations
      - Buildings
      - Equipment
  - name: Advanced Features
    tags:
      - Spatial
      - Workflows
      - Import
      - Export
      - Sync
  - name: Monitoring
    tags:
      - Health

paths:
  # Health & Monitoring Endpoints
  /health:
    get:
      summary: Health check
      tags: [Health]
      operationId: getHealth
      security: []
      responses:
        200:
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                version: 2.0.0
                timestamp: '2025-09-30T12:00:00Z'
                checks:
                  database: healthy
                  cache: healthy
                  storage: healthy
  
  /metrics:
    get:
      summary: Prometheus metrics
      tags: [Health]
      operationId: getMetrics
      security: []
      responses:
        200:
          description: Prometheus metrics in text format
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP arxos_api_requests_total Total API requests
                  # TYPE arxos_api_requests_total counter
                  arxos_api_requests_total{method="GET",path="/api/v1/buildings",status="200"} 1234

  # Authentication Endpoints
  /auth/login:
    post:
      summary: User login
      tags: [Authentication]
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: user@example.com
              password: SecurePassword123!
      responses:
        200:
          description: Login successful
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Rate limit per minute
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        400:
          $ref: '#/components/responses/ValidationError'
        401:
          $ref: '#/components/responses/Unauthorized'
        429:
          $ref: '#/components/responses/RateLimitExceeded'

  /auth/refresh:
    post:
      summary: Refresh access token
      tags: [Authentication]
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        200:
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        400:
          $ref: '#/components/responses/ValidationError'
        401:
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      summary: User logout
      tags: [Authentication]
      operationId: logout
      security:
        - BearerAuth: []
      responses:
        200:
          description: Logout successful
        401:
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

  schemas:
    # Authentication Schemas
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          minLength: 3
          maxLength: 255
          description: User email address
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          maxLength: 72
          description: User password (8-72 characters)
          example: SecurePassword123!
    
    RefreshTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: Refresh token from login response
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    
    AuthResponse:
      type: object
      required:
        - access_token
        - refresh_token
        - token_type
        - expires_in
      properties:
        access_token:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          description: Refresh token for obtaining new access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          enum: [Bearer]
          description: Token type (always Bearer)
          example: Bearer
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 3600
        user:
          $ref: '#/components/schemas/User'
    
    # User Schemas
    User:
      type: object
      required:
        - id
        - email
        - name
        - role
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: 123e4567-e89b-12d3-a456-426614174000
        email:
          type: string
          format: email
          description: User email address
          example: user@example.com
        name:
          type: string
          minLength: 2
          maxLength: 100
          description: User full name
          example: John Doe
        role:
          type: string
          enum: [admin, manager, technician, viewer]
          description: User role for RBAC
          example: manager
        org_id:
          type: string
          format: uuid
          description: Organization ID
          example: 123e4567-e89b-12d3-a456-426614174001
        active:
          type: boolean
          description: Whether user account is active
          example: true
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp
          example: '2025-01-15T09:30:00Z'
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
          example: '2025-09-30T12:00:00Z'
    
    # Building Schemas (Enhanced with validation)
    CreateBuildingRequest:
      type: object
      required:
        - arxos_id
        - name
        - org_id
      properties:
        arxos_id:
          type: string
          pattern: '^ARXOS-[A-Z0-9-]{3,}$'
          minLength: 9
          description: ArxOS ID format (e.g., ARXOS-001 or ARXOS-NA-US-NY-NYC-0001)
          example: ARXOS-NA-US-NY-NYC-0001
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Building name
          example: Empire State Building
        org_id:
          type: string
          format: uuid
          description: Organization ID
          example: 123e4567-e89b-12d3-a456-426614174001
        address:
          type: string
          maxLength: 500
          description: Street address
          example: 350 5th Ave
        city:
          type: string
          maxLength: 100
          description: City
          example: New York
        state:
          type: string
          maxLength: 100
          description: State/Province
          example: NY
        country:
          type: string
          maxLength: 100
          description: Country
          example: USA
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
          description: GPS latitude (-90 to 90)
          example: 40.748817
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
          description: GPS longitude (-180 to 180)
          example: -73.985428
        metadata:
          type: object
          additionalProperties: true
          description: Custom metadata
          example:
            floors: 102
            year_built: 1931
    
    BuildingResponse:
      type: object
      required:
        - id
        - arxos_id
        - name
        - org_id
      properties:
        id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174002
        arxos_id:
          type: string
          example: ARXOS-NA-US-NY-NYC-0001
        name:
          type: string
          example: Empire State Building
        address:
          type: string
          example: 350 5th Ave
        city:
          type: string
          example: New York
        state:
          type: string
          example: NY
        country:
          type: string
          example: USA
        latitude:
          type: number
          format: double
          example: 40.748817
        longitude:
          type: number
          format: double
          example: -73.985428
        org_id:
          type: string
          format: uuid
          example: 123e4567-e89b-12d3-a456-426614174001
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
          example: '2025-01-15T09:30:00Z'
        updated_at:
          type: string
          format: date-time
          example: '2025-09-30T12:00:00Z'
    
    # Equipment Schemas (Enhanced)
    CreateEquipmentRequest:
      type: object
      required:
        - name
        - type
        - building_id
        - status
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Equipment name
          example: HVAC Unit 01
        type:
          type: string
          minLength: 1
          maxLength: 100
          description: Equipment type
          example: hvac
        building_id:
          type: string
          format: uuid
          description: Building UUID
          example: 123e4567-e89b-12d3-a456-426614174002
        path:
          type: string
          pattern: '^/[^/]+(/.+)*$'
          description: Building path (e.g., /B1/3/A/301/HVAC/UNIT-01)
          example: /B1/3/A/301/HVAC/UNIT-01
        floor_id:
          type: string
          format: uuid
          description: Floor UUID
        room_id:
          type: string
          format: uuid
          description: Room UUID
        status:
          type: string
          enum: [OPERATIONAL, DEGRADED, FAILED, MAINTENANCE, OFFLINE, UNKNOWN]
          description: Equipment operational status
          example: OPERATIONAL
        model:
          type: string
          maxLength: 200
          description: Equipment model
          example: Carrier 30HX
        serial:
          type: string
          maxLength: 200
          description: Serial number
          example: SN123456789
        location:
          $ref: '#/components/schemas/Point3D'
        metadata:
          type: object
          additionalProperties: true
    
    # Error Schemas (Enhanced with validation errors)
    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Invalid request parameters
        code:
          type: string
          description: Machine-readable error code
          example: VALIDATION_ERROR
        details:
          type: object
          additionalProperties: true
          description: Additional error details
          example:
            request_id: abc-123-def
    
    ValidationError:
      allOf:
        - $ref: '#/components/schemas/Error'
        - type: object
          properties:
            validation_errors:
              type: array
              items:
                type: object
                required:
                  - field
                  - message
                  - tag
                properties:
                  field:
                    type: string
                    description: Field that failed validation
                    example: email
                  message:
                    type: string
                    description: Validation error message
                    example: email must be a valid email address
                  tag:
                    type: string
                    description: Validation tag that failed
                    example: email
                  value:
                    type: string
                    description: Value that failed validation
                    example: invalid-email
    
    # Pagination Schema
    PaginationInfo:
      type: object
      required:
        - page
        - page_size
        - total
        - total_pages
      properties:
        page:
          type: integer
          minimum: 1
          description: Current page number
          example: 1
        page_size:
          type: integer
          minimum: 1
          maximum: 1000
          description: Items per page
          example: 20
        total:
          type: integer
          format: int64
          description: Total number of items
          example: 150
        total_pages:
          type: integer
          description: Total number of pages
          example: 8
    
    PaginatedResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items: {}
          description: Array of data items
        pagination:
          $ref: '#/components/schemas/PaginationInfo'
    
    # Point3D Schema (Enhanced)
    Point3D:
      type: object
      required:
        - x
        - y
        - z
      properties:
        x:
          type: number
          format: double
          description: X coordinate (meters)
          example: 10.5
        y:
          type: number
          format: double
          description: Y coordinate (meters)
          example: 20.3
        z:
          type: number
          format: double
          description: Z coordinate (meters, elevation)
          example: 3.0
    
    # Health Response
    HealthResponse:
      type: object
      required:
        - status
        - version
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall service health status
          example: healthy
        version:
          type: string
          description: API version
          example: 2.0.0
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
          example: '2025-09-30T12:00:00Z'
        checks:
          type: object
          additionalProperties:
            type: string
          description: Individual component health status
          example:
            database: healthy
            cache: healthy
            storage: healthy

  responses:
    ValidationError:
      description: Request validation failed
      headers:
        X-Request-ID:
          schema:
            type: string
          description: Unique request identifier
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            error: Validation failed
            code: VALIDATION_ERROR
            validation_errors:
              - field: email
                message: email must be a valid email address
                tag: email
                value: invalid-email
              - field: password
                message: password must be at least 8 characters
                tag: min
                value: ""
    
    Unauthorized:
      description: Authentication required or invalid credentials
      headers:
        WWW-Authenticate:
          schema:
            type: string
          description: Authentication scheme
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Invalid or missing authentication token
            code: UNAUTHORIZED
    
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Insufficient permissions for this operation
            code: FORBIDDEN
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Resource not found
            code: NOT_FOUND
    
    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Rate limit per minute
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests (will be 0)
        X-RateLimit-Reset:
          schema:
            type: integer
            format: int64
          description: Unix timestamp when rate limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Rate limit exceeded
            code: RATE_LIMIT_EXCEEDED
            details:
              limit: 100
              window: 60
              retry_after: 45
    
    InternalError:
      description: Internal server error
      headers:
        X-Request-ID:
          schema:
            type: string
          description: Request ID for troubleshooting
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: An internal error occurred
            code: INTERNAL_ERROR
            details:
              request_id: abc-123-def

security:
  - BearerAuth: []
