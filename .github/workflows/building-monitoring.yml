name: Building Monitoring Workflow

on:
  workflow_dispatch:
    inputs:
      data_path:
        description: 'Path to building data to monitor'
        required: true
        default: 'building-data'
      monitoring_interval:
        description: 'Monitoring interval in minutes'
        required: false
        default: '60'
      create_issues:
        description: 'Create GitHub issues for critical alerts'
        required: false
        default: 'true'
      dry_run:
        description: 'Run in dry-run mode (no actual alerts)'
        required: false
        default: 'false'
  
  # schedule:
    # Run monitoring every hour
    # - cron: '0 * * * *'
  
  push:
    paths:
      - 'building-data/**/*.yaml'
      - 'building-data/**/*.yml'

jobs:
  monitor-equipment:
    runs-on: ubuntu-latest
    name: Monitor Equipment Health
    
    steps:
      - name: Monitor equipment health
        uses: ./.github/actions/equipment-monitor
        with:
          data-path: ${{ github.event.inputs.data_path || 'building-data' }}
          monitoring-interval: ${{ github.event.inputs.monitoring_interval || '60' }}
          alert-thresholds: '{"temperature": {"min": 15, "max": 25}, "humidity": {"min": 30, "max": 70}}'
          create-issues: ${{ github.event.inputs.create_issues || 'true' }}
          issue-labels: 'equipment-alert,critical,monitoring'
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}
      
      - name: Generate monitoring report
        uses: ./.github/actions/building-reporter
        with:
          data-path: ${{ github.event.inputs.data_path || 'building-data' }}
          report-type: 'equipment'
          output-format: 'markdown'
          commit-report: 'true'

  notify-monitoring-results:
    runs-on: ubuntu-latest
    needs: monitor-equipment
    if: always()
    
    steps:
      - name: Notify monitoring results
        run: |
          if [ "${{ needs.monitor-equipment.result }}" == "success" ]; then
            echo "✅ Equipment monitoring completed successfully!"
          else
            echo "❌ Equipment monitoring encountered issues - check the logs"
          fi
