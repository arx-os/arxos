apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: svgx-engine-ingress
  namespace: arxos
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/websocket-services: "svgx-engine-service"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    prometheus.io/scrape: "true"
    prometheus.io/port: "80"
spec:
  tls:
  - hosts:
    - svgx-engine.arxos.com
    secretName: svgx-engine-tls
  rules:
  - host: svgx-engine.arxos.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: svgx-engine-service
            port:
              number: 80
      - path: /ws
        pathType: Prefix
        backend:
          service:
            name: svgx-engine-service
            port:
              number: 80

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: arxos
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    
    http {
      upstream svgx_backend {
        server svgx-engine-service:80;
        keepalive 32;
      }
      
      # Rate limiting
      limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
      limit_req_zone $binary_remote_addr zone=websocket:10m rate=100r/s;
      
      server {
        listen 80;
        server_name svgx-engine.arxos.com;
        
        # API rate limiting
        location / {
          limit_req zone=api burst=20 nodelay;
          proxy_pass http://svgx_backend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_read_timeout 300s;
          proxy_send_timeout 300s;
        }
        
        # WebSocket rate limiting
        location /ws {
          limit_req zone=websocket burst=50 nodelay;
          proxy_pass http://svgx_backend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_read_timeout 300s;
          proxy_send_timeout 300s;
        }
        
        # Health checks
        location /health {
          proxy_pass http://svgx_backend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Metrics endpoint
        location /metrics {
          proxy_pass http://svgx_backend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    } 