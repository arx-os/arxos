version: '3.8'

services:
  # PostGIS database for testing
  postgis-test:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_DB: arxos_test
      POSTGRES_USER: arxos_test
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgis-test-data:/var/lib/postgresql/data
      - ./scripts/init-postgis.sql:/docker-entrypoint-initdb.d/init-postgis.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arxos_test -d arxos_test"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - arxos-test-network

  # Redis cache for testing
  redis-test:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 128m --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-test-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - arxos-test-network

  # IfcOpenShell service for testing
  ifcopenshell-test:
    build:
      context: ./services/ifcopenshell-service
      dockerfile: Dockerfile
    environment:
      - FLASK_ENV=testing
      - DEBUG=true
      - REDIS_HOST=redis-test
      - REDIS_PORT=6379
      - REDIS_DB=0
      - MAX_FILE_SIZE=52428800  # 50MB for tests
      - CACHE_ENABLED=true
      - CACHE_TTL=300  # 5 minutes for tests
    ports:
      - "5000:5000"
    depends_on:
      redis-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - ifc-test-cache:/app/cache
    networks:
      - arxos-test-network

  # ArxOS application for integration testing
  arxos-test:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ARXOS_MODE=testing
      - ARXOS_IFC_SERVICE_URL=http://ifcopenshell-test:5000
      - ARXOS_IFC_SERVICE_ENABLED=true
      - ARXOS_IFC_FALLBACK_ENABLED=false
      - POSTGIS_HOST=postgis-test
      - POSTGIS_PORT=5432
      - POSTGIS_DATABASE=arxos_test
      - POSTGIS_USER=arxos_test
      - POSTGIS_PASSWORD=test_password
      - POSTGIS_SSLMODE=disable
      - REDIS_HOST=redis-test
      - REDIS_PORT=6379
      - REDIS_DB=0
      - ARXOS_LOG_LEVEL=debug
      - ARXOS_TUI_ENABLED=false
    ports:
      - "8080:8080"
    depends_on:
      postgis-test:
        condition: service_healthy
      ifcopenshell-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    volumes:
      - arxos-test-data:/app/data
      - ./test/fixtures:/app/test/fixtures:ro
    command: ["go", "run", "cmd/arx/main.go", "serve"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - arxos-test-network

volumes:
  postgis-test-data:
    driver: local
  redis-test-data:
    driver: local
  ifc-test-cache:
    driver: local
  arxos-test-data:
    driver: local

networks:
  arxos-test-network:
    driver: bridge
