<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVG Viewer - Arx</title>

    <!-- CDN Configuration -->
    <script src="static/cdn-config.js"></script>
    <script src="static/js/cdn-loader.js"></script>

    <!-- Critical CSS and JavaScript - Loaded via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.17/dist/interact.min.js"></script>

    <!-- SVG Markup Layer -->
    <script src="static/js/svg_markup_layer.js"></script>

    <style>
        .symbol-preview {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
        }
        .symbol-preview svg {
            max-width: 100%;
            max-height: 100%;
        }
        .symbol-item {
            cursor: grab;
            transition: all 0.2s;
        }
        .symbol-item:hover {
            background-color: #f3f4f6;
        }
        .symbol-item.selected {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 2px #60a5fa;
        }
        .symbol-item:active {
            cursor: grabbing;
        }
        .placed-symbol {
            cursor: pointer;
            transition: all 0.2s;
        }
        .placed-symbol:hover {
            filter: brightness(1.1);
        }
        .placed-symbol.selected {
            filter: brightness(1.2) drop-shadow(0 0 8px #2563eb);
            outline: 3px solid #3b82f6;
            outline-offset: 2px;
        }
        .placed-symbol.placing {
            animation: symbol-flash 0.4s cubic-bezier(.4,2,.6,1) 1;
        }
        @keyframes symbol-flash {
            0% { transform: scale(1); filter: brightness(1.5); }
            60% { transform: scale(1.25); filter: brightness(2); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .svg-drop-hover {
            outline: 3px dashed #3b82f6 !important;
            background: rgba(96,165,250,0.08);
        }
        .placed-symbol.has-asset {
            filter: brightness(1.1) drop-shadow(0 0 4px #10b981);
            outline: 2px solid #10b981;
            outline-offset: 1px;
        }
        .placed-symbol.has-asset:hover {
            filter: brightness(1.2) drop-shadow(0 0 8px #10b981);
            outline: 3px solid #10b981;
        }
        .placed-symbol.no-asset {
            filter: brightness(0.9);
            outline: 2px solid #6b7280;
            outline-offset: 1px;
        }
        .placed-symbol.no-asset:hover {
            filter: brightness(1.0);
            outline: 3px solid #6b7280;
        }
        .placed-symbol.asset-selected {
            filter: brightness(1.3) drop-shadow(0 0 12px #3b82f6);
            outline: 4px solid #3b82f6;
            outline-offset: 2px;
            animation: asset-pulse 2s infinite;
        }
        @keyframes asset-pulse {
            0% { outline-width: 4px; }
            50% { outline-width: 6px; }
            100% { outline-width: 4px; }
        }
        .asset-status-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .asset-status-active {
            background-color: #10b981;
        }
        .asset-status-inactive {
            background-color: #6b7280;
        }
        .asset-status-maintenance {
            background-color: #f59e0b;
        }
        .asset-status-retired {
            background-color: #ef4444;
        }
        .asset-details-popup {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 12px;
            max-width: 300px;
            z-index: 1001;
            font-size: 12px;
        }
        .asset-details-popup h4 {
            margin: 0 0 8px 0;
            font-weight: 600;
            color: #374151;
        }
        .asset-details-popup .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .asset-details-popup .detail-label {
            font-weight: 500;
            color: #6b7280;
        }
        .asset-details-popup .detail-value {
            color: #374151;
        }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1002;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        .sync-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .annotation-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 20px;
            min-width: 300px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
        }
        #symbol-library {
            transition: left 0.3s;
        }
        #symbol-library:not(.hidden) {
            left: 0;
        }
        #symbol-library.hidden {
            left: -18rem;
        }

        /* SVG Markup Layer Styles */
        .edit-mode .placed-symbol {
            cursor: pointer;
        }
        .edit-mode .placed-symbol:hover {
            filter: brightness(1.2) drop-shadow(0 0 8px #3b82f6);
        }
        .diff-indicator {
            border: 2px solid #f59e0b;
            background: rgba(245, 158, 11, 0.2);
            pointer-events: none;
            z-index: 40;
        }
        .snap-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }

        /* Layer-specific styles */
        [data-layer="E"] { stroke: #FF6B35; fill: rgba(255, 107, 53, 0.1); }
        [data-layer="LV"] { stroke: #4ECDC4; fill: rgba(78, 205, 196, 0.1); }
        [data-layer="FA"] { stroke: #FFE66D; fill: rgba(255, 230, 109, 0.1); }
        [data-layer="N"] { stroke: #95E1D3; fill: rgba(149, 225, 211, 0.1); }
        [data-layer="M"] { stroke: #F38181; fill: rgba(243, 129, 129, 0.1); }
        [data-layer="P"] { stroke: #A8E6CF; fill: rgba(168, 230, 207, 0.1); }
        [data-layer="S"] { stroke: #FF8B94; fill: rgba(255, 139, 148, 0.1); }

        /* Layer toggle button */
        .layer-toggle-btn {
            position: fixed;
            top: 4px;
            right: 4px;
            z-index: 60;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        .layer-toggle-btn:hover {
            background: #f9fafb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Layer Toggle Button -->
    <button id="layer-toggle-btn" class="layer-toggle-btn" onclick="window.svgMarkupLayer.showLayerPanel()">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
    </button>

    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Symbol Library Sidebar -->
        <div id="symbol-library" class="w-72 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">Symbol Library</h2>
                    <button id="toggle-library" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Search Bar -->
                <div class="mt-4">
                    <input type="text" id="symbol-search" placeholder="Search symbols..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Filter Buttons -->
                <div class="mt-3 flex flex-wrap gap-2">
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800" data-filter="all">All</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-filter="electrical">Electrical</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-filter="mechanical">Mechanical</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-filter="plumbing">Plumbing</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-filter="fire">Fire</button>
                </div>
            </div>

            <!-- Symbol List -->
            <div id="symbol-list" class="flex-1 overflow-y-auto p-4">
                <!-- Symbols will be loaded here -->
            </div>
        </div>

        <!-- Main SVG Viewer -->
        <div class="flex-1 flex flex-col">
            <!-- Toolbar -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-semibold text-gray-800">SVG Viewer</h1>
                        <span class="text-sm text-gray-500">Objects: <span id="object-count">0</span></span>
                    </div>

                    <div class="flex items-center space-x-2">
                        <!-- Zoom Controls -->
                        <button id="zoom-in" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                            </svg>
                        </button>
                        <button id="zoom-out" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                            </svg>
                        </button>
                        <button id="reset-view" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                        </button>

                        <!-- Action Buttons -->
                        <button id="save-markup" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            Save Markup
                        </button>
                        <button id="export-svg" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            Export SVG
                        </button>
                        <button id="zoom-to-selection" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                            Zoom to Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- SVG Container -->
            <div id="svg-container" class="flex-1 relative overflow-hidden bg-white">
                <svg id="main-svg" class="w-full h-full" viewBox="0 0 800 600">
                    <!-- SVG content will be loaded here -->
                </svg>

                <!-- Snap Indicator -->
                <div id="snap-indicator" class="absolute w-2 h-2 bg-blue-500 rounded-full pointer-events-none z-50" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div id="sync-indicator" class="sync-indicator">
        <span id="sync-message">Changes saved</span>
    </div>

    <!-- HTMX Layer Management API -->
    <div id="htmx-layer-api" style="display: none;">
        <!-- Layer edit form template -->
        <template id="layer-edit-template">
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Edit Layer</h3>
                    <form hx-post="/api/layers/{layer}" hx-target="#layer-edit-result">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Color</label>
                                <input type="color" name="color" class="mt-1 block w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Opacity</label>
                                <input type="range" name="opacity" min="0" max="1" step="0.1" class="mt-1 block w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" onclick="this.closest('.fixed').remove()">Cancel</button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">Save</button>
                        </div>
                    </form>
                    <div id="layer-edit-result"></div>
                </div>
            </div>
        </template>
    </div>

    <!-- Scripts -->
    <script src="static/js/registry.js"></script>
    <script src="static/js/arx-logger.js"></script>
    <script src="static/js/access_control_manager.js"></script>
    <script src="static/js/auto_snapshot.js"></script>
    <script src="static/js/asset_inventory.js"></script>
    <script src="static/js/object_interaction.js"></script>
    <script src="static/js/symbol_library.js"></script>
    <script src="static/js/viewport_manager.js"></script>
    <script src="static/js/performance_monitor.js"></script>
    <script src="static/js/performance_tester.js"></script>
    <script src="static/js/lod_manager.js"></script>
    <script src="static/js/zoom_history.js"></script>
    <script src="static/js/throttled_updates.js"></script>
    <script src="static/js/bim_editing_integration.js"></script>
    <script src="static/js/asset_lifecycle.js"></script>
    <script src="static/js/export_integration.js"></script>
    <script src="static/js/validation_integration.js"></script>
    <script src="static/js/coordinate_validator.js"></script>
    <script src="static/js/scale_manager.js"></script>
    <script src="static/js/relationship_manager.js"></script>
    <script src="static/js/spatial_reasoning.js"></script>
    <script src="static/js/geometry_resolver.js"></script>
    <script src="static/js/failure_detection.js"></script>
    <script src="static/js/realtime_telemetry.js"></script>
    <script src="static/js/route_manager.js"></script>
    <script src="static/js/robust_error_handling.js"></script>
    <script src="static/js/persistence_export_interoperability.js"></script>
    <script src="static/js/backup_service.js"></script>
    <script src="static/js/version_control.js"></script>
    <script src="static/js/realtime_service.js"></script>
    <script src="static/js/data_partitioning.js"></script>
    <script src="static/js/cmms_integration.js"></script>
    <script src="static/js/arxsvgx.js"></script>
    <script src="static/js/arxsvgx_format.js"></script>
    <script src="static/js/svg_symbol_library_backup.js"></script>
    <script src="static/js/symbol_generator.js"></script>
    <script src="static/js/symbol_zoom_integration.js"></script>
    <script src="static/js/symbol_schema_validator.js"></script>
    <script src="static/js/schema_validation.js"></script>
    <script src="static/js/enhanced_spatial_reasoning.js"></script>
    <script src="static/js/relationship_manager.js"></script>
    <script src="static/js/spatial_reasoning.js"></script>
    <script src="static/js/performance_optimizer.js"></script>
    <script src="static/js/svg_bim_mapping.js"></script>
    <script src="static/js/symbol_renderer.js"></script>
    <script src="static/js/analytics.js"></script>
    <script src="static/js/telemetry.js"></script>
    <script src="static/js/system_simulation.js"></script>
    <script src="static/js/building_code_validator.js"></script>
    <script src="static/js/auto_snapshot.js"></script>
    <script src="static/js/object_id_service.js"></script>
    <script src="static/js/cache_service.js"></script>
    <script src="static/js/coordinate_validator.js"></script>
    <script src="static/js/svg_reader.js"></script>
    <script src="static/js/svg_writer.js"></script>

    <script>
        // Initialize SVG Markup Layer
        window.svgMarkupLayer = new SVGMarkupLayer({
            enableEditMode: true,
            enableLayerToggles: true,
            enableDiffOverlay: true,
            enableSnapping: true,
            enablePermissionGating: true
        });

        // Initialize other components
        let viewportManager;
        let symbolLibrary;
        let svgObjectInteraction;
        let accessControlManager;
        let autoSnapshotManager;
        let assetInventoryManager;
        let performanceMonitor;
        let performanceTester;
        let lodManager;
        let zoomHistory;
        let throttledUpdates;
        let bimEditingIntegration;
        let assetLifecycleManager;
        let exportIntegration;
        let validationIntegration;
        let coordinateValidator;
        let scaleManager;
        let relationshipManager;
        let spatialReasoning;
        let geometryResolver;
        let failureDetection;
        let realtimeTelemetry;
        let routeManager;
        let robustErrorHandling;
        let persistenceExportInteroperability;
        let backupService;
        let versionControl;
        let realtimeService;
        let dataPartitioning;
        let cmmsIntegration;
        let arxsvgx;
        let arxsvgxFormat;
        let svgSymbolLibraryBackup;
        let symbolGenerator;
        let symbolZoomIntegration;
        let symbolSchemaValidator;
        let schemaValidation;
        let enhancedSpatialReasoning;
        let relationshipManager;
        let spatialReasoning;
        let performanceOptimizer;
        let svgBimMapping;
        let symbolRenderer;
        let analytics;
        let telemetry;
        let systemSimulation;
        let buildingCodeValidator;
        let autoSnapshot;
        let objectIdService;
        let cacheService;
        let coordinateValidator;
        let svgReader;
        let svgWriter;

        // Initialize components when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing SVG Viewer components...');

            // Initialize viewport manager
            viewportManager = new ViewportManager(document.getElementById('main-svg'), {
                enableZoom: true,
                enablePan: true,
                enableSelection: true,
                enableSnapping: true,
                enablePerformanceMonitoring: true
            });

            // Initialize symbol library
            symbolLibrary = new SymbolLibrary({
                enableLOD: true,
                enablePerformanceOptimization: true,
                enableSymbolValidation: true
            });

            // Initialize SVG object interaction
            svgObjectInteraction = new SVGObjectInteraction({
                enableSelection: true,
                enableDragging: true,
                enableResizing: true,
                enableRotation: true,
                enableSnapping: true,
                enablePerformanceMonitoring: true
            });

            // Initialize access control manager
            accessControlManager = new AccessControlManager({
                enablePermissionChecking: true,
                enableRoleBasedAccess: true,
                enableAuditLogging: true
            });

            // Initialize auto snapshot manager
            autoSnapshotManager = new AutoSnapshotManager({
                enableAutoSnapshots: true,
                snapshotInterval: 30000,
                maxSnapshots: 10,
                enableCompression: true
            });

            // Initialize asset inventory manager
            assetInventoryManager = new AssetInventoryManager({
                enableAssetTracking: true,
                enableAssetValidation: true,
                enableAssetLifecycleManagement: true
            });

            // Initialize performance monitor
            performanceMonitor = new PerformanceMonitor({
                enableMonitoring: true,
                updateInterval: 1000,
                enableAlerts: true
            });

            // Initialize performance tester
            performanceTester = new PerformanceTester(document.getElementById('main-svg'), {
                enableStressTesting: true,
                enableBenchmarking: true,
                enablePerformanceProfiling: true
            });

            // Initialize LOD manager
            lodManager = new LODManager({
                enableLOD: true,
                enableTransitions: true,
                enablePerformanceOptimization: true
            });

            // Initialize zoom history
            zoomHistory = new ZoomHistory({
                enableHistory: true,
                maxHistorySize: 50,
                enableUndoRedo: true
            });

            // Initialize throttled updates
            throttledUpdates = new ThrottledUpdates({
                enableThrottling: true,
                throttleDelay: 100,
                enableBatching: true
            });

            // Initialize BIM editing integration
            bimEditingIntegration = new BIMEditingIntegration({
                enableBIMEditing: true,
                enableValidation: true,
                enableAutoSave: true
            });

            // Initialize asset lifecycle manager
            assetLifecycleManager = new AssetLifecycleManager({
                enableLifecycleTracking: true,
                enableStatusUpdates: true,
                enableMaintenanceScheduling: true
            });

            // Initialize export integration
            exportIntegration = new ExportIntegration({
                enableSVGExport: true,
                enablePDFExport: true,
                enableImageExport: true
            });

            // Initialize validation integration
            validationIntegration = new ValidationIntegration({
                enableValidation: true,
                enableRealTimeValidation: true,
                enableErrorReporting: true
            });

            // Initialize coordinate validator
            coordinateValidator = new CoordinateValidator({
                enableValidation: true,
                enableCoordinateTransformation: true,
                enableErrorReporting: true
            });

            // Initialize scale manager
            scaleManager = new ScaleManager({
                enableScaling: true,
                enableUnitConversion: true,
                enablePrecisionControl: true
            });

            // Initialize relationship manager
            relationshipManager = new RelationshipManager({
                enableRelationshipTracking: true,
                enableDependencyManagement: true,
                enableConflictResolution: true
            });

            // Initialize spatial reasoning
            spatialReasoning = new SpatialReasoning({
                enableSpatialAnalysis: true,
                enableCollisionDetection: true,
                enablePathfinding: true
            });

            // Initialize geometry resolver
            geometryResolver = new GeometryResolver({
                enableGeometryResolution: true,
                enableCoordinateTransformation: true,
                enablePrecisionControl: true
            });

            // Initialize failure detection
            failureDetection = new FailureDetection({
                enableFailureDetection: true,
                enableErrorReporting: true,
                enableRecoveryMechanisms: true
            });

            // Initialize realtime telemetry
            realtimeTelemetry = new RealtimeTelemetry({
                enableTelemetry: true,
                enableRealTimeUpdates: true,
                enablePerformanceMonitoring: true
            });

            // Initialize route manager
            routeManager = new RouteManager({
                enableRouteManagement: true,
                enablePathfinding: true,
                enableOptimization: true
            });

            // Initialize robust error handling
            robustErrorHandling = new RobustErrorHandling({
                enableErrorHandling: true,
                enableErrorRecovery: true,
                enableErrorReporting: true
            });

            // Initialize persistence export interoperability
            persistenceExportInteroperability = new PersistenceExportInteroperability({
                enablePersistence: true,
                enableExport: true,
                enableInteroperability: true
            });

            // Initialize backup service
            backupService = new BackupService({
                enableBackup: true,
                enableRestore: true,
                enableCompression: true
            });

            // Initialize version control
            versionControl = new VersionControl({
                enableVersionControl: true,
                enableBranching: true,
                enableMerging: true
            });

            // Initialize realtime service
            realtimeService = new RealtimeService({
                enableRealTimeUpdates: true,
                enableCollaboration: true,
                enableSynchronization: true
            });

            // Initialize data partitioning
            dataPartitioning = new DataPartitioning({
                enablePartitioning: true,
                enableOptimization: true,
                enableScalability: true
            });

            // Initialize CMMS integration
            cmmsIntegration = new CMMSIntegration({
                enableCMMSIntegration: true,
                enableDataSync: true,
                enableMaintenanceTracking: true
            });

            // Initialize ArxSVGX
            arxsvgx = new ArxSVGX({
                enableSVGX: true,
                enableFormatting: true,
                enableValidation: true
            });

            // Initialize ArxSVGX Format
            arxsvgxFormat = new ArxSVGXFormat({
                enableFormatting: true,
                enableValidation: true,
                enableOptimization: true
            });

            // Initialize SVG symbol library backup
            svgSymbolLibraryBackup = new SVGSymbolLibraryBackup({
                enableBackup: true,
                enableRestore: true,
                enableCompression: true
            });

            // Initialize symbol generator
            symbolGenerator = new SymbolGenerator({
                enableGeneration: true,
                enableValidation: true,
                enableOptimization: true
            });

            // Initialize symbol zoom integration
            symbolZoomIntegration = new SymbolZoomIntegration({
                enableZoomIntegration: true,
                enablePerformanceOptimization: true,
                enableLOD: true
            });

            // Initialize symbol schema validator
            symbolSchemaValidator = new SymbolSchemaValidator({
                enableValidation: true,
                enableSchemaChecking: true,
                enableErrorReporting: true
            });

            // Initialize schema validation
            schemaValidation = new SchemaValidation({
                enableValidation: true,
                enableSchemaChecking: true,
                enableErrorReporting: true
            });

            // Initialize enhanced spatial reasoning
            enhancedSpatialReasoning = new EnhancedSpatialReasoning({
                enableSpatialAnalysis: true,
                enableCollisionDetection: true,
                enablePathfinding: true
            });

            // Initialize relationship manager
            relationshipManager = new RelationshipManager({
                enableRelationshipTracking: true,
                enableDependencyManagement: true,
                enableConflictResolution: true
            });

            // Initialize spatial reasoning
            spatialReasoning = new SpatialReasoning({
                enableSpatialAnalysis: true,
                enableCollisionDetection: true,
                enablePathfinding: true
            });

            // Initialize performance optimizer
            performanceOptimizer = new PerformanceOptimizer({
                enableOptimization: true,
                enableCaching: true,
                enableCompression: true
            });

            // Initialize SVG BIM mapping
            svgBimMapping = new SVGBIMMapping({
                enableMapping: true,
                enableValidation: true,
                enableOptimization: true
            });

            // Initialize symbol renderer
            symbolRenderer = new SymbolRenderer({
                enableRendering: true,
                enableOptimization: true,
                enableCaching: true
            });

            // Initialize analytics
            analytics = new Analytics({
                enableAnalytics: true,
                enableTracking: true,
                enableReporting: true
            });

            // Initialize telemetry
            telemetry = new Telemetry({
                enableTelemetry: true,
                enableTracking: true,
                enableReporting: true
            });

            // Initialize system simulation
            systemSimulation = new SystemSimulation({
                enableSimulation: true,
                enableValidation: true,
                enableOptimization: true
            });

            // Initialize building code validator
            buildingCodeValidator = new BuildingCodeValidator({
                enableValidation: true,
                enableCodeChecking: true,
                enableErrorReporting: true
            });

            // Initialize auto snapshot
            autoSnapshot = new AutoSnapshot({
                enableAutoSnapshots: true,
                enableCompression: true,
                enableRestore: true
            });

            // Initialize object ID service
            objectIdService = new ObjectIDService({
                enableIDGeneration: true,
                enableValidation: true,
                enableUniqueness: true
            });

            // Initialize cache service
            cacheService = new CacheService({
                enableCaching: true,
                enableOptimization: true,
                enableCompression: true
            });

            // Initialize coordinate validator
            coordinateValidator = new CoordinateValidator({
                enableValidation: true,
                enableTransformation: true,
                enableErrorReporting: true
            });

            // Initialize SVG reader
            svgReader = new SVGReader({
                enableReading: true,
                enableParsing: true,
                enableValidation: true
            });

            // Initialize SVG writer
            svgWriter = new SVGWriter({
                enableWriting: true,
                enableOptimization: true,
                enableCompression: true
            });

            // Setup event listeners
            setupEventListeners();
            setupObjectPlacementEvents();
            setupKeyboardShortcuts();
            setupHTMXEvents();

            console.log('SVG Viewer components initialized successfully');
        });

        // Setup event listeners
        function setupEventListeners() {
            // Symbol library toggle
            const toggleLibraryBtn = document.getElementById('toggle-library');
            const symbolLibrary = document.getElementById('symbol-library');

            if (toggleLibraryBtn && symbolLibrary) {
                toggleLibraryBtn.addEventListener('click', () => {
                    symbolLibrary.classList.toggle('hidden');
                });
            }

            // Zoom controls
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const resetViewBtn = document.getElementById('reset-view');

            if (zoomInBtn && viewportManager) {
                zoomInBtn.addEventListener('click', () => viewportManager.zoomIn());
            }

            if (zoomOutBtn && viewportManager) {
                zoomOutBtn.addEventListener('click', () => viewportManager.zoomOut());
            }

            if (resetViewBtn && viewportManager) {
                resetViewBtn.addEventListener('click', () => viewportManager.resetView());
            }

            // Action buttons
            const saveMarkupBtn = document.getElementById('save-markup');
            const exportSvgBtn = document.getElementById('export-svg');
            const zoomToSelectionBtn = document.getElementById('zoom-to-selection');

            if (saveMarkupBtn) {
                saveMarkupBtn.addEventListener('click', saveMarkup);
            }

            if (exportSvgBtn) {
                exportSvgBtn.addEventListener('click', exportSVG);
            }

            if (zoomToSelectionBtn) {
                zoomToSelectionBtn.addEventListener('click', () => {
                    if (svgObjectInteraction && typeof svgObjectInteraction.getSelectionBounds === 'function') {
                        const bbox = svgObjectInteraction.getSelectionBounds();
                        if (bbox) {
                            viewportManager.zoomToSelection(bbox);
                        } else {
                            alert('No selection to zoom to.');
                        }
                    } else {
                        alert('Selection system not available.');
                    }
                });
            }

            // Symbol search
            const symbolSearch = document.getElementById('symbol-search');
            if (symbolSearch) {
                symbolSearch.addEventListener('input', (e) => {
                    if (symbolLibrary) {
                        symbolLibrary.searchSymbols(e.target.value);
                    }
                });
            }

            // Filter buttons
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    if (symbolLibrary) {
                        symbolLibrary.filterSymbols(filter);
                    }

                    // Update active filter button
                    filterBtns.forEach(b => b.classList.remove('bg-blue-100', 'text-blue-800'));
                    filterBtns.forEach(b => b.classList.add('bg-gray-100', 'text-gray-800'));
                    e.target.classList.remove('bg-gray-100', 'text-gray-800');
                    e.target.classList.add('bg-blue-100', 'text-blue-800');
                });
            });
        }

        // Setup object placement events
        function setupObjectPlacementEvents() {
            if (!viewportManager) return;

            // Listen for object placement events
            viewportManager.addEventListener('objectPlaced', (data) => {
                console.log('Object placed:', data);
                updateObjectCount();
            });

            viewportManager.addEventListener('objectMoved', (data) => {
                console.log('Object moved:', data);
            });

            // Listen for viewport changes to update symbol positions
            viewportManager.addEventListener('zoomChanged', () => {
                if (symbolLibrary) {
                    symbolLibrary.updateSymbolPositions();
                }
            });

            viewportManager.addEventListener('viewReset', () => {
                if (symbolLibrary) {
                    symbolLibrary.updateSymbolPositions();
                }
            });
        }

        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S: Save markup
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveMarkup();
                }

                // Ctrl+E: Export SVG
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportSVG();
                }

                // Ctrl+Z: Undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    if (zoomHistory) {
                        zoomHistory.undo();
                    }
                }

                // Ctrl+Y: Redo
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    if (zoomHistory) {
                        zoomHistory.redo();
                    }
                }

                // Escape: Clear selection
                if (e.key === 'Escape') {
                    if (svgObjectInteraction) {
                        svgObjectInteraction.clearSelection();
                    }
                }
            });
        }

        // Setup HTMX events
        function setupHTMXEvents() {
            document.addEventListener('htmx:afterRequest', (e) => {
                console.log('HTMX request completed:', e.detail);

                // Handle layer edit responses
                if (e.detail.xhr.responseURL.includes('/api/layers/')) {
                    if (window.svgMarkupLayer) {
                        window.svgMarkupLayer.refreshLayerPanel();
                    }
                }
            });

            document.addEventListener('htmx:beforeRequest', (e) => {
                console.log('HTMX request starting:', e.detail);
            });

            document.addEventListener('htmx:responseError', (e) => {
                console.error('HTMX request failed:', e.detail);
                if (window.svgMarkupLayer) {
                    window.svgMarkupLayer.showNotification('Request failed', 'error');
                }
            });
        }

        // Save markup function
        function saveMarkup() {
            if (!svgObjectInteraction) {
                alert('Object interaction system not available.');
                return;
            }

            svgObjectInteraction.saveObjectPositions()
                .then(response => {
                    console.log('Markup saved:', response);
                    showSyncIndicator('Changes saved successfully');
                })
                .catch(error => {
                    console.error('Save failed:', error);
                    showSyncIndicator('Save failed', 'error');
                });
        }

        // Export SVG function
        function exportSVG() {
            if (!exportIntegration) {
                alert('Export system not available.');
                return;
            }

            exportIntegration.exportSVG()
                .then(response => {
                    console.log('SVG exported:', response);
                    showSyncIndicator('SVG exported successfully');
                })
                .catch(error => {
                    console.error('Export failed:', error);
                    showSyncIndicator('Export failed', 'error');
                });
        }

        // Show sync indicator
        function showSyncIndicator(message, type = 'success') {
            const indicator = document.getElementById('sync-indicator');
            const messageEl = document.getElementById('sync-message');

            if (indicator && messageEl) {
                messageEl.textContent = message;
                indicator.className = `sync-indicator ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
                indicator.classList.add('show');

                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }

        // Update object count
        function updateObjectCount() {
            const placedSymbols = document.querySelectorAll('.placed-symbol[data-placed-symbol="true"]');
            const count = placedSymbols.length;

            const countElement = document.getElementById('object-count');
            if (countElement) {
                countElement.textContent = count;
            }

            const saveButton = document.getElementById('save-markup');
            if (saveButton) {
                saveButton.disabled = count === 0;
            }
        }

        // Initialize object count on load
        document.addEventListener('DOMContentLoaded', () => {
            updateObjectCount();
        });
    </script>
</body>
</html>
