{{template "base" .}}

{{define "content"}}
<div class="max-w-7xl mx-auto">
    <!-- Header with controls -->
    <div class="bg-white shadow rounded-lg mb-4 p-4">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{.Content.FloorPlan.Building}} - Level {{.Content.FloorPlan.Level}}</h1>
                <p class="text-sm text-gray-500">{{.Content.FloorPlan.Name}}</p>
            </div>
            
            <!-- View Controls -->
            <div class="flex space-x-2">
                <!-- Theme Selector -->
                <select id="theme-selector" 
                        class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        hx-get="/api/buildings/{{.Content.BuildingID}}/svg"
                        hx-trigger="change"
                        hx-target="#floor-plan-svg"
                        hx-include="[name='grid'], [name='labels']">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="blueprint">Blueprint</option>
                </select>
                
                <!-- Toggle Grid -->
                <label class="inline-flex items-center">
                    <input type="checkbox" 
                           name="grid" 
                           checked
                           class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           hx-get="/api/buildings/{{.Content.BuildingID}}/svg"
                           hx-trigger="change"
                           hx-target="#floor-plan-svg"
                           hx-include="#theme-selector, [name='labels']">
                    <span class="ml-2 text-sm">Grid</span>
                </label>
                
                <!-- Toggle Labels -->
                <label class="inline-flex items-center">
                    <input type="checkbox" 
                           name="labels" 
                           checked
                           class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                           hx-get="/api/buildings/{{.Content.BuildingID}}/svg"
                           hx-trigger="change"
                           hx-target="#floor-plan-svg"
                           hx-include="#theme-selector, [name='grid']">
                    <span class="ml-2 text-sm">Labels</span>
                </label>
                
                <!-- Export Button -->
                <button onclick="exportSVG()" 
                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                    Export SVG
                </button>
                
                <!-- Fullscreen Button -->
                <button onclick="toggleFullscreen()" 
                        class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm">
                    Fullscreen
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Floor Plan Visualization (3/4 width) -->
        <div class="lg:col-span-3">
            <div class="bg-white shadow rounded-lg p-4">
                <div id="floor-plan-container" class="border border-gray-200 rounded overflow-auto">
                    <!-- SVG Floor Plan loaded via HTMX -->
                    <div id="floor-plan-svg"
                         hx-get="/api/buildings/{{.Content.BuildingID}}/svg"
                         hx-trigger="load"
                         hx-indicator="#loading-indicator">
                        <div id="loading-indicator" class="flex justify-center items-center h-96">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Zoom Controls -->
                <div class="mt-2 flex justify-center space-x-2">
                    <button onclick="zoomIn()" class="p-1 text-gray-600 hover:text-gray-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                        </svg>
                    </button>
                    <button onclick="zoomOut()" class="p-1 text-gray-600 hover:text-gray-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                        </svg>
                    </button>
                    <button onclick="resetZoom()" class="p-1 text-gray-600 hover:text-gray-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Equipment Panel (1/4 width) -->
        <div class="lg:col-span-1">
            <!-- Equipment List -->
            <div class="bg-white shadow rounded-lg p-4 mb-4">
                <h3 class="text-lg font-medium mb-3">Equipment</h3>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    {{range .Content.FloorPlan.Equipment}}
                    <div class="p-2 border rounded hover:bg-gray-50 cursor-pointer"
                         onclick="highlightEquipment('{{.ID}}')"
                         id="equipment-card-{{.ID}}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-sm">{{.Name}}</div>
                                <div class="text-xs text-gray-500">{{.Type}}</div>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full
                                {{if eq .Status "normal"}}bg-green-100 text-green-800{{end}}
                                {{if eq .Status "needs-repair"}}bg-yellow-100 text-yellow-800{{end}}
                                {{if eq .Status "failed"}}bg-red-100 text-red-800{{end}}">
                                {{.Status}}
                            </span>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white shadow rounded-lg p-4">
                <h3 class="text-lg font-medium mb-3">Quick Actions</h3>
                <div class="space-y-2">
                    <button hx-get="/buildings/{{.Content.BuildingID}}/edit"
                            hx-target="#modal"
                            class="w-full px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">
                        Edit Floor Plan
                    </button>
                    <button onclick="showFailedEquipment()"
                            class="w-full px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
                        Show Failed Equipment
                    </button>
                    <button hx-post="/api/buildings/{{.Content.BuildingID}}/report"
                            class="w-full px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Equipment Details (appears when equipment is clicked) -->
    <div id="equipment-details" class="hidden mt-4">
        <div class="bg-white shadow rounded-lg p-4">
            <div class="flex justify-between items-start">
                <h3 class="text-lg font-medium">Equipment Details</h3>
                <button onclick="closeDetails()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="equipment-details-content" class="mt-3">
                <!-- Equipment details loaded here via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div id="modal"></div>

<script>
// Zoom functionality
let currentZoom = 1;

function zoomIn() {
    currentZoom *= 1.2;
    applyZoom();
}

function zoomOut() {
    currentZoom /= 1.2;
    applyZoom();
}

function resetZoom() {
    currentZoom = 1;
    applyZoom();
}

function applyZoom() {
    const svg = document.querySelector('#floor-plan-svg svg');
    if (svg) {
        svg.style.transform = `scale(${currentZoom})`;
        svg.style.transformOrigin = 'center';
    }
}

// Equipment interaction
function highlightEquipment(equipmentId) {
    // Remove previous highlights
    document.querySelectorAll('.equipment-highlighted').forEach(el => {
        el.classList.remove('equipment-highlighted');
    });
    
    // Highlight in SVG
    const equipment = document.querySelector(`[data-equipment-id="${equipmentId}"]`);
    if (equipment) {
        equipment.classList.add('equipment-highlighted');
        equipment.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Show details
    showEquipmentDetails(equipmentId);
}

function showEquipmentDetails(equipmentId) {
    const detailsDiv = document.getElementById('equipment-details');
    const contentDiv = document.getElementById('equipment-details-content');
    
    // Load details via HTMX
    htmx.ajax('GET', `/api/equipment/${equipmentId}`, {
        target: '#equipment-details-content',
        swap: 'innerHTML'
    });
    
    detailsDiv.classList.remove('hidden');
}

function closeDetails() {
    document.getElementById('equipment-details').classList.add('hidden');
}

function showFailedEquipment() {
    // Highlight all failed equipment
    document.querySelectorAll('.equipment-failed').forEach(el => {
        el.classList.add('animate-pulse');
    });
    
    setTimeout(() => {
        document.querySelectorAll('.equipment-failed').forEach(el => {
            el.classList.remove('animate-pulse');
        });
    }, 3000);
}

// Export functionality
function exportSVG() {
    const svg = document.querySelector('#floor-plan-svg svg');
    if (svg) {
        const svgData = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'floor-plan.svg';
        a.click();
        URL.revokeObjectURL(url);
    }
}

// Fullscreen functionality
function toggleFullscreen() {
    const container = document.getElementById('floor-plan-container');
    if (!document.fullscreenElement) {
        container.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Add click handlers to SVG elements after load
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'floor-plan-svg') {
        // Add click handlers to equipment in SVG
        document.querySelectorAll('.equipment').forEach(el => {
            el.style.cursor = 'pointer';
            el.addEventListener('click', function() {
                const equipmentId = this.dataset.equipmentId;
                highlightEquipment(equipmentId);
            });
        });
        
        // Add hover effects
        document.querySelectorAll('.room').forEach(el => {
            el.style.cursor = 'pointer';
            el.addEventListener('mouseenter', function() {
                this.style.opacity = '0.8';
            });
            el.addEventListener('mouseleave', function() {
                this.style.opacity = '1';
            });
        });
    }
});
</script>

<style>
.equipment-highlighted {
    animation: pulse 2s infinite;
    filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.8));
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
}
</style>
{{end}}