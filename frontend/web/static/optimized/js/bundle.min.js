class AccessControlManager{constructor(){this.baseUrl='/access-control';this.currentUser=null;this.userPermissions=new Map();this.auditLogs=[];this.init();}
async init(){try{await this.loadCurrentUser();await this.loadUserPermissions();this.setupEventListeners();this.setupRealTimeUpdates();}catch(error){console.error('Failed to initialize Access Control Manager:',error);}}
setupEventListeners(){document.addEventListener('DOMContentLoaded',()=>{this.setupUserManagementListeners();this.setupPermissionListeners();this.setupAuditLogListeners();this.setupFloorAccessListeners();});}
setupUserManagementListeners(){const createUserForm=document.getElementById('create-user-form');if(createUserForm){createUserForm.addEventListener('submit',(e)=>{e.preventDefault();this.createUser();});}
const refreshUsersBtn=document.getElementById('refresh-users');if(refreshUsersBtn){refreshUsersBtn.addEventListener('click',()=>this.loadUsers());}
const userSearchInput=document.getElementById('user-search');if(userSearchInput){userSearchInput.addEventListener('input',(e)=>{this.searchUsers(e.target.value);});}}
setupPermissionListeners(){const grantPermissionForm=document.getElementById('grant-permission-form');if(grantPermissionForm){grantPermissionForm.addEventListener('submit',(e)=>{e.preventDefault();this.grantPermission();});}
const checkPermissionForm=document.getElementById('check-permission-form');if(checkPermissionForm){checkPermissionForm.addEventListener('submit',(e)=>{e.preventDefault();this.checkPermission();});}
document.addEventListener('click',(e)=>{if(e.target.classList.contains('revoke-permission-btn')){const permissionId=e.target.dataset.permissionId;this.revokePermission(permissionId);}});}
setupAuditLogListeners(){const auditLogFilters=document.getElementById('audit-log-filters');if(auditLogFilters){auditLogFilters.addEventListener('change',()=>{this.loadAuditLogs();});}
const exportAuditLogsBtn=document.getElementById('export-audit-logs');if(exportAuditLogsBtn){exportAuditLogsBtn.addEventListener('click',()=>this.exportAuditLogs());}}
setupFloorAccessListeners(){const floorAccessSummaryBtn=document.getElementById('floor-access-summary');if(floorAccessSummaryBtn){floorAccessSummaryBtn.addEventListener('click',()=>this.loadFloorAccessSummary());}
const bulkPermissionForm=document.getElementById('bulk-permission-form');if(bulkPermissionForm){bulkPermissionForm.addEventListener('submit',(e)=>{e.preventDefault();this.grantBulkPermissions();});}}
setupRealTimeUpdates(){if(window.accessControlSocket){window.accessControlSocket.addEventListener('message',(event)=>{const data=JSON.parse(event.data);this.handleRealTimeUpdate(data);});}}
async loadCurrentUser(){try{const response=await fetch('/api/auth/current-user');if(response.ok){this.currentUser=await response.json();}}catch(error){console.error('Failed to load current user:',error);}}
async loadUserPermissions(){try{if(!this.currentUser)return;const response=await fetch(`${this.baseUrl}/permissions/role/${this.currentUser.primary_role}`);if(response.ok){const data=await response.json();if(data.success){data.permissions.forEach(permission=>{this.userPermissions.set(`${permission.resource_type}:${permission.resource_id || 'global'}`,permission.permission_level);});}}}catch(error){console.error('Failed to load user permissions:',error);}}
async createUser(){try{const form=document.getElementById('create-user-form');const formData=new FormData(form);const userData={username:formData.get('username'),email:formData.get('email'),primary_role:formData.get('primary_role'),secondary_roles:formData.get('secondary_roles')?.split(',').filter(r=>r.trim())||[],organization:formData.get('organization')||''};const response=await fetch(`${this.baseUrl}/users`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(userData)});const result=await response.json();if(result.success){this.showNotification('User created successfully','success');form.reset();await this.loadUsers();}else{this.showNotification(result.message,'error');}}catch(error){console.error('Failed to create user:',error);this.showNotification('Failed to create user','error');}}
async loadUsers(){try{const response=await fetch(`${this.baseUrl}/users`);const data=await response.json();if(data.success){this.renderUserList(data.users);}else{this.showNotification(data.message,'error');}}catch(error){console.error('Failed to load users:',error);this.showNotification('Failed to load users','error');}}
renderUserList(users){const userListContainer=document.getElementById('user-list');if(!userListContainer)return;userListContainer.innerHTML=users.map(user=>`
            <div class="user-item" data-user-id="${user.user_id}">
                <div class="user-info">
                    <h4>${user.username}</h4>
                    <p>${user.email}</p>
                    <span class="role-badge primary">${user.primary_role}</span>
                    ${user.secondary_roles.map(role => `<span class="role-badge secondary">${role}</span>`).join('')}
                </div>
                <div class="user-actions">
                    <button class="btn btn-sm btn-primary" onclick="accessControlManager.editUser('${user.user_id}')">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="accessControlManager.deleteUser('${user.user_id}')">
                        Delete
                    </button>
                </div>
            </div>
        `).join('');}
async grantPermission(){try{const form=document.getElementById('grant-permission-form');const formData=new FormData(form);const permissionData={role:formData.get('role'),resource_type:formData.get('resource_type'),resource_id:formData.get('resource_id')||null,permission_level:parseInt(formData.get('permission_level')),floor_id:formData.get('floor_id')||null,building_id:formData.get('building_id')||null,expires_at:formData.get('expires_at')||null};const response=await fetch(`${this.baseUrl}/permissions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(permissionData)});const result=await response.json();if(result.success){this.showNotification('Permission granted successfully','success');form.reset();await this.loadPermissions();}else{this.showNotification(result.message,'error');}}catch(error){console.error('Failed to grant permission:',error);this.showNotification('Failed to grant permission','error');}}
async checkPermission(){try{const form=document.getElementById('check-permission-form');const formData=new FormData(form);const checkData={user_id:formData.get('user_id'),resource_type:formData.get('resource_type'),action:formData.get('action'),resource_id:formData.get('resource_id')||null,floor_id:formData.get('floor_id')||null,building_id:formData.get('building_id')||null};const response=await fetch(`${this.baseUrl}/permissions/check`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(checkData)});const result=await response.json();this.showPermissionCheckResult(result);}catch(error){console.error('Failed to check permission:',error);this.showNotification('Failed to check permission','error');}}
showPermissionCheckResult(result){const resultContainer=document.getElementById('permission-check-result');if(!resultContainer)return;if(result.success){resultContainer.innerHTML=`
                <div class="alert alert-success">
                    <h5>Permission Granted</h5>
                    <p>User has sufficient permissions for this action.</p>
                    <small>Permission Level: ${result.permission?.permission_level}</small>
                </div>
            `;}else{resultContainer.innerHTML=`
                <div class="alert alert-danger">
                    <h5>Permission Denied</h5>
                    <p>${result.message}</p>
                </div>
            `;}}
async loadPermissions(){try{const response=await fetch(`${this.baseUrl}/permissions`);const data=await response.json();if(data.success){this.renderPermissionList(data.permissions);}else{this.showNotification(data.message,'error');}}catch(error){console.error('Failed to load permissions:',error);this.showNotification('Failed to load permissions','error');}}
renderPermissionList(permissions){const permissionListContainer=document.getElementById('permission-list');if(!permissionListContainer)return;permissionListContainer.innerHTML=permissions.map(permission=>`
            <div class="permission-item" data-permission-id="${permission.permission_id}">
                <div class="permission-info">
                    <h5>${permission.role} - ${permission.resource_type}</h5>
                    <p>Level: ${permission.permission_level}</p>
                    ${permission.resource_id ? `<p>Resource:${permission.resource_id}</p>` : ''}
                    ${permission.floor_id ? `<p>Floor:${permission.floor_id}</p>` : ''}
                    <small>Created: ${new Date(permission.created_at).toLocaleDateString()}</small>
                </div>
                <div class="permission-actions">
                    <button class="btn btn-sm btn-danger revoke-permission-btn"
                            data-permission-id="${permission.permission_id}">
                        Revoke
                    </button>
                </div>
            </div>
        `).join('');}
async revokePermission(permissionId){try{if(!confirm('Are you sure you want to revoke this permission?')){return;}
const response=await fetch(`${this.baseUrl}/permissions/${permissionId}`,{method:'DELETE'});const result=await response.json();if(result.success){this.showNotification('Permission revoked successfully','success');await this.loadPermissions();}else{this.showNotification(result.message,'error');}}catch(error){console.error('Failed to revoke permission:',error);this.showNotification('Failed to revoke permission','error');}}
async loadAuditLogs(){try{const filters=this.getAuditLogFilters();const queryParams=new URLSearchParams(filters);const response=await fetch(`${this.baseUrl}/audit-logs?${queryParams}`);const data=await response.json();if(data.success){this.renderAuditLogs(data.logs);}else{this.showNotification(data.message,'error');}}catch(error){console.error('Failed to load audit logs:',error);this.showNotification('Failed to load audit logs','error');}}
getAuditLogFilters(){const filters={};const form=document.getElementById('audit-log-filters');if(form){const formData=new FormData(form);for(const[key,value]of formData.entries()){if(value)filters[key]=value;}}
return filters;}
renderAuditLogs(logs){const auditLogContainer=document.getElementById('audit-logs');if(!auditLogContainer)return;auditLogContainer.innerHTML=logs.map(log=>`
            <div class="audit-log-item ${log.success ? 'success' : 'error'}" data-log-id="${log.log_id}">
                <div class="log-header">
                    <span class="log-action">${log.action}</span>
                    <span class="log-resource">${log.resource_type}: ${log.resource_id}</span>
                    <span class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</span>
                </div>
                <div class="log-details">
                    <p><strong>User:</strong> ${log.user_id}</p>
                    ${log.floor_id ? `<p><strong>Floor:</strong>${log.floor_id}</p>` : ''}
                    ${log.building_id ? `<p><strong>Building:</strong>${log.building_id}</p>` : ''}
                    ${log.ip_address ? `<p><strong>IP:</strong>${log.ip_address}</p>` : ''}
                    ${log.error_message ? `<p class="error-message"><strong>Error:</strong>${log.error_message}</p>` : ''}
                </div>
                ${Object.keys(log.details).length > 0 ? `<div class="log-metadata"><details><summary>Additional Details</summary><pre>${JSON.stringify(log.details,null,2)}</pre></details></div>` : ''}
            </div>
        `).join('');}
async exportAuditLogs(){try{const filters=this.getAuditLogFilters();const queryParams=new URLSearchParams(filters);const response=await fetch(`${this.baseUrl}/audit-logs/export?${queryParams}`);const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`audit-logs-${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(url);this.showNotification('Audit logs exported successfully','success');}catch(error){console.error('Failed to export audit logs:',error);this.showNotification('Failed to export audit logs','error');}}
async loadFloorAccessSummary(){try{const buildingId=document.getElementById('building-id')?.value;const floorId=document.getElementById('floor-id')?.value;if(!buildingId||!floorId){this.showNotification('Please provide building ID and floor ID','error');return;}
const response=await fetch(`${this.baseUrl}/floors/${buildingId}/${floorId}/access-summary`);const data=await response.json();if(data.success){this.renderFloorAccessSummary(data);}else{this.showNotification(data.message,'error');}}catch(error){console.error('Failed to load floor access summary:',error);this.showNotification('Failed to load floor access summary','error');}}
renderFloorAccessSummary(data){const summaryContainer=document.getElementById('floor-access-summary');if(!summaryContainer)return;summaryContainer.innerHTML=`
            <div class="access-summary">
                <h4>Access Summary for Floor ${data.floor_id}</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-number">${data.permission_count}</span>
                        <span class="stat-label">Permissions</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.activity_count}</span>
                        <span class="stat-label">Recent Activities</span>
                    </div>
                </div>

                <div class="permissions-section">
                    <h5>Floor Permissions</h5>
                    <div class="permission-list">
                        ${data.permissions.map(permission => `<div class="permission-item"><span class="role">${permission.role}</span><span class="resource">${permission.resource_type}</span><span class="level">Level ${permission.permission_level}</span></div>`).join('')}
                    </div>
                </div>

                <div class="activity-section">
                    <h5>Recent Activity</h5>
                    <div class="activity-list">
                        ${data.recent_activity.map(activity => `<div class="activity-item"><span class="action">${activity.action}</span><span class="user">${activity.user_id}</span><span class="time">${new Date(activity.timestamp).toLocaleString()}</span></div>`).join('')}
                    </div>
                </div>
            </div>
        `;}
async grantBulkPermissions(){try{const form=document.getElementById('bulk-permission-form');const formData=new FormData(form);const buildingId=formData.get('building_id');const floorId=formData.get('floor_id');const permissionsData=JSON.parse(formData.get('permissions')||'[]');if(!buildingId||!floorId||permissionsData.length===0){this.showNotification('Please provide building ID, floor ID, and permissions','error');return;}
const response=await fetch(`${this.baseUrl}/floors/${buildingId}/${floorId}/permissions/bulk`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(permissionsData)});const result=await response.json();if(result.success){this.showNotification(`Granted ${result.total} permissions successfully`,'success');form.reset();await this.loadFloorAccessSummary();}else{this.showNotification(result.message,'error');}}catch(error){console.error('Failed to grant bulk permissions:',error);this.showNotification('Failed to grant bulk permissions','error');}}
handleRealTimeUpdate(data){switch(data.type){case'permission_granted':this.showNotification(`Permission granted to ${data.role}`,'info');this.loadPermissions();break;case'permission_revoked':this.showNotification(`Permission revoked from ${data.role}`,'info');this.loadPermissions();break;case'user_created':this.showNotification(`User ${data.username} created`,'info');this.loadUsers();break;case'audit_log':this.showNotification(`New activity: ${data.action}`,'info');this.loadAuditLogs();break;}}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`notification notification-${type}`;notification.innerHTML=`
            <span class="message">${message}</span>
            <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
        `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},5000);}
hasPermission(resourceType,action,resourceId=null){const key=`${resourceType}:${resourceId || 'global'}`;const permissionLevel=this.userPermissions.get(key);if(!permissionLevel)return false;const requiredLevel=this.getRequiredPermissionLevel(action);return permissionLevel>=requiredLevel;}
getRequiredPermissionLevel(action){const actionLevels={'read':1,'create':2,'update':2,'delete':3,'export':1,'import':2,'merge':2,'branch':2,'annotate':2,'comment':2,'approve':3,'reject':3,'assign':3,'transfer':3};return actionLevels[action]||3;}
logActivity(action,resourceType,resourceId,details={}){if(!this.currentUser)return;const activityData={user_id:this.currentUser.user_id,action:action,resource_type:resourceType,resource_id:resourceId,details:details,ip_address:this.getClientIP(),user_agent:navigator.userAgent};fetch(`${this.baseUrl}/audit-logs`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(activityData)}).catch(error=>{console.error('Failed to log activity:',error);});}
getClientIP(){return'unknown';}}
const accessControlManager=new AccessControlManager();window.accessControlManager=accessControlManager;class ArxLogger{constructor(options={}){this.service=options.service||'arx-web-frontend';this.version=options.version||'1.0.0';this.environment=options.environment||'development';this.logLevel=options.logLevel||'info';this.enableRemoteLogging=options.enableRemoteLogging||false;this.remoteEndpoint=options.remoteEndpoint||'/api/logs/aggregate';this.batchSize=options.batchSize||10;this.batchTimeout=options.batchTimeout||5000;this.levels={debug:0,info:1,warning:2,error:3,critical:4};this.correlationId=null;this.requestId=null;this.userId=null;this.sessionId=null;this.buildingId=null;this.floorId=null;this.logBatch=[];this.batchTimer=null;this.performanceStats={};this._generateSessionId();this._setupErrorHandling();this._startBatchTimer();}
_generateSessionId(){this.sessionId='session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
generateCorrelationId(){this.correlationId='corr_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);return this.correlationId;}
generateRequestId(){this.requestId='req_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);return this.requestId;}
setContext(context){if(context.correlationId)this.correlationId=context.correlationId;if(context.requestId)this.requestId=context.requestId;if(context.userId)this.userId=context.userId;if(context.buildingId)this.buildingId=context.buildingId;if(context.floorId)this.floorId=context.floorId;}
clearContext(){this.correlationId=null;this.requestId=null;this.userId=null;this.buildingId=null;this.floorId=null;}
_shouldLog(level){return this.levels[level]>=this.levels[this.logLevel];}
_createLogEntry(level,message,metadata={}){const entry={timestamp:new Date().toISOString(),level:level,message:message,service:this.service,version:this.version,environment:this.environment,correlation_id:this.correlationId,request_id:this.requestId,user_id:this.userId,session_id:this.sessionId,building_id:this.buildingId,floor_id:this.floorId,url:window.location.href,user_agent:navigator.userAgent,metadata:metadata};if(metadata.performance){entry.performance=metadata.performance;}
return entry;}
_log(level,message,metadata={}){if(!this._shouldLog(level))return;const entry=this._createLogEntry(level,message,metadata);const consoleMethod=level==='error'?'error':level==='warning'?'warn':level==='debug'?'debug':'log';console[consoleMethod](`[${level.toUpperCase()}] ${message}`,entry);if(this.enableRemoteLogging){this._addToBatch(entry);}}
_addToBatch(entry){this.logBatch.push(entry);if(this.logBatch.length>=this.batchSize){this._sendBatch();}}
async _sendBatch(){if(this.logBatch.length===0)return;const batch=[...this.logBatch];this.logBatch=[];try{const response=await fetch(this.remoteEndpoint,{method:'POST',headers:{'Content-Type':'application/json','Authorization':localStorage.getItem('arx_jwt')?'Bearer '+localStorage.getItem('arx_jwt'):''},body:JSON.stringify(batch)});if(!response.ok){console.warn('Failed to send logs to remote endpoint:',response.status);}}catch(error){console.warn('Error sending logs to remote endpoint:',error);}}
_startBatchTimer(){this.batchTimer=setInterval(()=>{if(this.logBatch.length>0){this._sendBatch();}},this.batchTimeout);}
_setupErrorHandling(){window.addEventListener('unhandledrejection',(event)=>{this.error('Unhandled promise rejection',{reason:event.reason,stack:event.reason?.stack});});window.addEventListener('error',(event)=>{this.error('JavaScript error',{message:event.message,filename:event.filename,lineno:event.lineno,colno:event.colno,error:event.error?.stack});});window.addEventListener('error',(event)=>{if(event.target!==window){this.error('Resource loading error',{type:event.target.tagName,src:event.target.src||event.target.href,message:event.message});}},true);}
debug(message,metadata={}){this._log('debug',message,metadata);}
info(message,metadata={}){this._log('info',message,metadata);}
warning(message,metadata={}){this._log('warning',message,metadata);}
error(message,metadata={}){this._log('error',message,metadata);}
critical(message,metadata={}){this._log('critical',message,metadata);}
logApiRequest(method,url,statusCode,duration,responseSize=0,metadata={}){this.info(`API Request: ${method} ${url} - ${statusCode} (${duration.toFixed(3)}s)`,{method,url,status_code:statusCode,duration,response_size:responseSize,...metadata});}
logApiError(method,url,statusCode,error,duration=0,metadata={}){this.error(`API Error: ${method} ${url} - ${statusCode}`,{method,url,status_code:statusCode,duration,error_message:error.message,error_stack:error.stack,...metadata});}
logBusinessEvent(eventType,eventName,metrics={},metadata={}){this.info(`Business Event: ${eventType} - ${eventName}`,{event_type:eventType,event_name:eventName,metrics,...metadata});}
logPerformance(operation,duration,metadata={}){this.info(`Performance: ${operation} - ${duration.toFixed(3)}s`,{operation,duration,...metadata});if(!this.performanceStats[operation]){this.performanceStats[operation]={count:0,totalTime:0,minTime:Infinity,maxTime:0,avgTime:0};}
const stats=this.performanceStats[operation];stats.count++;stats.totalTime+=duration;stats.minTime=Math.min(stats.minTime,duration);stats.maxTime=Math.max(stats.maxTime,duration);stats.avgTime=stats.totalTime/stats.count;}
getPerformanceStats(){return this.performanceStats;}
logUserInteraction(action,element,metadata={}){this.info(`User Interaction: ${action}`,{action,element:element.tagName||element,element_id:element.id,element_class:element.className,...metadata});}
logPageNavigation(fromPage,toPage,metadata={}){this.info(`Page Navigation: ${fromPage} -> ${toPage}`,{from_page:fromPage,to_page:toPage,...metadata});}
logFormSubmission(formName,success,metadata={}){this.info(`Form Submission: ${formName} - ${success ? 'SUCCESS' : 'FAILED'}`,{form_name:formName,success,...metadata});}
logAssetOperation(operation,assetId,assetType,metadata={}){this.info(`Asset Operation: ${operation}`,{operation,asset_id:assetId,asset_type:assetType,...metadata});}
performanceTracker(operationName=null){return(target,propertyKey,descriptor)=>{const method=descriptor.value;const opName=operationName||`${target.constructor.name}.${propertyKey}`;descriptor.value=async function(...args){const startTime=performance.now();try{const result=await method.apply(this,args);const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.logPerformance(opName,duration);}
return result;}catch(error){const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.logPerformance(opName,duration,{error:error.message});}
throw error;}};return descriptor;};}
async cleanup(){if(this.batchTimer){clearInterval(this.batchTimer);}
if(this.logBatch.length>0){await this._sendBatch();}}}
window.arxLogger=new ArxLogger({service:'arx-web-frontend',version:'1.0.0',environment:window.location.hostname==='localhost'?'development':'production',logLevel:'info',enableRemoteLogging:true,remoteEndpoint:'/api/logs/aggregate'});if(typeof module!=='undefined'&&module.exports){module.exports=ArxLogger;}
let assets=[];let currentPage=1;let pageSize=20;let sortField='id';let sortAsc=true;let charts={};function loadAssets(){const building=document.getElementById('filter-building').value;const system=document.getElementById('filter-system').value;const assetType=document.getElementById('filter-asset-type').value;const room=document.getElementById('filter-room').value;const status=document.getElementById('filter-status').value;let url=`/api/buildings/${building}/assets?`;if(system)url+=`system=${encodeURIComponent(system)}&`;if(assetType)url+=`assetType=${encodeURIComponent(assetType)}&`;if(room)url+=`roomId=${encodeURIComponent(room)}&`;if(status)url+=`status=${encodeURIComponent(status)}&`;const startTime=performance.now();if(window.arxLogger){window.arxLogger.info('Loading assets',{building_id:building,filters:{system,assetType,room,status},url:url});}
fetch(url,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET',url,res.status,duration);}
return res.json();}).then(data=>{assets=data;currentPage=1;renderAssetTable();updateSummaryCards();renderCharts();if(window.arxLogger){window.arxLogger.businessEvent('asset_inventory','assets_loaded',{asset_count:data.length,building_id:building,filters:{system,assetType,room,status},page_size:pageSize});}}).catch(error=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiError('GET',url,error,0);window.arxLogger.error('Failed to load assets',{building_id:building,filters:{system,assetType,room,status},error:error.message});}});}
function renderAssetTable(){const startTime=performance.now();let sorted=[...assets];sorted.sort((a,b)=>{let v1=a[sortField],v2=b[sortField];if(typeof v1==='string')v1=v1.toLowerCase();if(typeof v2==='string')v2=v2.toLowerCase();if(v1<v2)return sortAsc?-1:1;if(v1>v2)return sortAsc?1:-1;return 0;});const start=(currentPage-1)*pageSize;const end=start+pageSize;const pageAssets=sorted.slice(start,end);const tbody=document.getElementById('asset-table-body');tbody.innerHTML='';for(const asset of pageAssets){const tr=document.createElement('tr');tr.innerHTML=`
      <td class="px-2 py-1"><input type="checkbox" class="asset-checkbox" value="${asset.id}"></td>
      <td class="px-2 py-1">${asset.id}</td>
      <td class="px-2 py-1">${asset.asset_type}</td>
      <td class="px-2 py-1">${asset.system}</td>
      <td class="px-2 py-1">${asset.location && asset.location.room ? asset.location.room : ''}</td>
      <td class="px-2 py-1">${asset.age ?? ''}</td>
      <td class="px-2 py-1">${asset.efficiency_rating ?? ''}</td>
      <td class="px-2 py-1">${asset.status ?? ''}</td>
      <td class="px-2 py-1">${asset.estimated_value ? '$' + asset.estimated_value.toLocaleString() : ''}</td>
      <td class="px-2 py-1">
        <button class="text-blue-600 hover:underline" onclick="openAssetModal('${asset.id}')">View</button>
      </td>
    `;tbody.appendChild(tr);}
document.getElementById('asset-count').textContent=`${assets.length} assets`;document.getElementById('page-info').textContent=`Page ${currentPage} of ${Math.ceil(assets.length / pageSize)}`;const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.performance('render_asset_table',duration,{total_assets:assets.length,page_assets:pageAssets.length,current_page:currentPage,sort_field:sortField,sort_ascending:sortAsc});}}
function sortAssets(field){if(window.arxLogger){window.arxLogger.info('Sorting assets',{field:field,previous_field:sortField,previous_ascending:sortAsc});}
if(sortField===field){sortAsc=!sortAsc;}else{sortField=field;sortAsc=true;}
renderAssetTable();}
function prevPage(){if(currentPage>1){if(window.arxLogger){window.arxLogger.info('Navigating to previous page',{from_page:currentPage,to_page:currentPage-1});}
currentPage--;renderAssetTable();}}
function nextPage(){if(currentPage<Math.ceil(assets.length/pageSize)){if(window.arxLogger){window.arxLogger.info('Navigating to next page',{from_page:currentPage,to_page:currentPage+1});}
currentPage++;renderAssetTable();}}
function toggleSelectAllAssets(){const checked=document.getElementById('select-all-assets').checked;const checkboxes=document.querySelectorAll('.asset-checkbox');const checkedCount=checked?checkboxes.length:0;checkboxes.forEach(cb=>cb.checked=checked);if(window.arxLogger){window.arxLogger.info('Toggled select all assets',{selected:checked,total_assets:checkboxes.length,selected_count:checkedCount});}}
function exportAssets(format){const building=document.getElementById('filter-building').value;let url=`/api/buildings/${building}/inventory/export?format=${format}`;if(window.arxLogger){window.arxLogger.info('Exporting assets',{format:format,building_id:building,url:url});}
window.open(url,'_blank');}
function exportAssetsAdvanced(){const building=document.getElementById('filter-building').value;const format=document.getElementById('export-format').value;const system=document.getElementById('export-system').value;const status=document.getElementById('export-status').value;const dateFrom=document.getElementById('export-date-from').value;const dateTo=document.getElementById('export-date-to').value;const includeHistory=document.getElementById('export-include-history').checked;const includeMaintenance=document.getElementById('export-include-maintenance').checked;const includeValuations=document.getElementById('export-include-valuations').checked;let url=`/api/buildings/${building}/inventory/export?format=${format}`;if(system)url+=`&system=${encodeURIComponent(system)}`;if(status)url+=`&status=${encodeURIComponent(status)}`;if(dateFrom)url+=`&dateFrom=${encodeURIComponent(dateFrom)}`;if(dateTo)url+=`&dateTo=${encodeURIComponent(dateTo)}`;if(includeHistory)url+=`&includeHistory=true`;if(includeMaintenance)url+=`&includeMaintenance=true`;if(includeValuations)url+=`&includeValuations=true`;const progress=document.getElementById('export-progress');progress.textContent='Preparing export...';const startTime=performance.now();if(window.arxLogger){window.arxLogger.info('Starting advanced asset export',{format:format,building_id:building,filters:{system,status,dateFrom,dateTo},options:{includeHistory,includeMaintenance,includeValuations},url:url});}
fetch(url,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET',url,res.status,duration);}
if(!res.ok)throw new Error('Export failed');progress.textContent='Downloading...';return res.blob();}).then(blob=>{const a=document.createElement('a');a.href=window.URL.createObjectURL(blob);a.download=`asset_inventory_export.${format}`;document.body.appendChild(a);a.click();a.remove();progress.textContent='Download complete.';setTimeout(()=>{progress.textContent='';},2000);showToast('Export complete.','success');if(window.arxLogger){window.arxLogger.businessEvent('asset_inventory','export_completed',{format:format,building_id:building,file_size:blob.size});}}).catch((error)=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiError('GET',url,error,0);window.arxLogger.error('Asset export failed',{format:format,building_id:building,error:error.message});}
progress.textContent='Export failed.';setTimeout(()=>{progress.textContent='';},2000);showToast('Export failed.','error');});}
function deleteSelectedAssets(){const selected=Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb=>cb.value);if(selected.length===0){if(window.arxLogger){window.arxLogger.warn('No assets selected for deletion');}
return alert('No assets selected.');}
if(!confirm(`Delete ${selected.length} assets?`)){if(window.arxLogger){window.arxLogger.info('Asset deletion cancelled by user',{selected_count:selected.length});}
return;}
if(window.arxLogger){window.arxLogger.info('Deleting selected assets',{selected_count:selected.length,asset_ids:selected});}
const startTime=performance.now();Promise.all(selected.map(id=>fetch(`/api/assets/${id}`,{method:'DELETE',headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}))).then((responses)=>{const duration=performance.now()-startTime;const successCount=responses.filter(r=>r.ok).length;const failureCount=responses.length-successCount;if(window.arxLogger){window.arxLogger.businessEvent('asset_inventory','assets_deleted',{total_requested:selected.length,success_count:successCount,failure_count:failureCount,duration_ms:duration});}
loadAssets();showToast('Assets deleted successfully.','success');}).catch((error)=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.error('Failed to delete assets',{selected_count:selected.length,error:error.message,duration_ms:duration});}
showToast('Failed to delete assets.','error');});}
function openAssetModal(assetId){const modal=document.getElementById('asset-modal');modal.classList.remove('hidden');if(window.arxLogger){window.arxLogger.info('Opening asset modal',{asset_id:assetId});}
if(assetId){const startTime=performance.now();fetch(`/api/assets/${assetId}`,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET',`/api/assets/${assetId}`,res.status,duration);}
return res.json();}).then(asset=>{document.getElementById('asset-modal-title').textContent=`Edit Asset: ${asset.id}`;renderAssetForm(asset,true);loadAssetDetails(asset);if(window.arxLogger){window.arxLogger.info('Asset details loaded',{asset_id:asset.id,asset_type:asset.asset_type,system:asset.system});}
if(asset.symbol_id){addHighlightOnSVGButton(asset);}}).catch(error=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiError('GET',`/api/assets/${assetId}`,error,0);window.arxLogger.error('Failed to load asset details',{asset_id:assetId,error:error.message});}});}else{document.getElementById('asset-modal-title').textContent='Add New Asset';renderAssetForm({},false);clearAssetDetails();}}
function renderAssetForm(asset,isEdit){if(window.arxLogger){window.arxLogger.info('Rendering asset form',{is_edit:isEdit,asset_id:asset.id||null});}
const startTime=performance.now();fetch('/api/buildings',{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET','/api/buildings',res.status,duration);}
return res.json();}).then(buildings=>{let buildingOptions='<option value="">-- Select --</option>';for(const b of buildings){buildingOptions+=`<option value="${b.id}"${asset.building_id == b.id ? ' selected' : ''}>${b.name}</option>`;}
document.getElementById('asset-form').innerHTML=`
        <label class="block">Building:
          <select id="asset-building" class="border rounded p-2 w-full" onchange="loadFloorsForAsset()">${buildingOptions}</select>
        </label>
        <label class="block">Floor:
          <select id="asset-floor" class="border rounded p-2 w-full"></select>
        </label>
        <label class="block">Room:
          <input id="asset-room" class="border rounded p-2 w-full" value="${asset.room_id ?? ''}">
        </label>
        <label class="block">Asset Type:
          <input id="asset-type" class="border rounded p-2 w-full" value="${asset.asset_type ?? ''}" required>
        </label>
        <label class="block">System:
          <input id="asset-system" class="border rounded p-2 w-full" value="${asset.system ?? ''}" required>
        </label>
        <label class="block">Location X:
          <input id="asset-x" type="number" step="any" class="border rounded p-2 w-full" value="${asset.location?.x ?? ''}">
        </label>
        <label class="block">Location Y:
          <input id="asset-y" type="number" step="any" class="border rounded p-2 w-full" value="${asset.location?.y ?? ''}">
        </label>
        <label class="block">Specifications (JSON):
          <textarea id="asset-specs" class="border rounded p-2 w-full" rows="3">${asset.specifications ? JSON.stringify(asset.specifications, null, 2) : ''}</textarea>
          <span id="specs-error" class="text-red-600 text-xs"></span>
        </label>
        <label class="block">Estimated Value:
          <input id="asset-value" type="number" step="any" class="border rounded p-2 w-full" value="${asset.estimated_value ?? ''}">
        </label>
        <label class="block">Replacement Cost:
          <input id="asset-replacement" type="number" step="any" class="border rounded p-2 w-full" value="${asset.replacement_cost ?? ''}">
        </label>
        <label class="block">Funding Source:
          <input id="asset-funding-source" type="text" class="border rounded p-2 w-full" value="${asset.funding_source ?? ''}" placeholder="e.g., Capital Budget, Grant, Operating Budget">
        </label>
        <label class="block">Status:
          <select id="asset-status" class="border rounded p-2 w-full">
            <option value="active"${asset.status === 'active' ? ' selected' : ''}>Active</option>
            <option value="inactive"${asset.status === 'inactive' ? ' selected' : ''}>Inactive</option>
            <option value="retired"${asset.status === 'retired' ? ' selected' : ''}>Retired</option>
          </select>
        </label>
        <div class="flex gap-4 mt-4">
          <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" onclick="submitAssetForm(${isEdit ? `'${asset.id}'` : ''})">${isEdit ? 'Save Changes' : 'Create Asset'}</button>
          <button type="button" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400" onclick="closeAssetModal()">Cancel</button>
        </div>
      `;if(asset.building_id){loadFloorsForAsset(asset.floor_id);}
if(window.arxLogger){window.arxLogger.info('Asset form rendered',{building_count:buildings.length,is_edit:isEdit,asset_id:asset.id||null});}});}
function loadFloorsForAsset(selectedFloorId){const buildingId=document.getElementById('asset-building').value;const floorSelect=document.getElementById('asset-floor');floorSelect.innerHTML='<option value="">-- Select --</option>';if(window.arxLogger){window.arxLogger.info('Loading floors for asset',{building_id:buildingId,selected_floor_id:selectedFloorId});}
if(buildingId){const startTime=performance.now();fetch(`/api/buildings/${buildingId}/floors`,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET',`/api/buildings/${buildingId}/floors`,res.status,duration);}
return res.json();}).then(floors=>{for(const f of floors){floorSelect.innerHTML+=`<option value="${f.id}"${selectedFloorId == f.id ? ' selected' : ''}>${f.name}</option>`;}
if(window.arxLogger){window.arxLogger.info('Floors loaded for asset',{building_id:buildingId,floor_count:floors.length,selected_floor_id:selectedFloorId});}});}}
function submitAssetForm(assetId){if(window.arxLogger){window.arxLogger.info('Submitting asset form',{is_edit:!!assetId,asset_id:assetId||null});}
const buildingId=document.getElementById('asset-building').value;const floorId=document.getElementById('asset-floor').value;const roomId=document.getElementById('asset-room').value;const assetType=document.getElementById('asset-type').value;const system=document.getElementById('asset-system').value;const x=parseFloat(document.getElementById('asset-x').value);const y=parseFloat(document.getElementById('asset-y').value);const specsText=document.getElementById('asset-specs').value;const value=parseFloat(document.getElementById('asset-value').value);const replacement=parseFloat(document.getElementById('asset-replacement').value);const fundingSource=document.getElementById('asset-funding-source').value;const status=document.getElementById('asset-status').value;let specifications;try{specifications=specsText?JSON.parse(specsText):{};document.getElementById('specs-error').textContent='';}catch(e){if(window.arxLogger){window.arxLogger.error('Invalid JSON in asset specifications',{error:e.message,specs_text:specsText});}
document.getElementById('specs-error').textContent='Invalid JSON';showToast('Specifications must be valid JSON.','error');return;}
if(!buildingId||!assetType||!system){if(window.arxLogger){window.arxLogger.warn('Asset form validation failed',{building_id:buildingId,asset_type:assetType,system:system});}
alert('Building, Asset Type, and System are required.');return;}
const assetData={building_id:buildingId,floor_id:floorId,room_id:roomId,asset_type:assetType,system:system,location:{x,y},specifications,estimated_value:isNaN(value)?null:value,replacement_cost:isNaN(replacement)?null:replacement,funding_source:fundingSource,status:status};const method=assetId?'PUT':'POST';const url=assetId?`/api/assets/${assetId}`:`/api/buildings/${buildingId}/assets`;const startTime=performance.now();if(window.arxLogger){window.arxLogger.info('Submitting asset data',{method:method,url:url,asset_data:{building_id:buildingId,floor_id:floorId,asset_type:assetType,system:system,funding_source:fundingSource,status:status}});}
fetch(url,{method,headers:{'Content-Type':'application/json',...(localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{})},body:JSON.stringify(assetData)}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest(method,url,res.status,duration);}
if(res.ok){closeAssetModal();loadAssets();if(window.arxLogger){window.arxLogger.businessEvent('asset_inventory',assetId?'asset_updated':'asset_created',{asset_id:assetId||'new',building_id:buildingId,asset_type:assetType,system:system,funding_source:fundingSource});}
showToast(assetId?'Asset updated successfully.':'Asset created successfully.','success');}else{res.text().then(t=>{if(window.arxLogger){window.arxLogger.error('Asset submission failed',{method:method,url:url,status:res.status,error:t});}
alert('Error: '+t);});}}).catch(error=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiError(method,url,error,0);window.arxLogger.error('Asset submission failed',{method:method,url:url,error:error.message,duration_ms:duration});}});}
function loadAssetDetails(asset){if(window.arxLogger){window.arxLogger.info('Loading asset details',{asset_id:asset.id,asset_type:asset.asset_type});}
const startTime=performance.now();fetch(`/api/assets/${asset.id}/history`,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>{const duration=performance.now()-startTime;if(window.arxLogger){window.arxLogger.apiRequest('GET',`/api/assets/${asset.id}/history`,res.status,duration);}
return res.json();}).then(history=>{document.getElementById('asset-history-timeline').innerHTML=history.map(h=>`<div>${h.event_type}: ${h.description} (${new Date(h.event_date).toLocaleDateString()})</div>`).join('')||'<div class="text-gray-400">No history records.</div>';}).catch(()=>{document.getElementById('asset-history-timeline').innerHTML='<div class="text-red-500">Failed to load history.</div>';});fetch(`/api/assets/${asset.id}/maintenance`,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>res.json()).then(maint=>{document.getElementById('asset-maintenance-records').innerHTML=maint.map(m=>`<div>${m.maintenance_type}: ${m.description} (${new Date(m.scheduled_date).toLocaleDateString()})</div>`).join('')||'<div class="text-gray-400">No maintenance records.</div>';}).catch(()=>{document.getElementById('asset-maintenance-records').innerHTML='<div class="text-red-500">Failed to load maintenance.</div>';});fetch(`/api/assets/${asset.id}/valuations`,{headers:localStorage.getItem('arx_jwt')?{'Authorization':'Bearer '+localStorage.getItem('arx_jwt')}:{}}).then(res=>res.json()).then(vals=>{document.getElementById('asset-valuation-history').innerHTML=vals.map(v=>`<div>${v.valuation_type}: $${v.value} (${new Date(v.valuation_date).toLocaleDateString()})</div>`).join('')||'<div class="text-gray-400">No valuation records.</div>';}).catch(()=>{document.getElementById('asset-valuation-history').innerHTML='<div class="text-red-500">Failed to load valuations.</div>';});document.getElementById('asset-documents').innerHTML='<div class="text-gray-400">No documents linked.</div>';}
function clearAssetDetails(){document.getElementById('asset-history-timeline').textContent='';document.getElementById('asset-maintenance-records').textContent='';document.getElementById('asset-valuation-history').textContent='';document.getElementById('asset-documents').textContent='';}
function closeAssetModal(){document.getElementById('asset-modal').classList.add('hidden');}
function updateSummaryCards(){const totalAssets=assets.length;const totalValue=assets.reduce((sum,asset)=>sum+(asset.estimated_value||0),0);const avgAge=assets.length>0?assets.reduce((sum,asset)=>sum+(asset.age||0),0)/assets.length:0;const activeAssets=assets.filter(asset=>asset.status==='active').length;const activePercentage=totalAssets>0?Math.round((activeAssets/totalAssets)*100):0;const building=document.getElementById('filter-building');const buildingName=building.options[building.selectedIndex]?.text||'All Buildings';document.getElementById('total-assets').textContent=totalAssets;document.getElementById('total-assets-building').textContent=buildingName;document.getElementById('total-value').textContent='$'+totalValue.toLocaleString();document.getElementById('avg-age').textContent=Math.round(avgAge);document.getElementById('active-assets').textContent=activeAssets;document.getElementById('active-percentage').textContent=`${activePercentage}% of total`;}
function renderCharts(){Object.values(charts).forEach(chart=>{if(chart&&typeof chart.destroy==='function'){chart.destroy();}});charts={};renderSystemChart();renderAgeChart();renderEfficiencyChart();renderMaintenanceChart();}
function renderSystemChart(){const ctx=document.getElementById('system-chart').getContext('2d');const systemCounts={};assets.forEach(asset=>{systemCounts[asset.system]=(systemCounts[asset.system]||0)+1;});charts.systemChart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(systemCounts),datasets:[{data:Object.values(systemCounts),backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});}
function renderAgeChart(){const ctx=document.getElementById('age-chart').getContext('2d');const ageRanges={'0-5':0,'6-10':0,'11-15':0,'16-20':0,'20+':0};assets.forEach(asset=>{const age=asset.age||0;if(age<=5)ageRanges['0-5']++;else if(age<=10)ageRanges['6-10']++;else if(age<=15)ageRanges['11-15']++;else if(age<=20)ageRanges['16-20']++;else ageRanges['20+']++;});charts.ageChart=new Chart(ctx,{type:'bar',data:{labels:Object.keys(ageRanges),datasets:[{label:'Number of Assets',data:Object.values(ageRanges),backgroundColor:'#36A2EB'}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});}
function renderEfficiencyChart(){const ctx=document.getElementById('efficiency-chart').getContext('2d');const efficiencyRanges={'0-50%':0,'51-75%':0,'76-90%':0,'91-100%':0};assets.forEach(asset=>{const efficiency=parseFloat(asset.efficiency_rating?.replace('%','')||'0');if(efficiency<=50)efficiencyRanges['0-50%']++;else if(efficiency<=75)efficiencyRanges['51-75%']++;else if(efficiency<=90)efficiencyRanges['76-90%']++;else efficiencyRanges['91-100%']++;});charts.efficiencyChart=new Chart(ctx,{type:'pie',data:{labels:Object.keys(efficiencyRanges),datasets:[{data:Object.values(efficiencyRanges),backgroundColor:['#FF6384','#FFCE56','#36A2EB','#4BC0C0']}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});}
function renderMaintenanceChart(){const ctx=document.getElementById('maintenance-chart').getContext('2d');const months=['Jan','Feb','Mar','Apr','May','Jun'];const costs=[1200,1900,3000,5000,2000,3000];charts.maintenanceChart=new Chart(ctx,{type:'line',data:{labels:months,datasets:[{label:'Maintenance Costs ($)',data:costs,borderColor:'#FF6384',backgroundColor:'rgba(255, 99, 132, 0.1)',tension:0.1}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});}
function addHighlightOnSVGButton(asset){const modalTitle=document.getElementById('asset-modal-title');const existingButton=document.getElementById('highlight-svg-button');if(existingButton){existingButton.remove();}
const highlightButton=document.createElement('button');highlightButton.id='highlight-svg-button';highlightButton.className='ml-2 bg-blue-500 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded';highlightButton.textContent='Show on SVG';highlightButton.onclick=()=>highlightAssetOnSVG(asset.id);modalTitle.appendChild(highlightButton);}
function highlightAssetOnSVG(assetId){window.open(`/svg_view.html?asset=${assetId}`,'_blank');}
function showAssetTab(tab){document.querySelectorAll('.asset-tab-content').forEach(el=>el.classList.add('hidden'));document.getElementById(`asset-tab-${tab}`).classList.remove('hidden');}
function showToast(message,type='info'){if(window.arxLogger){window.arxLogger.info('Showing toast message',{message:message,type:type});}
const toastArea=document.getElementById('toast-area');const toast=document.createElement('div');toast.className=`px-4 py-2 rounded shadow text-white mb-2 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;toast.textContent=message;toastArea.appendChild(toast);setTimeout(()=>toast.remove(),4000);}
function addAssetFromSymbol(){if(window.arxLogger){window.arxLogger.info('Adding asset from symbol',{integration_point:'symbol_placement'});}
showToast('Symbol placement integration coming soon!','info');}
document.addEventListener('DOMContentLoaded',()=>{if(window.arxLogger){window.arxLogger.info('Asset inventory page loaded',{page:'asset_inventory',url:window.location.href});}
loadBuildings();loadAssets();updateSummaryCards();renderCharts();});class AssetLifecycleManager{constructor(){this.baseUrl='/v1/asset-lifecycle';this.eventListeners={'lifecycle_event_logged':[],'replacement_schedule_created':[],'analytics_updated':[],'compliance_report_updated':[]};}
addEventListener(event,callback){if(!this.eventListeners[event])this.eventListeners[event]=[];this.eventListeners[event].push(callback);}
emit(event,data){if(this.eventListeners[event]){this.eventListeners[event].forEach(cb=>{try{cb(data);}catch(e){console.error(e);}});}}
async logLifecycleEvent(event){const res=await fetch(`${this.baseUrl}/event`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(event)});const result=await res.json();this.emit('lifecycle_event_logged',result);return result;}
async getLifecycleEvents(buildingId,floorId,assetId){const res=await fetch(`${this.baseUrl}/events/${buildingId}/${floorId}/${assetId}`);return await res.json();}
async createReplacementSchedule(schedule){const res=await fetch(`${this.baseUrl}/replacement-schedule`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(schedule)});const result=await res.json();this.emit('replacement_schedule_created',result);return result;}
async getReplacementSchedules(buildingId,floorId){const res=await fetch(`${this.baseUrl}/replacement-schedules/${buildingId}/${floorId}`);return await res.json();}
async getAssetAnalytics(buildingId,floorId){const res=await fetch(`${this.baseUrl}/analytics/${buildingId}/${floorId}`);const result=await res.json();this.emit('analytics_updated',result);return result;}
async getComplianceReport(buildingId,floorId){const res=await fetch(`${this.baseUrl}/compliance/${buildingId}/${floorId}`);const result=await res.json();this.emit('compliance_report_updated',result);return result;}
renderAnalyticsTable(analytics,container){if(!container)return;container.innerHTML='';const table=document.createElement('table');table.className='asset-analytics-table';table.innerHTML=`
            <thead><tr>
                <th>Asset ID</th><th>Events</th><th>Total Labor Hours</th><th>Total Cost</th>
            </tr></thead>
            <tbody>
                ${analytics.map(a => `<tr><td>${a.asset_id}</td><td>${a.event_count}</td><td>${a.total_labor_hours??0}</td><td>${a.total_cost??0}</td></tr>`).join('')}
            </tbody>
        `;container.appendChild(table);}
renderComplianceTable(assets,container){if(!container)return;container.innerHTML='';const table=document.createElement('table');table.className='compliance-report-table';table.innerHTML=`
            <thead><tr>
                <th>Asset ID</th><th>Name</th><th>Type</th><th>Status</th><th>Condition</th><th>Next Maintenance</th><th>Overdue</th>
            </tr></thead>
            <tbody>
                ${assets.map(a => `<tr${a.overdue?' class="overdue"':''}><td>${a.asset_id}</td><td>${a.asset_name}</td><td>${a.asset_type}</td><td>${a.status}</td><td>${a.condition}</td><td>${a.next_maintenance??''}</td><td>${a.overdue?'':''}</td></tr>`).join('')}
            </tbody>
        `;container.appendChild(table);}}
window.assetLifecycleManager=new AssetLifecycleManager();if(typeof module!=='undefined'&&module.exports)module.exports=AssetLifecycleManager;let currentPage=1;let currentFilters={};document.addEventListener('DOMContentLoaded',function(){loadAuditLogs();const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-(30*24*60*60*1000));document.getElementById('dateFrom').value=thirtyDaysAgo.toISOString().split('T')[0];document.getElementById('dateTo').value=today.toISOString().split('T')[0];});function loadAuditLogs(){const filters=getCurrentFilters();const queryParams=new URLSearchParams({page:currentPage,page_size:20,...filters});fetch(`/api/audit-logs?${queryParams}`).then(response=>response.json()).then(data=>{displayAuditLogs(data.results);updatePagination(data);updateLogCount(data.total);}).catch(error=>{console.error('Error loading audit logs:',error);document.getElementById('auditLogsTable').innerHTML='<tr><td colspan="8" class="px-6 py-4 text-center text-red-500">Error loading audit logs</td></tr>';});}
function getCurrentFilters(){const filters={};const objectType=document.getElementById('objectType').value;const action=document.getElementById('action').value;const dateFrom=document.getElementById('dateFrom').value;const dateTo=document.getElementById('dateTo').value;const userId=document.getElementById('userId').value;const assetId=document.getElementById('assetId').value;const buildingId=document.getElementById('buildingId').value;const ipAddress=document.getElementById('ipAddress').value;if(objectType)filters.object_type=objectType;if(action)filters.action=action;if(dateFrom)filters.date_from=dateFrom;if(dateTo)filters.date_to=dateTo;if(userId)filters.user_id=userId;if(assetId)filters.asset_id=assetId;if(buildingId)filters.building_id=buildingId;if(ipAddress)filters.ip_address=ipAddress;return filters;}
function displayAuditLogs(logs){const tbody=document.getElementById('auditLogsTable');if(logs.length===0){tbody.innerHTML='<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No audit logs found</td></tr>';return;}
tbody.innerHTML=logs.map(log=>`
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.user_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    ${getObjectTypeColor(log.object_type)}">
                    ${log.object_type}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${log.object_id}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    ${getActionColor(log.action)}">
                    ${log.action}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ip_address || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDate(log.created_at)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button onclick="showLogDetails('${log.id}')"
                        class="text-indigo-600 hover:text-indigo-900">
                    View Details
                </button>
            </td>
        </tr>
    `).join('');}
function getObjectTypeColor(objectType){switch(objectType){case'asset':return'bg-blue-100 text-blue-800';case'export':return'bg-green-100 text-green-800';case'user':return'bg-purple-100 text-purple-800';case'building':return'bg-yellow-100 text-yellow-800';default:return'bg-gray-100 text-gray-800';}}
function getActionColor(action){switch(action){case'create':return'bg-green-100 text-green-800';case'update':return'bg-blue-100 text-blue-800';case'delete':return'bg-red-100 text-red-800';case'export':return'bg-purple-100 text-purple-800';default:return'bg-gray-100 text-gray-800';}}
function formatDate(dateString){const date=new Date(dateString);return date.toLocaleString();}
function updatePagination(data){const totalPages=data.total_pages;const startRecord=((data.page-1)*data.page_size)+1;const endRecord=Math.min(data.page*data.page_size,data.total);document.getElementById('startRecord').textContent=startRecord;document.getElementById('endRecord').textContent=endRecord;document.getElementById('totalRecords').textContent=data.total;document.getElementById('pageInfo').textContent=`Page ${data.page} of ${totalPages}`;document.getElementById('prevBtn').disabled=data.page<=1;document.getElementById('nextBtn').disabled=data.page>=totalPages;if(data.page<=1){document.getElementById('prevBtn').classList.add('opacity-50','cursor-not-allowed');}else{document.getElementById('prevBtn').classList.remove('opacity-50','cursor-not-allowed');}
if(data.page>=totalPages){document.getElementById('nextBtn').classList.add('opacity-50','cursor-not-allowed');}else{document.getElementById('nextBtn').classList.remove('opacity-50','cursor-not-allowed');}}
function updateLogCount(total){document.getElementById('logCount').textContent=`Total: ${total} audit log entries`;}
function previousPage(){if(currentPage>1){currentPage--;loadAuditLogs();}}
function nextPage(){currentPage++;loadAuditLogs();}
function applyFilters(){currentPage=1;loadAuditLogs();}
function clearFilters(){document.getElementById('objectType').value='';document.getElementById('action').value='';document.getElementById('userId').value='';document.getElementById('assetId').value='';document.getElementById('buildingId').value='';document.getElementById('ipAddress').value='';const today=new Date();const thirtyDaysAgo=new Date(today.getTime()-(30*24*60*60*1000));document.getElementById('dateFrom').value=thirtyDaysAgo.toISOString().split('T')[0];document.getElementById('dateTo').value=today.toISOString().split('T')[0];currentPage=1;loadAuditLogs();}
function exportLogs(){const format=document.getElementById('exportFormat').value;const filters=getCurrentFilters();const queryParams=new URLSearchParams({export:format,...filters});const link=document.createElement('a');link.href=`/api/audit-logs?${queryParams}`;link.download=`audit_logs_${new Date().toISOString().split('T')[0]}.${format}`;document.body.appendChild(link);link.click();document.body.removeChild(link);}
function showLogDetails(logId){fetch(`/api/audit-logs?object_id=${logId}`).then(response=>response.json()).then(data=>{if(data.results&&data.results.length>0){const log=data.results[0];displayLogDetails(log);document.getElementById('logDetailsModal').classList.remove('hidden');}}).catch(error=>{console.error('Error loading log details:',error);});}
function displayLogDetails(log){const content=document.getElementById('logDetailsContent');let fieldChangesHtml='';if(log.field_changes){try{const fieldChanges=JSON.parse(log.field_changes);if(Object.keys(fieldChanges).length>0){fieldChangesHtml=`
                    <div class="mt-4">
                        <h4 class="font-medium text-gray-900">Field Changes:</h4>
                        <div class="mt-2 space-y-2">
                            ${Object.entries(fieldChanges).map(([field, change]) => `<div class="bg-gray-50 p-3 rounded"><div class="font-medium text-sm">${field}:</div><div class="text-sm text-gray-600"><div>Before:<span class="font-mono">${change.before||'null'}</span></div><div>After:<span class="font-mono">${change.after||'null'}</span></div></div></div>`).join('')}
                        </div>
                    </div>
                `;}}catch(e){console.error('Error parsing field changes:',e);}}
let payloadHtml='';if(log.payload){try{const payload=JSON.parse(log.payload);payloadHtml=`
                <div class="mt-4">
                    <h4 class="font-medium text-gray-900">Payload:</h4>
                    <pre class="mt-2 bg-gray-50 p-3 rounded text-sm overflow-x-auto">${JSON.stringify(payload, null, 2)}</pre>
                </div>
            `;}catch(e){console.error('Error parsing payload:',e);}}
content.innerHTML=`
        <div class="space-y-4">
            <div>
                <h4 class="font-medium text-gray-900">Basic Information</h4>
                <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                    <div><span class="font-medium">ID:</span> ${log.id}</div>
                    <div><span class="font-medium">User ID:</span> ${log.user_id}</div>
                    <div><span class="font-medium">Object Type:</span> ${log.object_type}</div>
                    <div><span class="font-medium">Object ID:</span> ${log.object_id}</div>
                    <div><span class="font-medium">Action:</span> ${log.action}</div>
                    <div><span class="font-medium">Timestamp:</span> ${formatDate(log.created_at)}</div>
                    <div><span class="font-medium">IP Address:</span> ${log.ip_address || 'N/A'}</div>
                    <div><span class="font-medium">User Agent:</span> ${log.user_agent || 'N/A'}</div>
                </div>
            </div>
            ${fieldChangesHtml}
            ${payloadHtml}
        </div>
    `;}
function closeLogDetails(){document.getElementById('logDetailsModal').classList.add('hidden');}
document.addEventListener('keydown',function(e){if(e.key==='Escape'){closeLogDetails();}});document.getElementById('logDetailsModal').addEventListener('click',function(e){if(e.target===this){closeLogDetails();}});class AutoSnapshotManager{constructor(options={}){this.options={apiBaseUrl:'/auto-snapshot',updateInterval:5000,enableNotifications:true,enableRealTimeUpdates:true,showActivityIndicators:true,...options};this.service=null;this.config=null;this.stats=null;this.activeFloors=new Set();this.updateTimer=null;this.isInitialized=false;this.eventListeners=new Map();this.initialize();}
async initialize(){try{await this.loadConfiguration();await this.loadStats();await this.loadActiveFloors();if(this.options.enableRealTimeUpdates){this.startRealTimeUpdates();}
this.isInitialized=true;this.emitEvent('initialized',{manager:this});}catch(error){console.error('Failed to initialize AutoSnapshotManager:',error);this.emitEvent('error',{error,context:'initialization'});}}
async loadConfiguration(){try{const response=await fetch(`${this.options.apiBaseUrl}/config`);if(!response.ok)throw new Error('Failed to load configuration');this.config=await response.json();this.emitEvent('configLoaded',{config:this.config});}catch(error){console.error('Error loading configuration:',error);throw error;}}
async updateConfiguration(newConfig){try{const response=await fetch(`${this.options.apiBaseUrl}/config`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(newConfig)});if(!response.ok)throw new Error('Failed to update configuration');this.config=await response.json();this.emitEvent('configUpdated',{config:this.config});if(this.options.enableNotifications){this.showNotification('Auto-snapshot configuration updated','success');}
return this.config;}catch(error){console.error('Error updating configuration:',error);this.showNotification('Failed to update configuration','error');throw error;}}
async loadStats(){try{const response=await fetch(`${this.options.apiBaseUrl}/stats`);if(!response.ok)throw new Error('Failed to load stats');this.stats=await response.json();this.emitEvent('statsLoaded',{stats:this.stats});}catch(error){console.error('Error loading stats:',error);throw error;}}
async loadActiveFloors(){try{const response=await fetch(`${this.options.apiBaseUrl}/active-floors`);if(!response.ok)throw new Error('Failed to load active floors');const data=await response.json();this.activeFloors=new Set(data.active_floors);this.emitEvent('activeFloorsLoaded',{activeFloors:this.activeFloors});}catch(error){console.error('Error loading active floors:',error);throw error;}}
async createManualSnapshot(floorId,options={}){try{const requestData={floor_id:floorId,description:options.description||'Manual snapshot',tags:options.tags||[],user_id:options.userId,session_id:options.sessionId};const response=await fetch(`${this.options.apiBaseUrl}/create-manual`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok)throw new Error('Failed to create manual snapshot');const snapshot=await response.json();this.emitEvent('manualSnapshotCreated',{snapshot,floorId});if(this.options.enableNotifications){this.showNotification('Manual snapshot created successfully','success');}
return snapshot;}catch(error){console.error('Error creating manual snapshot:',error);this.showNotification('Failed to create manual snapshot','error');throw error;}}
async trackChanges(floorId,currentData,options={}){try{const requestData={floor_id:floorId,current_data:currentData,previous_data:options.previousData,user_id:options.userId,session_id:options.sessionId};const response=await fetch(`${this.options.apiBaseUrl}/track-changes`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok)throw new Error('Failed to track changes');const result=await response.json();if(result){this.emitEvent('autoSnapshotCreated',{snapshot:result,floorId});if(this.options.enableNotifications){this.showNotification(`Auto-snapshot created: ${result.description}`,'info');}}
return result;}catch(error){console.error('Error tracking changes:',error);throw error;}}
async activateFloor(floorId){try{const response=await fetch(`${this.options.apiBaseUrl}/floors/${floorId}/activate`,{method:'POST'});if(!response.ok)throw new Error('Failed to activate floor');this.activeFloors.add(floorId);this.emitEvent('floorActivated',{floorId});if(this.options.enableNotifications){this.showNotification(`Auto-snapshot activated for floor ${floorId}`,'success');}}catch(error){console.error('Error activating floor:',error);this.showNotification('Failed to activate floor','error');throw error;}}
async deactivateFloor(floorId){try{const response=await fetch(`${this.options.apiBaseUrl}/floors/${floorId}/deactivate`,{method:'POST'});if(!response.ok)throw new Error('Failed to deactivate floor');this.activeFloors.delete(floorId);this.emitEvent('floorDeactivated',{floorId});if(this.options.enableNotifications){this.showNotification(`Auto-snapshot deactivated for floor ${floorId}`,'info');}}catch(error){console.error('Error deactivating floor:',error);this.showNotification('Failed to deactivate floor','error');throw error;}}
async getFloorSnapshots(floorId,options={}){try{const params=new URLSearchParams({limit:options.limit||50,offset:options.offset||0});const response=await fetch(`${this.options.apiBaseUrl}/floors/${floorId}/snapshots?${params}`);if(!response.ok)throw new Error('Failed to get floor snapshots');return await response.json();}catch(error){console.error('Error getting floor snapshots:',error);throw error;}}
async getFloorActivity(floorId){try{const response=await fetch(`${this.options.apiBaseUrl}/floors/${floorId}/activity`);if(!response.ok)throw new Error('Failed to get floor activity');return await response.json();}catch(error){console.error('Error getting floor activity:',error);throw error;}}
async triggerCleanup(floorId){try{const response=await fetch(`${this.options.apiBaseUrl}/cleanup/${floorId}`,{method:'POST'});if(!response.ok)throw new Error('Failed to trigger cleanup');const result=await response.json();this.emitEvent('cleanupTriggered',{floorId,result});if(this.options.enableNotifications){this.showNotification(`Cleanup triggered for floor ${floorId}`,'info');}
return result;}catch(error){console.error('Error triggering cleanup:',error);this.showNotification('Failed to trigger cleanup','error');throw error;}}
async triggerCleanupAll(){try{const response=await fetch(`${this.options.apiBaseUrl}/cleanup/all`,{method:'POST'});if(!response.ok)throw new Error('Failed to trigger cleanup for all floors');const result=await response.json();this.emitEvent('cleanupAllTriggered',{result});if(this.options.enableNotifications){this.showNotification(result.message,'info');}
return result;}catch(error){console.error('Error triggering cleanup for all floors:',error);this.showNotification('Failed to trigger cleanup','error');throw error;}}
startRealTimeUpdates(){if(this.updateTimer){clearInterval(this.updateTimer);}
this.updateTimer=setInterval(async()=>{try{await this.loadStats();await this.loadActiveFloors();this.emitEvent('statsUpdated',{stats:this.stats,activeFloors:this.activeFloors});}catch(error){console.error('Error updating stats:',error);}},this.options.updateInterval);}
stopRealTimeUpdates(){if(this.updateTimer){clearInterval(this.updateTimer);this.updateTimer=null;}}
renderConfigurationPanel(container){if(!this.config)return;container.innerHTML=`
            <div class="auto-snapshot-config-panel">
                <h3 class="text-lg font-semibold mb-4">Auto-Snapshot Configuration</h3>

                <form id="auto-snapshot-config-form" class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="config-enabled"
                               ${this.config.enabled ? 'checked' : ''}
                               class="mr-2">
                        <label for="config-enabled" class="text-sm font-medium">
                            Enable Auto-Snapshot
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Time Interval (minutes)</label>
                            <input type="number" id="config-time-interval"
                                   value="${this.config.time_interval_minutes}"
                                   min="1" max="1440" class="w-full border rounded px-2 py-1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Change Threshold</label>
                            <input type="number" id="config-change-threshold"
                                   value="${this.config.change_threshold}"
                                   min="1" max="1000" class="w-full border rounded px-2 py-1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Major Edit Threshold</label>
                            <input type="number" id="config-major-edit-threshold"
                                   value="${this.config.major_edit_threshold}"
                                   min="1" max="1000" class="w-full border rounded px-2 py-1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Max Snapshots/Hour</label>
                            <input type="number" id="config-max-hourly"
                                   value="${this.config.max_snapshots_per_hour}"
                                   min="1" max="100" class="w-full border rounded px-2 py-1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Max Snapshots/Day</label>
                            <input type="number" id="config-max-daily"
                                   value="${this.config.max_snapshots_per_day}"
                                   min="1" max="1000" class="w-full border rounded px-2 py-1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Retention (days)</label>
                            <input type="number" id="config-retention"
                                   value="${this.config.retention_days}"
                                   min="1" max="365" class="w-full border rounded px-2 py-1">
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="config-cleanup-enabled"
                                   ${this.config.cleanup_enabled ? 'checked' : ''}
                                   class="mr-2">
                            <label for="config-cleanup-enabled" class="text-sm">
                                Enable Cleanup
                            </label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="config-compression-enabled"
                                   ${this.config.compression_enabled ? 'checked' : ''}
                                   class="mr-2">
                            <label for="config-compression-enabled" class="text-sm">
                                Enable Compression
                            </label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="config-backup-enabled"
                                   ${this.config.backup_enabled ? 'checked' : ''}
                                   class="mr-2">
                            <label for="config-backup-enabled" class="text-sm">
                                Enable Backup
                            </label>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Save Configuration
                        </button>
                        <button type="button" id="reset-config" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                            Reset to Defaults
                        </button>
                    </div>
                </form>
            </div>
        `;this.addConfigurationEventListeners(container);}
renderStatsPanel(container){if(!this.stats)return;container.innerHTML=`
            <div class="auto-snapshot-stats-panel">
                <h3 class="text-lg font-semibold mb-4">Auto-Snapshot Statistics</h3>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm text-blue-600">Service Status</div>
                        <div class="text-lg font-semibold ${this.stats.running ? 'text-green-600' : 'text-red-600'}">
                            ${this.stats.running ? 'Running' : 'Stopped'}
                        </div>
                    </div>

                    <div class="bg-green-50 p-3 rounded">
                        <div class="text-sm text-green-600">Active Floors</div>
                        <div class="text-lg font-semibold text-green-700">
                            ${this.stats.active_floors}
                        </div>
                    </div>

                    <div class="bg-purple-50 p-3 rounded">
                        <div class="text-sm text-purple-600">Total Cleanups</div>
                        <div class="text-lg font-semibold text-purple-700">
                            ${this.stats.cleanup_stats.total_cleanups || 0}
                        </div>
                    </div>

                    <div class="bg-orange-50 p-3 rounded">
                        <div class="text-sm text-orange-600">Snapshots Removed</div>
                        <div class="text-lg font-semibold text-orange-700">
                            ${this.stats.cleanup_stats.total_removed || 0}
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <button id="refresh-stats" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        Refresh Stats
                    </button>
                    <button id="trigger-cleanup-all" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                        Trigger Cleanup (All Floors)
                    </button>
                </div>
            </div>
        `;this.addStatsEventListeners(container);}
renderFloorActivityPanel(container,floorId){container.innerHTML=`
            <div class="auto-snapshot-floor-activity-panel">
                <h3 class="text-lg font-semibold mb-4">Floor Activity - ${floorId}</h3>

                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="floor-active-${floorId}"
                                   ${this.activeFloors.has(floorId) ? 'checked' : ''}
                                   class="mr-2">
                            <label for="floor-active-${floorId}" class="text-sm font-medium">
                                Auto-Snapshot Active
                            </label>
                        </div>

                        <button id="create-manual-${floorId}" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            Create Manual Snapshot
                        </button>

                        <button id="trigger-cleanup-${floorId}" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                            Trigger Cleanup
                        </button>
                    </div>

                    <div id="floor-activity-content-${floorId}" class="bg-gray-50 p-3 rounded">
                        <div class="text-sm text-gray-600">Loading activity data...</div>
                    </div>
                </div>
            </div>
        `;this.addFloorActivityEventListeners(container,floorId);this.loadFloorActivityData(floorId);}
addConfigurationEventListeners(container){const form=container.querySelector('#auto-snapshot-config-form');const resetBtn=container.querySelector('#reset-config');form.addEventListener('submit',async(e)=>{e.preventDefault();const newConfig={enabled:container.querySelector('#config-enabled').checked,time_interval_minutes:parseInt(container.querySelector('#config-time-interval').value),change_threshold:parseInt(container.querySelector('#config-change-threshold').value),major_edit_threshold:parseInt(container.querySelector('#config-major-edit-threshold').value),max_snapshots_per_hour:parseInt(container.querySelector('#config-max-hourly').value),max_snapshots_per_day:parseInt(container.querySelector('#config-max-daily').value),retention_days:parseInt(container.querySelector('#config-retention').value),cleanup_enabled:container.querySelector('#config-cleanup-enabled').checked,compression_enabled:container.querySelector('#config-compression-enabled').checked,backup_enabled:container.querySelector('#config-backup-enabled').checked};try{await this.updateConfiguration(newConfig);}catch(error){console.error('Error updating configuration:',error);}});resetBtn.addEventListener('click',async()=>{try{await this.updateConfiguration({enabled:true,time_interval_minutes:15,change_threshold:10,major_edit_threshold:25,max_snapshots_per_hour:4,max_snapshots_per_day:24,retention_days:30,cleanup_enabled:true,compression_enabled:true,backup_enabled:true});this.renderConfigurationPanel(container);}catch(error){console.error('Error resetting configuration:',error);}});}
addStatsEventListeners(container){const refreshBtn=container.querySelector('#refresh-stats');const cleanupBtn=container.querySelector('#trigger-cleanup-all');refreshBtn.addEventListener('click',async()=>{try{await this.loadStats();this.renderStatsPanel(container);}catch(error){console.error('Error refreshing stats:',error);}});cleanupBtn.addEventListener('click',async()=>{try{await this.triggerCleanupAll();}catch(error){console.error('Error triggering cleanup:',error);}});}
addFloorActivityEventListeners(container,floorId){const activeCheckbox=container.querySelector(`#floor-active-${floorId}`);const manualBtn=container.querySelector(`#create-manual-${floorId}`);const cleanupBtn=container.querySelector(`#trigger-cleanup-${floorId}`);activeCheckbox.addEventListener('change',async()=>{try{if(activeCheckbox.checked){await this.activateFloor(floorId);}else{await this.deactivateFloor(floorId);}}catch(error){console.error('Error toggling floor activation:',error);activeCheckbox.checked=!activeCheckbox.checked;}});manualBtn.addEventListener('click',async()=>{try{const description=prompt('Enter snapshot description (optional):');await this.createManualSnapshot(floorId,{description});}catch(error){console.error('Error creating manual snapshot:',error);}});cleanupBtn.addEventListener('click',async()=>{try{await this.triggerCleanup(floorId);}catch(error){console.error('Error triggering cleanup:',error);}});}
async loadFloorActivityData(floorId){try{const activity=await this.getFloorActivity(floorId);const content=document.querySelector(`#floor-activity-content-${floorId}`);if(content){content.innerHTML=`
                    <div class="space-y-2">
                        <div class="text-sm">
                            <strong>Total Snapshots:</strong> ${activity.total_snapshots}
                        </div>
                        <div class="text-sm">
                            <strong>Last Activity:</strong> ${activity.activity.last_activity || 'None'}
                        </div>
                        <div class="text-sm">
                            <strong>User ID:</strong> ${activity.activity.user_id || 'None'}
                        </div>
                        <div class="text-sm">
                            <strong>Session ID:</strong> ${activity.activity.session_id || 'None'}
                        </div>
                    </div>
                `;}}catch(error){console.error('Error loading floor activity data:',error);}}
addEventListener(event,callback){if(!this.eventListeners.has(event)){this.eventListeners.set(event,[]);}
this.eventListeners.get(event).push(callback);}
removeEventListener(event,callback){if(this.eventListeners.has(event)){const listeners=this.eventListeners.get(event);const index=listeners.indexOf(callback);if(index>-1){listeners.splice(index,1);}}}
emitEvent(event,data){if(this.eventListeners.has(event)){this.eventListeners.get(event).forEach(callback=>{try{callback(data);}catch(error){console.error(`Error in event listener for ${event}:`,error);}});}}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            type === 'warning' ? 'bg-yellow-500 text-black' :
            'bg-blue-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},3000);}
destroy(){this.stopRealTimeUpdates();this.eventListeners.clear();this.isInitialized=false;}}
window.AutoSnapshotManager=AutoSnapshotManager;class BIMEditingIntegration{constructor(options={}){this.options={autoSnapshotEnabled:true,autoSnapshotInterval:300000,manualSnapshotPrompts:true,editTrackingEnabled:true,majorEditThreshold:10,versionControlSystem:null,viewportManager:null,objectInteraction:null,...options};this.editCount=0;this.lastSnapshotTime=Date.now();this.pendingChanges=new Set();this.editHistory=[];this.isProcessing=false;this.autoSnapshotTimer=null;this.initializeIntegration();}
initializeIntegration(){this.connectToViewportManager();this.connectToObjectInteraction();this.connectToVersionControl();this.setupEventListeners();this.startAutoSnapshotTimer();}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.options.viewportManager=window.viewportManager;window.arxLogger.info('BIMEditingIntegration connected to ViewportManager',{file:'bim_editing_integration.js'});this.options.viewportManager.addEventListener('objectMoved',(data)=>{this.trackEdit('object_move',data);});this.options.viewportManager.addEventListener('objectSelected',(data)=>{this.trackEdit('object_select',data);});this.options.viewportManager.addEventListener('zoomChanged',(data)=>{this.trackEdit('viewport_zoom',data);});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
connectToObjectInteraction(){const checkObjectInteraction=()=>{if(window.svgObjectInteraction){this.options.objectInteraction=window.svgObjectInteraction;window.arxLogger.info('BIMEditingIntegration connected to SVGObjectInteraction',{file:'bim_editing_integration.js'});this.overrideObjectInteractionMethods();}else{setTimeout(checkObjectInteraction,100);}};checkObjectInteraction();}
connectToVersionControl(){const checkVersionControl=()=>{if(window.floorVersionControl){this.options.versionControlSystem=window.floorVersionControl;window.arxLogger.info('BIMEditingIntegration connected to FloorVersionControl',{file:'bim_editing_integration.js'});}else{setTimeout(checkVersionControl,100);}};checkVersionControl();}
overrideObjectInteractionMethods(){const original=this.options.objectInteraction;const originalMove=original.moveSelectedObjectsWithArrowKeys.bind(original);original.moveSelectedObjectsWithArrowKeys=(key)=>{this.trackEdit('keyboard_move',{key,objects:original.selectedObjects});return originalMove(key);};if(original.rotateSelectedObjects){const originalRotate=original.rotateSelectedObjects.bind(original);original.rotateSelectedObjects=(angle)=>{this.trackEdit('object_rotate',{angle,objects:original.selectedObjects});return originalRotate(angle);};}
if(original.scaleSelectedObjects){const originalScale=original.scaleSelectedObjects.bind(original);original.scaleSelectedObjects=(scale)=>{this.trackEdit('object_scale',{scale,objects:original.selectedObjects});return originalScale(scale);};}
if(original.deleteSelectedObjects){const originalDelete=original.deleteSelectedObjects.bind(original);original.deleteSelectedObjects=()=>{this.trackEdit('object_delete',{objects:original.selectedObjects});return originalDelete();};}}
setupEventListeners(){document.addEventListener('symbolPlaced',(event)=>{this.trackEdit('symbol_place',event.detail);});document.addEventListener('objectPropertyChanged',(event)=>{this.trackEdit('property_change',event.detail);});document.addEventListener('objectDeleted',(event)=>{this.trackEdit('object_delete',event.detail);});document.addEventListener('objectDuplicated',(event)=>{this.trackEdit('object_duplicate',event.detail);});document.addEventListener('layerChanged',(event)=>{this.trackEdit('layer_change',event.detail);});document.addEventListener('viewportOperation',(event)=>{this.trackEdit('viewport_operation',event.detail);});document.addEventListener('undoOperation',(event)=>{this.trackEdit('undo',event.detail);});document.addEventListener('redoOperation',(event)=>{this.trackEdit('redo',event.detail);});document.addEventListener('saveOperation',(event)=>{this.trackEdit('save',event.detail);});document.addEventListener('exportOperation',(event)=>{this.trackEdit('export',event.detail);});}
trackEdit(type,data){if(!this.options.editTrackingEnabled)return;const edit={id:this.generateEditId(),type:type,data:data,timestamp:Date.now(),user:this.getCurrentUser(),session:this.getCurrentSession()};this.editHistory.push(edit);this.editCount++;this.pendingChanges.add(edit.id);if(this.isMajorEdit(edit)){window.arxLogger.info('Major edit detected:',edit,{file:'bim_editing_integration.js'});this.handleMajorEdit(edit);}
this.updateEditIndicators();this.checkAutoSnapshot();this.emitEvent('editTracked',edit);}
isMajorEdit(edit){const majorEditTypes=['object_delete','symbol_place','property_change','object_duplicate','layer_change'];return majorEditTypes.includes(edit.type);}
handleMajorEdit(edit){console.log('Major edit detected:',edit);this.showMajorEditIndicator(edit);if(this.options.manualSnapshotPrompts){this.promptForManualSnapshot(edit);}
this.emitEvent('majorEditDetected',edit);}
showMajorEditIndicator(edit){let indicator=document.getElementById('major-edit-indicator');if(!indicator){indicator=document.createElement('div');indicator.id='major-edit-indicator';indicator.className='fixed top-4 right-4 bg-yellow-500 text-white px-4 py-2 rounded-md shadow-lg z-50';indicator.innerHTML=`
                <div class="flex items-center space-x-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Major edit detected</span>
                    <button onclick="bimEditingIntegration.createManualSnapshot()" class="bg-white text-yellow-500 px-2 py-1 rounded text-sm">
                        Snapshot
                    </button>
                </div>
            `;document.body.appendChild(indicator);}
setTimeout(()=>{if(indicator&&indicator.parentElement){indicator.remove();}},5000);}
promptForManualSnapshot(edit){const lastPromptTime=this.lastPromptTime||0;const timeSinceLastPrompt=Date.now()-lastPromptTime;if(timeSinceLastPrompt<30000){return;}
this.lastPromptTime=Date.now();const prompt=document.createElement('div');prompt.className='fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white border border-gray-300 rounded-lg shadow-xl p-6 z-50 max-w-md';prompt.innerHTML=`
            <div class="text-center">
                <i class="fas fa-camera text-3xl text-blue-500 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Create Snapshot?</h3>
                <p class="text-gray-600 mb-4">
                    A major edit was detected. Would you like to create a snapshot to save your progress?
                </p>
                <div class="flex space-x-3">
                    <button onclick="bimEditingIntegration.createManualSnapshot()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Create Snapshot
                    </button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Later
                    </button>
                </div>
            </div>
        `;document.body.appendChild(prompt);setTimeout(()=>{if(prompt&&prompt.parentElement){prompt.remove();}},10000);}
startAutoSnapshotTimer(){if(!this.options.autoSnapshotEnabled)return;this.autoSnapshotTimer=setInterval(()=>{this.checkAutoSnapshot();},this.options.autoSnapshotInterval);}
checkAutoSnapshot(){if(!this.options.autoSnapshotEnabled)return;const timeSinceLastSnapshot=Date.now()-this.lastSnapshotTime;const hasPendingChanges=this.pendingChanges.size>0;if(timeSinceLastSnapshot>=this.options.autoSnapshotInterval&&hasPendingChanges){this.createAutoSnapshot();}}
async createAutoSnapshot(){if(this.isProcessing)return;try{this.isProcessing=true;const description=`Auto-save snapshot (${this.editCount} edits)`;const tags=['auto-save'];await this.createSnapshot(description,tags,'auto-save');this.pendingChanges.clear();this.lastSnapshotTime=Date.now();window.arxLogger.info('Auto-snapshot created successfully',{file:'bim_editing_integration.js'});}catch(error){console.error('Failed to create auto-snapshot:',error);}finally{this.isProcessing=false;}}
async createManualSnapshot(){if(this.isProcessing)return;try{this.isProcessing=true;const description=await this.promptForSnapshotDescription();if(!description)return;const tags=['manual'];await this.createSnapshot(description,tags,'manual');this.pendingChanges.clear();this.lastSnapshotTime=Date.now();window.arxLogger.info('Manual snapshot created successfully',{file:'bim_editing_integration.js'});}catch(error){console.error('Failed to create manual snapshot:',error);}finally{this.isProcessing=false;}}
promptForSnapshotDescription(){return new Promise((resolve)=>{const prompt=document.createElement('div');prompt.className='fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white border border-gray-300 rounded-lg shadow-xl p-6 z-50 max-w-md';prompt.innerHTML=`
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Create Snapshot</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="snapshot-description" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" rows="3" placeholder="Describe what changes this snapshot captures..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                        <input type="text" id="snapshot-tags" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Enter tags separated by commas...">
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="bimEditingIntegration.confirmSnapshot()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Create
                        </button>
                        <button onclick="bimEditingIntegration.cancelSnapshot()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>
            `;document.body.appendChild(prompt);this.currentSnapshotPrompt=prompt;this.currentSnapshotResolve=resolve;setTimeout(()=>{const descriptionField=prompt.querySelector('#snapshot-description');if(descriptionField){descriptionField.focus();}},100);});}
confirmSnapshot(){if(!this.currentSnapshotPrompt||!this.currentSnapshotResolve)return;const description=this.currentSnapshotPrompt.querySelector('#snapshot-description').value;const tags=this.currentSnapshotPrompt.querySelector('#snapshot-tags').value;this.currentSnapshotPrompt.remove();this.currentSnapshotPrompt=null;this.currentSnapshotResolve({description:description||'Manual snapshot',tags:tags?tags.split(',').map(tag=>tag.trim()).filter(tag=>tag):[]});this.currentSnapshotResolve=null;}
cancelSnapshot(){if(!this.currentSnapshotPrompt||!this.currentSnapshotResolve)return;this.currentSnapshotPrompt.remove();this.currentSnapshotPrompt=null;this.currentSnapshotResolve(null);this.currentSnapshotResolve=null;}
async createSnapshot(description,tags,type){if(!this.options.versionControlSystem){throw new Error('Version control system not available');}
const floorId=this.getCurrentFloorId();if(!floorId){throw new Error('No floor selected');}
await this.options.versionControlSystem.createSnapshot(description,tags,type);this.emitEvent('snapshotCreated',{description,tags,type,floorId,editCount:this.editCount});}
updateEditIndicators(){const editCounter=document.getElementById('edit-counter');if(editCounter){editCounter.textContent=this.editCount;editCounter.className=this.editCount>0?'text-orange-600':'text-gray-500';}
const pendingIndicator=document.getElementById('pending-changes-indicator');if(pendingIndicator){if(this.pendingChanges.size>0){pendingIndicator.style.display='block';pendingIndicator.textContent=`${this.pendingChanges.size} pending`;}else{pendingIndicator.style.display='none';}}
const autoSaveIndicator=document.getElementById('auto-save-indicator');if(autoSaveIndicator){const timeSinceLastSnapshot=Date.now()-this.lastSnapshotTime;const timeUntilNextSnapshot=Math.max(0,this.options.autoSnapshotInterval-timeSinceLastSnapshot);const minutes=Math.ceil(timeUntilNextSnapshot/60000);autoSaveIndicator.textContent=`Auto-save in ${minutes}m`;autoSaveIndicator.className=timeUntilNextSnapshot<60000?'text-red-600':'text-gray-500';}}
getCurrentUser(){return{id:localStorage.getItem('user_id')||'unknown',name:localStorage.getItem('user_name')||'Unknown User'};}
getCurrentSession(){return{id:sessionStorage.getItem('session_id')||this.generateSessionId(),timestamp:Date.now()};}
getCurrentFloorId(){return localStorage.getItem('current_floor_id')||document.querySelector('[data-floor-id]')?.dataset.floorId;}
generateEditId(){return'edit_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
generateSessionId(){const sessionId='session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);sessionStorage.setItem('session_id',sessionId);return sessionId;}
emitEvent(eventName,data){const event=new CustomEvent(eventName,{detail:data,bubbles:true});document.dispatchEvent(event);}
getEditStatistics(){return{totalEdits:this.editCount,pendingChanges:this.pendingChanges.size,editHistory:this.editHistory,lastSnapshotTime:this.lastSnapshotTime,timeSinceLastSnapshot:Date.now()-this.lastSnapshotTime};}
resetEditTracking(){this.editCount=0;this.pendingChanges.clear();this.editHistory=[];this.lastSnapshotTime=Date.now();this.updateEditIndicators();}
setAutoSnapshotEnabled(enabled){this.options.autoSnapshotEnabled=enabled;if(enabled){this.startAutoSnapshotTimer();}else{if(this.autoSnapshotTimer){clearInterval(this.autoSnapshotTimer);this.autoSnapshotTimer=null;}}}
setAutoSnapshotInterval(interval){this.options.autoSnapshotInterval=interval;if(this.options.autoSnapshotEnabled){if(this.autoSnapshotTimer){clearInterval(this.autoSnapshotTimer);}
this.startAutoSnapshotTimer();}}
destroy(){if(this.autoSnapshotTimer){clearInterval(this.autoSnapshotTimer);this.autoSnapshotTimer=null;}
const indicators=['major-edit-indicator','edit-counter','pending-changes-indicator','auto-save-indicator'];indicators.forEach(id=>{const element=document.getElementById(id);if(element){element.remove();}});if(this.currentSnapshotPrompt){this.currentSnapshotPrompt.remove();this.currentSnapshotPrompt=null;}}}
const bimEditingIntegration=new BIMEditingIntegration();if(typeof module!=='undefined'&&module.exports){module.exports=BIMEditingIntegration;}
class CDNLoader{constructor(){this.loadedAssets=new Set();this.loadingAssets=new Map();this.failedAssets=new Set();}
async loadCSS(path,fallbackPath=null){const assetId=`css:${path}`;if(this.loadedAssets.has(assetId)){return Promise.resolve();}
if(this.loadingAssets.has(assetId)){return this.loadingAssets.get(assetId);}
if(this.failedAssets.has(assetId)){return Promise.reject(new Error(`Asset previously failed to load: ${path}`));}
const cdnUrl=window.CDNUtils.getAssetUrl(path,'css');const fallbackUrl=fallbackPath?window.CDNUtils.getAssetUrl(fallbackPath,'css'):null;const loadPromise=window.CDNUtils.loadCSS(cdnUrl,fallbackUrl).then(()=>{this.loadedAssets.add(assetId);this.loadingAssets.delete(assetId);console.log(` CSS loaded: ${path}`);}).catch(error=>{this.failedAssets.add(assetId);this.loadingAssets.delete(assetId);console.error(` Failed to load CSS: ${path}`,error);throw error;});this.loadingAssets.set(assetId,loadPromise);return loadPromise;}
async loadJS(path,fallbackPath=null){const assetId=`js:${path}`;if(this.loadedAssets.has(assetId)){return Promise.resolve();}
if(this.loadingAssets.has(assetId)){return this.loadingAssets.get(assetId);}
if(this.failedAssets.has(assetId)){return Promise.reject(new Error(`Asset previously failed to load: ${path}`));}
const cdnUrl=window.CDNUtils.getAssetUrl(path,'js');const fallbackUrl=fallbackPath?window.CDNUtils.getAssetUrl(fallbackPath,'js'):null;const loadPromise=window.CDNUtils.loadJS(cdnUrl,fallbackUrl).then(()=>{this.loadedAssets.add(assetId);this.loadingAssets.delete(assetId);console.log(` JavaScript loaded: ${path}`);}).catch(error=>{this.failedAssets.add(assetId);this.loadingAssets.delete(assetId);console.error(` Failed to load JavaScript: ${path}`,error);throw error;});this.loadingAssets.set(assetId,loadPromise);return loadPromise;}
async loadMultipleCSS(paths){const promises=paths.map(path=>this.loadCSS(path));return Promise.all(promises);}
async loadMultipleJS(paths){const promises=paths.map(path=>this.loadJS(path));return Promise.all(promises);}
async loadCriticalAssets(assets={}){const promises=[];if(assets.css){const cssPaths=Array.isArray(assets.css)?assets.css:[assets.css];promises.push(this.loadMultipleCSS(cssPaths));}
if(assets.js){const jsPaths=Array.isArray(assets.js)?assets.js:[assets.js];promises.push(this.loadMultipleJS(jsPaths));}
return Promise.all(promises);}
preloadNonCriticalAssets(assets={}){const preloadAssets=[];if(assets.css){const cssPaths=Array.isArray(assets.css)?assets.css:[assets.css];cssPaths.forEach(path=>{preloadAssets.push({url:window.CDNUtils.getAssetUrl(path,'css'),type:'style'});});}
if(assets.js){const jsPaths=Array.isArray(assets.js)?assets.js:[assets.js];jsPaths.forEach(path=>{preloadAssets.push({url:window.CDNUtils.getAssetUrl(path,'js'),type:'script'});});}
if(assets.images){const imagePaths=Array.isArray(assets.images)?assets.images:[assets.images];imagePaths.forEach(path=>{preloadAssets.push({url:window.CDNUtils.getAssetUrl(path,'images'),type:'image'});});}
if(assets.fonts){const fontPaths=Array.isArray(assets.fonts)?assets.fonts:[assets.fonts];fontPaths.forEach(path=>{preloadAssets.push({url:window.CDNUtils.getAssetUrl(path,'fonts'),type:'font',crossorigin:true});});}
window.CDNUtils.preloadAssets(preloadAssets);}
getAssetURL(path,type='images'){return window.CDNUtils.getAssetUrl(path,type);}
isAssetLoaded(path,type='js'){const assetId=`${type}:${path}`;return this.loadedAssets.has(assetId);}
getStats(){return{loaded:this.loadedAssets.size,loading:this.loadingAssets.size,failed:this.failedAssets.size,loadedAssets:Array.from(this.loadedAssets),failedAssets:Array.from(this.failedAssets)};}
clearFailedAssets(){this.failedAssets.clear();}
reset(){this.loadedAssets.clear();this.loadingAssets.clear();this.failedAssets.clear();}}
window.CDNLoader=new CDNLoader();if(typeof module!=='undefined'&&module.exports){module.exports=CDNLoader;}
document.addEventListener('DOMContentLoaded',()=>{const tableBody=document.getElementById('cmms-table-body');const addBtn=document.getElementById('add-connection-btn');const modal=document.getElementById('cmms-modal');const closeModal=document.getElementById('close-modal');const form=document.getElementById('cmms-form');const toast=document.getElementById('toast');let editingId=null;function showToast(msg,isError=false){toast.textContent=msg;toast.className='toast'+(isError?' error':'');toast.classList.remove('hidden');setTimeout(()=>toast.classList.add('hidden'),3000);}
function showModal(edit=false,data={}){modal.classList.remove('hidden');document.getElementById('modal-title').textContent=edit?'Edit Connection':'Add Connection';form.reset();editingId=edit?data.id:null;document.getElementById('connection-id').value=data.id||'';document.getElementById('name').value=data.name||'';document.getElementById('type').value=data.type||'';document.getElementById('base-url').value=data.base_url||'';document.getElementById('auth-method').value=getAuthMethod(data)||'api_key';document.getElementById('api-key').value=data.api_key||'';document.getElementById('username').value=data.username||'';document.getElementById('password').value='';document.getElementById('oauth2-client-id').value=data.oauth2_client_id||'';document.getElementById('oauth2-secret').value='';document.getElementById('oauth2-token-url').value=data.oauth2_token_url||'';document.getElementById('oauth2-scope').value=data.oauth2_scope||'';document.getElementById('sync-interval').value=data.sync_interval_min||60;document.getElementById('is-active').checked=!!data.is_active;updateAuthFields();}
function hideModal(){modal.classList.add('hidden');}
function getAuthMethod(data){if(data.oauth2_client_id)return'oauth2';if(data.username)return'basic';return'api_key';}
function updateAuthFields(){const method=document.getElementById('auth-method').value;document.querySelectorAll('.auth-fields').forEach(div=>div.classList.add('hidden'));if(method==='api_key')document.getElementById('api-key-fields').classList.remove('hidden');if(method==='basic')document.getElementById('basic-fields').classList.remove('hidden');if(method==='oauth2')document.getElementById('oauth2-fields').classList.remove('hidden');}
document.getElementById('auth-method').addEventListener('change',updateAuthFields);addBtn.addEventListener('click',()=>showModal(false));closeModal.addEventListener('click',hideModal);window.onclick=e=>{if(e.target===modal)hideModal();};form.onsubmit=async e=>{e.preventDefault();const data={name:document.getElementById('name').value,type:document.getElementById('type').value,base_url:document.getElementById('base-url').value,api_key:document.getElementById('api-key').value,username:document.getElementById('username').value,password:document.getElementById('password').value,oauth2_client_id:document.getElementById('oauth2-client-id').value,oauth2_secret:document.getElementById('oauth2-secret').value,oauth2_token_url:document.getElementById('oauth2-token-url').value,oauth2_scope:document.getElementById('oauth2-scope').value,sync_interval_min:parseInt(document.getElementById('sync-interval').value,10),is_active:document.getElementById('is-active').checked};let url='/cmms/connections';let method='POST';if(editingId){url+='/'+editingId;method='PUT';}
const resp=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(resp.ok){showToast('Saved!');hideModal();loadConnections();}else{showToast('Error saving connection',true);}};async function loadConnections(){const resp=await fetch('/cmms/connections');if(!resp.ok)return;const{connections}=await resp.json();tableBody.innerHTML='';connections.forEach(conn=>{const tr=document.createElement('tr');tr.innerHTML=`
                <td>${conn.name}</td>
                <td>${conn.type}</td>
                <td>${conn.base_url}</td>
                <td>${getAuthMethod(conn)}</td>
                <td>${conn.sync_interval_min}</td>
                <td>${conn.last_sync ? new Date(conn.last_sync).toLocaleString() : ''}</td>
                <td>${conn.last_sync_status || ''}</td>
                <td>${conn.last_sync_error || ''}</td>
                <td>
                    <button class="btn btn-xs" onclick="window.editCMMS(${conn.id})">Edit</button>
                    <button class="btn btn-xs" onclick="window.deleteCMMS(${conn.id})">Delete</button>
                    <button class="btn btn-xs" onclick="window.testCMMS(${conn.id})">Test</button>
                    <button class="btn btn-xs" onclick="window.syncCMMS(${conn.id})">Sync Now</button>
                </td>
            `;tableBody.appendChild(tr);});}
window.editCMMS=async id=>{const resp=await fetch('/cmms/connections/'+id);if(!resp.ok)return showToast('Failed to load connection',true);const data=await resp.json();showModal(true,data);};window.deleteCMMS=async id=>{if(!confirm('Delete this connection?'))return;const resp=await fetch('/cmms/connections/'+id,{method:'DELETE'});if(resp.ok){showToast('Deleted');loadConnections();}else{showToast('Delete failed',true);}};window.testCMMS=async id=>{showToast('Testing...');const resp=await fetch(`/cmms/connections/${id}/test`,{method:'POST'});const data=await resp.json();if(data.success)showToast('Connection OK');else showToast('Test failed: '+(data.error||'Unknown error'),true);};window.syncCMMS=async id=>{showToast('Syncing...');const resp=await fetch(`/cmms/connections/${id}/sync`,{method:'POST'});const data=await resp.json();if(data.success)showToast('Sync started');else showToast('Sync failed: '+(data.error||'Unknown error'),true);};loadConnections();});class CollaborationSystem{constructor(options={}){this.options={floorLockTimeout:300000,conflictCheckInterval:10000,userActivityTimeout:60000,showUserPresence:true,enableFloorLocking:true,enableConflictResolution:true,enableCollaborativeIndicators:true,...options};this.currentUser=null;this.currentFloor=null;this.floorLock=null;this.activeUsers=new Map();this.userActivity=new Map();this.conflictQueue=[];this.isProcessing=false;this.lockTimer=null;this.activityTimer=null;this.conflictTimer=null;this.presenceTimer=null;this.initializeSystem();}
initializeSystem(){this.initializeCurrentUser();this.setupEventListeners();this.startTimers();this.initializeUI();}
initializeCurrentUser(){this.currentUser={id:localStorage.getItem('user_id')||this.generateUserId(),name:localStorage.getItem('user_name')||'Unknown User',email:localStorage.getItem('user_email')||'',avatar:localStorage.getItem('user_avatar')||null,sessionId:this.generateSessionId()};if(!localStorage.getItem('user_id')){localStorage.setItem('user_id',this.currentUser.id);}}
setupEventListeners(){document.addEventListener('floorSelected',(event)=>{this.handleFloorSelection(event.detail);});document.addEventListener('mousedown',()=>this.updateUserActivity());document.addEventListener('keydown',()=>this.updateUserActivity());document.addEventListener('touchstart',()=>this.updateUserActivity());document.addEventListener('visibilitychange',()=>{if(document.hidden){this.handlePageHidden();}else{this.handlePageVisible();}});window.addEventListener('beforeunload',()=>{this.releaseFloorLock();});document.addEventListener('versionRestoreStarted',()=>{this.handleVersionRestoreStarted();});document.addEventListener('versionRestoreCompleted',()=>{this.handleVersionRestoreCompleted();});document.addEventListener('versionRestoreFailed',()=>{this.handleVersionRestoreFailed();});}
startTimers(){this.startLockTimer();this.startActivityTimer();this.startConflictTimer();this.startPresenceTimer();}
startLockTimer(){this.lockTimer=setInterval(()=>{this.refreshFloorLock();},this.options.floorLockTimeout/2);}
startActivityTimer(){this.activityTimer=setInterval(()=>{this.checkUserActivity();},this.options.userActivityTimeout);}
startConflictTimer(){this.conflictTimer=setInterval(()=>{this.checkForConflicts();},this.options.conflictCheckInterval);}
startPresenceTimer(){this.presenceTimer=setInterval(()=>{this.updateUserPresence();},30000);}
initializeUI(){this.createCollaborationUI();this.updateCollaborationStatus();}
createCollaborationUI(){const statusBar=document.createElement('div');statusBar.id='collaboration-status-bar';statusBar.className='fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-2 text-sm z-50';statusBar.innerHTML=`
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center space-x-4">
                    <div id="floor-lock-status" class="flex items-center space-x-2">
                        <i class="fas fa-lock text-green-400"></i>
                        <span>Floor unlocked</span>
                    </div>
                    <div id="active-users" class="flex items-center space-x-2">
                        <i class="fas fa-users text-blue-400"></i>
                        <span>0 active users</span>
                    </div>
                    <div id="conflict-status" class="flex items-center space-x-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                        <span>Conflicts detected</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="user-activity" class="flex items-center space-x-2">
                        <i class="fas fa-circle text-green-400"></i>
                        <span>Active</span>
                    </div>
                    <button id="collaboration-settings" class="text-gray-300 hover:text-white">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        `;document.body.appendChild(statusBar);const presencePanel=document.createElement('div');presencePanel.id='user-presence-panel';presencePanel.className='fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-50 max-w-xs';presencePanel.style.display='none';presencePanel.innerHTML=`
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Active Users</h3>
                <button id="close-presence-panel" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="user-list" class="space-y-2">
                <!-- User list will be populated here -->
            </div>
        `;document.body.appendChild(presencePanel);const conflictModal=document.createElement('div');conflictModal.id='conflict-resolution-modal';conflictModal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';conflictModal.style.display='none';conflictModal.innerHTML=`
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Conflict Resolution</h3>
                    <button id="close-conflict-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="conflict-list" class="space-y-4 mb-4">
                    <!-- Conflicts will be listed here -->
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="resolve-conflicts" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Resolve Conflicts
                    </button>
                    <button id="ignore-conflicts" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Ignore
                    </button>
                </div>
            </div>
        `;document.body.appendChild(conflictModal);this.setupUIEventListeners();}
setupUIEventListeners(){document.getElementById('collaboration-settings')?.addEventListener('click',()=>{this.showCollaborationSettings();});document.getElementById('active-users')?.addEventListener('click',()=>{this.togglePresencePanel();});document.getElementById('close-presence-panel')?.addEventListener('click',()=>{this.hidePresencePanel();});document.getElementById('close-conflict-modal')?.addEventListener('click',()=>{this.hideConflictModal();});document.getElementById('resolve-conflicts')?.addEventListener('click',()=>{this.resolveConflicts();});document.getElementById('ignore-conflicts')?.addEventListener('click',()=>{this.ignoreConflicts();});}
async handleFloorSelection(floorData){const previousFloor=this.currentFloor;this.currentFloor=floorData;if(previousFloor&&previousFloor.id!==floorData.id){await this.releaseFloorLock();}
if(this.options.enableFloorLocking){await this.requestFloorLock();}
this.updateCollaborationStatus();this.updateUserPresence();}
async requestFloorLock(){if(!this.currentFloor||!this.options.enableFloorLocking)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/lock`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,lock_type:'version_control',expires_at:new Date(Date.now()+this.options.floorLockTimeout).toISOString()})});if(response.ok){const lockData=await response.json();this.floorLock=lockData;this.updateFloorLockStatus(true);console.log('Floor lock acquired successfully');}else if(response.status===409){const lockInfo=await response.json();this.handleFloorLockedByOther(lockInfo);}else{throw new Error('Failed to acquire floor lock');}}catch(error){console.error('Error requesting floor lock:',error);this.handleFloorLockError(error);}}
async refreshFloorLock(){if(!this.floorLock||!this.currentFloor)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/lock/refresh`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,expires_at:new Date(Date.now()+this.options.floorLockTimeout).toISOString()})});if(response.ok){const lockData=await response.json();this.floorLock=lockData;console.log('Floor lock refreshed successfully');}else{this.handleFloorLockExpired();}}catch(error){console.error('Error refreshing floor lock:',error);this.handleFloorLockError(error);}}
async releaseFloorLock(){if(!this.floorLock||!this.currentFloor)return;try{await fetch(`/api/floors/${this.currentFloor.id}/lock/release`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId})});this.floorLock=null;this.updateFloorLockStatus(false);console.log('Floor lock released successfully');}catch(error){console.error('Error releasing floor lock:',error);}}
handleFloorLockedByOther(lockInfo){this.updateFloorLockStatus(false,lockInfo.locked_by);this.showNotification(`Floor is locked by ${lockInfo.locked_by_name || 'another user'}`,'warning');this.emitEvent('floorLockedByOther',lockInfo);}
handleFloorLockExpired(){this.floorLock=null;this.updateFloorLockStatus(false);this.showNotification('Floor lock expired','warning');setTimeout(()=>{this.requestFloorLock();},1000);this.emitEvent('floorLockExpired');}
handleFloorLockError(error){this.floorLock=null;this.updateFloorLockStatus(false);this.showNotification('Failed to acquire floor lock','error');this.emitEvent('floorLockError',error);}
updateFloorLockStatus(locked,lockedBy=null){const statusElement=document.getElementById('floor-lock-status');if(!statusElement)return;if(locked){statusElement.innerHTML=`
                <i class="fas fa-lock text-green-400"></i>
                <span>Floor locked</span>
            `;}else if(lockedBy){statusElement.innerHTML=`
                <i class="fas fa-lock text-red-400"></i>
                <span>Locked by ${lockedBy}</span>
            `;}else{statusElement.innerHTML=`
                <i class="fas fa-unlock text-gray-400"></i>
                <span>Floor unlocked</span>
            `;}}
updateUserActivity(){this.userActivity.set(this.currentUser.id,Date.now());const activityElement=document.getElementById('user-activity');if(activityElement){activityElement.innerHTML=`
                <i class="fas fa-circle text-green-400"></i>
                <span>Active</span>
            `;}}
checkUserActivity(){const now=Date.now();const inactiveThreshold=this.options.userActivityTimeout;const lastActivity=this.userActivity.get(this.currentUser.id);if(lastActivity&&(now-lastActivity)>inactiveThreshold){this.handleUserInactive();}
for(const[userId,lastActivity]of this.userActivity.entries()){if(userId!==this.currentUser.id&&(now-lastActivity)>inactiveThreshold){this.handleUserBecameInactive(userId);}}}
handleUserInactive(){const activityElement=document.getElementById('user-activity');if(activityElement){activityElement.innerHTML=`
                <i class="fas fa-circle text-gray-400"></i>
                <span>Inactive</span>
            `;}
this.emitEvent('userInactive',{userId:this.currentUser.id});}
handleUserBecameInactive(userId){this.activeUsers.delete(userId);this.userActivity.delete(userId);this.updatePresencePanel();this.emitEvent('userBecameInactive',{userId});}
async updateUserPresence(){if(!this.currentFloor)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/presence`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,session_id:this.currentUser.sessionId,user_name:this.currentUser.name,user_email:this.currentUser.email,user_avatar:this.currentUser.avatar,last_activity:Date.now()})});if(response.ok){const presenceData=await response.json();this.updateActiveUsers(presenceData.active_users);}}catch(error){console.error('Error updating user presence:',error);}}
updateActiveUsers(users){this.activeUsers.clear();users.forEach(user=>{if(user.user_id!==this.currentUser.id){this.activeUsers.set(user.user_id,user);this.userActivity.set(user.user_id,user.last_activity);}});this.updateActiveUsersCount();this.updatePresencePanel();}
updateActiveUsersCount(){const countElement=document.getElementById('active-users');if(countElement){const count=this.activeUsers.size;countElement.innerHTML=`
                <i class="fas fa-users text-blue-400"></i>
                <span>${count} active user${count !== 1 ? 's' : ''}</span>
            `;}}
updatePresencePanel(){const userList=document.getElementById('user-list');if(!userList)return;userList.innerHTML='';this.activeUsers.forEach(user=>{const userElement=document.createElement('div');userElement.className='flex items-center space-x-3 p-2 bg-gray-50 rounded';userElement.innerHTML=`
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                    ${user.user_name ? user.user_name.charAt(0).toUpperCase() : 'U'}
                </div>
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${user.user_name || 'Unknown User'}</div>
                    <div class="text-sm text-gray-500">${user.user_email || ''}</div>
                </div>
                <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-xs text-gray-500">Active</span>
                </div>
            `;userList.appendChild(userElement);});}
togglePresencePanel(){const panel=document.getElementById('user-presence-panel');if(panel){panel.style.display=panel.style.display==='none'?'block':'none';}}
hidePresencePanel(){const panel=document.getElementById('user-presence-panel');if(panel){panel.style.display='none';}}
async checkForConflicts(){if(!this.currentFloor||this.isProcessing)return;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/conflicts`);if(response.ok){const conflicts=await response.json();if(conflicts.length>0){this.handleConflictsDetected(conflicts);}}}catch(error){console.error('Error checking for conflicts:',error);}}
handleConflictsDetected(conflicts){this.conflictQueue=conflicts;const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='flex';conflictElement.innerHTML=`
                <i class="fas fa-exclamation-triangle text-red-400"></i>
                <span>${conflicts.length} conflict${conflicts.length !== 1 ? 's' : ''} detected</span>
            `;}
this.showNotification(`${conflicts.length} conflict(s) detected`,'warning');this.emitEvent('conflictsDetected',conflicts);}
showConflictModal(){const modal=document.getElementById('conflict-resolution-modal');const conflictList=document.getElementById('conflict-list');if(!modal||!conflictList)return;conflictList.innerHTML='';this.conflictQueue.forEach(conflict=>{const conflictElement=document.createElement('div');conflictElement.className='border border-red-200 bg-red-50 p-3 rounded';conflictElement.innerHTML=`
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium text-red-900">${conflict.type}</h4>
                    <span class="text-sm text-red-600">${conflict.severity}</span>
                </div>
                <p class="text-sm text-red-700 mb-2">${conflict.description}</p>
                <div class="text-xs text-red-600">
                    <strong>Affected:</strong> ${conflict.affected_objects.join(', ')}
                </div>
            `;conflictList.appendChild(conflictElement);});modal.style.display='flex';}
hideConflictModal(){const modal=document.getElementById('conflict-resolution-modal');if(modal){modal.style.display='none';}}
async resolveConflicts(){if(this.isProcessing)return;this.isProcessing=true;try{const response=await fetch(`/api/floors/${this.currentFloor.id}/conflicts/resolve`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:this.currentUser.id,conflicts:this.conflictQueue})});if(response.ok){const result=await response.json();this.handleConflictsResolved(result);}else{throw new Error('Failed to resolve conflicts');}}catch(error){console.error('Error resolving conflicts:',error);this.showNotification('Failed to resolve conflicts','error');}finally{this.isProcessing=false;}}
handleConflictsResolved(result){this.conflictQueue=[];const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='none';}
this.hideConflictModal();this.showNotification('Conflicts resolved successfully','success');this.emitEvent('conflictsResolved',result);}
ignoreConflicts(){this.conflictQueue=[];const conflictElement=document.getElementById('conflict-status');if(conflictElement){conflictElement.style.display='none';}
this.hideConflictModal();this.showNotification('Conflicts ignored','info');this.emitEvent('conflictsIgnored');}
handleVersionRestoreStarted(){if(this.options.enableFloorLocking){this.requestFloorLock();}}
handleVersionRestoreCompleted(){setTimeout(()=>{this.releaseFloorLock();},5000);}
handleVersionRestoreFailed(){this.releaseFloorLock();}
handlePageHidden(){this.handleUserInactive();}
handlePageVisible(){this.updateUserActivity();}
showCollaborationSettings(){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Collaboration Settings</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">Floor Locking</label>
                        <input type="checkbox" id="enable-floor-locking" ${this.options.enableFloorLocking ? 'checked' : ''} class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">Conflict Resolution</label>
                        <input type="checkbox" id="enable-conflict-resolution" ${this.options.enableConflictResolution ? 'checked' : ''} class="rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">User Presence</label>
                        <input type="checkbox" id="show-user-presence" ${this.options.showUserPresence ? 'checked' : ''} class="rounded">
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="collaborationSystem.saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Save Settings
                    </button>
                </div>
            </div>
        `;document.body.appendChild(modal);modal.querySelector('#enable-floor-locking').addEventListener('change',(e)=>{this.options.enableFloorLocking=e.target.checked;});modal.querySelector('#enable-conflict-resolution').addEventListener('change',(e)=>{this.options.enableConflictResolution=e.target.checked;});modal.querySelector('#show-user-presence').addEventListener('change',(e)=>{this.options.showUserPresence=e.target.checked;this.updateCollaborationStatus();});}
saveSettings(){localStorage.setItem('collaboration_settings',JSON.stringify({enableFloorLocking:this.options.enableFloorLocking,enableConflictResolution:this.options.enableConflictResolution,showUserPresence:this.options.showUserPresence}));document.querySelector('.fixed.inset-0').remove();this.showNotification('Settings saved successfully','success');}
updateCollaborationStatus(){this.updateFloorLockStatus(!!this.floorLock);this.updateActiveUsersCount();this.updateUserActivity();}
showNotification(message,type='info'){if(window.notificationSystem){window.notificationSystem.show(message,type);}else{console.log(`${type.toUpperCase()}: ${message}`);}}
generateUserId(){return'user_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
generateSessionId(){return'session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
emitEvent(eventName,data){const event=new CustomEvent(eventName,{detail:data,bubbles:true});document.dispatchEvent(event);}
getCollaborationStatistics(){return{currentUser:this.currentUser,currentFloor:this.currentFloor,floorLock:this.floorLock,activeUsers:Array.from(this.activeUsers.values()),activeUsersCount:this.activeUsers.size,conflictQueue:this.conflictQueue,userActivity:Object.fromEntries(this.userActivity)};}
destroy(){if(this.lockTimer)clearInterval(this.lockTimer);if(this.activityTimer)clearInterval(this.activityTimer);if(this.conflictTimer)clearInterval(this.conflictTimer);if(this.presenceTimer)clearInterval(this.presenceTimer);this.releaseFloorLock();const elements=['collaboration-status-bar','user-presence-panel','conflict-resolution-modal'];elements.forEach(id=>{const element=document.getElementById(id);if(element){element.remove();}});this.activeUsers.clear();this.userActivity.clear();this.conflictQueue=[];}}
const collaborationSystem=new CollaborationSystem();if(typeof module!=='undefined'&&module.exports){module.exports=CollaborationSystem;}
class ComparisonView{constructor(containerId,options={}){this.containerId=containerId;this.container=document.getElementById(containerId);this.options={floorId:null,showExportButton:true,showDiffHighlighting:true,showChangeCounts:true,showTimeline:true,maxChanges:1000,...options};this.comparison=null;this.currentView='side-by-side';this.selectedChanges=[];this.render();this.initializeEventListeners();}
render(){this.container.innerHTML=`
            <div class="comparison-view bg-white rounded-lg shadow-md border">
                <!-- Header -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-gray-900">Version Comparison</h3>
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <span id="change-count">0 changes</span>
                                <span></span>
                                <span id="comparison-status">No comparison loaded</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="view-mode" class="border border-gray-300 rounded px-3 py-1 text-sm">
                                <option value="side-by-side">Side by Side</option>
                                <option value="unified">Unified</option>
                                <option value="timeline">Timeline</option>
                            </select>
                            ${this.options.showExportButton ? `<button id="export-comparison"class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm"><i class="fas fa-download mr-2"></i>Export</button>` : ''}
                            <button id="close-comparison" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-times mr-2"></i>Close
                            </button>
                        </div>
                    </div>

                    <!-- Version Info -->
                    <div id="version-info" class="mt-4 grid grid-cols-2 gap-4" style="display: none;">
                        <div class="from-version bg-gray-50 p-3 rounded-md">
                            <h4 class="font-medium text-gray-900 mb-2">From Version</h4>
                            <div id="from-version-details" class="text-sm text-gray-600"></div>
                        </div>
                        <div class="to-version bg-gray-50 p-3 rounded-md">
                            <h4 class="font-medium text-gray-900 mb-2">To Version</h4>
                            <div id="to-version-details" class="text-sm text-gray-600"></div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Content -->
                <div id="comparison-content" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-exchange-alt text-3xl mb-4"></i>
                        <p>Select versions to compare</p>
                    </div>
                </div>

                <!-- Change Summary -->
                <div id="change-summary" class="p-4 border-t border-gray-200 bg-gray-50" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-sm">
                            <span class="flex items-center">
                                <span class="change-indicator change-added mr-2"></span>
                                <span id="added-count">0 added</span>
                            </span>
                            <span class="flex items-center">
                                <span class="change-indicator change-removed mr-2"></span>
                                <span id="removed-count">0 removed</span>
                            </span>
                            <span class="flex items-center">
                                <span class="change-indicator change-modified mr-2"></span>
                                <span id="modified-count">0 modified</span>
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="select-all-changes" class="text-blue-600 hover:text-blue-800 text-sm">
                                Select All
                            </button>
                            <button id="deselect-all-changes" class="text-gray-600 hover:text-gray-800 text-sm">
                                Deselect All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;}
initializeEventListeners(){document.getElementById('view-mode').addEventListener('change',(e)=>{this.currentView=e.target.value;this.renderComparison();});if(this.options.showExportButton){document.getElementById('export-comparison').addEventListener('click',()=>{this.exportComparison();});}
document.getElementById('close-comparison').addEventListener('click',()=>{this.close();});document.getElementById('select-all-changes').addEventListener('click',()=>{this.selectAllChanges();});document.getElementById('deselect-all-changes').addEventListener('click',()=>{this.deselectAllChanges();});}
async loadComparison(fromVersionId,toVersionId){if(!this.options.floorId){this.showError('No floor selected');return;}
try{this.showLoading();const response=await fetch(`/api/floors/${this.options.floorId}/versions/compare`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from_version_id:fromVersionId,to_version_id:toVersionId})});if(response.ok){this.comparison=await response.json();this.renderComparison();this.updateChangeCounts();}else{throw new Error('Failed to load comparison');}}catch(error){this.showError('Error loading comparison: '+error.message);}}
renderComparison(){if(!this.comparison){this.showEmptyState();return;}
const content=document.getElementById('comparison-content');switch(this.currentView){case'side-by-side':content.innerHTML=this.renderSideBySideView();break;case'unified':content.innerHTML=this.renderUnifiedView();break;case'timeline':content.innerHTML=this.renderTimelineView();break;}
this.renderVersionInfo();this.showChangeSummary();this.initializeChangeSelection();}
renderSideBySideView(){const{from_data,to_data,changes}=this.comparison;return`
            <div class="grid grid-cols-2 gap-6 h-96">
                <div class="comparison-panel border border-gray-200 rounded-md overflow-hidden">
                    <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900">From Version</h4>
                    </div>
                    <div class="comparison-content p-4 h-80 overflow-y-auto">
                        ${this.renderDiffContent(from_data, changes, 'from')}
                    </div>
                </div>

                <div class="comparison-panel border border-gray-200 rounded-md overflow-hidden">
                    <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900">To Version</h4>
                    </div>
                    <div class="comparison-content p-4 h-80 overflow-y-auto">
                        ${this.renderDiffContent(to_data, changes, 'to')}
                    </div>
                </div>
            </div>
        `;}
renderUnifiedView(){const{changes}=this.comparison;return`
            <div class="unified-view border border-gray-200 rounded-md overflow-hidden">
                <div class="comparison-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                    <h4 class="font-medium text-gray-900">Unified Changes</h4>
                </div>
                <div class="comparison-content p-4 h-96 overflow-y-auto">
                    ${this.renderUnifiedChanges(changes)}
                </div>
            </div>
        `;}
renderTimelineView(){const{changes}=this.comparison;return`
            <div class="timeline-view">
                <div class="timeline-header bg-gray-50 px-4 py-2 border-b border-gray-200">
                    <h4 class="font-medium text-gray-900">Change Timeline</h4>
                </div>
                <div class="timeline-content p-4 h-96 overflow-y-auto">
                    ${this.renderTimelineChanges(changes)}
                </div>
            </div>
        `;}
renderDiffContent(data,changes,side){if(!data)return'<div class="text-gray-500">No data available</div>';let html='<div class="space-y-2">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;if(side==='from'&&change.type==='removed'){html+=`
                    <div class="diff-item diff-removed p-2 rounded border-l-4 border-red-500 bg-red-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-red-700">${change.old_value}</span>
                    </div>
                `;}else if(side==='to'&&change.type==='added'){html+=`
                    <div class="diff-item diff-added p-2 rounded border-l-4 border-green-500 bg-green-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-green-700">${change.new_value}</span>
                    </div>
                `;}else if(change.type==='modified'){const value=side==='from'?change.old_value:change.new_value;html+=`
                    <div class="diff-item diff-modified p-2 rounded border-l-4 border-yellow-500 bg-yellow-50">
                        ${checkbox}${indicator}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-yellow-700">${value}</span>
                    </div>
                `;}else if(change.type==='unchanged'){html+=`
                    <div class="diff-item p-2 rounded">
                        ${checkbox}
                        <span class="font-medium">${change.key}:</span>
                        <span class="text-gray-600">${change.value}</span>
                    </div>
                `;}});html+='</div>';return html;}
renderUnifiedChanges(changes){let html='<div class="space-y-3">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;switch(change.type){case'added':html+=`
                        <div class="unified-item diff-added p-3 rounded border-l-4 border-green-500 bg-green-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-green-600 text-sm">+ Added</span>
                            </div>
                            <div class="mt-1 text-green-700">${change.new_value}</div>
                        </div>
                    `;break;case'removed':html+=`
                        <div class="unified-item diff-removed p-3 rounded border-l-4 border-red-500 bg-red-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-red-600 text-sm">- Removed</span>
                            </div>
                            <div class="mt-1 text-red-700">${change.old_value}</div>
                        </div>
                    `;break;case'modified':html+=`
                        <div class="unified-item diff-modified p-3 rounded border-l-4 border-yellow-500 bg-yellow-50">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-yellow-600 text-sm">~ Modified</span>
                            </div>
                            <div class="mt-2 space-y-1">
                                <div class="text-red-700 text-sm">- ${change.old_value}</div>
                                <div class="text-green-700 text-sm">+ ${change.new_value}</div>
                            </div>
                        </div>
                    `;break;case'unchanged':html+=`
                        <div class="unified-item p-3 rounded border border-gray-200">
                            ${checkbox}
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-gray-500 text-sm">No change</span>
                            </div>
                            <div class="mt-1 text-gray-600">${change.value}</div>
                        </div>
                    `;break;}});html+='</div>';return html;}
renderTimelineChanges(changes){let html='<div class="space-y-4">';changes.forEach((change,index)=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;const checkbox=`<input type="checkbox" class="change-checkbox mr-2" data-change-index="${index}">`;html+=`
                <div class="timeline-item flex items-start space-x-3">
                    <div class="timeline-marker flex-shrink-0 w-3 h-3 rounded-full ${changeClass === 'change-added' ? 'bg-green-500' : changeClass === 'change-removed' ? 'bg-red-500' : 'bg-yellow-500'} mt-2"></div>
                    <div class="timeline-content flex-1">
                        <div class="bg-white border border-gray-200 rounded-md p-3">
                            ${checkbox}${indicator}
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">${change.key}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    change.type === 'added' ? 'bg-green-100 text-green-800' :
                                    change.type === 'removed' ? 'bg-red-100 text-red-800' :
                                    change.type === 'modified' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                }">${change.type}</span>
                            </div>
                            ${this.renderTimelineChangeDetails(change)}
                        </div>
                    </div>
                </div>
            `;});html+='</div>';return html;}
renderTimelineChangeDetails(change){switch(change.type){case'added':return`<div class="text-green-700 text-sm">${change.new_value}</div>`;case'removed':return`<div class="text-red-700 text-sm">${change.old_value}</div>`;case'modified':return`
                    <div class="space-y-1">
                        <div class="text-red-700 text-sm">- ${change.old_value}</div>
                        <div class="text-green-700 text-sm">+ ${change.new_value}</div>
                    </div>
                `;case'unchanged':return`<div class="text-gray-600 text-sm">${change.value}</div>`;default:return'';}}
getChangeClass(type){const classes={'added':'change-added','removed':'change-removed','modified':'change-modified','unchanged':'change-unchanged'};return classes[type]||'';}
renderVersionInfo(){const{from_version,to_version}=this.comparison;document.getElementById('from-version-details').innerHTML=`
            <div class="space-y-1">
                <div><strong>Description:</strong> ${from_version.description || 'Untitled'}</div>
                <div><strong>Created by:</strong> ${from_version.created_by}</div>
                <div><strong>Date:</strong> ${new Date(from_version.created_at).toLocaleString()}</div>
                <div><strong>Type:</strong> ${this.formatVersionType(from_version.type)}</div>
            </div>
        `;document.getElementById('to-version-details').innerHTML=`
            <div class="space-y-1">
                <div><strong>Description:</strong> ${to_version.description || 'Untitled'}</div>
                <div><strong>Created by:</strong> ${to_version.created_by}</div>
                <div><strong>Date:</strong> ${new Date(to_version.created_at).toLocaleString()}</div>
                <div><strong>Type:</strong> ${this.formatVersionType(to_version.type)}</div>
            </div>
        `;document.getElementById('version-info').style.display='grid';}
formatVersionType(type){const types={'manual':'Manual Snapshot','auto-save':'Auto Save','branch':'Branch','restored':'Restored'};return types[type]||type;}
updateChangeCounts(){if(!this.comparison)return;const{changes}=this.comparison;const counts={added:changes.filter(c=>c.type==='added').length,removed:changes.filter(c=>c.type==='removed').length,modified:changes.filter(c=>c.type==='modified').length};document.getElementById('added-count').textContent=`${counts.added} added`;document.getElementById('removed-count').textContent=`${counts.removed} removed`;document.getElementById('modified-count').textContent=`${counts.modified} modified`;document.getElementById('change-count').textContent=`${changes.length} changes`;document.getElementById('comparison-status').textContent='Comparison loaded';}
showChangeSummary(){document.getElementById('change-summary').style.display='block';}
initializeChangeSelection(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.addEventListener('change',(e)=>{const index=parseInt(e.target.dataset.changeIndex);if(e.target.checked){this.selectedChanges.push(index);}else{this.selectedChanges=this.selectedChanges.filter(i=>i!==index);}});});}
selectAllChanges(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.checked=true;const index=parseInt(checkbox.dataset.changeIndex);if(!this.selectedChanges.includes(index)){this.selectedChanges.push(index);}});}
deselectAllChanges(){const checkboxes=document.querySelectorAll('.change-checkbox');checkboxes.forEach(checkbox=>{checkbox.checked=false;});this.selectedChanges=[];}
async exportComparison(){if(!this.comparison){this.showError('No comparison to export');return;}
try{const response=await fetch(`/api/floors/${this.options.floorId}/versions/export-comparison`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({comparison:this.comparison,selected_changes:this.selectedChanges,format:'pdf'})});if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`comparison-${Date.now()}.pdf`;a.click();window.URL.revokeObjectURL(url);this.showSuccess('Comparison exported successfully');}else{throw new Error('Failed to export comparison');}}catch(error){this.showError('Error exporting comparison: '+error.message);}}
showLoading(){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                <p>Loading comparison...</p>
            </div>
        `;}
showEmptyState(){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-exchange-alt text-3xl mb-4"></i>
                <p>Select versions to compare</p>
            </div>
        `;}
showError(message){const content=document.getElementById('comparison-content');content.innerHTML=`
            <div class="text-center text-red-500 py-8">
                <i class="fas fa-exclamation-circle text-3xl mb-4"></i>
                <p>${message}</p>
            </div>
        `;}
showSuccess(message){console.log('Success:',message);}
close(){this.comparison=null;this.selectedChanges=[];this.showEmptyState();document.getElementById('version-info').style.display='none';document.getElementById('change-summary').style.display='none';document.getElementById('change-count').textContent='0 changes';document.getElementById('comparison-status').textContent='No comparison loaded';}
getSelectedChanges(){return this.selectedChanges;}
getComparison(){return this.comparison;}
updateFloorId(floorId){this.options.floorId=floorId;}
destroy(){if(this.container){this.container.innerHTML='';}}}
if(typeof module!=='undefined'&&module.exports){module.exports=ComparisonView;}
class ConnectorManager{constructor(){this.connectors=[];this.currentFloorId=null;this.filters={floor_id:null,system:null,connector_type:null,connection_status:null,status:null,search:null};this.init();}
init(){this.setupEventListeners();this.loadConnectors();}
setupEventListeners(){const floorFilter=document.getElementById('connector-floor-filter');if(floorFilter){floorFilter.addEventListener('change',(e)=>{this.filters.floor_id=e.target.value||null;this.loadConnectors();});}
const systemFilter=document.getElementById('connector-system-filter');if(systemFilter){systemFilter.addEventListener('change',(e)=>{this.filters.system=e.target.value||null;this.loadConnectors();});}
const typeFilter=document.getElementById('connector-type-filter');if(typeFilter){typeFilter.addEventListener('change',(e)=>{this.filters.connector_type=e.target.value||null;this.loadConnectors();});}
const searchFilter=document.getElementById('connector-search-filter');if(searchFilter){searchFilter.addEventListener('input',(e)=>{this.filters.search=e.target.value||null;this.loadConnectors();});}
const createBtn=document.getElementById('create-connector-btn');if(createBtn){createBtn.addEventListener('click',()=>this.showCreateConnectorModal());}
const bulkFloorBtn=document.getElementById('bulk-floor-assign-btn');if(bulkFloorBtn){bulkFloorBtn.addEventListener('click',()=>this.showBulkFloorAssignment());}}
async loadConnectors(){try{const params=new URLSearchParams();Object.entries(this.filters).forEach(([key,value])=>{if(value)params.append(key,value);});const response=await fetch(`/api/connectors?${params.toString()}`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const data=await response.json();this.connectors=data.results||[];this.renderConnectorList();this.updateConnectorStats();}else{console.error('Failed to load connectors:',response.statusText);this.showNotification('Failed to load connectors','error');}}catch(error){console.error('Error loading connectors:',error);this.showNotification('Error loading connectors','error');}}
renderConnectorList(){const container=document.getElementById('connector-list');if(!container)return;if(this.connectors.length===0){container.innerHTML=`
                <div class="text-center py-8 text-gray-500">
                    <p>No connectors found</p>
                    <button onclick="connectorManager.showCreateConnectorModal()"
                            class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Create First Connector
                    </button>
                </div>
            `;return;}
const grouped=this.groupConnectorsByFloor();let html='';for(const[floorName,connectors]of Object.entries(grouped)){html+=`<div class="mb-6">
                <div class="text-lg font-bold text-blue-700 mb-2 flex items-center">
                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">${floorName}</span>
                    <span class="text-xs text-gray-400">(${connectors.length} connector${connectors.length !== 1 ? 's' : ''})</span>
                </div>
                <div>`;html+=connectors.map(connector=>`
                    <div class="connector-item bg-white border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                        ${connector.name}
                                        <span class="ml-2 px-2 py-0.5 text-xs font-semibold rounded bg-blue-50 text-blue-700 border border-blue-200">${connector.floor?.name || 'N/A'}</span>
                                    </h3>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${this.getStatusColor(connector.status)}">
                                        ${connector.status}
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                    <div><span class="font-medium">Type:</span> ${connector.connector_type || 'N/A'}</div>
                                    <div><span class="font-medium">System:</span> ${connector.system || 'N/A'}</div>
                                    <div><span class="font-medium">Connection:</span> ${connector.connection_type || 'N/A'}</div>
                                    <div><span class="font-medium">Status:</span> ${connector.connection_status || 'N/A'}</div>
                                    <div><span class="font-medium">Floor:</span> ${connector.floor?.name || 'N/A'}</div>
                                    <div><span class="font-medium">Capacity:</span> ${connector.current_load || 0}/${connector.max_capacity || '\u221e'}</div>
                                </div>
                                ${connector.description ? `<div class="mt-2 text-sm text-gray-500">${connector.description}</div>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="connectorManager.editConnector('${connector.object_id}')" class="bg-blue-500 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded">Edit</button>
                                <button onclick="connectorManager.deleteConnector('${connector.object_id}')" class="bg-red-500 hover:bg-red-700 text-white text-sm px-3 py-1 rounded">Delete</button>
                            </div>
                        </div>
                    </div>
            `).join('');html+=`</div></div>`;}
container.innerHTML=html;}
getStatusColor(status){switch(status){case'active':return'bg-green-100 text-green-800';case'inactive':return'bg-gray-100 text-gray-800';case'maintenance':return'bg-yellow-100 text-yellow-800';case'retired':return'bg-red-100 text-red-800';default:return'bg-gray-100 text-gray-800';}}
updateConnectorStats(){const statsContainer=document.getElementById('connector-stats');if(!statsContainer)return;const total=this.connectors.length;const active=this.connectors.filter(c=>c.status==='active').length;const connected=this.connectors.filter(c=>c.connection_status==='connected').length;const byFloor=this.groupConnectorsByFloor();statsContainer.innerHTML=`
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${total}</div>
                    <div class="text-sm text-blue-600">Total Connectors</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${active}</div>
                    <div class="text-sm text-green-600">Active</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">${connected}</div>
                    <div class="text-sm text-purple-600">Connected</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600">${Object.keys(byFloor).length}</div>
                    <div class="text-sm text-orange-600">Floors</div>
                </div>
            </div>
        `;}
groupConnectorsByFloor(){return this.connectors.reduce((groups,connector)=>{const floorName=connector.floor?.name||'Unknown Floor';if(!groups[floorName]){groups[floorName]=[];}
groups[floorName].push(connector);return groups;},{});}
showCreateConnectorModal(){const modal=document.getElementById('create-connector-modal');if(modal){modal.classList.remove('hidden');this.loadFloorsForModal();}}
hideCreateConnectorModal(){const modal=document.getElementById('create-connector-modal');if(modal){modal.classList.add('hidden');}}
async loadFloorsForModal(){try{const response=await fetch('/api/buildings/1/floors',{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();const floorSelect=document.getElementById('new-connector-floor');if(floorSelect){floorSelect.innerHTML='<option value="">-- Select Floor --</option>'+
floors.map(floor=>`<option value="${floor.id}">${floor.name}</option>`).join('');}}}catch(error){console.error('Error loading floors:',error);}}
async createConnector(formData){try{const response=await fetch('/api/connectors',{method:'POST',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){const connector=await response.json();this.showNotification('Connector created successfully','success');this.hideCreateConnectorModal();this.loadConnectors();return connector;}else{const error=await response.json();this.showNotification(`Failed to create connector: ${error.message}`,'error');return null;}}catch(error){console.error('Error creating connector:',error);this.showNotification('Error creating connector','error');return null;}}
async editConnector(connectorId){try{const response=await fetch(`/api/connectors/${connectorId}`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const connector=await response.json();this.showEditConnectorModal(connector);}else{this.showNotification('Failed to load connector details','error');}}catch(error){console.error('Error loading connector:',error);this.showNotification('Error loading connector','error');}}
showEditConnectorModal(connector){const modal=document.getElementById('edit-connector-modal');if(modal){document.getElementById('edit-connector-name').value=connector.name||'';document.getElementById('edit-connector-floor').value=connector.floor_id||'';document.getElementById('edit-connector-type').value=connector.connector_type||'';document.getElementById('edit-connection-type').value=connector.connection_type||'';document.getElementById('edit-connection-status').value=connector.connection_status||'';document.getElementById('edit-max-capacity').value=connector.max_capacity||'';document.getElementById('edit-current-load').value=connector.current_load||'';document.getElementById('edit-connector-description').value=connector.description||'';modal.setAttribute('data-connector-id',connector.object_id);modal.classList.remove('hidden');}}
async updateConnector(connectorId,formData){try{const response=await fetch(`/api/connectors/${connectorId}`,{method:'PUT',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){this.showNotification('Connector updated successfully','success');this.hideEditConnectorModal();this.loadConnectors();return true;}else{const error=await response.json();this.showNotification(`Failed to update connector: ${error.message}`,'error');return false;}}catch(error){console.error('Error updating connector:',error);this.showNotification('Error updating connector','error');return false;}}
async deleteConnector(connectorId){if(!confirm('Are you sure you want to delete this connector?')){return;}
try{const response=await fetch(`/api/connectors/${connectorId}`,{method:'DELETE',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){this.showNotification('Connector deleted successfully','success');this.loadConnectors();}else{this.showNotification('Failed to delete connector','error');}}catch(error){console.error('Error deleting connector:',error);this.showNotification('Error deleting connector','error');}}
showBulkFloorAssignment(){const modal=document.getElementById('bulk-floor-assignment-modal');if(modal){modal.classList.remove('hidden');this.loadFloorsForBulkAssignment();}}
async loadFloorsForBulkAssignment(){try{const response=await fetch('/api/buildings/1/floors',{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();const floorSelect=document.getElementById('bulk-assignment-floor');if(floorSelect){floorSelect.innerHTML='<option value="">-- Select Floor --</option>'+
floors.map(floor=>`<option value="${floor.id}">${floor.name}</option>`).join('');}}}catch(error){console.error('Error loading floors for bulk assignment:',error);}}
async assignConnectorsToFloor(connectorIds,floorId){try{const promises=connectorIds.map(connectorId=>fetch(`/api/connectors/${connectorId}`,{method:'PUT',headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'},body:JSON.stringify({floor_id:parseInt(floorId)})}));const results=await Promise.allSettled(promises);const successful=results.filter(result=>result.status==='fulfilled'&&result.value.ok).length;const failed=results.length-successful;if(successful>0){this.showNotification(`Successfully assigned ${successful} connectors to floor`,'success');if(failed>0){this.showNotification(`${failed} connectors failed to update`,'warning');}
this.loadConnectors();}else{this.showNotification('Failed to assign connectors to floor','error');}}catch(error){console.error('Error in bulk floor assignment:',error);this.showNotification('Error assigning connectors to floor','error');}}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            type === 'warning' ? 'bg-yellow-500 text-white' :
            'bg-blue-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},3000);}
hideEditConnectorModal(){const modal=document.getElementById('edit-connector-modal');if(modal){modal.classList.add('hidden');}}}
document.addEventListener('DOMContentLoaded',()=>{window.connectorManager=new ConnectorManager();});const ConsoleLogReplacer={patterns:{simpleString:{from:/console\.log\('([^']+)'\)/g,to:(match,message)=>`window.arxLogger.info('${message}')`},templateLiteral:{from:/console\.log\(`([^`]+)`\)/g,to:(match,message)=>`window.arxLogger.info(\`${message}\`)`},variable:{from:/console\.log\(([^)]+)\)/g,to:(match,expression)=>`window.arxLogger.info(${expression})`},multiArg:{from:/console\.log\(([^)]+(?:,\s*[^)]+)*)\)/g,to:(match,args)=>`window.arxLogger.info(${args})`}},smartReplace:function(content,fileName){let modifiedContent=content;let replacements=0;modifiedContent=modifiedContent.replace(this.patterns.simpleString.from,(match,message)=>{replacements++;const level=this.determineLogLevel(message);return`window.arxLogger.${level}('${message}', { file: '${fileName}' })`;});modifiedContent=modifiedContent.replace(this.patterns.templateLiteral.from,(match,message)=>{replacements++;const level=this.determineLogLevel(message);return`window.arxLogger.${level}(\`${message}\`, { file: '${fileName}' })`;});modifiedContent=modifiedContent.replace(this.patterns.variable.from,(match,expression)=>{replacements++;const level=this.determineLogLevel(expression);return`window.arxLogger.${level}(${expression}, { file: '${fileName}' })`;});return{content:modifiedContent,replacements};},determineLogLevel:function(message){const lowerMessage=message.toLowerCase();if(/error|failed|failure|exception|crash|broken|invalid|missing|not found|unauthorized|forbidden|timeout|connection failed|network error/i.test(lowerMessage)){return'error';}
if(/warn|warning|deprecated|obsolete|slow|performance|retry|fallback|degraded|partial|incomplete/i.test(lowerMessage)){return'warning';}
if(/debug|test|testing|tester|performance|benchmark|profile|trace|verbose|detailed|step|phase/i.test(lowerMessage)){return'debug';}
if(/info|connected|disconnected|initialized|started|completed|finished|loaded|saved|updated|created|deleted|moved|resized|selected|deselected/i.test(lowerMessage)){return'info';}
return'info';},getFileExamples:function(){return{'realtime_manager.js':[{from:"console.log('RealTimeManager initialized for user:', this.username);",to:"window.arxLogger.info('RealTimeManager initialized for user:', this.username, { file: 'realtime_manager.js' });"},{from:"console.log('WebSocket connected');",to:"window.arxLogger.info('WebSocket connected', { file: 'realtime_manager.js' });"},{from:"console.log('WebSocket disconnected');",to:"window.arxLogger.warning('WebSocket disconnected', { file: 'realtime_manager.js' });"},{from:"console.log('Received message:', message);",to:"window.arxLogger.debug('Received message:', message, { file: 'realtime_manager.js' });"}],'object_interaction.js':[{from:"console.log('SVGObjectInteraction connected to ViewportManager');",to:"window.arxLogger.info('SVGObjectInteraction connected to ViewportManager', { file: 'object_interaction.js' });"},{from:"console.log('Object deleted successfully:', id);",to:"window.arxLogger.info('Object deleted successfully:', id, { file: 'object_interaction.js' });"},{from:"console.log('=== Testing Multi-Object Selection with Zoom ===');",to:"window.arxLogger.debug('=== Testing Multi-Object Selection with Zoom ===', { file: 'object_interaction.js' });"}],'viewport_manager.js':[{from:"console.log(`ViewportCulling: ${visibleCount}/${this.totalObjects} objects visible (${culledCount} culled) in ${cullingTime.toFixed(2)}ms`);",to:"window.arxLogger.debug(`ViewportCulling: ${visibleCount}/${this.totalObjects} objects visible (${culledCount} culled) in ${cullingTime.toFixed(2)}ms`, { file: 'viewport_manager.js' });"},{from:"console.log('ViewportCulling: Enabled');",to:"window.arxLogger.info('ViewportCulling: Enabled', { file: 'viewport_manager.js' });"}],'lod_manager.js':[{from:"console.log('LODManager initialized');",to:"window.arxLogger.info('LODManager initialized', { file: 'lod_manager.js' });"},{from:"console.log(`LODManager: Switching from ${this.currentLODLevel} to ${newLevel} at zoom ${zoomLevel}`);",to:"window.arxLogger.info(`LODManager: Switching from ${this.currentLODLevel} to ${newLevel} at zoom ${zoomLevel}`, { file: 'lod_manager.js' });"}],'throttled_update_manager.js':[{from:"console.log('ThrottledUpdateManager initialized');",to:"window.arxLogger.info('ThrottledUpdateManager initialized', { file: 'throttled_update_manager.js' });"}],'bim_editing_integration.js':[{from:"console.log('BIMEditingIntegration connected to ViewportManager');",to:"window.arxLogger.info('BIMEditingIntegration connected to ViewportManager', { file: 'bim_editing_integration.js' });"},{from:"console.log('Major edit detected:', edit);",to:"window.arxLogger.info('Major edit detected:', edit, { file: 'bim_editing_integration.js' });"}],'collaboration_system.js':[{from:"console.log('CollaborationSystem initialized');",to:"window.arxLogger.info('CollaborationSystem initialized', { file: 'collaboration_system.js' });"}],'data_partitioning_manager.js':[{from:"console.log('DataPartitioningManager initialized');",to:"window.arxLogger.info('DataPartitioningManager initialized', { file: 'data_partitioning_manager.js' });"}],'symbol_library.js':[{from:"console.log('SymbolLibrary connected to ViewportManager');",to:"window.arxLogger.info('SymbolLibrary connected to ViewportManager', { file: 'symbol_library.js' });"},{from:"console.log(`Symbol placed at real-world coordinates: (${realWorldCoords.x.toFixed(2)}, ${realWorldCoords.y.toFixed(2)}) ${this.viewportManager.currentUnit}`);",to:"window.arxLogger.info(`Symbol placed at real-world coordinates: (${realWorldCoords.x.toFixed(2)}, ${realWorldCoords.y.toFixed(2)}) ${this.viewportManager.currentUnit}`, { file: 'symbol_library.js' });"}]};},getReplacementSummary:function(){const files={'realtime_manager.js':15,'object_interaction.js':15,'viewport_manager.js':12,'lod_manager.js':8,'throttled_update_manager.js':8,'bim_editing_integration.js':4,'collaboration_system.js':4,'data_partitioning_manager.js':2,'symbol_library.js':3};const total=Object.values(files).reduce((sum,count)=>sum+count,0);return{files,total,summary:`Total console.log calls to replace: ${total} across ${Object.keys(files).length} files`};}};if(typeof module!=='undefined'&&module.exports){module.exports=ConsoleLogReplacer;}
window.ConsoleLogReplacer=ConsoleLogReplacer;console.log('ConsoleLogReplacer loaded. Use ConsoleLogReplacer.getReplacementSummary() to see what needs to be replaced.');class ContextPanel{constructor(){this.panel=document.getElementById('context-panel');this.content=this.panel?this.panel.querySelector('#context-panel-content'):null;this.selectedObjects=new Set();this.isVisible=false;this.init();}
init(){if(!this.panel||!this.content)return;this.setupEventListeners();}
setupEventListeners(){const closeBtn=this.panel.querySelector('#close-context-panel');if(closeBtn){closeBtn.addEventListener('click',()=>this.hide());}
document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.isVisible)this.hide();});document.addEventListener('click',(e)=>{if(!this.panel.contains(e.target)&&this.isVisible)this.hide();});}
updateSelection(selectedObjects){this.selectedObjects=selectedObjects;if(selectedObjects.size===0){this.hide();return;}
if(selectedObjects.size===1){this.showSingleObjectPanel(Array.from(selectedObjects)[0]);}else{this.showMultiObjectPanel(selectedObjects);}}
showSingleObjectPanel(object){this.isVisible=true;this.panel.classList.remove('hidden');const objectData=this.extractObjectData(object);const floorInfo=this.getFloorInfo(objectData.floor_id);this.content.innerHTML=`
            <div class="space-y-4">
                ${objectData.type === 'connector' ? `<div class="flex items-center space-x-2"><span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold">Floor:${floorInfo?floorInfo.name||floorInfo.id:'N/A'}</span></div>` : ''}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="object-name" value="${objectData.name || ''}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="object-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="device" ${objectData.type === 'device' ? 'selected' : ''}>Device</option>
                        <option value="room" ${objectData.type === 'room' ? 'selected' : ''}>Room</option>
                        <option value="panel" ${objectData.type === 'panel' ? 'selected' : ''}>Panel</option>
                        <option value="connector" ${objectData.type === 'connector' ? 'selected' : ''}>Connector</option>
                        <option value="label" ${objectData.type === 'label' ? 'selected' : ''}>Label</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">System</label>
                    <select id="object-system" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="electrical" ${objectData.system === 'electrical' ? 'selected' : ''}>Electrical</option>
                        <option value="hvac" ${objectData.system === 'hvac' ? 'selected' : ''}>HVAC</option>
                        <option value="plumbing" ${objectData.system === 'plumbing' ? 'selected' : ''}>Plumbing</option>
                        <option value="fire" ${objectData.system === 'fire' ? 'selected' : ''}>Fire Alarm</option>
                        <option value="security" ${objectData.system === 'security' ? 'selected' : ''}>Security</option>
                        <option value="av" ${objectData.system === 'av' ? 'selected' : ''}>Audio/Video</option>
                        <option value="network" ${objectData.system === 'network' ? 'selected' : ''}>Network</option>
                        <option value="lighting" ${objectData.system === 'lighting' ? 'selected' : ''}>Lighting</option>
                    </select>
                </div>

                <!-- Floor Selection (for all objects) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                    <select id="object-floor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select Floor --</option>
                        ${this.getFloorOptions(objectData.floor_id)}
                    </select>
                </div>

                <!-- Connector-specific fields -->
                <div id="connector-fields" class="space-y-3 ${objectData.type === 'connector' ? '' : 'hidden'}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connector Type</label>
                        <select id="connector-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="electrical" ${objectData.connector_type === 'electrical' ? 'selected' : ''}>Electrical</option>
                            <option value="plumbing" ${objectData.connector_type === 'plumbing' ? 'selected' : ''}>Plumbing</option>
                            <option value="hvac" ${objectData.connector_type === 'hvac' ? 'selected' : ''}>HVAC</option>
                            <option value="data" ${objectData.connector_type === 'data' ? 'selected' : ''}>Data</option>
                            <option value="av" ${objectData.connector_type === 'av' ? 'selected' : ''}>Audio/Video</option>
                            <option value="fire" ${objectData.connector_type === 'fire' ? 'selected' : ''}>Fire Alarm</option>
                            <option value="security" ${objectData.connector_type === 'security' ? 'selected' : ''}>Security</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connection Type</label>
                        <select id="connection-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="male" ${objectData.connection_type === 'male' ? 'selected' : ''}>Male</option>
                            <option value="female" ${objectData.connection_type === 'female' ? 'selected' : ''}>Female</option>
                            <option value="both" ${objectData.connection_type === 'both' ? 'selected' : ''}>Both</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connection Status</label>
                        <select id="connection-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="connected" ${objectData.connection_status === 'connected' ? 'selected' : ''}>Connected</option>
                            <option value="disconnected" ${objectData.connection_status === 'disconnected' ? 'selected' : ''}>Disconnected</option>
                            <option value="pending" ${objectData.connection_status === 'pending' ? 'selected' : ''}>Pending</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Capacity</label>
                            <input type="number" id="max-capacity" value="${objectData.max_capacity || ''}" step="0.1" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Load</label>
                            <input type="number" id="current-load" value="${objectData.current_load || ''}" step="0.1" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="object-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active" ${objectData.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${objectData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        <option value="maintenance" ${objectData.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="retired" ${objectData.status === 'retired' ? 'selected' : ''}>Retired</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">X Position</label>
                        <input type="number" id="object-x" value="${objectData.x || 0}" step="0.1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Y Position</label>
                        <input type="number" id="object-y" value="${objectData.y || 0}" step="0.1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rotation</label>
                    <input type="number" id="object-rotation" value="${objectData.rotation || 0}" step="1" min="0" max="360"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input type="text" id="object-tags" value="${objectData.tags || ''}"
                           placeholder="Enter tags separated by commas"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="object-description" rows="3"
                              placeholder="Enter description"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${objectData.description || ''}</textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Funding Source</label>
                    <input type="text" id="object-funding-source" value="${objectData.funding_source || ''}"
                           placeholder="e.g., Capital Budget, Grant, Operating Budget"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex space-x-2 pt-4">
                    <button id="save-object" class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Save
                    </button>
                    <button id="delete-object" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Delete
                    </button>
                </div>
            </div>
        `;this.setupFormEventListeners(object);}
showMultiObjectPanel(selectedObjects){this.isVisible=true;this.panel.classList.remove('hidden');this.content.innerHTML=`
            <div class="space-y-4">
                <div class="text-center">
                    <h4 class="font-medium text-gray-800">${selectedObjects.size} Objects Selected</h4>
                    <p class="text-sm text-gray-500">Batch operations</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">System (apply to all)</label>
                    <select id="batch-system" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No change</option>
                        <option value="electrical">Electrical</option>
                        <option value="hvac">HVAC</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="fire">Fire Alarm</option>
                        <option value="security">Security</option>
                        <option value="av">Audio/Video</option>
                        <option value="network">Network</option>
                        <option value="lighting">Lighting</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status (apply to all)</label>
                    <select id="batch-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">No change</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="retired">Retired</option>
                    </select>
                </div>

                <div class="flex space-x-2">
                    <button id="batch-save" class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Apply Changes
                    </button>
                    <button id="batch-delete" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Delete All
                    </button>
                </div>
            </div>
        `;this.setupBatchEventListeners(selectedObjects);}
setupFormEventListeners(object){const saveBtn=this.panel.querySelector('#save-object');const deleteBtn=this.panel.querySelector('#delete-object');const typeSelect=this.panel.querySelector('#object-type');saveBtn.addEventListener('click',()=>this.saveObjectChanges(object));deleteBtn.addEventListener('click',()=>{if(confirm('Are you sure you want to delete this object?')){this.deleteObject(object);}});typeSelect.addEventListener('change',()=>{const connectorFields=this.panel.querySelector('#connector-fields');if(typeSelect.value==='connector'){connectorFields.classList.remove('hidden');}else{connectorFields.classList.add('hidden');}});const xInput=this.panel.querySelector('#object-x');const yInput=this.panel.querySelector('#object-y');const rotationInput=this.panel.querySelector('#object-rotation');xInput.addEventListener('input',()=>{const x=parseFloat(xInput.value)||0;const y=parseFloat(yInput.value)||0;this.updateObjectPosition(object,x,y);});yInput.addEventListener('input',()=>{const x=parseFloat(xInput.value)||0;const y=parseFloat(yInput.value)||0;this.updateObjectPosition(object,x,y);});rotationInput.addEventListener('input',()=>{const rotation=parseFloat(rotationInput.value)||0;this.updateObjectRotation(object,rotation);});}
setupBatchEventListeners(selectedObjects){const batchSaveBtn=this.panel.querySelector('#batch-save');const batchDeleteBtn=this.panel.querySelector('#batch-delete');batchSaveBtn.addEventListener('click',()=>this.saveBatchChanges(selectedObjects));batchDeleteBtn.addEventListener('click',()=>{if(confirm(`Are you sure you want to delete ${selectedObjects.size} objects?`)){this.deleteBatchObjects(selectedObjects);}});}
extractObjectData(object){return{id:object.getAttribute('data-id'),name:object.getAttribute('data-name')||'',type:object.getAttribute('data-type')||'device',system:object.getAttribute('data-system')||'electrical',status:object.getAttribute('data-status')||'active',x:parseFloat(object.getAttribute('data-x')||0),y:parseFloat(object.getAttribute('data-y')||0),rotation:parseFloat(object.getAttribute('data-rotation')||0),tags:object.getAttribute('data-tags')||'',description:object.getAttribute('data-description')||'',floor_id:object.getAttribute('data-floor-id')||'',connector_type:object.getAttribute('data-connector-type')||'',connection_type:object.getAttribute('data-connection-type')||'',connection_status:object.getAttribute('data-connection-status')||'',max_capacity:parseFloat(object.getAttribute('data-max-capacity')||''),current_load:parseFloat(object.getAttribute('data-current-load')||''),funding_source:object.getAttribute('data-funding-source')||''};}
async saveObjectChanges(object){const formData=this.getFormData();try{const response=await fetch(`/api/bim/objects/${object.getAttribute('data-id')}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});if(response.ok){this.updateObjectAttributes(object,formData);this.showNotification('Object saved successfully','success');}else{throw new Error('Failed to save object');}}catch(error){console.error('Error saving object:',error);this.showNotification('Failed to save object','error');}}
async saveBatchChanges(selectedObjects){const batchData=this.getBatchFormData();const objectIds=Array.from(selectedObjects).map(obj=>obj.getAttribute('data-id'));try{const response=await fetch('/api/bim/objects/bulk-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({object_ids:objectIds,updates:batchData})});if(response.ok){selectedObjects.forEach(obj=>this.updateObjectAttributes(obj,batchData));this.showNotification('Batch changes applied successfully','success');}else{throw new Error('Failed to apply batch changes');}}catch(error){console.error('Error applying batch changes:',error);this.showNotification('Failed to apply batch changes','error');}}
getFormData(){return{name:this.panel.querySelector('#object-name').value,type:this.panel.querySelector('#object-type').value,system:this.panel.querySelector('#object-system').value,status:this.panel.querySelector('#object-status').value,x:parseFloat(this.panel.querySelector('#object-x').value),y:parseFloat(this.panel.querySelector('#object-y').value),rotation:parseFloat(this.panel.querySelector('#object-rotation').value),tags:this.panel.querySelector('#object-tags').value.split(',').map(tag=>tag.trim()).filter(tag=>tag),description:this.panel.querySelector('#object-description').value,floor_id:this.panel.querySelector('#object-floor').value,connector_type:this.panel.querySelector('#connector-type').value,connection_type:this.panel.querySelector('#connection-type').value,connection_status:this.panel.querySelector('#connection-status').value,max_capacity:parseFloat(this.panel.querySelector('#max-capacity').value),current_load:parseFloat(this.panel.querySelector('#current-load').value),funding_source:this.panel.querySelector('#object-funding-source').value};}
getBatchFormData(){const data={};const system=this.panel.querySelector('#batch-system').value;const status=this.panel.querySelector('#batch-status').value;if(system)data.system=system;if(status)data.status=status;return data;}
updateObjectAttributes(object,data){if(data.name)object.setAttribute('data-name',data.name);if(data.type)object.setAttribute('data-type',data.type);if(data.system)object.setAttribute('data-system',data.system);if(data.status)object.setAttribute('data-status',data.status);if(data.tags)object.setAttribute('data-tags',data.tags.join(','));if(data.description)object.setAttribute('data-description',data.description);if(data.floor_id)object.setAttribute('data-floor-id',data.floor_id);if(data.connector_type)object.setAttribute('data-connector-type',data.connector_type);if(data.connection_type)object.setAttribute('data-connection-type',data.connection_type);if(data.connection_status)object.setAttribute('data-connection-status',data.connection_status);if(data.max_capacity)object.setAttribute('data-max-capacity',data.max_capacity);if(data.current_load)object.setAttribute('data-current-load',data.current_load);if(data.funding_source)object.setAttribute('data-funding-source',data.funding_source);}
updateObjectPosition(object,x,y){object.setAttribute('data-x',x);object.setAttribute('data-y',y);const rotation=object.getAttribute('data-rotation')||0;object.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);}
updateObjectRotation(object,rotation){object.setAttribute('data-rotation',rotation);const x=object.getAttribute('data-x')||0;const y=object.getAttribute('data-y')||0;object.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);}
deleteObject(object){object.remove();this.hide();this.showNotification('Object deleted','success');}
deleteBatchObjects(selectedObjects){selectedObjects.forEach(obj=>obj.remove());this.hide();this.showNotification(`${selectedObjects.size} objects deleted`,'success');}
showNotification(message,type){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>notification.remove(),3000);}
hide(){this.isVisible=false;this.panel.classList.add('hidden');}
getFloorOptions(selectedFloorId=''){const floors=[{id:1,name:'Ground Floor'},{id:2,name:'First Floor'},{id:3,name:'Second Floor'},{id:4,name:'Third Floor'},{id:5,name:'Basement'}];return floors.map(floor=>`<option value="${floor.id}" ${floor.id.toString() === selectedFloorId.toString() ? 'selected' : ''}>${floor.name}</option>`).join('');}
getFloorInfo(floorId){if(!floorId)return null;const floors=[{id:1,name:'Ground Floor'},{id:2,name:'First Floor'},{id:3,name:'Second Floor'},{id:4,name:'Third Floor'},{id:5,name:'Basement'}];return floors.find(floor=>floor.id.toString()===floorId.toString());}
async loadFloorsFromAPI(buildingId){try{const response=await fetch(`/api/buildings/${buildingId}/floors`,{headers:{'Authorization':`Bearer ${localStorage.getItem('arx_jwt') || ''}`,'Content-Type':'application/json'}});if(response.ok){const floors=await response.json();return floors;}else{console.error('Failed to load floors:',response.statusText);return[];}}catch(error){console.error('Error loading floors:',error);return[];}}}
document.addEventListener('DOMContentLoaded',()=>{window.contextPanel=new ContextPanel();});class DataPartitioningManager{constructor(){this.baseUrl='/v1/partitioning';this.partitions=new Map();this.loadedPartitions=new Set();this.performanceStats=null;this.compressionStats=null;this.lazyLoadingStats=null;this.eventListeners={'partition_created':[],'partition_loaded':[],'partition_unloaded':[],'performance_updated':[],'compression_completed':[],'optimization_recommendations':[]};this.performanceHistory=[];this.maxHistorySize=100;this.init();}
init(){console.log('DataPartitioningManager initialized');this.startPerformanceMonitoring();}
addEventListener(event,callback){if(!this.eventListeners[event]){this.eventListeners[event]=[];}
this.eventListeners[event].push(callback);}
removeEventListener(event,callback){if(this.eventListeners[event]){const index=this.eventListeners[event].indexOf(callback);if(index>-1){this.eventListeners[event].splice(index,1);}}}
emit(event,data){if(this.eventListeners[event]){this.eventListeners[event].forEach(callback=>{try{callback(data);}catch(error){console.error('Error in event listener:',error);}});}}
async partitionFloor(floorData,floorId,buildingId,options={}){const{partitionStrategy='floor_based',compressionType='gzip'}=options;try{const response=await fetch(`${this.baseUrl}/partition-floor`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({floor_data:floorData,floor_id:floorId,building_id:buildingId,partition_strategy:partitionStrategy,compression_type:compressionType})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();result.partitions.forEach(partition=>{this.partitions.set(partition.partition_id,partition);});this.emit('partition_created',result);console.log(`Partitioned floor ${floorId} into ${result.total_partitions} partitions`);return result;}catch(error){console.error('Failed to partition floor:',error);throw error;}}
async getFloorPartitions(buildingId,floorId){try{const response=await fetch(`${this.baseUrl}/floor-partitions/${buildingId}/${floorId}`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();result.partitions.forEach(partition=>{this.partitions.set(partition.partition_id,partition);if(partition.is_loaded){this.loadedPartitions.add(partition.partition_id);}});return result;}catch(error){console.error('Failed to get floor partitions:',error);throw error;}}
async loadFloorPartitions(buildingId,floorId,loadStrategy='lazy'){try{const response=await fetch(`${this.baseUrl}/load-floor`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({building_id:buildingId,floor_id:floorId,load_strategy:loadStrategy})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();if(result.success){const floorPartitions=await this.getFloorPartitions(buildingId,floorId);floorPartitions.partitions.forEach(partition=>{if(partition.is_loaded){this.loadedPartitions.add(partition.partition_id);}});}
this.emit('partition_loaded',result);return result;}catch(error){console.error('Failed to load floor partitions:',error);throw error;}}
async getPartition(partitionId){try{const response=await fetch(`${this.baseUrl}/partition/${partitionId}`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.loadedPartitions.add(partitionId);return result;}catch(error){console.error('Failed to get partition:',error);throw error;}}
async loadPartition(partitionId){try{const response=await fetch(`${this.baseUrl}/load-partition`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({partition_id:partitionId})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();if(result.success){this.loadedPartitions.add(partitionId);this.emit('partition_loaded',{partition_id:partitionId});}
return result;}catch(error){console.error('Failed to load partition:',error);throw error;}}
async unloadPartition(partitionId){try{const response=await fetch(`${this.baseUrl}/unload-partition/${partitionId}`,{method:'DELETE'});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();if(result.success){this.loadedPartitions.delete(partitionId);this.emit('partition_unloaded',{partition_id:partitionId});}
return result;}catch(error){console.error('Failed to unload partition:',error);throw error;}}
async preloadPartitions(partitionIds){try{const response=await fetch(`${this.baseUrl}/preload-partitions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({partition_ids:partitionIds})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();result.preload_results.forEach(preloadResult=>{if(preloadResult.success){this.loadedPartitions.add(preloadResult.partition_id);}});return result;}catch(error){console.error('Failed to preload partitions:',error);throw error;}}
async getPerformanceStats(){try{const response=await fetch(`${this.baseUrl}/performance-stats`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.performanceStats=result.performance_stats;this.performanceHistory.push({timestamp:new Date(),stats:this.performanceStats});if(this.performanceHistory.length>this.maxHistorySize){this.performanceHistory.shift();}
this.emit('performance_updated',this.performanceStats);return this.performanceStats;}catch(error){console.error('Failed to get performance stats:',error);throw error;}}
async getCompressionStats(){try{const response=await fetch(`${this.baseUrl}/compression-stats`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.compressionStats=result.compression_stats;return this.compressionStats;}catch(error){console.error('Failed to get compression stats:',error);throw error;}}
async getLazyLoadingStats(){try{const response=await fetch(`${this.baseUrl}/lazy-loading-stats`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.lazyLoadingStats=result.lazy_loading_stats;return this.lazyLoadingStats;}catch(error){console.error('Failed to get lazy loading stats:',error);throw error;}}
async optimizeFloor(buildingId,floorId){try{const response=await fetch(`${this.baseUrl}/optimize-floor/${buildingId}/${floorId}`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.emit('optimization_recommendations',result.optimization_results);return result.optimization_results;}catch(error){console.error('Failed to optimize floor:',error);throw error;}}
async compressPartition(partitionId,compressionType='gzip'){try{const response=await fetch(`${this.baseUrl}/compress-partition`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({partition_id:partitionId,compression_type:compressionType})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();this.emit('compression_completed',result);return result;}catch(error){console.error('Failed to compress partition:',error);throw error;}}
async getStorageInfo(){try{const response=await fetch(`${this.baseUrl}/storage-info`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();return result.storage_info;}catch(error){console.error('Failed to get storage info:',error);throw error;}}
async batchPartitionFloors(floorsData,options={}){const{partitionStrategy='floor_based',compressionType='gzip'}=options;try{const response=await fetch(`${this.baseUrl}/batch-partition`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({floors_data:floorsData,partition_strategy:partitionStrategy,compression_type:compressionType})});if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}
const result=await response.json();result.batch_results.forEach(batchResult=>{if(batchResult.success){this.getFloorPartitions(batchResult.building_id,batchResult.floor_id);}});return result;}catch(error){console.error('Failed to batch partition floors:',error);throw error;}}
isPartitionLoaded(partitionId){return this.loadedPartitions.has(partitionId);}
getPartitionInfo(partitionId){return this.partitions.get(partitionId);}
getLoadedPartitions(){return Array.from(this.loadedPartitions);}
getPartitionCount(){return this.partitions.size;}
getLoadedPartitionCount(){return this.loadedPartitions.size;}
startPerformanceMonitoring(){setInterval(async()=>{try{await this.getPerformanceStats();await this.getCompressionStats();await this.getLazyLoadingStats();}catch(error){console.error('Error in performance monitoring:',error);}},30000);}
getPerformanceHistory(){return this.performanceHistory;}
getPerformanceTrend(){if(this.performanceHistory.length<2){return'insufficient_data';}
const recent=this.performanceHistory[this.performanceHistory.length-1];const previous=this.performanceHistory[this.performanceHistory.length-2];const recentTotalSize=recent.stats.total_size||0;const previousTotalSize=previous.stats.total_size||0;if(recentTotalSize>previousTotalSize*1.1){return'increasing';}else if(recentTotalSize<previousTotalSize*0.9){return'decreasing';}else{return'stable';}}
getPartitionSizeChartData(){const data=[];this.partitions.forEach(partition=>{data.push({partition_id:partition.partition_id,data_size:partition.data_size,compressed_size:partition.compressed_size,compression_ratio:partition.compression_ratio,object_count:partition.object_count});});return data;}
getPerformanceChartData(){return this.performanceHistory.map(entry=>({timestamp:entry.timestamp,total_partitions:entry.stats.total_partitions||0,loaded_partitions:entry.stats.partitions?.loaded||0,cache_hit_rate:entry.stats.cache_stats?.hit_rate||0,average_compression_ratio:entry.stats.compression?.average_compression_ratio||0}));}
async cleanupUnusedPartitions(){const unusedPartitions=[];this.partitions.forEach(partition=>{if(partition.access_count===0&&this.loadedPartitions.has(partition.partition_id)){unusedPartitions.push(partition.partition_id);}});for(const partitionId of unusedPartitions){await this.unloadPartition(partitionId);}
return{unloaded_count:unusedPartitions.length,unloaded_partitions:unusedPartitions};}
handleError(error,operation){console.error(`Error in ${operation}:`,error);this.emit('error',{operation:operation,error:error.message,timestamp:new Date()});this.showErrorNotification(error.message,operation);}
showErrorNotification(message,operation){const notification=document.createElement('div');notification.className='partitioning-error-notification';notification.innerHTML=`
            <div class="error-header">
                <h4>Partitioning Error</h4>
                <button class="close-btn" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="error-content">
                <p><strong>Operation:</strong> ${operation}</p>
                <p><strong>Error:</strong> ${message}</p>
            </div>
        `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},10000);}}
window.dataPartitioningManager=new DataPartitioningManager();if(typeof module!=='undefined'&&module.exports){module.exports=DataPartitioningManager;}
class DataVendorAdmin{constructor(){this.currentTab='dashboard';this.apiKeys=[];this.usageData={};this.billingData={};this.init();}
async init(){await this.loadDashboard();this.setupEventListeners();this.setupCharts();}
setupEventListeners(){document.querySelectorAll('.tab-button').forEach(button=>{button.addEventListener('click',(e)=>{const tab=e.target.getAttribute('onclick').match(/showTab\('(.+)'\)/)[1];this.showTab(tab);});});document.getElementById('create-key-btn')?.addEventListener('click',()=>{this.showCreateKeyModal();});document.getElementById('date-range')?.addEventListener('change',()=>{this.loadUsageData();});document.getElementById('vendor-filter')?.addEventListener('click',()=>{this.loadUsageData();});document.getElementById('billing-month')?.addEventListener('change',()=>{this.loadBillingData();});}
async showTab(tabName){document.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.remove('border-blue-500','text-blue-600');btn.classList.add('border-transparent','text-gray-500');});const activeButton=document.querySelector(`[onclick="showTab('${tabName}')"]`);if(activeButton){activeButton.classList.remove('border-transparent','text-gray-500');activeButton.classList.add('border-blue-500','text-blue-600');}
document.querySelectorAll('.tab-content').forEach(content=>{content.classList.add('hidden');});const selectedTab=document.getElementById(`${tabName}-tab`);if(selectedTab){selectedTab.classList.remove('hidden');}
this.currentTab=tabName;switch(tabName){case'dashboard':await this.loadDashboard();break;case'api-keys':await this.loadAPIKeys();break;case'usage':await this.loadUsageData();break;case'billing':await this.loadBillingData();break;}}
async loadDashboard(){try{const response=await fetch('/api/data-vendor-admin/dashboard',{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load dashboard');const data=await response.json();this.updateDashboardMetrics(data);this.updateUsageChart(data.usage_trends);this.updateTopVendors(data.top_vendors);this.updateRecentActivity(data.recent_activity);}catch(error){console.error('Error loading dashboard:',error);this.showNotification('Error loading dashboard data','error');}}
updateDashboardMetrics(data){document.getElementById('active-keys-count').textContent=data.active_keys;document.getElementById('today-requests').textContent=data.today_requests.toLocaleString();document.getElementById('monthly-revenue').textContent=`$${data.monthly_revenue.toLocaleString()}`;document.getElementById('rate-limit-hits').textContent=data.rate_limit_hits;}
updateUsageChart(usageTrends){const ctx=document.getElementById('usageChart');if(!ctx)return;const labels=usageTrends.map(item=>item.date);const data=usageTrends.map(item=>item.requests);new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'API Requests',data:data,borderColor:'rgb(59, 130, 246)',backgroundColor:'rgba(59, 130, 246, 0.1)',tension:0.1}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});}
updateTopVendors(vendors){const container=document.getElementById('top-vendors');if(!container)return;container.innerHTML=vendors.map(vendor=>`
            <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
                <div>
                    <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                    <p class="text-sm text-gray-500">${vendor.access_level}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-gray-900">${vendor.request_count.toLocaleString()}</p>
                    <p class="text-sm text-gray-500">requests</p>
                </div>
            </div>
        `).join('');}
updateRecentActivity(activity){const container=document.getElementById('recent-activity');if(!container)return;container.innerHTML=activity.map(item=>`
            <li class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <span class="text-sm font-medium text-blue-600">${item.vendor_name.charAt(0)}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">${item.vendor_name}</p>
                            <p class="text-sm text-gray-500">${item.method} ${item.endpoint}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            item.status === 200 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${item.status}
                        </span>
                        <span class="ml-2 text-sm text-gray-500">${this.formatTime(item.created_at)}</span>
                    </div>
                </div>
            </li>
        `).join('');}
async loadAPIKeys(){try{const response=await fetch('/api/data-vendor-admin/api-keys',{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load API keys');this.apiKeys=await response.json();this.renderAPIKeysTable();}catch(error){console.error('Error loading API keys:',error);this.showNotification('Error loading API keys','error');}}
renderAPIKeysTable(){const tbody=document.getElementById('api-keys-table');if(!tbody)return;tbody.innerHTML=this.apiKeys.map(key=>`
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${key.vendor_name}</div>
                    <div class="text-sm text-gray-500">${key.email}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        this.getAccessLevelColor(key.access_level)
                    }">
                        ${key.access_level}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${key.rate_limit.toLocaleString()}/hour
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        key.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${key.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${key.last_used_at ? this.formatTime(key.last_used_at) : 'Never'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="dataVendorAdmin.viewAPIKey('${key.id}')"
                            class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                    <button onclick="dataVendorAdmin.toggleAPIKeyStatus('${key.id}', ${!key.is_active})"
                            class="text-${key.is_active ? 'red' : 'green'}-600 hover:text-${key.is_active ? 'red' : 'green'}-900">
                        ${key.is_active ? 'Deactivate' : 'Activate'}
                    </button>
                </td>
            </tr>
        `).join('');}
async loadUsageData(){try{const dateRange=document.getElementById('date-range')?.value||30;const vendor=document.getElementById('vendor-filter')?.value||'';const params=new URLSearchParams({date_range:dateRange,...(vendor&&{vendor})});const response=await fetch(`/api/data-vendor-admin/usage?${params}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load usage data');this.usageData=await response.json();this.renderUsageData();}catch(error){console.error('Error loading usage data:',error);this.showNotification('Error loading usage data','error');}}
renderUsageData(){document.getElementById('total-requests').textContent=this.usageData.total_requests.toLocaleString();document.getElementById('success-rate').textContent=`${this.usageData.success_rate}%`;document.getElementById('avg-response-time').textContent=`${this.usageData.avg_response_time}ms`;document.getElementById('rate-limit-hits-count').textContent=this.usageData.rate_limit_hits;const vendorContainer=document.getElementById('usage-by-vendor');if(vendorContainer&&this.usageData.usage_by_vendor){vendorContainer.innerHTML=this.usageData.usage_by_vendor.map(vendor=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                        <p class="text-sm text-gray-500">${vendor.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">${vendor.success_rate}%</p>
                        <p class="text-sm text-gray-500">success rate</p>
                    </div>
                </div>
            `).join('');}
const endpointContainer=document.getElementById('usage-by-endpoint');if(endpointContainer&&this.usageData.usage_by_endpoint){endpointContainer.innerHTML=this.usageData.usage_by_endpoint.map(endpoint=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${endpoint.endpoint}</h4>
                        <p class="text-sm text-gray-500">${endpoint.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">${endpoint.avg_response_time}ms</p>
                        <p class="text-sm text-gray-500">avg response</p>
                    </div>
                </div>
            `).join('');}}
async loadBillingData(){try{const month=document.getElementById('billing-month')?.value||'';const vendor=document.getElementById('billing-vendor-filter')?.value||'';const params=new URLSearchParams();if(month)params.append('month',month);if(vendor)params.append('vendor',vendor);const response=await fetch(`/api/data-vendor-admin/billing?${params}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load billing data');this.billingData=await response.json();this.renderBillingData();}catch(error){console.error('Error loading billing data:',error);this.showNotification('Error loading billing data','error');}}
renderBillingData(){document.getElementById('total-revenue').textContent=`$${this.billingData.total_revenue.toLocaleString()}`;const vendorContainer=document.getElementById('billing-by-vendor');if(vendorContainer&&this.billingData.billing_by_vendor){vendorContainer.innerHTML=this.billingData.billing_by_vendor.map(vendor=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${vendor.vendor_name}</h4>
                        <p class="text-sm text-gray-500">${vendor.access_level} - ${vendor.request_count.toLocaleString()} requests</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">$${vendor.total_cost.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">$${vendor.base_cost} + $${vendor.per_request_cost}/request</p>
                    </div>
                </div>
            `).join('');}
const levelContainer=document.getElementById('billing-by-access-level');if(levelContainer&&this.billingData.billing_by_access_level){levelContainer.innerHTML=this.billingData.billing_by_access_level.map(level=>`
                <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-sm">
                    <div>
                        <h4 class="font-medium text-gray-900">${level.access_level}</h4>
                        <p class="text-sm text-gray-500">${level.vendor_count} vendors</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">$${level.total_revenue.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">revenue</p>
                    </div>
                </div>
            `).join('');}}
showCreateKeyModal(){const modal=document.getElementById('create-key-modal');if(modal){modal.classList.remove('hidden');}}
hideCreateKeyModal(){const modal=document.getElementById('create-key-modal');if(modal){modal.classList.add('hidden');document.getElementById('create-key-form').reset();}}
async createAPIKey(formData){try{const response=await fetch('/api/data-vendor-admin/api-keys',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.getToken()}`},body:JSON.stringify(formData)});if(!response.ok)throw new Error('Failed to create API key');const newKey=await response.json();this.apiKeys.unshift(newKey);this.renderAPIKeysTable();this.hideCreateKeyModal();this.showNotification('API key created successfully','success');this.showAPIKeyDetails(newKey);}catch(error){console.error('Error creating API key:',error);this.showNotification('Error creating API key','error');}}
async viewAPIKey(keyId){try{const response=await fetch(`/api/data-vendor-admin/api-keys/${keyId}`,{headers:{'Authorization':`Bearer ${this.getToken()}`}});if(!response.ok)throw new Error('Failed to load API key details');const keyData=await response.json();this.showAPIKeyDetails(keyData.key,keyData.stats);}catch(error){console.error('Error loading API key details:',error);this.showNotification('Error loading API key details','error');}}
showAPIKeyDetails(key,stats=null){const modal=document.getElementById('key-details-modal');if(!modal)return;document.getElementById('key-vendor-name').textContent=key.vendor_name;document.getElementById('key-email').textContent=key.email;document.getElementById('key-access-level').textContent=key.access_level;document.getElementById('key-rate-limit').textContent=`${key.rate_limit.toLocaleString()}/hour`;document.getElementById('key-status').textContent=key.is_active?'Active':'Inactive';document.getElementById('key-created').textContent=this.formatTime(key.created_at);document.getElementById('key-expires').textContent=this.formatTime(key.expires_at);if(stats){document.getElementById('key-total-requests').textContent=stats.total_requests.toLocaleString();document.getElementById('key-last-used').textContent=stats.last_used?this.formatTime(stats.last_used):'Never';document.getElementById('key-rate-limit-hits').textContent=stats.rate_limit_hits;}
const maskedKey=key.key.substring(0,8)+'...'+key.key.substring(key.key.length-4);document.getElementById('key-value').textContent=maskedKey;modal.classList.remove('hidden');}
hideKeyDetailsModal(){const modal=document.getElementById('key-details-modal');if(modal){modal.classList.add('hidden');}}
async toggleAPIKeyStatus(keyId,newStatus){try{const response=await fetch(`/api/data-vendor-admin/api-keys/${keyId}/status`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.getToken()}`},body:JSON.stringify({is_active:newStatus})});if(!response.ok)throw new Error('Failed to update API key status');const keyIndex=this.apiKeys.findIndex(key=>key.id==keyId);if(keyIndex!==-1){this.apiKeys[keyIndex].is_active=newStatus;this.renderAPIKeysTable();}
this.showNotification(`API key ${newStatus ? 'activated' : 'deactivated'} successfully`,'success');}catch(error){console.error('Error updating API key status:',error);this.showNotification('Error updating API key status','error');}}
getAccessLevelColor(level){switch(level.toLowerCase()){case'basic':return'bg-gray-100 text-gray-800';case'premium':return'bg-blue-100 text-blue-800';case'enterprise':return'bg-purple-100 text-purple-800';default:return'bg-gray-100 text-gray-800';}}
formatTime(timestamp){if(!timestamp)return'Never';return new Date(timestamp).toLocaleString();}
getToken(){return localStorage.getItem('authToken')||sessionStorage.getItem('authToken');}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove();},5000);}
setupCharts(){}}
let dataVendorAdmin;document.addEventListener('DOMContentLoaded',()=>{dataVendorAdmin=new DataVendorAdmin();});function showTab(tabName){dataVendorAdmin?.showTab(tabName);}
function showCreateKeyModal(){dataVendorAdmin?.showCreateKeyModal();}
function hideCreateKeyModal(){dataVendorAdmin?.hideCreateKeyModal();}
function hideKeyDetailsModal(){dataVendorAdmin?.hideKeyDetailsModal();}
document.getElementById('create-key-form')?.addEventListener('submit',(e)=>{e.preventDefault();const formData=new FormData(e.target);const data={vendor_name:formData.get('vendor_name'),email:formData.get('email'),access_level:formData.get('access_level'),rate_limit:parseInt(formData.get('rate_limit')),expires_at:formData.get('expires_at')};dataVendorAdmin?.createAPIKey(data);});let exportVolumeChart,formatChart,exportTypeChart;let currentPage=1;let pageSize=20;document.addEventListener('DOMContentLoaded',function(){loadDashboardData();loadExportActivities();setupEventListeners();});function setupEventListeners(){document.getElementById('user-filter').addEventListener('change',function(){currentPage=1;loadExportActivities();});document.getElementById('format-filter').addEventListener('change',function(){currentPage=1;loadExportActivities();});document.getElementById('status-filter').addEventListener('change',function(){currentPage=1;loadExportActivities();});document.getElementById('date-filter').addEventListener('change',function(){currentPage=1;loadExportActivities();});document.getElementById('page-size').addEventListener('change',function(){pageSize=parseInt(this.value);currentPage=1;loadExportActivities();});}
async function loadDashboardData(){try{const response=await fetch('/api/export-analytics/dashboard',{headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`}});if(!response.ok){throw new Error('Failed to load dashboard data');}
const data=await response.json();updateDashboardMetrics(data);updateCharts(data);updateTopUsers(data.top_users);updateRecentExports(data.recent_exports);}catch(error){console.error('Error loading dashboard data:',error);showNotification('Error loading dashboard data','error');}}
function updateDashboardMetrics(data){document.getElementById('today-exports').textContent=data.today_exports;document.getElementById('today-downloads').textContent=data.today_downloads;document.getElementById('avg-processing-time').textContent=formatProcessingTime(data.avg_processing_time);document.getElementById('failed-exports').textContent=data.failed_exports;}
function updateCharts(data){const exportVolumeCtx=document.getElementById('exportVolumeChart').getContext('2d');exportVolumeChart=new Chart(exportVolumeCtx,{type:'line',data:{labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],datasets:[{label:'Exports',data:[12,19,15,25,22,18,24],borderColor:'rgb(59, 130, 246)',backgroundColor:'rgba(59, 130, 246, 0.1)',tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});const formatCtx=document.getElementById('formatChart').getContext('2d');formatChart=new Chart(formatCtx,{type:'doughnut',data:{labels:Object.keys(data.top_formats),datasets:[{data:Object.values(data.top_formats),backgroundColor:['rgba(59, 130, 246, 0.8)','rgba(16, 185, 129, 0.8)','rgba(245, 158, 11, 0.8)','rgba(239, 68, 68, 0.8)']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});const exportTypeCtx=document.getElementById('exportTypeChart').getContext('2d');exportTypeChart=new Chart(exportTypeCtx,{type:'bar',data:{labels:Object.keys(data.top_export_types),datasets:[{label:'Exports',data:Object.values(data.top_export_types),backgroundColor:'rgba(59, 130, 246, 0.8)'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});}
function updateTopUsers(users){const container=document.getElementById('top-users');container.innerHTML='';users.forEach((user,index)=>{const userElement=document.createElement('div');userElement.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';userElement.innerHTML=`
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-sm font-medium text-blue-600">${index + 1}</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">${user.username}</p>
                    <p class="text-xs text-gray-500">${user.export_count} exports</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-sm font-medium text-gray-900">${user.download_count}</p>
                <p class="text-xs text-gray-500">downloads</p>
            </div>
        `;container.appendChild(userElement);});}
function updateRecentExports(exports){const container=document.getElementById('recent-exports');container.innerHTML='';exports.forEach(exportItem=>{const exportElement=document.createElement('div');exportElement.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';exportElement.innerHTML=`
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900">${exportItem.export_type}</p>
                    <p class="text-xs text-gray-500">${exportItem.format.toUpperCase()}  ${formatFileSize(exportItem.file_size)}</p>
                </div>
            </div>
            <div class="text-right">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(exportItem.status)}">
                    ${exportItem.status}
                </span>
            </div>
        `;container.appendChild(exportElement);});}
async function loadExportActivities(){try{const filters=buildFilters();const url=`/api/export-activities?page=${currentPage}&limit=${pageSize}${filters}`;const response=await fetch(url,{headers:{'Authorization':`Bearer ${localStorage.getItem('token')}`}});if(!response.ok){throw new Error('Failed to load export activities');}
const data=await response.json();updateExportActivitiesTable(data.activities);updatePagination(data.pagination);}catch(error){console.error('Error loading export activities:',error);showNotification('Error loading export activities','error');}}
function buildFilters(){const filters=[];const userId=document.getElementById('user-filter').value;if(userId)filters.push(`user_id=${userId}`);const format=document.getElementById('format-filter').value;if(format)filters.push(`format=${format}`);const status=document.getElementById('status-filter').value;if(status)filters.push(`status=${status}`);const date=document.getElementById('date-filter').value;if(date)filters.push(`start_date=${date}`);return filters.length>0?'&'+filters.join('&'):'';}
function updateExportActivitiesTable(activities){const tbody=document.getElementById('export-activities-table');tbody.innerHTML='';activities.forEach(activity=>{const row=document.createElement('tr');row.className='hover:bg-gray-50';row.innerHTML=`
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${activity.user?.username || 'Unknown'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${activity.export_type}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    ${activity.format.toUpperCase()}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(activity.status)}">
                    ${activity.status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${activity.download_count}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${formatFileSize(activity.file_size)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDate(activity.created_at)}
            </td>
        `;tbody.appendChild(row);});}
function updatePagination(pagination){const container=document.getElementById('pagination');container.innerHTML='';const prevButton=document.createElement('button');prevButton.className=`px-3 py-1 rounded-md text-sm font-medium ${pagination.page > 1 ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`;prevButton.textContent='Previous';prevButton.disabled=pagination.page<=1;prevButton.onclick=()=>{if(pagination.page>1){currentPage=pagination.page-1;loadExportActivities();}};container.appendChild(prevButton);for(let i=1;i<=pagination.pages;i++){if(i===1||i===pagination.pages||(i>=pagination.page-2&&i<=pagination.page+2)){const pageButton=document.createElement('button');pageButton.className=`px-3 py-1 mx-1 rounded-md text-sm font-medium ${i === pagination.page ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;pageButton.textContent=i;pageButton.onclick=()=>{currentPage=i;loadExportActivities();};container.appendChild(pageButton);}else if(i===pagination.page-3||i===pagination.page+3){const ellipsis=document.createElement('span');ellipsis.className='px-3 py-1 text-sm text-gray-500';ellipsis.textContent='...';container.appendChild(ellipsis);}}
const nextButton=document.createElement('button');nextButton.className=`px-3 py-1 rounded-md text-sm font-medium ${pagination.page < pagination.pages ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`;nextButton.textContent='Next';nextButton.disabled=pagination.page>=pagination.pages;nextButton.onclick=()=>{if(pagination.page<pagination.pages){currentPage=pagination.page+1;loadExportActivities();}};container.appendChild(nextButton);}
function formatProcessingTime(ms){if(!ms)return'N/A';if(ms<1000)return`${ms}ms`;return`${(ms / 1000).toFixed(1)}s`;}
function formatFileSize(bytes){if(!bytes)return'N/A';const sizes=['B','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(1024));return`${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;}
function formatDate(dateString){if(!dateString)return'N/A';return new Date(dateString).toLocaleDateString();}
function getStatusColor(status){switch(status){case'completed':return'bg-green-100 text-green-800';case'processing':return'bg-yellow-100 text-yellow-800';case'failed':return'bg-red-100 text-red-800';case'requested':return'bg-blue-100 text-blue-800';default:return'bg-gray-100 text-gray-800';}}
function showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'
    }`;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove();},3000);}
function logout(){localStorage.removeItem('token');window.location.href='login.html';}
setInterval(loadDashboardData,5*60*1000);class ExportImportSystem{constructor(options={}){this.options={enableJSONExport:true,enableSVGExport:true,enableBackupRestore:true,compressionEnabled:true,includeMetadata:true,includeHistory:true,maxFileSize:50*1024*1024,supportedFormats:['json','svg','zip'],...options};this.exportQueue=[];this.importQueue=[];this.isProcessing=false;this.currentOperation=null;this.utils=window.sharedUtilities||new SharedUtilities();this.initializeSystem();}
initializeSystem(){this.setupEventListeners();this.initializeUI();}
setupEventListeners(){document.addEventListener('exportVersion',(event)=>{this.handleExportRequest(event.detail);});document.addEventListener('importVersion',(event)=>{this.handleImportRequest(event.detail);});document.addEventListener('backupFloor',(event)=>{this.handleBackupRequest(event.detail);});document.addEventListener('restoreFloor',(event)=>{this.handleRestoreRequest(event.detail);});document.addEventListener('dragover',(event)=>{event.preventDefault();this.handleDragOver(event);});document.addEventListener('drop',(event)=>{event.preventDefault();this.handleFileDrop(event);});}
initializeUI(){this.createExportImportUI();}
createExportImportUI(){const panel=document.createElement('div');panel.id='export-import-panel';panel.className='fixed top-4 left-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-50 max-w-sm';panel.style.display='none';panel.innerHTML=`
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900">Export/Import</h3>
                <button id="close-export-import-panel" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">Export</h4>
                    <div class="space-y-2">
                        <button id="export-json" class="w-full bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 text-sm">
                            <i class="fas fa-download mr-2"></i>Export as JSON
                        </button>
                        <button id="export-svg" class="w-full bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">
                            <i class="fas fa-image mr-2"></i>Export as SVG
                        </button>
                        <button id="export-backup" class="w-full bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-sm">
                            <i class="fas fa-archive mr-2"></i>Create Backup
                        </button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Import</h4>
                    <div class="space-y-2">
                        <button id="import-file" class="w-full bg-orange-600 text-white px-3 py-2 rounded-md hover:bg-orange-700 text-sm">
                            <i class="fas fa-upload mr-2"></i>Import File
                        </button>
                        <button id="restore-backup" class="w-full bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 text-sm">
                            <i class="fas fa-undo mr-2"></i>Restore Backup
                        </button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Drop Zone</h4>
                    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center text-gray-500 hover:border-blue-400 transition-colors">
                        <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                        <p>Drop files here to import</p>
                    </div>
                </div>
            </div>
        `;document.body.appendChild(panel);const progressModal=document.createElement('div');progressModal.id='export-import-progress-modal';progressModal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';progressModal.style.display='none';progressModal.innerHTML=`
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="text-center">
                    <div id="progress-icon" class="text-3xl mb-4">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    </div>
                    <h3 id="progress-title" class="text-lg font-semibold text-gray-900 mb-2">Processing...</h3>
                    <p id="progress-description" class="text-gray-600 mb-4">Please wait while we process your request.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progress-details" class="text-sm text-gray-500"></div>
                    <button id="cancel-operation" class="mt-4 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        `;document.body.appendChild(progressModal);this.setupUIEventListeners();}
setupUIEventListeners(){document.getElementById('close-export-import-panel')?.addEventListener('click',()=>{this.hideExportImportPanel();});document.getElementById('export-json')?.addEventListener('click',()=>{this.exportAsJSON();});document.getElementById('export-svg')?.addEventListener('click',()=>{this.exportAsSVG();});document.getElementById('export-backup')?.addEventListener('click',()=>{this.createBackup();});document.getElementById('import-file')?.addEventListener('click',()=>{this.showFileImportDialog();});document.getElementById('restore-backup')?.addEventListener('click',()=>{this.showBackupRestoreDialog();});document.getElementById('cancel-operation')?.addEventListener('click',()=>{this.cancelCurrentOperation();});const dropZone=document.getElementById('drop-zone');if(dropZone){dropZone.addEventListener('dragover',(e)=>{e.preventDefault();dropZone.classList.add('border-blue-400','bg-blue-50');});dropZone.addEventListener('dragleave',(e)=>{e.preventDefault();dropZone.classList.remove('border-blue-400','bg-blue-50');});dropZone.addEventListener('drop',(e)=>{e.preventDefault();dropZone.classList.remove('border-blue-400','bg-blue-50');this.handleFileDrop(e);});}}
async handleExportRequest(details){const{format,versionId,includeMetadata,includeHistory}=details;try{switch(format){case'json':await this.exportVersionAsJSON(versionId,includeMetadata,includeHistory);break;case'svg':await this.exportVersionAsSVG(versionId,includeMetadata);break;case'backup':await this.createVersionBackup(versionId);break;default:throw new Error(`Unsupported export format: ${format}`);}}catch(error){console.error('Export request failed:',error);this.showNotification('Export failed: '+error.message,'error');}}
async handleImportRequest(details){const{file,format,options}=details;try{switch(format){case'json':await this.importFromJSON(file,options);break;case'svg':await this.importFromSVG(file,options);break;case'backup':await this.restoreFromBackup(file,options);break;default:throw new Error(`Unsupported import format: ${format}`);}}catch(error){console.error('Import request failed:',error);this.showNotification('Import failed: '+error.message,'error');}}
async handleBackupRequest(details){const{floorId,includeAllVersions,includeMetadata}=details;try{await this.createFloorBackup(floorId,includeAllVersions,includeMetadata);}catch(error){console.error('Backup request failed:',error);this.showNotification('Backup failed: '+error.message,'error');}}
async handleRestoreRequest(details){const{backupFile,options}=details;try{await this.restoreFloorFromBackup(backupFile,options);}catch(error){console.error('Restore request failed:',error);this.showNotification('Restore failed: '+error.message,'error');}}
handleDragOver(event){event.preventDefault();event.dataTransfer.dropEffect='copy';}
handleFileDrop(event){const files=Array.from(event.dataTransfer.files);if(files.length===0)return;files.forEach(file=>{this.processDroppedFile(file);});}
async processDroppedFile(file){try{const fileExtension=this.utils.getFileExtension(file.name);switch(fileExtension){case'json':await this.importFromJSON(file);break;case'svg':await this.importFromSVG(file);break;case'zip':await this.restoreFromBackup(file);break;default:this.utils.showNotification(`Unsupported file type: ${fileExtension}`,'warning');}}catch(error){console.error('Error processing dropped file:',error);this.utils.showNotification('Failed to process file: '+error.message,'error');}}
async exportVersionAsJSON(versionId,includeMetadata=true,includeHistory=true){this.startProgress('Exporting as JSON','Preparing version data...');try{const versionData=await this.getVersionData(versionId);this.updateProgress(25,'Processing version data...');const exportData={format:'json',version:'1.0',exported_at:new Date().toISOString(),exported_by:this.getCurrentUser(),version_data:versionData};if(includeMetadata){exportData.metadata=await this.getVersionMetadata(versionId);}
if(includeHistory){exportData.history=await this.getVersionHistory(versionId);}
this.updateProgress(50,'Compressing data...');let finalData=exportData;if(this.options.compressionEnabled){finalData=await this.compressData(exportData);}
this.updateProgress(75,'Generating file...');const fileName=`version_${versionId}_${new Date().toISOString().split('T')[0]}.json`;await this.utils.downloadJSON(finalData,fileName);this.completeProgress('Export completed successfully');this.utils.showNotification('Version exported as JSON successfully','success');}catch(error){this.failProgress('Export failed: '+error.message);throw error;}}
async exportVersionAsSVG(versionId,includeMetadata=true){this.startProgress('Exporting as SVG','Preparing SVG data...');try{const svgData=await this.getVersionSVGData(versionId);this.updateProgress(25,'Processing SVG elements...');const svgDocument=this.createSVGDocument(svgData,includeMetadata);this.updateProgress(50,'Optimizing SVG...');const optimizedSVG=await this.optimizeSVG(svgDocument);this.updateProgress(75,'Generating file...');const fileName=`version_${versionId}_${new Date().toISOString().split('T')[0]}.svg`;await this.utils.downloadSVG(optimizedSVG,fileName);this.completeProgress('Export completed successfully');this.utils.showNotification('Version exported as SVG successfully','success');}catch(error){this.failProgress('Export failed: '+error.message);throw error;}}
async createVersionBackup(versionId){this.startProgress('Creating Backup','Preparing backup data...');try{const versionData=await this.getVersionData(versionId);const metadata=await this.getVersionMetadata(versionId);const history=await this.getVersionHistory(versionId);this.updateProgress(25,'Collecting assets...');const assets=await this.collectVersionAssets(versionId);this.updateProgress(50,'Creating backup package...');const backupPackage={type:'version_backup',version:'1.0',created_at:new Date().toISOString(),created_by:this.getCurrentUser(),version_data:versionData,metadata:metadata,history:history,assets:assets};this.updateProgress(75,'Compressing backup...');const compressedBackup=await this.compressBackup(backupPackage);this.updateProgress(90,'Generating backup file...');const fileName=`backup_version_${versionId}_${new Date().toISOString().split('T')[0]}.zip`;await this.utils.downloadZIP(compressedBackup,fileName);this.completeProgress('Backup created successfully');this.utils.showNotification('Version backup created successfully','success');}catch(error){this.failProgress('Backup failed: '+error.message);throw error;}}
async createFloorBackup(floorId,includeAllVersions=true,includeMetadata=true){this.startProgress('Creating Floor Backup','Preparing floor data...');try{const floorData=await this.getFloorData(floorId);this.updateProgress(20,'Collecting versions...');let versions=[];if(includeAllVersions){versions=await this.getFloorVersions(floorId);}
this.updateProgress(40,'Collecting assets...');const assets=await this.collectFloorAssets(floorId);this.updateProgress(60,'Creating backup package...');const backupPackage={type:'floor_backup',version:'1.0',created_at:new Date().toISOString(),created_by:this.getCurrentUser(),floor_data:floorData,versions:versions,assets:assets};if(includeMetadata){backupPackage.metadata=await this.getFloorMetadata(floorId);}
this.updateProgress(80,'Compressing backup...');const compressedBackup=await this.compressBackup(backupPackage);this.updateProgress(90,'Generating backup file...');const fileName=`backup_floor_${floorId}_${new Date().toISOString().split('T')[0]}.zip`;await this.utils.downloadZIP(compressedBackup,fileName);this.completeProgress('Floor backup created successfully');this.utils.showNotification('Floor backup created successfully','success');}catch(error){this.failProgress('Backup failed: '+error.message);throw error;}}
async importFromJSON(file,options={}){this.startProgress('Importing JSON','Reading file...');try{const fileContent=await this.utils.readFileAsText(file);this.updateProgress(25,'Parsing JSON data...');const importData=JSON.parse(fileContent);this.validateImportData(importData);this.updateProgress(50,'Processing version data...');const processedData=await this.processImportData(importData,options);this.updateProgress(75,'Importing version...');const result=await this.importVersion(processedData,options);this.completeProgress('Import completed successfully');this.utils.showNotification('Version imported successfully','success');this.emitEvent('versionImported',result);return result;}catch(error){this.failProgress('Import failed: '+error.message);throw error;}}
async importFromSVG(file,options={}){this.startProgress('Importing SVG','Reading file...');try{const fileContent=await this.readFileAsText(file);this.updateProgress(25,'Parsing SVG data...');const svgData=this.parseSVGData(fileContent);this.updateProgress(50,'Processing SVG elements...');const processedData=await this.processSVGData(svgData,options);this.updateProgress(75,'Importing SVG...');const result=await this.importSVG(processedData,options);this.completeProgress('Import completed successfully');this.showNotification('SVG imported successfully','success');this.emitEvent('svgImported',result);return result;}catch(error){this.failProgress('Import failed: '+error.message);throw error;}}
async restoreFromBackup(file,options={}){this.startProgress('Restoring from Backup','Reading backup file...');try{const backupData=await this.readBackupFile(file);this.updateProgress(25,'Validating backup...');this.validateBackup(backupData);this.updateProgress(50,'Preparing restore data...');const restoreData=await this.prepareRestoreData(backupData,options);this.updateProgress(75,'Restoring data...');const result=await this.performRestore(restoreData,options);this.completeProgress('Restore completed successfully');this.showNotification('Backup restored successfully','success');this.emitEvent('backupRestored',result);return result;}catch(error){this.failProgress('Restore failed: '+error.message);throw error;}}
showFileImportDialog(){const input=document.createElement('input');input.type='file';input.accept='.json,.svg,.zip';input.multiple=false;input.addEventListener('change',(event)=>{const file=event.target.files[0];if(file){this.processDroppedFile(file);}});input.click();}
showBackupRestoreDialog(){const input=document.createElement('input');input.type='file';input.accept='.zip';input.multiple=false;input.addEventListener('change',(event)=>{const file=event.target.files[0];if(file){this.restoreFromBackup(file);}});input.click();}
startProgress(title,description){this.currentOperation={title,description,progress:0};const modal=document.getElementById('export-import-progress-modal');const titleElement=document.getElementById('progress-title');const descriptionElement=document.getElementById('progress-description');const iconElement=document.getElementById('progress-icon');if(modal&&titleElement&&descriptionElement&&iconElement){titleElement.textContent=title;descriptionElement.textContent=description;iconElement.innerHTML='<i class="fas fa-spinner fa-spin text-blue-500"></i>';modal.style.display='flex';}
this.updateProgress(0);}
updateProgress(progress,description=null){if(this.currentOperation){this.currentOperation.progress=progress;if(description){this.currentOperation.description=description;}}
const barElement=document.getElementById('progress-bar');const descriptionElement=document.getElementById('progress-description');if(barElement){barElement.style.width=`${progress}%`;}
if(descriptionElement&&description){descriptionElement.textContent=description;}}
completeProgress(message){const iconElement=document.getElementById('progress-icon');const titleElement=document.getElementById('progress-title');if(iconElement){iconElement.innerHTML='<i class="fas fa-check-circle text-green-500"></i>';}
if(titleElement){titleElement.textContent=message;}
setTimeout(()=>{this.hideProgressModal();},2000);}
failProgress(message){const iconElement=document.getElementById('progress-icon');const titleElement=document.getElementById('progress-title');if(iconElement){iconElement.innerHTML='<i class="fas fa-times-circle text-red-500"></i>';}
if(titleElement){titleElement.textContent=message;}
setTimeout(()=>{this.hideProgressModal();},3000);}
hideProgressModal(){const modal=document.getElementById('export-import-progress-modal');if(modal){modal.style.display='none';}
this.currentOperation=null;}
cancelCurrentOperation(){if(this.currentOperation){this.currentOperation.cancelled=true;this.hideProgressModal();this.showNotification('Operation cancelled','info');}}
showExportImportPanel(){const panel=document.getElementById('export-import-panel');if(panel){panel.style.display='block';}}
hideExportImportPanel(){const panel=document.getElementById('export-import-panel');if(panel){panel.style.display='none';}}
async exportAsJSON(){const currentVersion=this.getCurrentVersion();if(currentVersion){await this.exportVersionAsJSON(currentVersion.id);}else{this.showNotification('No version selected for export','warning');}}
async exportAsSVG(){const currentVersion=this.getCurrentVersion();if(currentVersion){await this.exportVersionAsSVG(currentVersion.id);}else{this.showNotification('No version selected for export','warning');}}
async createBackup(){const currentFloor=this.getCurrentFloor();if(currentFloor){await this.createFloorBackup(currentFloor.id);}else{this.showNotification('No floor selected for backup','warning');}}
getCurrentUser(){return{id:localStorage.getItem('user_id')||'unknown',name:localStorage.getItem('user_name')||'Unknown User'};}
getCurrentVersion(){return window.floorVersionControl?.getCurrentVersion();}
getCurrentFloor(){return{id:localStorage.getItem('current_floor_id'),name:localStorage.getItem('current_floor_name')};}
async getVersionData(versionId){const response=await fetch(`/api/versions/${versionId}/data`);if(!response.ok)throw new Error('Failed to get version data');return response.json();}
async getVersionMetadata(versionId){const response=await fetch(`/api/versions/${versionId}/metadata`);if(!response.ok)throw new Error('Failed to get version metadata');return response.json();}
async getVersionHistory(versionId){const response=await fetch(`/api/versions/${versionId}/history`);if(!response.ok)throw new Error('Failed to get version history');return response.json();}
async getVersionSVGData(versionId){const response=await fetch(`/api/versions/${versionId}/svg`);if(!response.ok)throw new Error('Failed to get version SVG data');return response.json();}
async getFloorData(floorId){const response=await fetch(`/api/floors/${floorId}/data`);if(!response.ok)throw new Error('Failed to get floor data');return response.json();}
async getFloorVersions(floorId){const response=await fetch(`/api/floors/${floorId}/versions`);if(!response.ok)throw new Error('Failed to get floor versions');return response.json();}
async getFloorMetadata(floorId){const response=await fetch(`/api/floors/${floorId}/metadata`);if(!response.ok)throw new Error('Failed to get floor metadata');return response.json();}
async compressData(data){return JSON.stringify(data);}
async compressBackup(backupData){return JSON.stringify(backupData);}
createSVGDocument(svgData,includeMetadata){const svg=`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${svgData.width}" height="${svgData.height}">
    ${includeMetadata ? this.createSVGMetadata(svgData.metadata) : ''}
    ${svgData.content}
</svg>`;return svg;}
createSVGMetadata(metadata){return`<metadata>
    <title>${metadata.title || 'Floor Plan'}</title>
    <description>${metadata.description || ''}</description>
    <created>${metadata.created_at || new Date().toISOString()}</created>
    <version>${metadata.version || '1.0'}</version>
</metadata>`;}
async optimizeSVG(svgDocument){return svgDocument.replace(/\s+/g,' ').trim();}
parseSVGData(svgContent){const parser=new DOMParser();const doc=parser.parseFromString(svgContent,'image/svg+xml');return{width:doc.documentElement.getAttribute('width'),height:doc.documentElement.getAttribute('height'),content:svgContent,elements:Array.from(doc.documentElement.children)};}
validateImportData(data){if(!data.format||!data.version_data){throw new Error('Invalid import data format');}}
validateBackup(backupData){if(!backupData.type||!backupData.version){throw new Error('Invalid backup format');}}
async processImportData(importData,options){return importData.version_data;}
async processSVGData(svgData,options){return svgData;}
async prepareRestoreData(backupData,options){return backupData;}
async collectVersionAssets(versionId){return[];}
async collectFloorAssets(floorId){return[];}
async importVersion(data,options){const response=await fetch('/api/versions/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data,options})});if(!response.ok)throw new Error('Failed to import version');return response.json();}
async importSVG(data,options){const response=await fetch('/api/svg/import',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data,options})});if(!response.ok)throw new Error('Failed to import SVG');return response.json();}
async performRestore(data,options){const response=await fetch('/api/backup/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data,options})});if(!response.ok)throw new Error('Failed to restore backup');return response.json();}
async readBackupFile(file){const content=await this.utils.readFileAsText(file);return JSON.parse(content);}
emitEvent(eventName,data){const event=new CustomEvent(eventName,{detail:data,bubbles:true});document.dispatchEvent(event);}
getExportImportStatistics(){return{exportQueue:this.exportQueue,importQueue:this.importQueue,currentOperation:this.currentOperation,options:this.options};}
destroy(){this.exportQueue=[];this.importQueue=[];this.cancelCurrentOperation();const elements=['export-import-panel','export-import-progress-modal'];elements.forEach(id=>{const element=document.getElementById(id);if(element){element.remove();}});}}
const exportImportSystem=new ExportImportSystem();if(typeof module!=='undefined'&&module.exports){module.exports=ExportImportSystem;}
class FloorVersionControl{constructor(){this.currentFloor=null;this.versions=[];this.selectedVersion=null;this.undoStack=[];this.redoStack=[];this.isProcessing=false;this.apiBaseUrl='http://localhost:8080/api';this.initializeEventListeners();this.loadFloors();this.setupKeyboardShortcuts();}
initializeEventListeners(){document.getElementById('floor-select').addEventListener('change',(e)=>{this.currentFloor=e.target.value;if(this.currentFloor){this.loadVersions();}});document.getElementById('create-snapshot-btn').addEventListener('click',()=>{this.showSnapshotModal();});document.getElementById('undo-btn').addEventListener('click',()=>this.undo());document.getElementById('redo-btn').addEventListener('click',()=>this.redo());document.getElementById('version-search').addEventListener('input',(e)=>{this.filterVersions(e.target.value);});document.getElementById('version-filter').addEventListener('change',(e)=>{this.filterVersionsByType(e.target.value);});this.initializeModalEvents();document.getElementById('export-comparison-btn').addEventListener('click',()=>{this.exportComparisonReport();});document.getElementById('close-comparison-btn').addEventListener('click',()=>{this.hideComparisonView();});}
initializeModalEvents(){document.getElementById('close-snapshot-modal').addEventListener('click',()=>{this.hideModal('snapshot-modal');});document.getElementById('cancel-snapshot').addEventListener('click',()=>{this.hideModal('snapshot-modal');});document.getElementById('snapshot-form').addEventListener('submit',(e)=>{e.preventDefault();this.createSnapshot();});document.getElementById('close-restore-modal').addEventListener('click',()=>{this.hideModal('restore-modal');});document.getElementById('cancel-restore').addEventListener('click',()=>{this.hideModal('restore-modal');});document.getElementById('confirm-restore').addEventListener('click',()=>{this.confirmRestore();});document.querySelectorAll('.modal-overlay').forEach(overlay=>{overlay.addEventListener('click',(e)=>{if(e.target===overlay){this.hideModal(overlay.id);}});});}
setupKeyboardShortcuts(){document.addEventListener('keydown',(e)=>{if(e.ctrlKey||e.metaKey){switch(e.key){case'z':e.preventDefault();if(e.shiftKey){this.redo();}else{this.undo();}
break;case'y':e.preventDefault();this.redo();break;}}});}
async loadFloors(){try{const response=await fetch(`${this.apiBaseUrl}/floors`);if(response.ok){const floors=await response.json();const select=document.getElementById('floor-select');select.innerHTML='<option value="">Select a floor...</option>';floors.forEach(floor=>{const option=document.createElement('option');option.value=floor.id;option.textContent=floor.name;select.appendChild(option);});}}catch(error){this.showToast('Error loading floors','error');}}
async loadVersions(){if(!this.currentFloor)return;try{this.showProgress('Loading versions...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions`);if(response.ok){this.versions=await response.json();this.renderVersionList();this.hideProgress();}else{throw new Error('Failed to load versions');}}catch(error){this.hideProgress();this.showToast('Error loading versions','error');}}
renderVersionList(){const container=document.getElementById('version-list');if(this.versions.length===0){container.innerHTML=`
                <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-history text-2xl mb-2"></i>
                    <p>No versions found. Create your first snapshot to get started.</p>
                </div>
            `;return;}
container.innerHTML=this.versions.map(version=>this.createVersionItem(version)).join('');container.querySelectorAll('.version-item').forEach((item,index)=>{item.addEventListener('click',()=>this.selectVersion(this.versions[index]));});}
createVersionItem(version){const date=new Date(version.created_at).toLocaleString();const tags=this.getVersionTags(version);return`
            <div class="version-item p-4 cursor-pointer ${version.type}" data-version-id="${version.id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center mb-2">
                            <h4 class="font-medium text-gray-900">${version.description || 'Untitled Version'}</h4>
                            ${tags}
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">${version.created_by}</span>  ${date}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${version.changes_count || 0} changes  ${version.size || '0 KB'}
                        </div>
                    </div>

                    <div class="version-actions">
                        <button class="compare-button" onclick="event.stopPropagation(); floorVersionControl.compareVersion('${version.id}')">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="restore-button" onclick="event.stopPropagation(); floorVersionControl.showRestoreModal('${version.id}')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="export-button" onclick="event.stopPropagation(); floorVersionControl.exportVersion('${version.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="delete-button" onclick="event.stopPropagation(); floorVersionControl.deleteVersion('${version.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;}
getVersionTags(version){const tags=[];if(version.type==='auto-save'){tags.push('<span class="version-tag tag-auto-save">Auto-save</span>');}
if(version.type==='branch'){tags.push('<span class="version-tag tag-branch">Branch</span>');}
if(version.is_restored){tags.push('<span class="version-tag tag-restored">Restored</span>');}
return tags.join('');}
selectVersion(version){this.selectedVersion=version;document.querySelectorAll('.version-item').forEach(item=>{item.classList.remove('selected');});const selectedItem=document.querySelector(`[data-version-id="${version.id}"]`);if(selectedItem){selectedItem.classList.add('selected');}
this.renderVersionDetails(version);}
renderVersionDetails(version){const container=document.getElementById('version-details');const date=new Date(version.created_at).toLocaleString();container.innerHTML=`
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">${version.description || 'Untitled Version'}</h4>
                    <p class="text-sm text-gray-600">${version.created_by}</p>
                    <p class="text-sm text-gray-600">${date}</p>
                </div>

                <div class="bg-gray-50 p-3 rounded-md">
                    <h5 class="font-medium text-gray-900 mb-2">Version Information</h5>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Type:</span>
                            <span class="font-medium">${this.formatVersionType(version.type)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Changes:</span>
                            <span class="font-medium">${version.changes_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Size:</span>
                            <span class="font-medium">${version.size || '0 KB'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">ID:</span>
                            <span class="font-mono text-xs">${version.id}</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <button class="w-full restore-button py-2 px-4 rounded-md" onclick="floorVersionControl.showRestoreModal('${version.id}')">
                        <i class="fas fa-undo mr-2"></i>Restore This Version
                    </button>
                    <button class="w-full compare-button py-2 px-4 rounded-md" onclick="floorVersionControl.compareVersion('${version.id}')">
                        <i class="fas fa-exchange-alt mr-2"></i>Compare with Current
                    </button>
                    <button class="w-full export-button py-2 px-4 rounded-md" onclick="floorVersionControl.exportVersion('${version.id}')">
                        <i class="fas fa-download mr-2"></i>Export Version
                    </button>
                </div>
            </div>
        `;}
formatVersionType(type){const types={'manual':'Manual Snapshot','auto-save':'Auto Save','branch':'Branch','restored':'Restored'};return types[type]||type;}
filterVersions(searchTerm){const items=document.querySelectorAll('.version-item');const term=searchTerm.toLowerCase();items.forEach(item=>{const text=item.textContent.toLowerCase();item.style.display=text.includes(term)?'block':'none';});}
filterVersionsByType(type){const items=document.querySelectorAll('.version-item');items.forEach(item=>{if(type==='all'||item.classList.contains(type)){item.style.display='block';}else{item.style.display='none';}});}
showSnapshotModal(){document.getElementById('snapshot-modal').style.display='block';document.getElementById('snapshot-description').focus();}
async createSnapshot(){const description=document.getElementById('snapshot-description').value;const tags=document.getElementById('snapshot-tags').value;const isAutoSave=document.getElementById('snapshot-auto-save').checked;if(!this.currentFloor){this.showToast('Please select a floor first','warning');return;}
try{this.showProgress('Creating snapshot...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({description,tags:tags.split(',').map(tag=>tag.trim()).filter(tag=>tag),type:isAutoSave?'auto-save':'manual'})});if(response.ok){const newVersion=await response.json();this.versions.unshift(newVersion);this.renderVersionList();this.hideModal('snapshot-modal');this.showToast('Snapshot created successfully','success');document.getElementById('snapshot-form').reset();}else{throw new Error('Failed to create snapshot');}}catch(error){this.showToast('Error creating snapshot','error');}finally{this.hideProgress();}}
async showRestoreModal(versionId){const version=this.versions.find(v=>v.id===versionId);if(!version)return;const conflicts=await this.checkConflicts(versionId);document.getElementById('restore-version-info').innerHTML=`
            <div class="font-medium">${version.description || 'Untitled Version'}</div>
            <div class="text-sm text-gray-600">${version.created_by}  ${new Date(version.created_at).toLocaleString()}</div>
        `;const warning=document.getElementById('restore-warning');if(conflicts.length>0){warning.style.display='block';document.getElementById('conflict-list').innerHTML=conflicts.map(conflict=>`<li>${conflict}</li>`).join('');}else{warning.style.display='none';}
document.getElementById('restore-modal').style.display='block';this.selectedVersion=version;}
async checkConflicts(versionId){try{const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${versionId}/conflicts`);if(response.ok){return await response.json();}}catch(error){console.error('Error checking conflicts:',error);}
return[];}
async confirmRestore(){if(!this.selectedVersion)return;try{this.hideModal('restore-modal');this.showProgress('Restoring version...','This may take a few moments...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${this.selectedVersion.id}/restore`,{method:'POST'});if(response.ok){this.showToast('Version restored successfully','success');this.loadVersions();this.undoStack.push({action:'restore',versionId:this.selectedVersion.id,timestamp:Date.now()});this.updateUndoRedoButtons();}else{throw new Error('Failed to restore version');}}catch(error){this.showToast('Error restoring version','error');}finally{this.hideProgress();}}
async compareVersion(versionId){try{this.showProgress('Loading comparison...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${versionId}/compare`);if(response.ok){const comparison=await response.json();this.showComparisonView(comparison);}else{throw new Error('Failed to load comparison');}}catch(error){this.showToast('Error loading comparison','error');}finally{this.hideProgress();}}
showComparisonView(comparison){document.getElementById('comparison-view').style.display='block';document.getElementById('from-version-label').textContent=`From: ${comparison.from_version.description || 'Current'}`;document.getElementById('to-version-label').textContent=`To: ${comparison.to_version.description || 'Selected Version'}`;this.renderComparisonContent(comparison);}
renderComparisonContent(comparison){const fromContent=document.getElementById('from-version-content');const toContent=document.getElementById('to-version-content');fromContent.innerHTML=this.renderDiffContent(comparison.from_data,comparison.changes,'from');toContent.innerHTML=this.renderDiffContent(comparison.to_data,comparison.changes,'to');}
renderDiffContent(data,changes,side){if(!data)return'<div class="text-gray-500">No data available</div>';let html='<div class="space-y-2">';changes.forEach(change=>{const changeClass=this.getChangeClass(change.type);const indicator=`<span class="change-indicator ${changeClass}"></span>`;if(side==='from'&&change.type==='removed'){html+=`<div class="diff-removed p-2 rounded">${indicator}${change.key}: ${change.old_value}</div>`;}else if(side==='to'&&change.type==='added'){html+=`<div class="diff-added p-2 rounded">${indicator}${change.key}: ${change.new_value}</div>`;}else if(change.type==='modified'){const value=side==='from'?change.old_value:change.new_value;html+=`<div class="diff-modified p-2 rounded">${indicator}${change.key}: ${value}</div>`;}else if(change.type==='unchanged'){html+=`<div class="p-2">${change.key}: ${change.value}</div>`;}});html+='</div>';return html;}
getChangeClass(type){const classes={'added':'change-added','removed':'change-removed','modified':'change-modified'};return classes[type]||'';}
hideComparisonView(){document.getElementById('comparison-view').style.display='none';}
async exportComparisonReport(){try{this.showProgress('Generating report...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/export-comparison`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({format:'pdf'})});if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`version-comparison-${Date.now()}.pdf`;a.click();window.URL.revokeObjectURL(url);this.showToast('Comparison report exported successfully','success');}else{throw new Error('Failed to export report');}}catch(error){this.showToast('Error exporting report','error');}finally{this.hideProgress();}}
async exportVersion(versionId){try{this.showProgress('Exporting version...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${versionId}/export`);if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`version-${versionId}-${Date.now()}.json`;a.click();window.URL.revokeObjectURL(url);this.showToast('Version exported successfully','success');}else{throw new Error('Failed to export version');}}catch(error){this.showToast('Error exporting version','error');}finally{this.hideProgress();}}
async deleteVersion(versionId){if(!confirm('Are you sure you want to delete this version? This action cannot be undone.')){return;}
try{this.showProgress('Deleting version...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${versionId}`,{method:'DELETE'});if(response.ok){this.versions=this.versions.filter(v=>v.id!==versionId);this.renderVersionList();this.showToast('Version deleted successfully','success');}else{throw new Error('Failed to delete version');}}catch(error){this.showToast('Error deleting version','error');}finally{this.hideProgress();}}
undo(){if(this.undoStack.length===0)return;const lastAction=this.undoStack.pop();this.redoStack.push(lastAction);if(lastAction.action==='restore'){this.undoRestore(lastAction);}
this.updateUndoRedoButtons();}
redo(){if(this.redoStack.length===0)return;const nextAction=this.redoStack.pop();this.undoStack.push(nextAction);if(nextAction.action==='restore'){this.redoRestore(nextAction);}
this.updateUndoRedoButtons();}
async undoRestore(action){try{this.showProgress('Undoing restore...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${action.versionId}/undo-restore`,{method:'POST'});if(response.ok){this.showToast('Restore undone successfully','success');this.loadVersions();}else{throw new Error('Failed to undo restore');}}catch(error){this.showToast('Error undoing restore','error');}finally{this.hideProgress();}}
async redoRestore(action){try{this.showProgress('Redoing restore...');const response=await fetch(`${this.apiBaseUrl}/floors/${this.currentFloor}/versions/${action.versionId}/restore`,{method:'POST'});if(response.ok){this.showToast('Restore redone successfully','success');this.loadVersions();}else{throw new Error('Failed to redo restore');}}catch(error){this.showToast('Error redoing restore','error');}finally{this.hideProgress();}}
updateUndoRedoButtons(){const undoBtn=document.getElementById('undo-btn');const redoBtn=document.getElementById('redo-btn');undoBtn.disabled=this.undoStack.length===0;redoBtn.disabled=this.redoStack.length===0;}
showModal(modalId){document.getElementById(modalId).style.display='block';}
hideModal(modalId){document.getElementById(modalId).style.display='none';}
showProgress(title='Processing...',message='Please wait while we process your request.'){document.getElementById('progress-title').textContent=title;document.getElementById('progress-message').textContent=message;document.getElementById('progress-modal').style.display='block';this.isProcessing=true;}
hideProgress(){document.getElementById('progress-modal').style.display='none';this.isProcessing=false;}
showToast(message,type='info',duration=5000){const container=document.getElementById('toast-container');const toast=document.createElement('div');toast.className=`toast ${type} p-4 rounded-md shadow-lg`;toast.innerHTML=`
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas ${this.getToastIcon(type)} mr-2"></i>
                    <span>${message}</span>
                </div>
                <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;container.appendChild(toast);setTimeout(()=>{if(toast.parentElement){toast.remove();}},duration);}
getToastIcon(type){const icons={'success':'fa-check-circle','error':'fa-exclamation-circle','warning':'fa-exclamation-triangle','info':'fa-info-circle'};return icons[type]||'fa-info-circle';}}
const floorVersionControl=new FloorVersionControl();class LODManager{constructor(options={}){this.lodLevels=options.lodLevels||{high:{minZoom:2.0,complexity:1.0,name:'High Detail'},medium:{minZoom:0.5,complexity:0.7,name:'Medium Detail'},low:{minZoom:0.1,complexity:0.4,name:'Low Detail'},minimal:{minZoom:0.0,complexity:0.2,name:'Minimal Detail'}};this.switchThreshold=options.switchThreshold||0.1;this.transitionDuration=options.transitionDuration||200;this.enableTransitions=options.enableTransitions!==false;this.currentLODLevel='medium';this.lastZoomLevel=1.0;this.switchingLOD=false;this.lodCache=new Map();this.symbolLODData=new Map();this.lodStats={totalSwitches:0,lastSwitchTime:0,averageSwitchTime:0,switchTimes:[]};this.eventHandlers=new Map();this.viewportManager=null;this.symbolScaler=null;this.initialize();}
initialize(){this.connectToViewportManager();this.connectToSymbolScaler();console.log('LODManager initialized');}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.viewportManager=window.viewportManager;console.log('LODManager connected to ViewportManager');this.viewportManager.addEventListener('zoomChanged',(data)=>{this.handleZoomChange(data.zoom);});this.viewportManager.addEventListener('viewReset',()=>{this.handleZoomChange(this.viewportManager.currentZoom);});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
connectToSymbolScaler(){const checkSymbolScaler=()=>{if(window.symbolScaler){this.symbolScaler=window.symbolScaler;console.log('LODManager connected to SymbolScaler');}else{setTimeout(checkSymbolScaler,100);}};checkSymbolScaler();}
handleZoomChange(zoomLevel){if(this.switchingLOD)return;const targetLOD=this.getLODLevelForZoom(zoomLevel);if(targetLOD!==this.currentLODLevel){this.switchLODLevel(targetLOD,zoomLevel);}
this.lastZoomLevel=zoomLevel;}
getLODLevelForZoom(zoomLevel){const levels=Object.keys(this.lodLevels).reverse();for(const level of levels){if(zoomLevel>=this.lodLevels[level].minZoom){return level;}}
return'minimal';}
switchLODLevel(newLevel,zoomLevel){if(this.switchingLOD||newLevel===this.currentLODLevel){return;}
this.switchingLOD=true;const startTime=performance.now();console.log(`LODManager: Switching from ${this.currentLODLevel} to ${newLevel} at zoom ${zoomLevel}`);this.updateAllSymbolsLOD(newLevel);this.currentLODLevel=newLevel;const switchTime=performance.now()-startTime;this.updateLODStats(switchTime);this.triggerEvent('lodChanged',{fromLevel:this.currentLODLevel,toLevel:newLevel,zoomLevel:zoomLevel,switchTime:switchTime});this.switchingLOD=false;}
updateAllSymbolsLOD(lodLevel){const symbols=document.querySelectorAll('.placed-symbol');const lodConfig=this.lodLevels[lodLevel];symbols.forEach(symbol=>{this.updateSymbolLOD(symbol,lodLevel,lodConfig);});}
updateSymbolLOD(symbolElement,lodLevel,lodConfig){if(!symbolElement)return;const symbolId=symbolElement.getAttribute('data-symbol-id');if(!symbolId)return;const lodData=this.getSymbolLODData(symbolId);if(!lodData)return;const svgContent=this.getLODSVG(lodData,lodLevel);if(!svgContent)return;this.updateSymbolSVG(symbolElement,svgContent,lodLevel,lodConfig);}
getSymbolLODData(symbolId){if(this.symbolLODData.has(symbolId)){return this.symbolLODData.get(symbolId);}
if(window.symbolLibrary){const symbol=window.symbolLibrary.symbols.find(s=>s.id===symbolId);if(symbol&&symbol.lodData){this.symbolLODData.set(symbolId,symbol.lodData);return symbol.lodData;}}
const defaultLODData=this.generateDefaultLODData(symbolId);this.symbolLODData.set(symbolId,defaultLODData);return defaultLODData;}
generateDefaultLODData(symbolId){const symbol=this.getSymbolById(symbolId);if(!symbol)return null;const originalSVG=symbol.svg||'';return{symbolId:symbolId,levels:{high:{svg:originalSVG,complexity:1.0,elementCount:this.countSVGElements(originalSVG)},medium:{svg:this.simplifySVG(originalSVG,0.7),complexity:0.7,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.7))},low:{svg:this.simplifySVG(originalSVG,0.4),complexity:0.4,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.4))},minimal:{svg:this.simplifySVG(originalSVG,0.2),complexity:0.2,elementCount:this.countSVGElements(this.simplifySVG(originalSVG,0.2))}}};}
getSymbolById(symbolId){if(window.symbolLibrary){return window.symbolLibrary.symbols.find(s=>s.id===symbolId);}
return null;}
countSVGElements(svgContent){const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const svgElement=tempDiv.querySelector('svg');if(!svgElement)return 0;const elements=svgElement.querySelectorAll('path, rect, circle, ellipse, line, polyline, polygon, text');return elements.length;}
simplifySVG(svgContent,complexityFactor){const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const svgElement=tempDiv.querySelector('svg');if(!svgElement)return svgContent;const simplifiedSVG=svgElement.cloneNode(true);if(complexityFactor<0.5){const detailedElements=simplifiedSVG.querySelectorAll('text, path[d*="c"], path[d*="s"]');detailedElements.forEach(el=>el.remove());}
if(complexityFactor<0.3){const complexElements=simplifiedSVG.querySelectorAll('path:not([d*="M"]):not([d*="L"]), text, circle[r*="."]');complexElements.forEach(el=>el.remove());}
if(complexityFactor<0.2){const basicElements=simplifiedSVG.querySelectorAll('rect, circle, line');const allElements=simplifiedSVG.querySelectorAll('*');allElements.forEach(el=>{if(!basicElements.includes(el)&&el!==simplifiedSVG){el.remove();}});}
return simplifiedSVG.outerHTML;}
getLODSVG(lodData,lodLevel){if(!lodData||!lodData.levels||!lodData.levels[lodLevel]){return null;}
return lodData.levels[lodLevel].svg;}
updateSymbolSVG(symbolElement,svgContent,lodLevel,lodConfig){if(!symbolElement||!svgContent)return;const svgElement=symbolElement.querySelector('svg');if(!svgElement)return;const currentTransform=svgElement.getAttribute('transform')||'';const currentScale=symbolElement.getAttribute('data-scale')||'1';const tempDiv=document.createElement('div');tempDiv.innerHTML=svgContent;const newSVG=tempDiv.querySelector('svg');if(!newSVG)return;if(this.enableTransitions){svgElement.style.transition=`opacity ${this.transitionDuration}ms ease`;svgElement.style.opacity='0';setTimeout(()=>{svgElement.innerHTML=newSVG.innerHTML;svgElement.setAttribute('viewBox',newSVG.getAttribute('viewBox')||'0 0 20 20');svgElement.setAttribute('transform',currentTransform);svgElement.style.opacity='1';setTimeout(()=>{svgElement.style.transition='';},this.transitionDuration);},this.transitionDuration/2);}else{svgElement.innerHTML=newSVG.innerHTML;svgElement.setAttribute('viewBox',newSVG.getAttribute('viewBox')||'0 0 20 20');svgElement.setAttribute('transform',currentTransform);}
symbolElement.setAttribute('data-lod-level',lodLevel);symbolElement.setAttribute('data-lod-complexity',lodConfig.complexity);this.triggerEvent('symbolLODChanged',{symbolElement:symbolElement,lodLevel:lodLevel,complexity:lodConfig.complexity});}
updateLODStats(switchTime){this.lodStats.totalSwitches++;this.lodStats.lastSwitchTime=Date.now();this.lodStats.switchTimes.push(switchTime);if(this.lodStats.switchTimes.length>100){this.lodStats.switchTimes.shift();}
this.lodStats.averageSwitchTime=this.lodStats.switchTimes.reduce((a,b)=>a+b,0)/this.lodStats.switchTimes.length;}
getCurrentLODLevel(){return this.currentLODLevel;}
getLODConfig(){return{...this.lodLevels};}
setLODConfig(config){this.lodLevels={...config};console.log('LODManager: Configuration updated');}
forceLODLevel(level){if(!this.lodLevels[level]){console.warn(`LODManager: Invalid LOD level: ${level}`);return;}
this.switchLODLevel(level,this.lastZoomLevel);}
getLODStats(){return{...this.lodStats};}
clearLODCache(){this.lodCache.clear();this.symbolLODData.clear();console.log('LODManager: Cache cleared');}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in LOD manager event handler for ${event}:`,error);}});}}
setTransitionsEnabled(enabled){this.enableTransitions=enabled;console.log(`LODManager: Transitions ${enabled ? 'enabled' : 'disabled'}`);}
setTransitionDuration(duration){this.transitionDuration=duration;console.log(`LODManager: Transition duration set to ${duration}ms`);}
getPerformanceReport(){const report={currentLODLevel:this.currentLODLevel,totalSwitches:this.lodStats.totalSwitches,averageSwitchTime:this.lodStats.averageSwitchTime,lastSwitchTime:this.lodStats.lastSwitchTime,cacheSize:this.lodCache.size,symbolLODDataSize:this.symbolLODData.size,configuration:this.getLODConfig()};return report;}
destroy(){this.eventHandlers.clear();this.lodCache.clear();this.symbolLODData.clear();console.log('LODManager: Destroyed');}}
if(typeof module!=='undefined'&&module.exports){module.exports=LODManager;}else if(typeof window!=='undefined'){window.LODManager=LODManager;}
class LODTester{constructor(){this.testSymbols=[];this.testResults=[];this.isRunning=false;this.currentTest=null;this.testConfigs={simple:{name:'Simple Symbols',symbolCount:50,complexity:'low',description:'Basic geometric shapes'},medium:{name:'Medium Complexity',symbolCount:30,complexity:'medium',description:'Symbols with moderate detail'},complex:{name:'Complex Symbols',symbolCount:20,complexity:'high',description:'Highly detailed symbols'},mixed:{name:'Mixed Complexity',symbolCount:100,complexity:'mixed',description:'Mix of simple and complex symbols'}};this.metrics={renderTime:0,memoryUsage:0,lodSwitches:0,averageSwitchTime:0};this.initialize();}
initialize(){this.generateTestSymbols();window.arxLogger.info('LODTester initialized',{file:'lod_tester.js'});}
generateTestSymbols(){this.testSymbols=[{id:'test-simple-1',name:'Simple Circle',category:'test',svg:'<circle cx="10" cy="10" r="8" fill="blue" stroke="black" stroke-width="1"/>',complexity:'low'},{id:'test-simple-2',name:'Simple Square',category:'test',svg:'<rect x="2" y="2" width="16" height="16" fill="red" stroke="black" stroke-width="1"/>',complexity:'low'},{id:'test-simple-3',name:'Simple Triangle',category:'test',svg:'<polygon points="10,2 18,18 2,18" fill="green" stroke="black" stroke-width="1"/>',complexity:'low'},{id:'test-medium-1',name:'Medium Device',category:'test',svg:`
                    <rect x="3" y="3" width="14" height="14" fill="lightblue" stroke="black" stroke-width="1"/>
                    <circle cx="10" cy="10" r="3" fill="white" stroke="black" stroke-width="1"/>
                    <line x1="7" y1="10" x2="13" y2="10" stroke="black" stroke-width="2"/>
                    <line x1="10" y1="7" x2="10" y2="13" stroke="black" stroke-width="2"/>
                `,complexity:'medium'},{id:'test-medium-2',name:'Medium Sensor',category:'test',svg:`
                    <circle cx="10" cy="10" r="8" fill="yellow" stroke="black" stroke-width="1"/>
                    <circle cx="10" cy="10" r="5" fill="orange" stroke="black" stroke-width="1"/>
                    <circle cx="10" cy="10" r="2" fill="red"/>
                    <text x="10" y="22" text-anchor="middle" font-size="3" fill="black">S</text>
                `,complexity:'medium'},{id:'test-complex-1',name:'Complex Controller',category:'test',svg:`
                    <rect x="2" y="2" width="16" height="16" fill="lightgray" stroke="black" stroke-width="1"/>
                    <rect x="4" y="4" width="12" height="4" fill="white" stroke="black" stroke-width="0.5"/>
                    <rect x="4" y="10" width="12" height="4" fill="white" stroke="black" stroke-width="0.5"/>
                    <circle cx="6" cy="6" r="1" fill="green"/>
                    <circle cx="10" cy="6" r="1" fill="yellow"/>
                    <circle cx="14" cy="6" r="1" fill="red"/>
                    <circle cx="6" cy="12" r="1" fill="blue"/>
                    <circle cx="10" cy="12" r="1" fill="purple"/>
                    <circle cx="14" cy="12" r="1" fill="orange"/>
                    <text x="10" y="18" text-anchor="middle" font-size="2" fill="black">CTRL</text>
                `,complexity:'high'},{id:'test-complex-2',name:'Complex Panel',category:'test',svg:`
                    <rect x="1" y="1" width="18" height="18" fill="darkgray" stroke="black" stroke-width="1"/>
                    <rect x="3" y="3" width="14" height="6" fill="black"/>
                    <rect x="3" y="11" width="14" height="6" fill="black"/>
                    <rect x="5" y="5" width="2" height="2" fill="red"/>
                    <rect x="8" y="5" width="2" height="2" fill="green"/>
                    <rect x="11" y="5" width="2" height="2" fill="blue"/>
                    <rect x="14" y="5" width="2" height="2" fill="yellow"/>
                    <rect x="5" y="13" width="2" height="2" fill="cyan"/>
                    <rect x="8" y="13" width="2" height="2" fill="magenta"/>
                    <rect x="11" y="13" width="2" height="2" fill="orange"/>
                    <rect x="14" y="13" width="2" height="2" fill="pink"/>
                    <text x="10" y="22" text-anchor="middle" font-size="2" fill="black">PANEL</text>
                `,complexity:'high'}];}
async runTest(testType){if(this.isRunning){console.warn('LODTester: Test already running');return;}
const config=this.testConfigs[testType];if(!config){console.error(`LODTester: Unknown test type: ${testType}`);return;}
this.isRunning=true;this.currentTest=testType;window.arxLogger.info(`LODTester: Starting ${config.name} test`,{file:'lod_tester.js'});try{this.clearTestObjects();const testObjects=this.generateTestObjects(config);await this.placeTestObjects(testObjects);await this.runZoomTest();const results=this.collectTestResults(config);this.testResults.push(results);window.arxLogger.info(`LODTester: ${config.name} test completed`,{results,file:'lod_tester.js'});return results;}catch(error){console.error('LODTester: Test failed',error);throw error;}finally{this.isRunning=false;this.currentTest=null;}}
generateTestObjects(config){const objects=[];const symbols=this.getSymbolsByComplexity(config.complexity);for(let i=0;i<config.symbolCount;i++){const symbol=symbols[i%symbols.length];const x=Math.random()*800+100;const y=Math.random()*600+100;objects.push({symbol:symbol,x:x,y:y,id:`test-${config.complexity}-${i}`});}
return objects;}
getSymbolsByComplexity(complexity){if(complexity==='mixed'){return this.testSymbols;}
return this.testSymbols.filter(symbol=>symbol.complexity===complexity);}
async placeTestObjects(objects){const svg=document.querySelector('#svg-container svg');if(!svg){throw new Error('SVG container not found');}
const startTime=performance.now();for(const obj of objects){await this.placeTestObject(svg,obj);await new Promise(resolve=>setTimeout(resolve,10));}
this.metrics.renderTime=performance.now()-startTime;}
async placeTestObject(svg,obj){const symbolElement=document.createElementNS('http://www.w3.org/2000/svg','g');symbolElement.setAttribute('id',obj.id);symbolElement.setAttribute('class','placed-symbol test-object');symbolElement.setAttribute('data-symbol-id',obj.symbol.id);symbolElement.setAttribute('data-symbol-name',obj.symbol.name);symbolElement.setAttribute('data-category',obj.symbol.category);symbolElement.setAttribute('data-complexity',obj.symbol.complexity);symbolElement.setAttribute('data-x',obj.x.toString());symbolElement.setAttribute('data-y',obj.y.toString());symbolElement.setAttribute('data-base-scale','1.0');symbolElement.setAttribute('data-lod-level','medium');symbolElement.setAttribute('data-lod-complexity','0.7');symbolElement.setAttribute('data-lod-enabled','true');const symbolSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');symbolSvg.setAttribute('width','40');symbolSvg.setAttribute('height','40');symbolSvg.setAttribute('viewBox','0 0 20 20');symbolSvg.innerHTML=obj.symbol.svg;symbolElement.appendChild(symbolSvg);symbolElement.setAttribute('transform',`translate(${obj.x}, ${obj.y})`);svg.appendChild(symbolElement);}
async runZoomTest(){if(!window.viewportManager){console.warn('LODTester: ViewportManager not available for zoom test');return;}
const viewportManager=window.viewportManager;const lodManager=window.lodManager;if(!lodManager){console.warn('LODTester: LODManager not available for zoom test');return;}
const initialZoom=viewportManager.currentZoom;const initialLOD=lodManager.getCurrentLODLevel();const zoomLevels=[0.1,0.5,1.0,2.0,5.0];const lodSwitches=[];for(const zoom of zoomLevels){const startTime=performance.now();viewportManager.setZoom(zoom);await new Promise(resolve=>setTimeout(resolve,500));const switchTime=performance.now()-startTime;const currentLOD=lodManager.getCurrentLODLevel();lodSwitches.push({zoom:zoom,lodLevel:currentLOD,switchTime:switchTime});}
viewportManager.setZoom(initialZoom);this.metrics.lodSwitches=lodSwitches.length;this.metrics.averageSwitchTime=lodSwitches.reduce((sum,s)=>sum+s.switchTime,0)/lodSwitches.length;return lodSwitches;}
collectTestResults(config){const testObjects=document.querySelectorAll('.test-object');const lodManager=window.lodManager;const results={testType:config.name,timestamp:new Date().toISOString(),objectCount:testObjects.length,renderTime:this.metrics.renderTime,lodSwitches:this.metrics.lodSwitches,averageSwitchTime:this.metrics.averageSwitchTime,currentLODLevel:lodManager?lodManager.getCurrentLODLevel():'unknown',memoryUsage:this.getMemoryUsage(),performance:{fps:this.calculateFPS(),objectVisibility:this.calculateObjectVisibility()}};return results;}
getMemoryUsage(){if(performance.memory){return{used:performance.memory.usedJSHeapSize,total:performance.memory.totalJSHeapSize,limit:performance.memory.jsHeapSizeLimit};}
return null;}
calculateFPS(){const renderTime=this.metrics.renderTime;const objectCount=document.querySelectorAll('.test-object').length;if(renderTime>0&&objectCount>0){const timePerObject=renderTime/objectCount;return Math.round(1000/timePerObject);}
return 60;}
calculateObjectVisibility(){const testObjects=document.querySelectorAll('.test-object');const viewportManager=window.viewportManager;if(!viewportManager)return 100;let visibleCount=0;testObjects.forEach(obj=>{const x=parseFloat(obj.getAttribute('data-x'));const y=parseFloat(obj.getAttribute('data-y'));if(viewportManager.isObjectVisible(x,y)){visibleCount++;}});return Math.round((visibleCount/testObjects.length)*100);}
clearTestObjects(){const testObjects=document.querySelectorAll('.test-object');testObjects.forEach(obj=>obj.remove());}
getTestResultsSummary(){if(this.testResults.length===0){return{message:'No test results available'};}
const summary={totalTests:this.testResults.length,averageRenderTime:0,averageLODSwitches:0,averageSwitchTime:0,bestPerformance:null,worstPerformance:null};summary.averageRenderTime=this.testResults.reduce((sum,r)=>sum+r.renderTime,0)/this.testResults.length;summary.averageLODSwitches=this.testResults.reduce((sum,r)=>sum+r.lodSwitches,0)/this.testResults.length;summary.averageSwitchTime=this.testResults.reduce((sum,r)=>sum+r.averageSwitchTime,0)/this.testResults.length;const sortedByRenderTime=[...this.testResults].sort((a,b)=>a.renderTime-b.renderTime);summary.bestPerformance=sortedByRenderTime[0];summary.worstPerformance=sortedByRenderTime[sortedByRenderTime.length-1];return summary;}
exportTestResults(){const data={summary:this.getTestResultsSummary(),detailedResults:this.testResults,timestamp:new Date().toISOString()};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`lod-test-results-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);}
resetTestResults(){this.testResults=[];this.metrics={renderTime:0,memoryUsage:0,lodSwitches:0,averageSwitchTime:0};window.arxLogger.info('LODTester: Test results reset',{file:'lod_tester.js'});}
getAvailableTests(){return Object.keys(this.testConfigs);}
getTestConfig(testType){return this.testConfigs[testType];}}
if(typeof module!=='undefined'&&module.exports){module.exports=LODTester;}else if(typeof window!=='undefined'){window.LODTester=LODTester;}
class LoggingReplacer{constructor(){this.replacements=[{pattern:/console\.log\('([^']+)'\)/g,replacement:(match,message)=>this.determineLogLevel(message,'info')},{pattern:/console\.log\(`([^`]+)`\)/g,replacement:(match,message)=>this.determineLogLevel(message,'info')},{pattern:/console\.log\(([^)]+)\)/g,replacement:(match,expression)=>this.determineLogLevel(expression,'info')},{pattern:/console\.log\(([^)]+(?:,\s*[^)]+)*)\)/g,replacement:(match,args)=>this.determineLogLevel(args,'info')}];this.logLevelPatterns={error:[/error/i,/failed/i,/failure/i,/exception/i,/crash/i,/broken/i,/invalid/i,/missing/i,/not found/i,/unauthorized/i,/forbidden/i,/timeout/i,/connection failed/i,/network error/i],warning:[/warn/i,/warning/i,/deprecated/i,/obsolete/i,/slow/i,/performance/i,/retry/i,/fallback/i,/degraded/i,/partial/i,/incomplete/i],debug:[/debug/i,/test/i,/testing/i,/tester/i,/performance/i,/benchmark/i,/profile/i,/trace/i,/verbose/i,/detailed/i,/step/i,/phase/i],info:[/info/i,/connected/i,/disconnected/i,/initialized/i,/started/i,/completed/i,/finished/i,/loaded/i,/saved/i,/updated/i,/created/i,/deleted/i,/moved/i,/resized/i,/selected/i,/deselected/i]};this.contextPatterns={performance:[/performance/i,/benchmark/i,/timing/i,/duration/i,/ms/i,/milliseconds/i,/fps/i,/frame/i,/render/i,/load time/i,/response time/i],connection:[/connected/i,/disconnected/i,/websocket/i,/socket/i,/reconnect/i,/connection/i,/network/i,/api/i,/request/i,/response/i],user:[/user/i,/click/i,/interaction/i,/action/i,/event/i,/input/i,/form/i,/submit/i,/validation/i,/error/i],system:[/system/i,/service/i,/component/i,/module/i,/initialized/i,/started/i,/stopped/i,/shutdown/i,/restart/i],data:[/data/i,/object/i,/array/i,/property/i,/value/i,/state/i,/cache/i,/storage/i,/database/i,/query/i]};this.isInitialized=false;this.processedFiles=new Set();}
initialize(){if(this.isInitialized){console.warn('LoggingReplacer already initialized');return;}
if(typeof window.arxLogger==='undefined'){console.warn('ArxLogger not found. Creating default instance...');window.arxLogger=new ArxLogger({service:'arx-web-frontend',environment:window.location.hostname==='localhost'?'development':'production',enableRemoteLogging:true,remoteEndpoint:'/api/logs/aggregate'});}
this.overrideConsoleLog();this.replaceAll();this.setupMutationObserver();this.isInitialized=true;console.log('LoggingReplacer initialized successfully');}
overrideConsoleLog(){const originalConsoleLog=console.log;const self=this;console.log=function(...args){const message=args.map(arg=>typeof arg==='string'?arg:JSON.stringify(arg)).join(' ');const logLevel=self.determineLogLevel(message,'info');const context=self.determineContext(message);if(window.arxLogger){const metadata={context,originalArgs:args};window.arxLogger[logLevel](message,metadata);}else{originalConsoleLog.apply(console,args);}};}
determineLogLevel(message,defaultLevel='info'){const lowerMessage=message.toLowerCase();for(const pattern of this.logLevelPatterns.error){if(pattern.test(lowerMessage)){return'error';}}
for(const pattern of this.logLevelPatterns.warning){if(pattern.test(lowerMessage)){return'warning';}}
for(const pattern of this.logLevelPatterns.debug){if(pattern.test(lowerMessage)){return'debug';}}
for(const pattern of this.logLevelPatterns.info){if(pattern.test(lowerMessage)){return'info';}}
return defaultLevel;}
determineContext(message){const lowerMessage=message.toLowerCase();const contexts=[];for(const[context,patterns]of Object.entries(this.contextPatterns)){for(const pattern of patterns){if(pattern.test(lowerMessage)){contexts.push(context);break;}}}
return contexts.length>0?contexts:['general'];}
replaceInFile(fileContent,fileName='unknown'){if(this.processedFiles.has(fileName)){return fileContent;}
let modifiedContent=fileContent;let replacements=0;for(const replacement of this.replacements){const matches=fileContent.match(replacement.pattern);if(matches){replacements+=matches.length;modifiedContent=modifiedContent.replace(replacement.pattern,(match,...args)=>{const message=args[0];const logLevel=this.determineLogLevel(message,'info');const context=this.determineContext(message);if(match.includes('`')){return`window.arxLogger.${logLevel}(\`${message}\`, { context: '${context.join(',')}', file: '${fileName}' })`;}else if(match.includes("'")){return`window.arxLogger.${logLevel}('${message}', { context: '${context.join(',')}', file: '${fileName}' })`;}else{return`window.arxLogger.${logLevel}(${message}, { context: '${context.join(',')}', file: '${fileName}' })`;}});}}
if(replacements>0){console.log(`LoggingReplacer: Replaced ${replacements} console.log calls in ${fileName}`);}
this.processedFiles.add(fileName);return modifiedContent;}
replaceAll(){const scripts=document.querySelectorAll('script[src*=".js"]');scripts.forEach(script=>{const src=script.getAttribute('src');if(src&&!this.processedFiles.has(src)){console.log(`LoggingReplacer: Found script ${src}`);}});}
setupMutationObserver(){const observer=new MutationObserver((mutations)=>{mutations.forEach((mutation)=>{mutation.addedNodes.forEach((node)=>{if(node.nodeType===Node.ELEMENT_NODE){if(node.tagName==='SCRIPT'){if(node.src){console.log(`LoggingReplacer: New script detected: ${node.src}`);}else if(node.textContent){const processedContent=this.replaceInFile(node.textContent,'inline');if(processedContent!==node.textContent){node.textContent=processedContent;}}}}});});});observer.observe(document.head,{childList:true,subtree:true});observer.observe(document.body,{childList:true,subtree:true});}
async processFile(filePath){try{const response=await fetch(filePath);const content=await response.text();const processedContent=this.replaceInFile(content,filePath);const script=document.createElement('script');script.textContent=processedContent;script.setAttribute('data-processed','true');const originalScript=document.querySelector(`script[src="${filePath}"]`);if(originalScript){originalScript.parentNode.replaceChild(script,originalScript);}else{document.head.appendChild(script);}
return processedContent;}catch(error){console.error(`LoggingReplacer: Error processing file ${filePath}:`,error);return null;}}
getStats(){return{processedFiles:Array.from(this.processedFiles),totalFiles:this.processedFiles.size,isInitialized:this.isInitialized};}
reset(){this.processedFiles.clear();this.isInitialized=false;console.log('LoggingReplacer reset');}}
window.LoggingReplacer=new LoggingReplacer();if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{window.LoggingReplacer.initialize();});}else{window.LoggingReplacer.initialize();}
if(typeof module!=='undefined'&&module.exports){module.exports=LoggingReplacer;}
class NotificationSystem{constructor(options={}){this.options={position:'top-right',maxNotifications:5,autoClose:true,autoCloseDelay:5000,showProgress:true,showIcons:true,showCloseButton:true,animationDuration:300,...options};this.notifications=[];this.container=null;this.init();}
init(){this.createContainer();this.setupGlobalStyles();}
createContainer(){this.container=document.createElement('div');this.container.id='notification-container';this.container.className=`notification-container fixed z-50 ${this.getPositionClasses()}`;this.container.style.cssText=`
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            pointer-events: none;
        `;document.body.appendChild(this.container);}
getPositionClasses(){const positions={'top-right':'top-0 right-0','top-left':'top-0 left-0','bottom-right':'bottom-0 right-0','bottom-left':'bottom-0 left-0','top-center':'top-0 left-1/2 transform -translate-x-1/2','bottom-center':'bottom-0 left-1/2 transform -translate-x-1/2'};return positions[this.options.position]||positions['top-right'];}
setupGlobalStyles(){const style=document.createElement('style');style.textContent=`
            .notification {
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                padding: 16px;
                margin-bottom: 8px;
                min-width: 300px;
                max-width: 400px;
                pointer-events: auto;
                position: relative;
                overflow: hidden;
                animation: slideIn 0.3s ease-out;
            }

            .notification.success {
                border-left: 4px solid #10b981;
            }

            .notification.error {
                border-left: 4px solid #ef4444;
            }

            .notification.warning {
                border-left: 4px solid #f59e0b;
            }

            .notification.info {
                border-left: 4px solid #3b82f6;
            }

            .notification.processing {
                border-left: 4px solid #8b5cf6;
            }

            .notification-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .notification-title {
                font-weight: 600;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
            }

            .notification-icon {
                margin-right: 8px;
                font-size: 16px;
            }

            .notification-close {
                background: none;
                border: none;
                color: #6b7280;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                transition: all 0.2s;
            }

            .notification-close:hover {
                background: #f3f4f6;
                color: #374151;
            }

            .notification-message {
                font-size: 13px;
                color: #6b7280;
                line-height: 1.4;
                margin-bottom: 8px;
            }

            .notification-progress {
                height: 3px;
                background: #e5e7eb;
                border-radius: 2px;
                overflow: hidden;
                margin-top: 8px;
            }

            .notification-progress-bar {
                height: 100%;
                background: #3b82f6;
                transition: width 0.1s linear;
            }

            .notification-actions {
                display: flex;
                gap: 8px;
                margin-top: 12px;
            }

            .notification-btn {
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                border: none;
            }

            .notification-btn.primary {
                background: #3b82f6;
                color: white;
            }

            .notification-btn.primary:hover {
                background: #2563eb;
            }

            .notification-btn.secondary {
                background: #f3f4f6;
                color: #374151;
            }

            .notification-btn.secondary:hover {
                background: #e5e7eb;
            }

            .notification-btn.danger {
                background: #ef4444;
                color: white;
            }

            .notification-btn.danger:hover {
                background: #dc2626;
            }

            .notification.loading .notification-icon {
                animation: spin 1s linear infinite;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            .notification.removing {
                animation: slideOut 0.3s ease-in forwards;
            }
        `;document.head.appendChild(style);}
show(options){const notification={id:this.generateId(),type:options.type||'info',title:options.title||'',message:options.message||'',duration:options.duration||this.options.autoCloseDelay,actions:options.actions||[],onClose:options.onClose||null,onAction:options.onAction||null,progress:100,element:null};this.notifications.push(notification);this.renderNotification(notification);this.manageNotifications();if(this.options.autoClose&&notification.duration>0){this.startAutoClose(notification);}
return notification.id;}
renderNotification(notification){const element=document.createElement('div');element.className=`notification ${notification.type}`;element.dataset.notificationId=notification.id;const icon=this.getIcon(notification.type);const actions=this.renderActions(notification);element.innerHTML=`
            <div class="notification-header">
                <div class="notification-title">
                    ${this.options.showIcons ? `<i class="fas ${icon} notification-icon"></i>` : ''}
                    ${notification.title}
                </div>
                ${this.options.showCloseButton ? `<button class="notification-close"onclick="notificationSystem.close('${notification.id}')"><i class="fas fa-times"></i></button>` : ''}
            </div>
            <div class="notification-message">${notification.message}</div>
            ${this.options.showProgress ? `<div class="notification-progress"><div class="notification-progress-bar"style="width: ${notification.progress}%"></div></div>` : ''}
            ${actions}
        `;notification.element=element;this.container.appendChild(element);}
renderActions(notification){if(!notification.actions||notification.actions.length===0){return'';}
const actionsHtml=notification.actions.map(action=>`
            <button class="notification-btn ${action.type || 'secondary'}"
                    onclick="notificationSystem.handleAction('${notification.id}', '${action.key}')">
                ${action.label}
            </button>
        `).join('');return`<div class="notification-actions">${actionsHtml}</div>`;}
getIcon(type){const icons={'success':'fa-check-circle','error':'fa-exclamation-circle','warning':'fa-exclamation-triangle','info':'fa-info-circle','processing':'fa-spinner'};return icons[type]||icons['info'];}
startAutoClose(notification){const startTime=Date.now();const duration=notification.duration;const updateProgress=()=>{const elapsed=Date.now()-startTime;const progress=Math.max(0,100-(elapsed/duration)*100);notification.progress=progress;if(notification.element){const progressBar=notification.element.querySelector('.notification-progress-bar');if(progressBar){progressBar.style.width=`${progress}%`;}}
if(progress>0){requestAnimationFrame(updateProgress);}else{this.close(notification.id);}};requestAnimationFrame(updateProgress);}
close(id){const notification=this.notifications.find(n=>n.id===id);if(!notification)return;if(notification.element){notification.element.classList.add('removing');setTimeout(()=>{if(notification.element&&notification.element.parentElement){notification.element.parentElement.removeChild(notification.element);}},this.options.animationDuration);}
this.notifications=this.notifications.filter(n=>n.id!==id);if(notification.onClose){notification.onClose();}}
handleAction(notificationId,actionKey){const notification=this.notifications.find(n=>n.id===notificationId);if(!notification||!notification.onAction)return;notification.onAction(actionKey);}
manageNotifications(){if(this.notifications.length>this.options.maxNotifications){const oldestNotification=this.notifications[0];this.close(oldestNotification.id);}}
generateId(){return'notification_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
success(title,message,options={}){return this.show({type:'success',title,message,...options});}
error(title,message,options={}){return this.show({type:'error',title,message,...options});}
warning(title,message,options={}){return this.show({type:'warning',title,message,...options});}
info(title,message,options={}){return this.show({type:'info',title,message,...options});}
processing(title,message,options={}){return this.show({type:'processing',title,message,duration:0,...options});}
updateProcessing(id,title,message,progress=null){const notification=this.notifications.find(n=>n.id===id);if(!notification||!notification.element)return;if(title){const titleElement=notification.element.querySelector('.notification-title');if(titleElement){titleElement.innerHTML=`
                    ${this.options.showIcons ? `<i class="fas ${this.getIcon('processing')} notification-icon"></i>` : ''}
                    ${title}
                `;}}
if(message){const messageElement=notification.element.querySelector('.notification-message');if(messageElement){messageElement.textContent=message;}}
if(progress!==null){notification.progress=progress;const progressBar=notification.element.querySelector('.notification-progress-bar');if(progressBar){progressBar.style.width=`${progress}%`;}}}
completeProcessing(id,type='success',title=null,message=null){const notification=this.notifications.find(n=>n.id===id);if(!notification)return;if(notification.element){notification.element.className=`notification ${type}`;const icon=this.getIcon(type);const titleElement=notification.element.querySelector('.notification-title');if(titleElement&&title){titleElement.innerHTML=`
                    ${this.options.showIcons ? `<i class="fas ${icon} notification-icon"></i>` : ''}
                    ${title}
                `;}
if(message){const messageElement=notification.element.querySelector('.notification-message');if(messageElement){messageElement.textContent=message;}}}
setTimeout(()=>{this.close(id);},2000);}
clear(){this.notifications.forEach(notification=>{this.close(notification.id);});}
getCount(){return this.notifications.length;}
destroy(){this.clear();if(this.container&&this.container.parentElement){this.container.parentElement.removeChild(this.container);}}}
const notificationSystem=new NotificationSystem();if(typeof module!=='undefined'&&module.exports){module.exports=NotificationSystem;}
class SVGObjectInteraction{constructor(){this.selectedObjects=new Set();this.isDragging=false;this.currentDragTarget=null;this.rotateHandle=null;this.undoStack=[];this.redoStack=[];this.maxUndoSteps=50;this.objectPool=new Map();this.dragThrottleTimer=null;this.dragThrottleDelay=16;this.selectionCache=new Map();this.autoSaveTimer=null;this.autoSaveDelay=2000;this.loadingStates=new Set();this.notifications=[];this.helpOverlay=null;this.isMarqueeSelecting=false;this.marqueeStart=null;this.marqueeElement=null;this.autoSaveIndicator=null;this.viewportManager=null;this.init();}
init(){this.svgContainer=document.getElementById('svg-container');this.svgElement=this.svgContainer?this.svgContainer.querySelector('svg'):null;if(!this.svgContainer||!this.svgElement)return;this.connectToViewportManager();this.setupEventListeners();this.setupInteractJS();this.createHelpOverlay();this.setupAutoSave();this.createAutoSaveIndicator();}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.viewportManager=window.viewportManager;window.arxLogger.info('SVGObjectInteraction connected to ViewportManager',{file:'object_interaction.js'});this.viewportManager.addEventListener('zoomChanged',()=>{this.updateRotateHandlePosition();});this.viewportManager.addEventListener('viewReset',()=>{this.updateRotateHandlePosition();});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
setupEventListeners(){this.svgElement.addEventListener('mousedown',(e)=>{const target=this.findClosestObject(e.target);if(!target){this.clearSelection();this.removeRotateHandle();return;}
if(e.shiftKey){this.toggleObjectSelection(target);}else{this.selectObject(target);}
this.showRotateHandle(target);});this.svgElement.addEventListener('mousedown',(e)=>{if(e.target===this.svgElement||e.target.classList.contains('svg-background')){this.startMarqueeSelection(e);}});document.addEventListener('mousemove',(e)=>{if(this.isMarqueeSelecting){this.updateMarqueeSelection(e);}});document.addEventListener('mouseup',(e)=>{if(this.isMarqueeSelecting){this.endMarqueeSelection(e);}});document.addEventListener('keydown',(e)=>{if(e.key==='Delete'||e.key==='Backspace'){this.deleteSelectedObjects();}else if(e.key.toLowerCase()==='r'){this.rotateSelectedObjects(15);}else if(e.key==='Escape'){this.cancelOperations();}else if(e.ctrlKey||e.metaKey){if(e.key.toLowerCase()==='z'){e.preventDefault();this.undo();}else if(e.key.toLowerCase()==='y'){e.preventDefault();this.redo();}else if(e.key==='?'){e.preventDefault();this.toggleHelpOverlay();}else if(e.key.toLowerCase()==='a'){e.preventDefault();this.selectAllObjects();}else if(e.key.toLowerCase()==='d'){e.preventDefault();this.clearSelection();}}else if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){e.preventDefault();this.moveSelectedObjectsWithArrowKeys(e.key);}});let scrollTimer,resizeTimer;window.addEventListener('scroll',()=>{clearTimeout(scrollTimer);scrollTimer=setTimeout(()=>this.updateSelectionCache(),100);});window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>this.updateSelectionCache(),100);});}
getMousePosition(e){const rect=this.svgContainer.getBoundingClientRect();return{x:e.clientX-rect.left,y:e.clientY-rect.top};}
getObjectsInRect(rect){const objects=[];const placedSymbols=this.svgElement.querySelectorAll('.placed-symbol');placedSymbols.forEach(symbol=>{const symbolRect=symbol.getBoundingClientRect();if(this.rectsIntersect(rect,symbolRect)){objects.push(symbol);}});return objects;}
getObjectsInMarqueeSelection(){if(!this.marqueeElement)return[];const marqueeRect=this.marqueeElement.getBoundingClientRect();const objects=[];const placedSymbols=this.svgElement.querySelectorAll('.placed-symbol');placedSymbols.forEach(symbol=>{const symbolRect=symbol.getBoundingClientRect();if(this.rectsIntersect(marqueeRect,symbolRect)){objects.push(symbol);}});return objects;}
startMarqueeSelection(e){this.isMarqueeSelecting=true;this.marqueeStart=this.getMousePosition(e);this.marqueeElement=document.createElement('div');this.marqueeElement.className='marquee-selection';this.marqueeElement.style.left=this.marqueeStart.x+'px';this.marqueeElement.style.top=this.marqueeStart.y+'px';this.marqueeElement.style.width='0px';this.marqueeElement.style.height='0px';this.svgContainer.appendChild(this.marqueeElement);}
updateMarqueeSelection(e){if(!this.isMarqueeSelecting||!this.marqueeElement)return;const currentPos=this.getMousePosition(e);const startX=Math.min(this.marqueeStart.x,currentPos.x);const startY=Math.min(this.marqueeStart.y,currentPos.y);const width=Math.abs(currentPos.x-this.marqueeStart.x);const height=Math.abs(currentPos.y-this.marqueeStart.y);this.marqueeElement.style.left=startX+'px';this.marqueeElement.style.top=startY+'px';this.marqueeElement.style.width=width+'px';this.marqueeElement.style.height=height+'px';}
endMarqueeSelection(e){if(!this.isMarqueeSelecting)return;this.isMarqueeSelecting=false;if(this.marqueeElement){const selectedObjects=this.getObjectsInMarqueeSelection();if(e.shiftKey){selectedObjects.forEach(obj=>this.toggleObjectSelection(obj));}else{this.clearSelection();selectedObjects.forEach(obj=>this.selectObject(obj));}
this.marqueeElement.remove();this.marqueeElement=null;}
this.marqueeStart=null;}
rectsIntersect(rect1,rect2){return!(rect2.left>rect1.right||rect2.right<rect1.left||rect2.top>rect1.bottom||rect2.bottom<rect1.top);}
selectAllObjects(){const allObjects=this.svgElement.querySelectorAll('.placed-symbol');allObjects.forEach(obj=>{this.selectedObjects.add(obj);obj.classList.add('selected');});this.updateContextPanel();this.showNotification(`${allObjects.length} objects selected`,'info');}
setupInteractJS(){if(typeof interact==='undefined')return;interact('.placed-symbol',{context:this.svgElement}).draggable({listeners:{start:(event)=>{this.setLoadingState(event.target,true);this.saveStateBeforeDrag();this.currentDragTarget=event.target;},move:(event)=>{if(this.dragThrottleTimer)return;this.dragThrottleTimer=requestAnimationFrame(()=>{this.handleDragMove(event);this.dragThrottleTimer=null;});},end:()=>{this.setLoadingState(this.currentDragTarget,false);this.saveStateAfterDrag();this.triggerAutoSave();this.currentDragTarget=null;}}});}
handleDragMove(event){const target=event.target;let currentX=parseFloat(target.getAttribute('data-x'))||0;let currentY=parseFloat(target.getAttribute('data-y'))||0;let deltaX=event.dx;let deltaY=event.dy;if(this.viewportManager&&this.viewportManager.currentZoom){deltaX=deltaX/this.viewportManager.currentZoom;deltaY=deltaY/this.viewportManager.currentZoom;}
let newX=currentX+deltaX;let newY=currentY+deltaY;const gridSize=5;newX=Math.round(newX/gridSize)*gridSize;newY=Math.round(newY/gridSize)*gridSize;target.setAttribute('data-x',newX);target.setAttribute('data-y',newY);const rotation=target.getAttribute('data-rotation')||0;target.setAttribute('transform',`translate(${newX},${newY}) rotate(${rotation})`);if(this.selectedObjects.has(target)){this.selectedObjects.forEach(obj=>{if(obj!==target){let objX=parseFloat(obj.getAttribute('data-x'))||0;let objY=parseFloat(obj.getAttribute('data-y'))||0;let objNewX=objX+deltaX;let objNewY=objY+deltaY;objNewX=Math.round(objNewX/gridSize)*gridSize;objNewY=Math.round(objNewY/gridSize)*gridSize;obj.setAttribute('data-x',objNewX);obj.setAttribute('data-y',objNewY);const objRotation=obj.getAttribute('data-rotation')||0;obj.setAttribute('transform',`translate(${objNewX},${objNewY}) rotate(${objRotation})`);}});}
this.updateRotateHandlePosition();if(this.viewportManager){this.viewportManager.triggerEvent('objectMoved',{objectId:target.getAttribute('data-id'),x:newX,y:newY,element:target});}}
findClosestObject(target){if(target.classList.contains('placed-symbol')){return target;}
const cacheKey=`${target.offsetLeft},${target.offsetTop}`;if(this.selectionCache.has(cacheKey)){return this.selectionCache.get(cacheKey);}
const closest=target.closest('.placed-symbol');this.selectionCache.set(cacheKey,closest);if(this.selectionCache.size>1000){const firstKey=this.selectionCache.keys().next().value;this.selectionCache.delete(firstKey);}
return closest;}
updateSelectionCache(){this.selectionCache.clear();}
getObjectFromPool(type){if(this.objectPool.has(type)){const pool=this.objectPool.get(type);return pool.length>0?pool.pop():null;}
return null;}
returnObjectToPool(object,type){if(!this.objectPool.has(type)){this.objectPool.set(type,[]);}
this.objectPool.get(type).push(object);}
selectObject(obj){this.clearSelection();this.selectedObjects.add(obj);obj.classList.add('selected');this.showRotateHandle(obj);this.updateContextPanel();this.showNotification('Object selected','info');}
toggleObjectSelection(obj){if(this.selectedObjects.has(obj)){this.selectedObjects.delete(obj);obj.classList.remove('selected');}else{this.selectedObjects.add(obj);obj.classList.add('selected');}
this.showRotateHandle(obj);this.updateContextPanel();this.showNotification(`${this.selectedObjects.size} objects selected`,'info');}
clearSelection(){this.selectedObjects.forEach(obj=>obj.classList.remove('selected'));this.selectedObjects.clear();this.removeRotateHandle();this.updateContextPanel();}
rotateSelectedObjects(angle){this.saveStateBeforeOperation('rotate');this.setLoadingState(Array.from(this.selectedObjects),true);this.selectedObjects.forEach(obj=>{let rotation=parseFloat(obj.getAttribute('data-rotation')||0)+angle;obj.setAttribute('data-rotation',rotation);let x=obj.getAttribute('data-x')||0;let y=obj.getAttribute('data-y')||0;obj.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);});this.setLoadingState(Array.from(this.selectedObjects),false);this.saveStateAfterOperation();this.triggerAutoSave();this.showNotification('Objects rotated','success');}
moveSelectedObjectsWithArrowKeys(key){let step=1;if(this.viewportManager&&this.viewportManager.currentZoom){step=Math.max(0.5,1/this.viewportManager.currentZoom);}
let deltaX=0,deltaY=0;switch(key){case'ArrowUp':deltaY=-step;break;case'ArrowDown':deltaY=step;break;case'ArrowLeft':deltaX=-step;break;case'ArrowRight':deltaX=step;break;}
if(deltaX!==0||deltaY!==0){this.saveStateBeforeOperation('move');this.selectedObjects.forEach(obj=>{const currentX=parseFloat(obj.getAttribute('data-x')||0);const currentY=parseFloat(obj.getAttribute('data-y')||0);const newX=currentX+deltaX;const newY=currentY+deltaY;obj.setAttribute('data-x',newX);obj.setAttribute('data-y',newY);const rotation=obj.getAttribute('data-rotation')||0;obj.setAttribute('transform',`translate(${newX},${newY}) rotate(${rotation})`);if(this.viewportManager){this.viewportManager.triggerEvent('objectMoved',{objectId:obj.getAttribute('data-id'),x:newX,y:newY,element:obj});}});this.updateRotateHandlePosition();this.saveStateAfterOperation();this.triggerAutoSave();}}
showRotateHandle(obj){this.removeRotateHandle();if(!obj)return;const bbox=obj.getBBox();const handle=document.createElementNS('http://www.w3.org/2000/svg','circle');const handleX=bbox.x+bbox.width+10;const handleY=bbox.y+bbox.height/2;handle.setAttribute('cx',handleX);handle.setAttribute('cy',handleY);handle.setAttribute('r',8);handle.setAttribute('fill','#3b82f6');handle.setAttribute('stroke','#1e40af');handle.setAttribute('stroke-width',2);handle.setAttribute('class','rotate-handle');handle.style.cursor='pointer';handle.setAttribute('data-target-object',obj.getAttribute('data-id'));let startAngle=0,startRotation=0;handle.addEventListener('mousedown',(e)=>{e.stopPropagation();this.saveStateBeforeOperation('rotate');this.setLoadingState(obj,true);const svg=this.svgElement;const objCenter={x:bbox.x+bbox.width/2,y:bbox.y+bbox.height/2};const mouseMove=(ev)=>{let svgP;if(this.viewportManager&&this.viewportManager.screenToSVG){svgP=this.viewportManager.screenToSVG(ev.clientX,ev.clientY);}else{const pt=svg.createSVGPoint();pt.x=ev.clientX;pt.y=ev.clientY;svgP=pt.matrixTransform(svg.getScreenCTM().inverse());}
const dx=svgP.x-objCenter.x;const dy=svgP.y-objCenter.y;const angle=Math.atan2(dy,dx)*180/Math.PI;const rotation=angle;obj.setAttribute('data-rotation',rotation);let x=obj.getAttribute('data-x')||0;let y=obj.getAttribute('data-y')||0;obj.setAttribute('transform',`translate(${x},${y}) rotate(${rotation})`);this.updateRotateHandlePosition();};const mouseUp=()=>{document.removeEventListener('mousemove',mouseMove);document.removeEventListener('mouseup',mouseUp);this.setLoadingState(obj,false);this.saveStateAfterOperation();this.triggerAutoSave();this.showNotification('Object rotated','success');};document.addEventListener('mousemove',mouseMove);document.addEventListener('mouseup',mouseUp);});obj.parentNode.appendChild(handle);this.rotateHandle=handle;}
updateRotateHandlePosition(){if(!this.rotateHandle)return;const targetId=this.rotateHandle.getAttribute('data-target-object');const target=document.querySelector(`[data-id="${targetId}"]`);if(!target){this.removeRotateHandle();return;}
const bbox=target.getBBox();const handleX=bbox.x+bbox.width+10;const handleY=bbox.y+bbox.height/2;this.rotateHandle.setAttribute('cx',handleX);this.rotateHandle.setAttribute('cy',handleY);}
removeRotateHandle(){if(this.rotateHandle&&this.rotateHandle.parentNode){this.rotateHandle.parentNode.removeChild(this.rotateHandle);}
this.rotateHandle=null;}
deleteSelectedObjects(){if(this.selectedObjects.size===0)return;if(!confirm(`Delete ${this.selectedObjects.size} selected object(s)?`))return;this.saveStateBeforeOperation('delete');this.setLoadingState(Array.from(this.selectedObjects),true);const deletedObjects=Array.from(this.selectedObjects).map(obj=>({element:obj,data:this.extractObjectData(obj)}));this.selectedObjects.forEach(obj=>{obj.remove();this.deleteObjectBackend(obj.getAttribute('data-id'));});this.selectedObjects.clear();this.removeRotateHandle();this.updateContextPanel();this.setLoadingState(Array.from(this.selectedObjects),false);this.currentOperation.deletedObjects=deletedObjects;this.saveStateAfterOperation();this.showNotification(`${deletedObjects.length} objects deleted`,'success');}
cancelOperations(){this.clearSelection();this.removeRotateHandle();this.isDragging=false;this.currentDragTarget=null;this.showNotification('Operation cancelled','info');}
setupAutoSave(){this.autoSaveTimer=null;}
createAutoSaveIndicator(){this.autoSaveIndicator=document.createElement('div');this.autoSaveIndicator.className='auto-save-indicator';this.autoSaveIndicator.textContent='Auto-saving...';document.body.appendChild(this.autoSaveIndicator);}
triggerAutoSave(){clearTimeout(this.autoSaveTimer);this.autoSaveTimer=setTimeout(()=>{this.saveObjectPositions();},this.autoSaveDelay);}
setLoadingState(objects,isLoading){const objectArray=Array.isArray(objects)?objects:[objects];objectArray.forEach(obj=>{if(isLoading){this.loadingStates.add(obj);obj.classList.add('loading');}else{this.loadingStates.delete(obj);obj.classList.remove('loading');}});}
showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`notification ${type}`;notification.textContent=message;const icon=document.createElement('span');icon.className='mr-2';icon.innerHTML=type==='success'?'':type==='error'?'':type==='warning'?'':'';notification.insertBefore(icon,notification.firstChild);document.body.appendChild(notification);setTimeout(()=>notification.classList.add('show'),10);setTimeout(()=>{notification.classList.remove('show');setTimeout(()=>notification.remove(),300);},3000);this.notifications.push(notification);}
createHelpOverlay(){this.helpOverlay=document.createElement('div');this.helpOverlay.className='help-overlay hidden';this.helpOverlay.innerHTML=`
            <div class="help-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Keyboard Shortcuts</h2>
                    <button id="close-help" class="text-gray-400 hover:text-gray-600"></button>
                </div>
                <div class="help-grid">
                    <div class="help-section">
                        <h3>Selection</h3>
                        <div class="space-y-1">
                            <div><kbd>Click</kbd> Select object</div>
                            <div><kbd>Shift + Click</kbd> Multi-select</div>
                            <div><kbd>Ctrl + A</kbd> Select all</div>
                            <div><kbd>Ctrl + D</kbd> Deselect all</div>
                            <div><kbd>Escape</kbd> Cancel operation</div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h3>Manipulation</h3>
                        <div class="space-y-1">
                            <div><kbd>Drag</kbd> Move object</div>
                            <div><kbd>R</kbd> Rotate 15</div>
                            <div><kbd>Arrow Keys</kbd> Fine movement</div>
                            <div><kbd>Delete</kbd> Delete object</div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h3>History</h3>
                        <div class="space-y-1">
                            <div><kbd>Ctrl + Z</kbd> Undo</div>
                            <div><kbd>Ctrl + Y</kbd> Redo</div>
                        </div>
                    </div>
                    <div class="help-section">
                        <h3>Help</h3>
                        <div class="space-y-1">
                            <div><kbd>Ctrl + ?</kbd> Show this help</div>
                        </div>
                    </div>
                </div>
            </div>
        `;document.body.appendChild(this.helpOverlay);this.helpOverlay.querySelector('#close-help').addEventListener('click',()=>{this.hideHelpOverlay();});this.helpOverlay.addEventListener('click',(e)=>{if(e.target===this.helpOverlay){this.hideHelpOverlay();}});}
toggleHelpOverlay(){if(this.helpOverlay.classList.contains('hidden')){this.showHelpOverlay();}else{this.hideHelpOverlay();}}
showHelpOverlay(){this.helpOverlay.classList.remove('hidden');}
hideHelpOverlay(){this.helpOverlay.classList.add('hidden');}
saveStateBeforeOperation(operationType){this.currentOperation={type:operationType,timestamp:Date.now(),objects:Array.from(this.selectedObjects).map(obj=>({element:obj,data:this.extractObjectData(obj)}))};}
saveStateBeforeDrag(){this.saveStateBeforeOperation('drag');}
saveStateAfterOperation(){if(this.currentOperation){this.undoStack.push(this.currentOperation);this.redoStack=[];if(this.undoStack.length>this.maxUndoSteps){this.undoStack.shift();}
this.currentOperation=null;}}
saveStateAfterDrag(){this.saveStateAfterOperation();}
undo(){if(this.undoStack.length===0)return;const operation=this.undoStack.pop();this.redoStack.push(operation);switch(operation.type){case'move':case'drag':case'rotate':this.restoreObjectStates(operation.objects);break;case'delete':this.restoreDeletedObjects(operation.deletedObjects);break;}
this.updateContextPanel();this.showNotification('Undo completed','success');}
redo(){if(this.redoStack.length===0)return;const operation=this.redoStack.pop();this.undoStack.push(operation);switch(operation.type){case'move':case'drag':case'rotate':this.restoreObjectStates(operation.objects,true);break;case'delete':this.deleteSelectedObjects();break;}
this.updateContextPanel();this.showNotification('Redo completed','success');}
restoreObjectStates(objects,isRedo=false){objects.forEach(({element,data})=>{if(element&&element.parentNode){element.setAttribute('data-x',data.x);element.setAttribute('data-y',data.y);element.setAttribute('data-rotation',data.rotation);element.setAttribute('transform',`translate(${data.x},${data.y}) rotate(${data.rotation})`);}});}
restoreDeletedObjects(deletedObjects){deletedObjects.forEach(({element,data})=>{if(element){this.svgElement.appendChild(element);this.selectedObjects.add(element);element.classList.add('selected');}});}
extractObjectData(obj){return{id:obj.getAttribute('data-id'),x:parseFloat(obj.getAttribute('data-x')||0),y:parseFloat(obj.getAttribute('data-y')||0),rotation:parseFloat(obj.getAttribute('data-rotation')||0),name:obj.getAttribute('data-name'),type:obj.getAttribute('data-type'),system:obj.getAttribute('data-system'),status:obj.getAttribute('data-status')};}
async saveObjectPositions(){const objects=Array.from(this.selectedObjects).map(obj=>{const baseData={id:obj.getAttribute('data-id'),x:parseFloat(obj.getAttribute('data-x')||0),y:parseFloat(obj.getAttribute('data-y')||0),rotation:parseFloat(obj.getAttribute('data-rotation')||0)};if(window.scaleManager&&window.scaleManager.scaleFactors.x!==1.0){baseData.scale_factors={x:window.scaleManager.scaleFactors.x,y:window.scaleManager.scaleFactors.y};baseData.coordinates={coordinate_system:"real_world",units:window.scaleManager.currentUnit,svg_coordinates:{x:baseData.x,y:baseData.y},real_world_coords:{x:baseData.x*window.scaleManager.scaleFactors.x,y:baseData.y*window.scaleManager.scaleFactors.y}};}
const realWorldX=obj.getAttribute('data-real-world-x');const realWorldY=obj.getAttribute('data-real-world-y');const unit=obj.getAttribute('data-unit');if(realWorldX&&realWorldY&&unit){if(!baseData.coordinates){baseData.coordinates={};}
baseData.coordinates.real_world_coords={x:parseFloat(realWorldX),y:parseFloat(realWorldY)};baseData.coordinates.units=unit;baseData.coordinates.coordinate_system="real_world";}
return baseData;});if(objects.length===0)return;try{this.autoSaveIndicator.classList.add('show');const response=await fetch('/api/bim/objects/bulk-update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bim_object_ids:objects.map(obj=>parseInt(obj.id)),updates:{x:objects[0].x,y:objects[0].y,rotation:objects[0].rotation},scale_factors:objects[0].scale_factors,coordinates:objects[0].coordinates})});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}
const result=await response.json();this.showNotification('Changes saved successfully with scale metadata','success');objects.forEach(objData=>{const element=document.querySelector(`[data-id="${objData.id}"]`);if(element){if(objData.coordinates&&objData.coordinates.real_world_coords){element.setAttribute('data-real-world-x',objData.coordinates.real_world_coords.x.toString());element.setAttribute('data-real-world-y',objData.coordinates.real_world_coords.y.toString());element.setAttribute('data-unit',objData.coordinates.units);}}});}catch(error){console.error('Error saving object positions:',error);this.showNotification('Failed to save changes. Use Ctrl+Z to undo.','error');}finally{setTimeout(()=>{this.autoSaveIndicator.classList.remove('show');},1000);}}
async deleteObjectBackend(id){try{const response=await fetch(`/api/bim/objects/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}
window.arxLogger.info('Object deleted successfully:',id,{file:'object_interaction.js'});}catch(error){console.error('Error deleting object:',error);this.showNotification('Failed to delete object from backend.','error');}}
updateContextPanel(){if(window.contextPanel){window.contextPanel.updateSelection(this.selectedObjects);}}
screenToSVGCoordinates(screenX,screenY){if(this.viewportManager&&this.viewportManager.screenToSVG){return this.viewportManager.screenToSVG(screenX,screenY);}
return{x:screenX,y:screenY};}
svgToScreenCoordinates(svgX,svgY){if(this.viewportManager&&this.viewportManager.svgToScreen){return this.viewportManager.svgToScreen(svgX,svgY);}
return{x:svgX,y:svgY};}
testMultiObjectSelection(){if(!this.viewportManager){console.warn('Viewport manager not available for testing');return;}
window.arxLogger.debug('=== Testing Multi-Object Selection with Zoom ===',{file:'object_interaction.js'});const placedSymbols=document.querySelectorAll('.placed-symbol');if(placedSymbols.length<2){console.warn('Need at least 2 objects for multi-selection testing');return;}
const zoomLevels=[0.5,1.0,2.0,3.0];zoomLevels.forEach((zoom,zoomIndex)=>{window.arxLogger.debug(`\n--- Testing at Zoom Level ${zoom} ---`,{file:'object_interaction.js'});this.viewportManager.setZoom(zoom);this.clearSelection();const objectsToSelect=Array.from(placedSymbols).slice(0,3);objectsToSelect.forEach((obj,index)=>{this.selectObject(obj);window.arxLogger.debug(`Selected object ${index + 1}: ${obj.getAttribute('data-id')}`,{file:'object_interaction.js'});});window.arxLogger.debug(`Total selected objects: ${this.selectedObjects.size}`,{file:'object_interaction.js'});this.selectedObjects.forEach((obj,index)=>{const x=parseFloat(obj.getAttribute('data-x'))||0;const y=parseFloat(obj.getAttribute('data-y'))||0;window.arxLogger.debug(`Object ${index + 1} position: (${x.toFixed(2)}, ${y.toFixed(2)})`,{file:'object_interaction.js'});});if(this.selectedObjects.size>0){const firstObject=Array.from(this.selectedObjects)[0];this.showRotateHandle(firstObject);window.arxLogger.debug('Rotate handle displayed',{file:'object_interaction.js'});}
setTimeout(()=>{if(zoomIndex<zoomLevels.length-1){window.arxLogger.debug('Moving to next zoom level...',{file:'object_interaction.js'});}else{window.arxLogger.debug('Multi-object selection testing complete!',{file:'object_interaction.js'});this.clearSelection();}},1000);});setTimeout(()=>{this.viewportManager.setZoom(1.0);window.arxLogger.debug('Reset to original zoom level',{file:'object_interaction.js'});},zoomLevels.length*1000+2000);}
getSelectionBounds(){if(this.selectedObjects.size===0)return null;let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;this.selectedObjects.forEach(obj=>{const x=parseFloat(obj.getAttribute('data-x'))||0;const y=parseFloat(obj.getAttribute('data-y'))||0;minX=Math.min(minX,x);minY=Math.min(minY,y);maxX=Math.max(maxX,x);maxY=Math.max(maxY,y);});return{minX,minY,maxX,maxY,width:maxX-minX,height:maxY-minY,centerX:(minX+maxX)/2,centerY:(minY+maxY)/2};}
centerSelection(){const bounds=this.getSelectionBounds();if(!bounds||!this.viewportManager)return;const containerRect=this.svgContainer.getBoundingClientRect();const centerX=containerRect.width/2;const centerY=containerRect.height/2;const svgCenter=this.screenToSVGCoordinates(centerX,centerY);const offsetX=svgCenter.x-bounds.centerX;const offsetY=svgCenter.y-bounds.centerY;this.selectedObjects.forEach(obj=>{const currentX=parseFloat(obj.getAttribute('data-x'))||0;const currentY=parseFloat(obj.getAttribute('data-y'))||0;const newX=currentX+offsetX;const newY=currentY+offsetY;obj.setAttribute('data-x',newX);obj.setAttribute('data-y',newY);const rotation=obj.getAttribute('data-rotation')||0;obj.setAttribute('transform',`translate(${newX},${newY}) rotate(${rotation})`);});this.updateRotateHandlePosition();window.arxLogger.info('Selection centered',{file:'object_interaction.js'});}
async loadObjectsWithScaleMetadata(floorId){try{const response=await fetch(`/api/bim/floor/${floorId}`,{method:'GET',headers:{'Content-Type':'application/json'}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}
const bimModel=await response.json();const allObjects=[...bimModel.rooms||[],...bimModel.devices||[],...bimModel.labels||[],...bimModel.panels||[],...bimModel.connectors||[],...bimModel.walls||[],...bimModel.zones||[]];allObjects.forEach(obj=>{this.restoreObjectScaleMetadata(obj);});window.arxLogger.info(`Loaded ${allObjects.length} objects with scale metadata`,{file:'object_interaction.js'});this.showNotification(`Loaded ${allObjects.length} objects with scale metadata`,'success');}catch(error){console.error('Error loading objects with scale metadata:',error);this.showNotification('Failed to load objects with scale metadata','error');}}
restoreObjectScaleMetadata(bimObject){const element=document.querySelector(`[data-id="${bimObject.object_id}"]`);if(!element){console.warn(`Element not found for BIM object: ${bimObject.object_id}`);return;}
if(bimObject.scale_factors){try{const scaleFactors=typeof bimObject.scale_factors==='string'?JSON.parse(bimObject.scale_factors):bimObject.scale_factors;element.setAttribute('data-scale-x',scaleFactors.x.toString());element.setAttribute('data-scale-y',scaleFactors.y.toString());}catch(error){console.warn(`Failed to parse scale factors for object ${bimObject.object_id}:`,error);}}
if(bimObject.coordinate_system){element.setAttribute('data-coordinate-system',bimObject.coordinate_system);}
if(bimObject.units){element.setAttribute('data-unit',bimObject.units);}
if(bimObject.svg_coordinates){try{const svgCoords=typeof bimObject.svg_coordinates==='string'?JSON.parse(bimObject.svg_coordinates):bimObject.svg_coordinates;element.setAttribute('data-svg-x',svgCoords.x.toString());element.setAttribute('data-svg-y',svgCoords.y.toString());}catch(error){console.warn(`Failed to parse SVG coordinates for object ${bimObject.object_id}:`,error);}}
if(bimObject.real_world_coords){try{const realWorldCoords=typeof bimObject.real_world_coords==='string'?JSON.parse(bimObject.real_world_coords):bimObject.real_world_coords;element.setAttribute('data-real-world-x',realWorldCoords.x.toString());element.setAttribute('data-real-world-y',realWorldCoords.y.toString());}catch(error){console.warn(`Failed to parse real-world coordinates for object ${bimObject.object_id}:`,error);}}
if(window.scaleManager&&bimObject.scale_factors&&!window.scaleManager.scaleFactors.x){try{const scaleFactors=typeof bimObject.scale_factors==='string'?JSON.parse(bimObject.scale_factors):bimObject.scale_factors;window.scaleManager.setScaleFactors(scaleFactors.x,scaleFactors.y,bimObject.units||'pixels');window.arxLogger.info(`Restored scale factors from object ${bimObject.object_id}:`,scaleFactors,{file:'object_interaction.js'});}catch(error){console.warn(`Failed to restore scale factors from object ${bimObject.object_id}:`,error);}}}
testCoordinatePersistence(){window.arxLogger.debug('=== Testing Coordinate Persistence ===',{file:'object_interaction.js'});window.arxLogger.debug('1. Testing save with scale metadata...',{file:'object_interaction.js'});this.saveObjectPositions();setTimeout(()=>{window.arxLogger.debug('2. Simulating session reload...',{file:'object_interaction.js'});this.simulateSessionReload();},2000);}
simulateSessionReload(){const currentObjects=Array.from(this.selectedObjects).map(obj=>({id:obj.getAttribute('data-id'),x:obj.getAttribute('data-x'),y:obj.getAttribute('data-y'),rotation:obj.getAttribute('data-rotation'),realWorldX:obj.getAttribute('data-real-world-x'),realWorldY:obj.getAttribute('data-real-world-y'),unit:obj.getAttribute('data-unit'),scaleX:obj.getAttribute('data-scale-x'),scaleY:obj.getAttribute('data-scale-y')}));window.arxLogger.debug('Stored objects for session reload:',currentObjects,{file:'object_interaction.js'});this.clearSelection();setTimeout(()=>{window.arxLogger.debug('3. Restoring objects from session...',{file:'object_interaction.js'});currentObjects.forEach(objData=>{const element=document.querySelector(`[data-id="${objData.id}"]`);if(element){if(objData.x)element.setAttribute('data-x',objData.x);if(objData.y)element.setAttribute('data-y',objData.y);if(objData.rotation)element.setAttribute('data-rotation',objData.rotation);if(objData.realWorldX)element.setAttribute('data-real-world-x',objData.realWorldX);if(objData.realWorldY)element.setAttribute('data-real-world-y',objData.realWorldY);if(objData.unit)element.setAttribute('data-unit',objData.unit);if(objData.scaleX)element.setAttribute('data-scale-x',objData.scaleX);if(objData.scaleY)element.setAttribute('data-scale-y',objData.scaleY);this.selectObject(element);}});window.arxLogger.debug('Session reload simulation complete!',{file:'object_interaction.js'});this.showNotification('Coordinate persistence test completed','success');},1000);}}
document.addEventListener('DOMContentLoaded',()=>{window.svgObjectInteraction=new SVGObjectInteraction();});class PerformanceMonitor{constructor(options={}){this.enabled=options.enabled!==false;this.updateInterval=options.updateInterval||1000;this.maxHistorySize=options.maxHistorySize||100;this.metrics={culling:{totalObjects:0,visibleObjects:0,culledObjects:0,cullingTime:0,cullingEfficiency:0,lastUpdate:0},rendering:{frameTime:0,fps:0,renderTime:0,lastFrameTime:0},memory:{boundsCacheSize:0,visibleObjectsSize:0,totalMemoryUsage:0},interaction:{zoomOperations:0,panOperations:0,objectSelections:0,lastInteraction:0}};this.history=[];this.lastUpdate=0;this.updateTimer=null;this.thresholds={cullingTime:options.cullingTimeThreshold||16,frameTime:options.frameTimeThreshold||16,memoryUsage:options.memoryThreshold||50*1024*1024,objectCount:options.objectCountThreshold||1000};this.eventHandlers=new Map();this.initialize();}
initialize(){if(!this.enabled){return;}
this.startMonitoring();if(window.arxLogger){window.arxLogger.info('PerformanceMonitor initialized',{component:'performance_monitor',update_interval:this.updateInterval,max_history_size:this.maxHistorySize});}}
startMonitoring(){if(this.updateTimer){clearInterval(this.updateTimer);}
this.updateTimer=setInterval(()=>{this.updateMetrics();},this.updateInterval);}
stopMonitoring(){if(this.updateTimer){clearInterval(this.updateTimer);this.updateTimer=null;}}
updateMetrics(){const now=Date.now();if(this.metrics.rendering.lastFrameTime>0){const frameTime=now-this.metrics.rendering.lastFrameTime;this.metrics.rendering.frameTime=frameTime;this.metrics.rendering.fps=Math.round(1000/frameTime);}
this.metrics.rendering.lastFrameTime=now;if(this.metrics.culling.totalObjects>0){this.metrics.culling.cullingEfficiency=(this.metrics.culling.culledObjects/this.metrics.culling.totalObjects)*100;}
this.addToHistory();this.checkPerformanceIssues();this.triggerEvent('metricsUpdated',this.metrics);}
updateCullingMetrics(stats){this.metrics.culling={...this.metrics.culling,...stats,lastUpdate:Date.now()};}
updateRenderingMetrics(renderTime){this.metrics.rendering.renderTime=renderTime;}
updateMemoryMetrics(boundsCacheSize,visibleObjectsSize){this.metrics.memory.boundsCacheSize=boundsCacheSize;this.metrics.memory.visibleObjectsSize=visibleObjectsSize;this.metrics.memory.totalMemoryUsage=boundsCacheSize+visibleObjectsSize+(this.history.length*1024);}
trackInteraction(type){this.metrics.interaction.lastInteraction=Date.now();switch(type){case'zoom':this.metrics.interaction.zoomOperations++;break;case'pan':this.metrics.interaction.panOperations++;break;case'selection':this.metrics.interaction.objectSelections++;break;}}
addToHistory(){const snapshot={timestamp:Date.now(),metrics:JSON.parse(JSON.stringify(this.metrics))};this.history.push(snapshot);if(this.history.length>this.maxHistorySize){this.history.shift();}}
checkPerformanceIssues(){const issues=[];if(this.metrics.culling.cullingTime>this.thresholds.cullingTime){issues.push({type:'culling',severity:'warning',message:`Culling time (${this.metrics.culling.cullingTime.toFixed(2)}ms) exceeds threshold (${this.thresholds.cullingTime}ms)`});}
if(this.metrics.rendering.frameTime>this.thresholds.frameTime){issues.push({type:'rendering',severity:'warning',message:`Frame time (${this.metrics.rendering.frameTime.toFixed(2)}ms) exceeds threshold (${this.thresholds.frameTime}ms)`});}
if(this.metrics.memory.totalMemoryUsage>this.thresholds.memoryUsage){issues.push({type:'memory',severity:'warning',message:`Memory usage (${(this.metrics.memory.totalMemoryUsage / 1024 / 1024).toFixed(2)}MB) exceeds threshold (${(this.thresholds.memoryUsage / 1024 / 1024).toFixed(2)}MB)`});}
if(this.metrics.culling.totalObjects>this.thresholds.objectCount){issues.push({type:'objects',severity:'info',message:`Large number of objects (${this.metrics.culling.totalObjects}) - consider enabling culling`});}
if(issues.length>0){this.triggerEvent('performanceIssues',issues);}}
getMetrics(){return JSON.parse(JSON.stringify(this.metrics));}
getHistory(){return JSON.parse(JSON.stringify(this.history));}
getTrends(){if(this.history.length<2){return null;}
const recent=this.history.slice(-10);const older=this.history.slice(-20,-10);if(older.length===0){return null;}
const trends={};const recentAvgCullingTime=recent.reduce((sum,h)=>sum+h.metrics.culling.cullingTime,0)/recent.length;const olderAvgCullingTime=older.reduce((sum,h)=>sum+h.metrics.culling.cullingTime,0)/older.length;trends.cullingTime={change:recentAvgCullingTime-olderAvgCullingTime,percentage:((recentAvgCullingTime-olderAvgCullingTime)/olderAvgCullingTime)*100};const recentAvgFPS=recent.reduce((sum,h)=>sum+h.metrics.rendering.fps,0)/recent.length;const olderAvgFPS=older.reduce((sum,h)=>sum+h.metrics.rendering.fps,0)/older.length;trends.fps={change:recentAvgFPS-olderAvgFPS,percentage:((recentAvgFPS-olderAvgFPS)/olderAvgFPS)*100};return trends;}
generateReport(){const trends=this.getTrends();const report={timestamp:Date.now(),currentMetrics:this.getMetrics(),trends:trends,recommendations:this.generateRecommendations()};return report;}
generateRecommendations(){const recommendations=[];if(this.metrics.culling.cullingEfficiency<50){recommendations.push({type:'culling',priority:'high',message:'Low culling efficiency - consider adjusting culling margin or object placement'});}
if(this.metrics.culling.cullingTime>this.thresholds.cullingTime){recommendations.push({type:'culling',priority:'medium',message:'High culling time - consider increasing culling throttle or optimizing bounds calculation'});}
if(this.metrics.rendering.fps<30){recommendations.push({type:'rendering',priority:'high',message:'Low FPS - consider reducing object complexity or enabling more aggressive culling'});}
if(this.metrics.memory.totalMemoryUsage>this.thresholds.memoryUsage){recommendations.push({type:'memory',priority:'medium',message:'High memory usage - consider clearing bounds cache or reducing history size'});}
return recommendations;}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in performance monitor event handler for ${event}:`,error);}});}}
enable(){this.enabled=true;this.startMonitoring();if(window.arxLogger){window.arxLogger.info('PerformanceMonitor: Enabled',{component:'performance_monitor',status:'enabled'});}}
disable(){this.enabled=false;this.stopMonitoring();if(window.arxLogger){window.arxLogger.info('PerformanceMonitor: Disabled',{component:'performance_monitor',status:'disabled'});}}
reset(){this.metrics={culling:{totalObjects:0,visibleObjects:0,culledObjects:0,cullingTime:0,cullingEfficiency:0,lastUpdate:0},rendering:{frameTime:0,fps:0,renderTime:0,lastFrameTime:0},memory:{boundsCacheSize:0,visibleObjectsSize:0,totalMemoryUsage:0},interaction:{zoomOperations:0,panOperations:0,objectSelections:0,lastInteraction:0}};this.history=[];if(window.arxLogger){window.arxLogger.info('PerformanceMonitor: Metrics reset',{component:'performance_monitor',action:'reset'});}}
destroy(){this.stopMonitoring();this.eventHandlers.clear();this.history=[];if(window.arxLogger){window.arxLogger.info('PerformanceMonitor: Destroyed',{component:'performance_monitor',status:'destroyed'});}}}
if(typeof module!=='undefined'&&module.exports){module.exports=PerformanceMonitor;}else if(typeof window!=='undefined'){window.PerformanceMonitor=PerformanceMonitor;}
class PerformanceTester{constructor(svgElement,options={}){this.svg=svgElement;this.container=svgElement.parentElement;this.testConfig={objectTypes:options.objectTypes||['sensor','valve','pump','fan','controller'],gridSpacing:options.gridSpacing||50,objectSize:options.objectSize||{width:30,height:30},colorVariation:options.colorVariation!==false,randomRotation:options.randomRotation!==false,randomScale:options.randomScale!==false};this.isGenerating=false;this.generatedObjects=[];this.currentTest=null;this.generationTimes=[];this.renderTimes=[];this.eventHandlers=new Map();window.arxLogger.info('PerformanceTester initialized',{file:'performance_tester.js'});}
generateObjectGrid(count,options={}){if(this.isGenerating){console.warn('PerformanceTester: Already generating objects');return;}
this.isGenerating=true;const startTime=performance.now();const cols=Math.ceil(Math.sqrt(count));const rows=Math.ceil(count/cols);const gridWidth=cols*this.testConfig.gridSpacing;const gridHeight=rows*this.testConfig.gridSpacing;const containerRect=this.container.getBoundingClientRect();const startX=(containerRect.width-gridWidth)/2;const startY=(containerRect.height-gridHeight)/2;window.arxLogger.debug(`PerformanceTester: Generating ${count} objects in ${cols}x${rows} grid`,{file:'performance_tester.js'});const objects=[];let objectIndex=0;for(let row=0;row<rows&&objectIndex<count;row++){for(let col=0;col<cols&&objectIndex<count;col++){const x=startX+(col*this.testConfig.gridSpacing);const y=startY+(row*this.testConfig.gridSpacing);const object=this.createTestObject(x,y,objectIndex,options);objects.push(object);objectIndex++;}}
this.addObjectsToSVG(objects);const generationTime=performance.now()-startTime;this.generationTimes.push(generationTime);this.generatedObjects=objects;this.isGenerating=false;this.triggerEvent('objectsGenerated',{count:objects.length,generationTime:generationTime,objects:objects});window.arxLogger.performance('generate_grid',generationTime,{count,cols,rows,file:'performance_tester.js'});return objects;}
generateRandomObjects(count,options={}){if(this.isGenerating){console.warn('PerformanceTester: Already generating objects');return;}
this.isGenerating=true;const startTime=performance.now();const containerRect=this.container.getBoundingClientRect();const margin=100;const maxX=containerRect.width-margin;const maxY=containerRect.height-margin;window.arxLogger.debug(`PerformanceTester: Generating ${count} random objects`,{file:'performance_tester.js'});const objects=[];for(let i=0;i<count;i++){const x=margin+Math.random()*(maxX-margin);const y=margin+Math.random()*(maxY-margin);const object=this.createTestObject(x,y,i,options);objects.push(object);}
this.addObjectsToSVG(objects);const generationTime=performance.now()-startTime;this.generationTimes.push(generationTime);this.generatedObjects=objects;this.isGenerating=false;this.triggerEvent('objectsGenerated',{count:objects.length,generationTime:generationTime,objects:objects});window.arxLogger.performance('generate_random',generationTime,{count,file:'performance_tester.js'});return objects;}
generateSpiralObjects(count,options={}){if(this.isGenerating){console.warn('PerformanceTester: Already generating objects');return;}
this.isGenerating=true;const startTime=performance.now();const containerRect=this.container.getBoundingClientRect();const centerX=containerRect.width/2;const centerY=containerRect.height/2;window.arxLogger.debug(`PerformanceTester: Generating ${count} spiral objects`,{file:'performance_tester.js'});const objects=[];const spacing=this.testConfig.gridSpacing;for(let i=0;i<count;i++){const angle=i*0.5;const radius=i*spacing*0.1;const x=centerX+Math.cos(angle)*radius;const y=centerY+Math.sin(angle)*radius;const object=this.createTestObject(x,y,i,options);objects.push(object);}
this.addObjectsToSVG(objects);const generationTime=performance.now()-startTime;this.generationTimes.push(generationTime);this.generatedObjects=objects;this.isGenerating=false;this.triggerEvent('objectsGenerated',{count:objects.length,generationTime:generationTime,objects:objects});window.arxLogger.performance('generate_spiral',generationTime,{count,file:'performance_tester.js'});return objects;}
createTestObject(x,y,index,options={}){const objectType=this.testConfig.objectTypes[index%this.testConfig.objectTypes.length];const size=this.testConfig.objectSize;const object=document.createElementNS('http://www.w3.org/2000/svg','g');object.setAttribute('class','placed-symbol test-object');object.setAttribute('data-placed-symbol','true');object.setAttribute('data-type',objectType);object.setAttribute('data-test-object','true');object.setAttribute('data-object-id',`test-${index}`);let transform=`translate(${x}, ${y})`;if(this.testConfig.randomRotation){const rotation=Math.random()*360;transform+=` rotate(${rotation})`;}
if(this.testConfig.randomScale){const scale=0.5+Math.random()*1.5;transform+=` scale(${scale})`;}
object.setAttribute('transform',transform);const visual=this.createObjectVisual(objectType,size,index);object.appendChild(visual);object.setAttribute('data-x',x);object.setAttribute('data-y',y);object.setAttribute('data-index',index);return object;}
createObjectVisual(type,size,index){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const color=this.getObjectColor(type,index);switch(type){case'sensor':return this.createSensorVisual(size,color);case'valve':return this.createValveVisual(size,color);case'pump':return this.createPumpVisual(size,color);case'fan':return this.createFanVisual(size,color);case'controller':return this.createControllerVisual(size,color);default:return this.createDefaultVisual(size,color);}}
createSensorVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');circle.setAttribute('cx',size.width/2);circle.setAttribute('cy',size.height/2);circle.setAttribute('r',Math.min(size.width,size.height)/3);circle.setAttribute('fill',color);circle.setAttribute('stroke','#333');circle.setAttribute('stroke-width','2');visual.appendChild(circle);return visual;}
createValveVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x',size.width*0.1);rect.setAttribute('y',size.height*0.1);rect.setAttribute('width',size.width*0.8);rect.setAttribute('height',size.height*0.8);rect.setAttribute('fill',color);rect.setAttribute('stroke','#333');rect.setAttribute('stroke-width','2');rect.setAttribute('rx','3');visual.appendChild(rect);return visual;}
createPumpVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const polygon=document.createElementNS('http://www.w3.org/2000/svg','polygon');const centerX=size.width/2;const centerY=size.height/2;const radius=Math.min(size.width,size.height)/3;const points=[];for(let i=0;i<6;i++){const angle=(i*Math.PI)/3;const x=centerX+Math.cos(angle)*radius;const y=centerY+Math.sin(angle)*radius;points.push(`${x},${y}`);}
polygon.setAttribute('points',points.join(' '));polygon.setAttribute('fill',color);polygon.setAttribute('stroke','#333');polygon.setAttribute('stroke-width','2');visual.appendChild(polygon);return visual;}
createFanVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const centerX=size.width/2;const centerY=size.height/2;const radius=Math.min(size.width,size.height)/3;for(let i=0;i<4;i++){const angle=(i*Math.PI)/2;const x1=centerX+Math.cos(angle)*radius*0.3;const y1=centerY+Math.sin(angle)*radius*0.3;const x2=centerX+Math.cos(angle)*radius;const y2=centerY+Math.sin(angle)*radius;const line=document.createElementNS('http://www.w3.org/2000/svg','line');line.setAttribute('x1',x1);line.setAttribute('y1',y1);line.setAttribute('x2',x2);line.setAttribute('y2',y2);line.setAttribute('stroke',color);line.setAttribute('stroke-width','3');visual.appendChild(line);}
const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');circle.setAttribute('cx',centerX);circle.setAttribute('cy',centerY);circle.setAttribute('r',radius*0.2);circle.setAttribute('fill',color);circle.setAttribute('stroke','#333');circle.setAttribute('stroke-width','2');visual.appendChild(circle);return visual;}
createControllerVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x',size.width*0.1);rect.setAttribute('y',size.height*0.1);rect.setAttribute('width',size.width*0.8);rect.setAttribute('height',size.height*0.8);rect.setAttribute('fill',color);rect.setAttribute('stroke','#333');rect.setAttribute('stroke-width','2');const innerRect=document.createElementNS('http://www.w3.org/2000/svg','rect');innerRect.setAttribute('x',size.width*0.25);innerRect.setAttribute('y',size.height*0.25);innerRect.setAttribute('width',size.width*0.5);innerRect.setAttribute('height',size.height*0.5);innerRect.setAttribute('fill','none');innerRect.setAttribute('stroke','#333');innerRect.setAttribute('stroke-width','1');visual.appendChild(rect);visual.appendChild(innerRect);return visual;}
createDefaultVisual(size,color){const visual=document.createElementNS('http://www.w3.org/2000/svg','g');const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x',size.width*0.1);rect.setAttribute('y',size.height*0.1);rect.setAttribute('width',size.width*0.8);rect.setAttribute('height',size.height*0.8);rect.setAttribute('fill',color);rect.setAttribute('stroke','#333');rect.setAttribute('stroke-width','2');visual.appendChild(rect);return visual;}
getObjectColor(type,index){if(!this.testConfig.colorVariation){return'#4CAF50';}
const colors=['#4CAF50','#2196F3','#FF9800','#F44336','#9C27B0','#00BCD4','#FF5722','#795548','#607D8B','#E91E63'];const colorIndex=(index+type.length)%colors.length;return colors[colorIndex];}
addObjectsToSVG(objects){const renderStart=performance.now();let testContainer=this.svg.querySelector('#test-objects-container');if(!testContainer){testContainer=document.createElementNS('http://www.w3.org/2000/svg','g');testContainer.setAttribute('id','test-objects-container');this.svg.appendChild(testContainer);}
objects.forEach(object=>{testContainer.appendChild(object);});const renderTime=performance.now()-renderStart;this.renderTimes.push(renderTime);window.arxLogger.performance('render_objects',renderTime,{count:objects.length,file:'performance_tester.js'});console.log(`PerformanceTester: Rendered ${objects.length} objects in ${renderTime.toFixed(2)}ms`);}
clearTestObjects(){const testContainer=this.svg.querySelector('#test-objects-container');if(testContainer){testContainer.remove();}
this.generatedObjects=[];this.triggerEvent('objectsCleared',{clearedCount:this.generatedObjects.length});window.arxLogger.info('PerformanceTester: Cleared all test objects',{file:'performance_tester.js'});}
async runPerformanceTest(testConfig={}){const tests=testConfig.tests||[{name:'Grid 100',count:100,pattern:'grid'},{name:'Grid 500',count:500,pattern:'grid'},{name:'Grid 1000',count:1000,pattern:'grid'},{name:'Random 100',count:100,pattern:'random'},{name:'Random 500',count:500,pattern:'random'},{name:'Spiral 100',count:100,pattern:'spiral'},{name:'Spiral 500',count:500,pattern:'spiral'}];const results=[];for(const test of tests){window.arxLogger.info(`PerformanceTester: Running test: ${test.name}`,{file:'performance_tester.js'});this.clearTestObjects();await new Promise(resolve=>setTimeout(resolve,100));const startTime=performance.now();let objects;switch(test.pattern){case'grid':objects=this.generateObjectGrid(test.count,test.options);break;case'random':objects=this.generateRandomObjects(test.count,test.options);break;case'spiral':objects=this.generateSpiralObjects(test.count,test.options);break;default:objects=this.generateObjectGrid(test.count,test.options);}
const totalTime=performance.now()-startTime;await new Promise(resolve=>setTimeout(resolve,200));const metrics=this.measurePerformance();results.push({name:test.name,count:test.count,pattern:test.pattern,generationTime:this.generationTimes[this.generationTimes.length-1]||0,renderTime:this.renderTimes[this.renderTimes.length-1]||0,totalTime:totalTime,metrics:metrics});}
this.triggerEvent('performanceTestCompleted',{results:results,summary:this.generateTestSummary(results)});window.arxLogger.info('PerformanceTester: Performance test completed',{results,file:'performance_tester.js'});return results;}
measurePerformance(){const objects=this.svg.querySelectorAll('.test-object');const visibleObjects=this.svg.querySelectorAll('.test-object:not(.culled)');return{totalObjects:objects.length,visibleObjects:visibleObjects.length,culledObjects:objects.length-visibleObjects.length,cullingEfficiency:objects.length>0?((objects.length-visibleObjects.length)/objects.length)*100:0};}
generateTestSummary(results){const summary={totalTests:results.length,totalObjects:results.reduce((sum,r)=>sum+r.count,0),averageGenerationTime:results.reduce((sum,r)=>sum+r.generationTime,0)/results.length,averageRenderTime:results.reduce((sum,r)=>sum+r.renderTime,0)/results.length,averageTotalTime:results.reduce((sum,r)=>sum+r.totalTime,0)/results.length};return summary;}
getTestStats(){return{generatedObjects:this.generatedObjects.length,generationTimes:[...this.generationTimes],renderTimes:[...this.renderTimes],averageGenerationTime:this.generationTimes.length>0?this.generationTimes.reduce((sum,time)=>sum+time,0)/this.generationTimes.length:0,averageRenderTime:this.renderTimes.length>0?this.renderTimes.reduce((sum,time)=>sum+time,0)/this.renderTimes.length:0};}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in performance tester event handler for ${event}:`,error);}});}}
destroy(){this.clearTestObjects();this.eventHandlers.clear();this.generationTimes=[];this.renderTimes=[];window.arxLogger.info('PerformanceTester: Destroyed',{file:'performance_tester.js'});}}
if(typeof module!=='undefined'&&module.exports){module.exports=PerformanceTester;}else if(typeof window!=='undefined'){window.PerformanceTester=PerformanceTester;}
class RealTimeManager{constructor(){this.websocket=null;this.userId=null;this.username=null;this.currentRoom=null;this.isConnected=false;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectDelay=1000;this.heartbeatInterval=null;this.presenceUpdateInterval=null;this.eventListeners={'connection':[],'disconnection':[],'user_joined':[],'user_left':[],'presence_update':[],'lock_acquired':[],'lock_released':[],'conflict_detected':[],'conflict_resolved':[],'broadcast':[],'error':[]};this.activeLocks=new Map();this.conflicts=new Map();this.roomUsers=new Map();this.cacheStats=null;this.preloadQueue=[];this.init();}
init(){this.userId=localStorage.getItem('user_id')||this.generateUserId();this.username=localStorage.getItem('username')||`User_${this.userId}`;localStorage.setItem('user_id',this.userId);localStorage.setItem('username',this.username);this.setupEventListeners();window.arxLogger.info('RealTimeManager initialized for user:',this.username,{file:'realtime_manager.js'});}
generateUserId(){return'user_'+Math.random().toString(36).substr(2,9);}
setupEventListeners(){document.addEventListener('visibilitychange',()=>{if(document.hidden){this.updatePresence({current_action:'away'});}else{this.updatePresence({current_action:'active'});}});window.addEventListener('beforeunload',()=>{this.disconnect();});let cursorTimeout;document.addEventListener('mousemove',(e)=>{clearTimeout(cursorTimeout);cursorTimeout=setTimeout(()=>{this.updatePresence({cursor_position:[e.clientX,e.clientY]});},100);});}
async connect(){if(this.isConnected){window.arxLogger.info('Already connected',{file:'realtime_manager.js'});return;}
try{const wsUrl=`ws://${window.location.host}/v1/realtime/ws/${this.userId}`;this.websocket=new WebSocket(wsUrl);this.websocket.onopen=()=>{window.arxLogger.info('WebSocket connected',{file:'realtime_manager.js'});this.isConnected=true;this.reconnectAttempts=0;this.startHeartbeat();this.startPresenceUpdates();this.emit('connection');};this.websocket.onmessage=(event)=>{this.handleMessage(JSON.parse(event.data));};this.websocket.onclose=()=>{window.arxLogger.warning('WebSocket disconnected',{file:'realtime_manager.js'});this.isConnected=false;this.stopHeartbeat();this.stopPresenceUpdates();this.emit('disconnection');this.handleReconnection();};this.websocket.onerror=(error)=>{console.error('WebSocket error:',error);this.emit('error',error);};}catch(error){console.error('Failed to connect:',error);this.emit('error',error);}}
disconnect(){if(this.websocket){this.websocket.close();this.websocket=null;}
this.isConnected=false;this.stopHeartbeat();this.stopPresenceUpdates();}
handleReconnection(){if(this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const delay=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);window.arxLogger.warning(`Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`,{file:'realtime_manager.js'});setTimeout(()=>{this.connect();},delay);}else{console.error('Max reconnection attempts reached');this.emit('error',new Error('Max reconnection attempts reached'));}}
startHeartbeat(){this.heartbeatInterval=setInterval(()=>{if(this.isConnected){this.sendMessage({type:'heartbeat',timestamp:new Date().toISOString()});}},30000);}
stopHeartbeat(){if(this.heartbeatInterval){clearInterval(this.heartbeatInterval);this.heartbeatInterval=null;}}
startPresenceUpdates(){this.presenceUpdateInterval=setInterval(()=>{if(this.isConnected){this.updatePresence();}},10000);}
stopPresenceUpdates(){if(this.presenceUpdateInterval){clearInterval(this.presenceUpdateInterval);this.presenceUpdateInterval=null;}}
sendMessage(message){if(this.websocket&&this.isConnected){this.websocket.send(JSON.stringify(message));}else{console.warn('WebSocket not connected, message not sent:',message);}}
handleMessage(message){window.arxLogger.debug('Received message:',message,{file:'realtime_manager.js'});switch(message.type){case'connection_established':this.handleConnectionEstablished(message);break;case'user_joined_room':this.handleUserJoinedRoom(message);break;case'user_left_room':this.handleUserLeftRoom(message);break;case'presence_updated':this.handlePresenceUpdated(message);break;case'lock_acquired':this.handleLockAcquired(message);break;case'lock_released':this.handleLockReleased(message);break;case'conflict_detected':this.handleConflictDetected(message);break;case'conflict_resolved':this.handleConflictResolved(message);break;case'broadcast':this.handleBroadcast(message);break;case'room_state':this.handleRoomState(message);break;case'error':this.handleError(message);break;default:console.warn('Unknown message type:',message.type);}}
handleConnectionEstablished(message){window.arxLogger.info('Connection established:',message,{file:'realtime_manager.js'});this.emit('connection',message);}
handleUserJoinedRoom(message){window.arxLogger.info('User joined room:',message,{file:'realtime_manager.js'});this.emit('user_joined',message);this.updateRoomUsers(message.room_id);}
handleUserLeftRoom(message){window.arxLogger.info('User left room:',message,{file:'realtime_manager.js'});this.emit('user_left',message);this.updateRoomUsers(message.room_id);}
handlePresenceUpdated(message){window.arxLogger.debug('Presence updated:',message,{file:'realtime_manager.js'});this.emit('presence_update',message);}
handleLockAcquired(message){window.arxLogger.info('Lock acquired:',message,{file:'realtime_manager.js'});this.activeLocks.set(message.lock_id,message);this.emit('lock_acquired',message);}
handleLockReleased(message){window.arxLogger.info('Lock released:',message,{file:'realtime_manager.js'});this.activeLocks.delete(message.lock_id);this.emit('lock_released',message);}
handleConflictDetected(message){window.arxLogger.warning('Conflict detected:',message,{file:'realtime_manager.js'});this.conflicts.set(message.conflict_id,message);this.emit('conflict_detected',message);this.showConflictNotification(message);}
handleConflictResolved(message){window.arxLogger.info('Conflict resolved:',message,{file:'realtime_manager.js'});this.conflicts.delete(message.conflict_id);this.emit('conflict_resolved',message);this.showConflictResolutionNotification(message);}
handleBroadcast(message){window.arxLogger.debug('Broadcast received:',message,{file:'realtime_manager.js'});this.emit('broadcast',message);}
handleRoomState(message){window.arxLogger.debug('Room state received:',message,{file:'realtime_manager.js'});this.roomUsers.set(message.room_id,message.users);this.activeLocks.clear();message.locks.forEach(lock=>{this.activeLocks.set(lock.lock_id,lock);});}
handleError(message){console.error('Error received:',message);this.emit('error',message);this.showErrorNotification(message);}
async joinRoom(roomId){if(!this.isConnected){await this.connect();}
this.sendMessage({type:'join_room',room_id:roomId});this.currentRoom=roomId;window.arxLogger.info('Joined room:',roomId,{file:'realtime_manager.js'});}
leaveRoom(roomId){this.sendMessage({type:'leave_room',room_id:roomId});if(this.currentRoom===roomId){this.currentRoom=null;}
window.arxLogger.info('Left room:',roomId,{file:'realtime_manager.js'});}
updatePresence(data={}){const presenceData={type:'update_presence',floor_id:this.currentRoom,current_action:data.current_action||'active',cursor_position:data.cursor_position,metadata:data.metadata||{}};this.sendMessage(presenceData);}
async acquireLock(lockType,resourceId,metadata={}){const message={type:'acquire_lock',lock_type:lockType,resource_id:resourceId,metadata:metadata};this.sendMessage(message);return new Promise((resolve,reject)=>{const timeout=setTimeout(()=>{reject(new Error('Lock acquisition timeout'));},10000);const handleLockResponse=(event)=>{if(event.detail.type==='lock_response'){clearTimeout(timeout);this.removeEventListener('lock_acquired',handleLockResponse);if(event.detail.success){resolve(event.detail.lock_id);}else{reject(new Error(event.detail.result));}}};this.addEventListener('lock_acquired',handleLockResponse);});}
releaseLock(lockId){this.sendMessage({type:'release_lock',lock_id:lockId});}
async resolveConflict(conflictId,resolution){const message={type:'resolve_conflict',conflict_id:conflictId,resolution:resolution};this.sendMessage(message);}
broadcast(message,roomId=null){this.sendMessage({type:'broadcast',room_id:roomId||this.currentRoom,message:message});}
async getRoomUsers(roomId){try{const response=await fetch(`/v1/realtime/room-users/${roomId}`);const data=await response.json();return data.users;}catch(error){console.error('Failed to get room users:',error);return[];}}
async getActiveLocks(resourceId){try{const response=await fetch(`/v1/realtime/active-locks/${resourceId}`);const data=await response.json();return data.locks;}catch(error){console.error('Failed to get active locks:',error);return[];}}
async getCacheStats(){try{const response=await fetch('/v1/realtime/cache-stats');const data=await response.json();this.cacheStats=data.cache_stats;return this.cacheStats;}catch(error){console.error('Failed to get cache stats:',error);return null;}}
async preloadFloorData(floorId){try{const response=await fetch('/v1/realtime/preload-floor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({floor_id:floorId})});const data=await response.json();window.arxLogger.info('Floor data preloaded:',data,{file:'realtime_manager.js'});return data.success;}catch(error){console.error('Failed to preload floor data:',error);return false;}}
async invalidateFloorCache(floorId){try{const response=await fetch('/v1/realtime/invalidate-floor-cache',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({floor_id:floorId})});const data=await response.json();window.arxLogger.info('Floor cache invalidated:',data,{file:'realtime_manager.js'});return data.count;}catch(error){console.error('Failed to invalidate floor cache:',error);return 0;}}
updateRoomUsers(roomId){this.getRoomUsers(roomId).then(users=>{this.roomUsers.set(roomId,users);});}
showConflictNotification(conflict){const notification=document.createElement('div');notification.className='conflict-notification';notification.innerHTML=`
            <div class="conflict-header">
                <h4>Conflict Detected</h4>
                <button class="close-btn" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="conflict-content">
                <p><strong>Type:</strong> ${conflict.conflict_type}</p>
                <p><strong>Severity:</strong> ${conflict.severity}</p>
                <p><strong>Description:</strong> ${conflict.description}</p>
                <p><strong>Users:</strong> ${conflict.user_id_1}, ${conflict.user_id_2}</p>
            </div>
            <div class="conflict-actions">
                <button onclick="resolveConflict('${conflict.conflict_id}', 'accept_mine')">Accept Mine</button>
                <button onclick="resolveConflict('${conflict.conflict_id}', 'accept_theirs')">Accept Theirs</button>
                <button onclick="resolveConflict('${conflict.conflict_id}', 'merge')">Merge</button>
            </div>
        `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},30000);}
showConflictResolutionNotification(resolution){const notification=document.createElement('div');notification.className='conflict-resolution-notification';notification.innerHTML=`
            <div class="conflict-header">
                <h4>Conflict Resolved</h4>
                <button class="close-btn" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="conflict-content">
                <p><strong>Resolution:</strong> ${resolution.resolution}</p>
                <p><strong>Resolved by:</strong> ${resolution.resolved_by}</p>
            </div>
        `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},5000);}
showErrorNotification(error){const notification=document.createElement('div');notification.className='error-notification';notification.innerHTML=`
            <div class="error-header">
                <h4>Error</h4>
                <button class="close-btn" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="error-content">
                <p>${error.message || 'An error occurred'}</p>
            </div>
        `;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},5000);}
addEventListener(event,callback){if(!this.eventListeners[event]){this.eventListeners[event]=[];}
this.eventListeners[event].push(callback);}
removeEventListener(event,callback){if(this.eventListeners[event]){const index=this.eventListeners[event].indexOf(callback);if(index>-1){this.eventListeners[event].splice(index,1);}}}
emit(event,data){if(this.eventListeners[event]){this.eventListeners[event].forEach(callback=>{try{callback(data);}catch(error){console.error('Error in event listener:',error);}});}
const customEvent=new CustomEvent(event,{detail:data});document.dispatchEvent(customEvent);}
isLocked(resourceId,lockType){for(const[lockId,lock]of this.activeLocks){if(lock.resource_id===resourceId&&lock.lock_type===lockType){return lock;}}
return null;}
hasConflict(resourceId){for(const[conflictId,conflict]of this.conflicts){if(conflict.resource_id===resourceId&&!conflict.resolved){return conflict;}}
return null;}
getRoomUserCount(roomId){const users=this.roomUsers.get(roomId);return users?users.length:0;}
getCurrentUser(){return{id:this.userId,username:this.username};}}
window.realtimeManager=new RealTimeManager();window.resolveConflict=function(conflictId,resolution){window.realtimeManager.resolveConflict(conflictId,resolution);};if(typeof module!=='undefined'&&module.exports){module.exports=RealTimeManager;}
let objectTypesRegistry=null;let behaviorProfilesRegistry=null;async function fetchRegistries(){const[objTypesRes,behaviorRes]=await Promise.all([fetch('/api/object-types'),fetch('/api/behavior-profiles')]);objectTypesRegistry=await objTypesRes.json();behaviorProfilesRegistry=await behaviorRes.json();}
function getObjectTypesRegistry(){return objectTypesRegistry;}
function getBehaviorProfilesRegistry(){return behaviorProfilesRegistry;}
function generateObjectId(building,floor,system,type,instance){const instanceStr=String(instance).padStart(3,'0');return`${building}_${floor}_${system}_${type}_${instanceStr}`;}
function isValidObjectId(id){const pattern=/^[A-Z0-9]{3,10}_L[0-9]{1,2}_(E|LV|FA|N|M|P)_[A-Z][a-zA-Z]+_[0-9]{3}$/;return pattern.test(id);}
function getNextInstanceNumber(objects,{building,floor,system,type}){const regex=new RegExp(`^${building}_${floor}_${system}_${type}_(\\d{3})$`);let maxInstance=0;for(const obj of objects){const match=obj.id&&obj.id.match(regex);if(match){const instanceNum=parseInt(match[1],10);if(instanceNum>maxInstance)maxInstance=instanceNum;}}
return maxInstance+1;}
export{fetchRegistries,getObjectTypesRegistry,getBehaviorProfilesRegistry,generateObjectId,isValidObjectId,getNextInstanceNumber};class ScaleManager{constructor(){this.scaleMode=false;this.referencePoints={point1:null,point2:null};this.scaleFactors={x:1.0,y:1.0};this.currentUnit='meters';this.units={pixels:{name:'Pixels',conversion:1},meters:{name:'Meters',conversion:1},feet:{name:'Feet',conversion:0.3048},inches:{name:'Inches',conversion:0.0254},millimeters:{name:'Millimeters',conversion:0.001}};this.initializeEventListeners();this.updateScaleIndicator();}
initializeEventListeners(){document.getElementById('scale-mode-toggle').addEventListener('click',()=>{this.toggleScaleMode();});document.getElementById('unit-selector').addEventListener('change',(e)=>{this.setUnit(e.target.value);});document.addEventListener('keydown',(e)=>{if(e.key==='s'||e.key==='S'){e.preventDefault();this.toggleScaleMode();}});document.getElementById('svg-container').addEventListener('click',(e)=>{if(this.scaleMode){this.handleReferencePointClick(e);}});}
toggleScaleMode(){this.scaleMode=!this.scaleMode;const toggleButton=document.getElementById('scale-mode-toggle');if(this.scaleMode){toggleButton.classList.add('scale-mode-active');toggleButton.textContent='Scale Mode Active';this.showScaleReferencePanel();this.updateCursor();}else{toggleButton.classList.remove('scale-mode-active');toggleButton.innerHTML='<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>Scale';this.hideScaleReferencePanel();this.updateCursor();}}
updateCursor(){const container=document.getElementById('svg-container');if(this.scaleMode){container.style.cursor='crosshair';}else{container.style.cursor='default';}}
showScaleReferencePanel(){const panel=document.getElementById('scale-reference-panel');panel.classList.remove('hidden');panel.classList.add('scale-panel-enter');setTimeout(()=>{panel.classList.remove('scale-panel-enter');},300);}
hideScaleReferencePanel(){const panel=document.getElementById('scale-reference-panel');panel.classList.add('scale-panel-exit');setTimeout(()=>{panel.classList.add('hidden');panel.classList.remove('scale-panel-exit');},300);}
closeScaleReferencePanel(){this.scaleMode=false;this.toggleScaleMode();}
handleReferencePointClick(event){const rect=event.currentTarget.getBoundingClientRect();const x=event.clientX-rect.left;const y=event.clientY-rect.top;const svgCoords=this.screenToSVGCoordinates(x,y);let pointNumber=1;if(this.referencePoints.point1){pointNumber=2;}
this.setReferencePointFromClick(pointNumber,svgCoords);}
setReferencePointFromClick(pointNumber,svgCoords){const point={svg:svgCoords,real:[0,0]};if(pointNumber===1){this.referencePoints.point1=point;this.updateReferencePointInputs(1,point);this.addReferencePointMarker(1,svgCoords);}else{this.referencePoints.point2=point;this.updateReferencePointInputs(2,point);this.addReferencePointMarker(2,svgCoords);}
this.updateScaleLine();this.validateReferencePoints();}
setReferencePoint(pointNumber){if(pointNumber===1){const x=parseFloat(document.getElementById('ref1-svg-x').value)||0;const y=parseFloat(document.getElementById('ref1-svg-y').value)||0;this.referencePoints.point1={svg:[x,y],real:[0,0]};this.addReferencePointMarker(1,[x,y]);}else{const x=parseFloat(document.getElementById('ref2-svg-x').value)||100;const y=parseFloat(document.getElementById('ref2-svg-y').value)||100;this.referencePoints.point2={svg:[x,y],real:[0,0]};this.addReferencePointMarker(2,[x,y]);}
this.updateScaleLine();this.validateReferencePoints();}
updateReferencePointInputs(pointNumber,point){if(pointNumber===1){document.getElementById('ref1-svg-x').value=point.svg[0].toFixed(2);document.getElementById('ref1-svg-y').value=point.svg[1].toFixed(2);}else{document.getElementById('ref2-svg-x').value=point.svg[0].toFixed(2);document.getElementById('ref2-svg-y').value=point.svg[1].toFixed(2);}}
addReferencePointMarker(pointNumber,coords){const markersContainer=document.getElementById('scale-reference-markers');const markerId=`ref-marker-${pointNumber}`;const existingMarker=document.getElementById(markerId);if(existingMarker){existingMarker.remove();}
const marker=document.createElement('div');marker.id=markerId;marker.className=`reference-point-marker point-${pointNumber}`;marker.style.left=`${coords[0] - 10}px`;marker.style.top=`${coords[1] - 10}px`;const label=document.createElement('div');label.className='reference-point-label';label.textContent=`Point ${pointNumber}`;label.style.left=`${coords[0] + 15}px`;label.style.top=`${coords[1] - 10}px`;marker.appendChild(label);markersContainer.appendChild(marker);}
updateScaleLine(){const markersContainer=document.getElementById('scale-reference-markers');const lineId='scale-line';const existingLine=document.getElementById(lineId);if(existingLine){existingLine.remove();}
if(this.referencePoints.point1&&this.referencePoints.point2){const line=document.createElement('div');line.id=lineId;line.className='scale-line';const x1=this.referencePoints.point1.svg[0];const y1=this.referencePoints.point1.svg[1];const x2=this.referencePoints.point2.svg[0];const y2=this.referencePoints.point2.svg[1];const length=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));const angle=Math.atan2(y2-y1,x2-x1)*180/Math.PI;line.style.left=`${x1}px`;line.style.top=`${y1}px`;line.style.width=`${length}px`;line.style.transform=`rotate(${angle}deg)`;line.style.transformOrigin='0 50%';markersContainer.appendChild(line);}}
validateReferencePoints(){const inputs=['ref1-svg-x','ref1-svg-y','ref1-real-x','ref1-real-y','ref2-svg-x','ref2-svg-y','ref2-real-x','ref2-real-y'];inputs.forEach(inputId=>{const input=document.getElementById(inputId);const value=parseFloat(input.value);input.classList.remove('valid','invalid');if(input.value===''||isNaN(value)){input.classList.add('invalid');}else{input.classList.add('valid');}});}
calculateScaleFactors(){if(!this.referencePoints.point1||!this.referencePoints.point2){this.showError('Please set both reference points');return;}
const real1x=parseFloat(document.getElementById('ref1-real-x').value);const real1y=parseFloat(document.getElementById('ref1-real-y').value);const real2x=parseFloat(document.getElementById('ref2-real-x').value);const real2y=parseFloat(document.getElementById('ref2-real-y').value);if(isNaN(real1x)||isNaN(real1y)||isNaN(real2x)||isNaN(real2y)){this.showError('Please enter valid real-world coordinates');return;}
const svg1=this.referencePoints.point1.svg;const svg2=this.referencePoints.point2.svg;const dxSvg=svg2[0]-svg1[0];const dySvg=svg2[1]-svg1[1];const dxReal=real2x-real1x;const dyReal=real2y-real1y;if(dxSvg===0||dySvg===0){this.showError('Reference points cannot be on the same vertical or horizontal line');return;}
this.scaleFactors.x=dxReal/dxSvg;this.scaleFactors.y=dyReal/dySvg;const scaleRatio=Math.abs(this.scaleFactors.x-this.scaleFactors.y)/Math.max(Math.abs(this.scaleFactors.x),Math.abs(this.scaleFactors.y));const uniform=scaleRatio<0.01;const confidence=Math.min(1.0,0.5+(1-scaleRatio)*0.5);this.updateScaleCalculationResults(uniform,confidence);this.updateScaleFactorDisplay();this.updateScaleIndicator();this.showSuccess('Scale factors calculated successfully');}
updateScaleCalculationResults(uniform,confidence){const resultsDiv=document.getElementById('scale-calculation-results');const scaleXSpan=document.getElementById('calculated-scale-x');const scaleYSpan=document.getElementById('calculated-scale-y');const uniformSpan=document.getElementById('scale-uniform');const confidenceSpan=document.getElementById('scale-confidence');scaleXSpan.textContent=this.scaleFactors.x.toFixed(6);scaleYSpan.textContent=this.scaleFactors.y.toFixed(6);uniformSpan.textContent=uniform?'Yes':'No';confidenceSpan.textContent=`${(confidence * 100).toFixed(1)}%`;resultsDiv.classList.remove('hidden');resultsDiv.classList.add('show');}
updateScaleFactorDisplay(){const display=document.getElementById('scale-factor-display');const valueSpan=document.getElementById('scale-factor-value');const scaleX=this.scaleFactors.x;const scaleY=this.scaleFactors.y;if(Math.abs(scaleX-scaleY)<0.01){valueSpan.textContent=`1:${(1/scaleX).toFixed(2)}`;}else{valueSpan.textContent=`X:${(1/scaleX).toFixed(2)} Y:${(1/scaleY).toFixed(2)}`;}
display.classList.add('updated');setTimeout(()=>{display.classList.remove('updated');},600);}
updateScaleIndicator(){const ratioSpan=document.getElementById('scale-ratio');const unitsSpan=document.getElementById('scale-units');const distanceSpan=document.getElementById('scale-distance');const indicator=document.getElementById('scale-indicator');const scaleX=this.scaleFactors.x;const scaleY=this.scaleFactors.y;if(Math.abs(scaleX-scaleY)<0.01){ratioSpan.textContent=`1:${(1/scaleX).toFixed(2)}`;}else{ratioSpan.textContent=`X:${(1/scaleX).toFixed(2)} Y:${(1/scaleY).toFixed(2)}`;}
unitsSpan.textContent=this.currentUnit;const examplePixels=100;const exampleReal=examplePixels*scaleX;const convertedReal=this.convertUnits(exampleReal,this.currentUnit);distanceSpan.textContent=`${examplePixels}px = ${convertedReal.toFixed(2)}${this.currentUnit}`;indicator.classList.add('updated');setTimeout(()=>{indicator.classList.remove('updated');},500);}
applyScaleFactors(){if(!this.scaleFactors.x||!this.scaleFactors.y){this.showError('Please calculate scale factors first');return;}
window.currentScaleFactors={x:this.scaleFactors.x,y:this.scaleFactors.y,unit:this.currentUnit};if(window.viewportManager){window.viewportManager.setScaleFactors(this.scaleFactors.x,this.scaleFactors.y);}
this.showSuccess('Scale factors applied successfully');}
clearReferencePoints(){this.referencePoints={point1:null,point2:null};['ref1-svg-x','ref1-svg-y','ref1-real-x','ref1-real-y','ref2-svg-x','ref2-svg-y','ref2-real-x','ref2-real-y'].forEach(id=>{document.getElementById(id).value='';document.getElementById(id).classList.remove('valid','invalid');});document.getElementById('scale-reference-markers').innerHTML='';document.getElementById('scale-calculation-results').classList.add('hidden');this.showSuccess('Reference points cleared');}
setUnit(unit){this.currentUnit=unit;this.updateScaleIndicator();document.getElementById('scale-units').textContent=unit;this.showSuccess(`Unit changed to ${this.units[unit].name}`);}
convertUnits(value,targetUnit){const baseUnit='meters';const baseValue=value*this.units[this.currentUnit].conversion;return baseValue/this.units[targetUnit].conversion;}
screenToSVGCoordinates(screenX,screenY){return[screenX,screenY];}
showError(message){const notification=document.createElement('div');notification.className='fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove();},3000);}
showSuccess(message){const notification=document.createElement('div');notification.className='fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.remove();},3000);}
getScaleFactors(){return this.scaleFactors;}
getCurrentUnit(){return this.currentUnit;}
convertToRealWorld(svgCoords){return[svgCoords[0]*this.scaleFactors.x,svgCoords[1]*this.scaleFactors.y];}
convertToSVG(realWorldCoords){return[realWorldCoords[0]/this.scaleFactors.x,realWorldCoords[1]/this.scaleFactors.y];}}
function toggleScaleMode(){if(window.scaleManager){window.scaleManager.toggleScaleMode();}}
function setReferencePoint(pointNumber){if(window.scaleManager){window.scaleManager.setReferencePoint(pointNumber);}}
function calculateScaleFactors(){if(window.scaleManager){window.scaleManager.calculateScaleFactors();}}
function applyScaleFactors(){if(window.scaleManager){window.scaleManager.applyScaleFactors();}}
function clearReferencePoints(){if(window.scaleManager){window.scaleManager.clearReferencePoints();}}
function closeScaleReferencePanel(){if(window.scaleManager){window.scaleManager.closeScaleReferencePanel();}}
document.addEventListener('DOMContentLoaded',()=>{window.scaleManager=new ScaleManager();});class MultiSelection{constructor(){this.selectedObjects=new Set();this.isMarqueeSelecting=false;this.marqueeStart={x:0,y:0};this.marqueeElement=null;this.svgContainer=null;this.svgElement=null;this.init();}
init(){this.svgContainer=document.getElementById('svg-container');this.svgElement=this.svgContainer?this.svgContainer.querySelector('svg'):null;if(!this.svgContainer||!this.svgElement)return;this.createMarqueeElement();this.setupEventListeners();}
createMarqueeElement(){this.marqueeElement=document.createElement('div');this.marqueeElement.className='marquee-selection absolute border-2 border-blue-500 bg-blue-100 bg-opacity-20 pointer-events-none z-40 hidden';this.svgContainer.appendChild(this.marqueeElement);}
setupEventListeners(){this.svgContainer.addEventListener('mousedown',this.handleMouseDown.bind(this));this.svgContainer.addEventListener('mousemove',this.handleMouseMove.bind(this));this.svgContainer.addEventListener('mouseup',this.handleMouseUp.bind(this));this.svgContainer.addEventListener('dragstart',(e)=>{if(this.isMarqueeSelecting)e.preventDefault();});document.addEventListener('keydown',this.handleKeyDown.bind(this));}
handleMouseDown(event){const target=event.target.closest('.placed-symbol');if(!target&&event.button===0){this.startMarqueeSelection(event);return;}
if(target){if(event.shiftKey){this.toggleObjectSelection(target);}else{this.selectObject(target);}}}
handleMouseMove(event){if(!this.isMarqueeSelecting)return;const currentPos=this.getMousePosition(event);this.updateMarqueeElement(currentPos);this.updateMarqueeSelection(currentPos);}
handleMouseUp(event){if(this.isMarqueeSelecting){this.endMarqueeSelection();}}
handleKeyDown(event){switch(event.key){case'a':if(event.ctrlKey||event.metaKey){event.preventDefault();this.selectAllObjects();}
break;case'd':if(event.ctrlKey||event.metaKey){event.preventDefault();this.clearSelection();}
break;case'Escape':this.clearSelection();break;}}
startMarqueeSelection(event){this.isMarqueeSelecting=true;this.marqueeStart=this.getMousePosition(event);this.marqueeElement.style.left=this.marqueeStart.x+'px';this.marqueeElement.style.top=this.marqueeStart.y+'px';this.marqueeElement.style.width='0px';this.marqueeElement.style.height='0px';this.marqueeElement.classList.remove('hidden');if(!event.shiftKey){this.clearSelection();}}
updateMarqueeElement(currentPos){const left=Math.min(this.marqueeStart.x,currentPos.x);const top=Math.min(this.marqueeStart.y,currentPos.y);const width=Math.abs(currentPos.x-this.marqueeStart.x);const height=Math.abs(currentPos.y-this.marqueeStart.y);this.marqueeElement.style.left=left+'px';this.marqueeElement.style.top=top+'px';this.marqueeElement.style.width=width+'px';this.marqueeElement.style.height=height+'px';}
updateMarqueeSelection(currentPos){const marqueeRect={left:Math.min(this.marqueeStart.x,currentPos.x),top:Math.min(this.marqueeStart.y,currentPos.y),right:Math.max(this.marqueeStart.x,currentPos.x),bottom:Math.max(this.marqueeStart.y,currentPos.y)};const objects=this.svgElement.querySelectorAll('.placed-symbol');objects.forEach(obj=>{const objRect=obj.getBoundingClientRect();const containerRect=this.svgContainer.getBoundingClientRect();const objLeft=objRect.left-containerRect.left;const objTop=objRect.top-containerRect.top;const objRight=objLeft+objRect.width;const objBottom=objTop+objRect.height;if(this.rectsIntersect(marqueeRect,{left:objLeft,top:objTop,right:objRight,bottom:objBottom})){this.selectedObjects.add(obj);obj.classList.add('selected');}});}
endMarqueeSelection(){this.isMarqueeSelecting=false;this.marqueeElement.classList.add('hidden');this.updateContextPanel();}
getMousePosition(event){const rect=this.svgContainer.getBoundingClientRect();return{x:event.clientX-rect.left,y:event.clientY-rect.top};}
rectsIntersect(rect1,rect2){return!(rect1.left>rect2.right||rect1.right<rect2.left||rect1.top>rect2.bottom||rect1.bottom<rect2.top);}
selectObject(obj){this.clearSelection();this.selectedObjects.add(obj);obj.classList.add('selected');this.updateContextPanel();}
toggleObjectSelection(obj){if(this.selectedObjects.has(obj)){this.selectedObjects.delete(obj);obj.classList.remove('selected');}else{this.selectedObjects.add(obj);obj.classList.add('selected');}
this.updateContextPanel();}
selectAllObjects(){const objects=this.svgElement.querySelectorAll('.placed-symbol');objects.forEach(obj=>{this.selectedObjects.add(obj);obj.classList.add('selected');});this.updateContextPanel();}
clearSelection(){this.selectedObjects.forEach(obj=>obj.classList.remove('selected'));this.selectedObjects.clear();this.updateContextPanel();}
getSelectedObjects(){return Array.from(this.selectedObjects);}
getSelectedObjectIds(){return Array.from(this.selectedObjects).map(obj=>obj.getAttribute('data-id'));}
moveSelectedObjects(deltaX,deltaY){this.selectedObjects.forEach(obj=>{const currentX=parseFloat(obj.getAttribute('data-x')||0);const currentY=parseFloat(obj.getAttribute('data-y')||0);const newX=currentX+deltaX;const newY=currentY+deltaY;obj.setAttribute('data-x',newX);obj.setAttribute('data-y',newY);const rotation=obj.getAttribute('data-rotation')||0;obj.setAttribute('transform',`translate(${newX},${newY}) rotate(${rotation})`);});}
rotateSelectedObjects(angle){this.selectedObjects.forEach(obj=>{const currentRotation=parseFloat(obj.getAttribute('data-rotation')||0);const newRotation=currentRotation+angle;obj.setAttribute('data-rotation',newRotation);const x=obj.getAttribute('data-x')||0;const y=obj.getAttribute('data-y')||0;obj.setAttribute('transform',`translate(${x},${y}) rotate(${newRotation})`);});}
deleteSelectedObjects(){if(this.selectedObjects.size===0)return;if(confirm(`Delete ${this.selectedObjects.size} selected object(s)?`)){this.selectedObjects.forEach(obj=>{obj.remove();});this.selectedObjects.clear();this.updateContextPanel();}}
groupSelectedObjects(){if(this.selectedObjects.size<2)return;const groupId='group_'+Date.now();const objects=Array.from(this.selectedObjects);const groupElement=document.createElementNS('http://www.w3.org/2000/svg','g');groupElement.setAttribute('data-group-id',groupId);groupElement.classList.add('object-group','selected');objects.forEach(obj=>{obj.setAttribute('data-group-id',groupId);groupElement.appendChild(obj);});this.svgElement.appendChild(groupElement);this.clearSelection();this.selectedObjects.add(groupElement);this.updateContextPanel();}
ungroupSelectedObjects(){const groups=Array.from(this.selectedObjects).filter(obj=>obj.classList.contains('object-group'));groups.forEach(group=>{const groupId=group.getAttribute('data-group-id');const objects=group.querySelectorAll('.placed-symbol');objects.forEach(obj=>{obj.removeAttribute('data-group-id');this.svgElement.appendChild(obj);});group.remove();});this.clearSelection();}
selectByType(type){const objects=this.svgElement.querySelectorAll(`.placed-symbol[data-type="${type}"]`);this.clearSelection();objects.forEach(obj=>{this.selectedObjects.add(obj);obj.classList.add('selected');});this.updateContextPanel();}
selectBySystem(system){const objects=this.svgElement.querySelectorAll(`.placed-symbol[data-system="${system}"]`);this.clearSelection();objects.forEach(obj=>{this.selectedObjects.add(obj);obj.classList.add('selected');});this.updateContextPanel();}
selectByStatus(status){const objects=this.svgElement.querySelectorAll(`.placed-symbol[data-status="${status}"]`);this.clearSelection();objects.forEach(obj=>{this.selectedObjects.add(obj);obj.classList.add('selected');});this.updateContextPanel();}
invertSelection(){const allObjects=this.svgElement.querySelectorAll('.placed-symbol');allObjects.forEach(obj=>{if(this.selectedObjects.has(obj)){this.selectedObjects.delete(obj);obj.classList.remove('selected');}else{this.selectedObjects.add(obj);obj.classList.add('selected');}});this.updateContextPanel();}
updateContextPanel(){if(window.contextPanel){window.contextPanel.updateSelection(this.selectedObjects);}
if(window.svgObjectInteraction){window.svgObjectInteraction.selectedObjects=this.selectedObjects;}}
exportSelection(){const selectionData=Array.from(this.selectedObjects).map(obj=>({id:obj.getAttribute('data-id'),name:obj.getAttribute('data-name'),type:obj.getAttribute('data-type'),system:obj.getAttribute('data-system'),x:parseFloat(obj.getAttribute('data-x')||0),y:parseFloat(obj.getAttribute('data-y')||0),rotation:parseFloat(obj.getAttribute('data-rotation')||0),status:obj.getAttribute('data-status')}));return selectionData;}
importSelection(selectionData){this.clearSelection();selectionData.forEach(data=>{const obj=this.svgElement.querySelector(`[data-id="${data.id}"]`);if(obj){this.selectedObjects.add(obj);obj.classList.add('selected');}});this.updateContextPanel();}}
document.addEventListener('DOMContentLoaded',()=>{window.multiSelection=new MultiSelection();});const token=localStorage.getItem('arx_jwt');function isAuthenticated(){return!!localStorage.getItem('arx_jwt');}
function logout(){localStorage.removeItem('arx_jwt');window.location.href='login.html';}
function getAuthHeaders(){const token=localStorage.getItem('arx_jwt');return token?{'Authorization':'Bearer '+token}:{};}
function handleAuthError(){localStorage.removeItem('arx_jwt');window.location.href='login.html';}
if(!isAuthenticated()){window.location.href='login.html';}
if(window.htmx){document.body.addEventListener('htmx:configRequest',function(evt){const token=localStorage.getItem('arx_jwt');if(token){evt.detail.headers['Authorization']='Bearer '+token;}});}
function parseJwt(token){try{const base64Url=token.split('.')[1];const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');const jsonPayload=decodeURIComponent(atob(base64).split('').map(function(c){return'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2);}).join(''));return JSON.parse(jsonPayload);}catch(e){return{};}}
(function(){const token=localStorage.getItem('arx_jwt');if(token&&document.getElementById('user-info')){const payload=parseJwt(token);if(payload.username){document.getElementById('user-info').textContent=payload.username;}else if(payload.email){document.getElementById('user-info').textContent=payload.email;}}})();class SharedUtilities{constructor(options={}){this.options={enableNotifications:true,notificationDuration:5000,maxFileSize:50*1024*1024,supportedFormats:['json','svg','zip','pdf'],...options};this.notificationQueue=[];this.isProcessingNotifications=false;this.initializeNotificationSystem();}
async readFileAsText(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=(e)=>resolve(e.target.result);reader.onerror=(e)=>reject(new Error('Failed to read file'));reader.readAsText(file);});}
async readFileAsArrayBuffer(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=(e)=>resolve(e.target.result);reader.onerror=(e)=>reject(new Error('Failed to read file'));reader.readAsArrayBuffer(file);});}
getFileExtension(filename){return filename.split('.').pop().toLowerCase();}
validateFileType(file,allowedTypes=this.options.supportedFormats){const extension=this.getFileExtension(file.name);return allowedTypes.includes(extension);}
validateFileSize(file,maxSize=this.options.maxFileSize){return file.size<=maxSize;}
async downloadFile(data,filename,mimeType='application/octet-stream'){const blob=new Blob([data],{type:mimeType});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);}
async downloadJSON(data,filename){const jsonString=JSON.stringify(data,null,2);await this.downloadFile(jsonString,filename,'application/json');}
async downloadSVG(svgContent,filename){await this.downloadFile(svgContent,filename,'image/svg+xml');}
async downloadZIP(zipData,filename){await this.downloadFile(zipData,filename,'application/zip');}
initializeNotificationSystem(){if(!this.options.enableNotifications)return;let container=document.getElementById('shared-notifications');if(!container){container=document.createElement('div');container.id='shared-notifications';container.className='shared-notifications-container';container.style.cssText=`
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
            `;document.body.appendChild(container);}
this.notificationContainer=container;}
showNotification(message,type='info',duration=this.options.notificationDuration){if(!this.options.enableNotifications){console.log(`[${type.toUpperCase()}] ${message}`);return;}
const notification=this.createNotificationElement(message,type);this.notificationContainer.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},duration);return notification;}
createNotificationElement(message,type){const notification=document.createElement('div');notification.className=`shared-notification shared-notification-${type}`;notification.style.cssText=`
            background: ${this.getNotificationColor(type)};
            color: white;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 14px;
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
            animation: slideInRight 0.3s ease-out;
        `;notification.innerHTML=`
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <span>${this.escapeHtml(message)}</span>
                <button onclick="this.parentElement.parentElement.remove()"
                        style="background: none; border: none; color: white; cursor: pointer; margin-left: 8px; font-size: 16px;">
                    
                </button>
            </div>
        `;return notification;}
getNotificationColor(type){const colors={success:'#10b981',error:'#ef4444',warning:'#f59e0b',info:'#3b82f6'};return colors[type]||colors.info;}
escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
validateEmail(email){const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return emailRegex.test(email);}
validateRequiredFields(data,requiredFields){const missing=[];for(const field of requiredFields){if(!data[field]||data[field].toString().trim()===''){missing.push(field);}}
return missing;}
generateRandomString(length=8){const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let result='';for(let i=0;i<length;i++){result+=chars.charAt(Math.floor(Math.random()*chars.length));}
return result;}
formatFileSize(bytes){if(bytes===0)return'0 Bytes';const k=1024;const sizes=['Bytes','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];}
formatDate(date,format='YYYY-MM-DD HH:mm:ss'){const d=new Date(date);const year=d.getFullYear();const month=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');const hours=String(d.getHours()).padStart(2,'0');const minutes=String(d.getMinutes()).padStart(2,'0');const seconds=String(d.getSeconds()).padStart(2,'0');return format.replace('YYYY',year).replace('MM',month).replace('DD',day).replace('HH',hours).replace('mm',minutes).replace('ss',seconds);}
handleError(error,context=''){const errorMessage=error.message||error.toString();console.error(`[${context}] Error:`,error);this.showNotification(`Error: ${errorMessage}`,'error');return{success:false,error:errorMessage};}
async retryOperation(operation,maxRetries=3,baseDelay=1000){for(let attempt=1;attempt<=maxRetries;attempt++){try{return await operation();}catch(error){if(attempt===maxRetries){throw error;}
const delay=baseDelay*Math.pow(2,attempt-1);await new Promise(resolve=>setTimeout(resolve,delay));}}}
debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}
throttle(func,limit){let inThrottle;return function(){const args=arguments;const context=this;if(!inThrottle){func.apply(context,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit);}};}}
window.sharedUtilities=new SharedUtilities();if(typeof module!=='undefined'&&module.exports){module.exports=SharedUtilities;}
if(window.arxLogger){window.arxLogger.info('Symbol Generator loaded',{component:'symbol_generator',version:'1.0.0'});}
class SymbolLibrary{constructor(){this.symbols=[];this.categories=[];this.sidebar=document.getElementById('symbol-library');this.list=this.sidebar?this.sidebar.querySelector('#symbol-list'):null;this.searchInput=this.sidebar?this.sidebar.querySelector('#symbol-search'):null;this.categoryFilter=this.sidebar?this.sidebar.querySelector('#category-filter'):null;this.uploadForm=this.sidebar?this.sidebar.querySelector('#symbol-upload-form'):null;this.uploadStatus=this.sidebar?this.sidebar.querySelector('#symbol-upload-status'):null;this.isDragging=false;this.draggedSymbol=null;this.viewportManager=null;this.symbolScaler=null;this.lodManager=null;this.init();}
async init(){await this.fetchCategories();await this.fetchSymbols();this.renderSymbols();this.setupDragDrop();this.setupFilterEvents();this.setupUpload();this.connectToViewportManager();this.connectToSymbolScaler();this.connectToLODManager();}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.viewportManager=window.viewportManager;window.arxLogger.info('SymbolLibrary connected to ViewportManager',{file:'symbol_library.js'});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
connectToSymbolScaler(){const checkSymbolScaler=()=>{if(window.symbolScaler){this.symbolScaler=window.symbolScaler;window.arxLogger.info('SymbolLibrary connected to SymbolScaler',{file:'symbol_library.js'});this.updateSymbolPreviews();}else{setTimeout(checkSymbolScaler,100);}};checkSymbolScaler();}
connectToLODManager(){const checkLODManager=()=>{if(window.lodManager){this.lodManager=window.lodManager;window.arxLogger.info('SymbolLibrary connected to LODManager',{file:'symbol_library.js'});this.lodManager.addEventListener('lodChanged',(data)=>{this.updateSymbolPreviews();});}else{setTimeout(checkLODManager,100);}};checkLODManager();}
async fetchCategories(){try{const res=await fetch('/api/symbols/categories');this.categories=await res.json();this.populateCategoryDropdown();}catch(e){this.categories=[];}}
populateCategoryDropdown(){if(!this.categoryFilter)return;this.categoryFilter.innerHTML='<option value="">All</option>';this.categories.forEach(cat=>{const opt=document.createElement('option');opt.value=cat;opt.textContent=cat.charAt(0).toUpperCase()+cat.slice(1);this.categoryFilter.appendChild(opt);});}
async fetchSymbols(){try{const res=await fetch('/api/symbols');this.symbols=await res.json();}catch(e){this.symbols=[];}}
getFilteredSymbols(){let filtered=this.symbols;const search=this.searchInput?.value?.toLowerCase()||'';const cat=this.categoryFilter?.value||'';if(cat)filtered=filtered.filter(s=>s.category===cat);if(search)filtered=filtered.filter(s=>s.name.toLowerCase().includes(search)||s.id.toLowerCase().includes(search));return filtered;}
renderSymbols(){if(!this.list)return;this.list.innerHTML='';const symbols=this.getFilteredSymbols();if(symbols.length===0){this.list.innerHTML='<div class="text-gray-400 text-center col-span-2">No symbols found.</div>';return;}
symbols.forEach(symbol=>{const div=document.createElement('div');div.className='symbol-item mb-2 p-2 border rounded flex flex-col items-center cursor-grab bg-white shadow-sm';div.setAttribute('draggable','true');div.setAttribute('data-symbol-id',symbol.id);div.setAttribute('data-base-scale','1.0');const previewDiv=document.createElement('div');previewDiv.className='symbol-preview mb-1';previewDiv.setAttribute('data-base-scale','1.0');previewDiv.setAttribute('data-symbol-id',symbol.id);const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');svg.setAttribute('width','32');svg.setAttribute('height','32');svg.setAttribute('viewBox','0 0 20 20');if(this.lodManager){const lodData=this.lodManager.getSymbolLODData(symbol.id);if(lodData){const currentLODLevel=this.lodManager.getCurrentLODLevel();const lodSVG=this.lodManager.getLODSVG(lodData,currentLODLevel);if(lodSVG){svg.innerHTML=lodSVG;}else{svg.innerHTML=symbol.svg||'';}}else{svg.innerHTML=symbol.svg||'';}}else{svg.innerHTML=symbol.svg||'';}
previewDiv.appendChild(svg);div.innerHTML='';div.appendChild(previewDiv);const nameSpan=document.createElement('span');nameSpan.className='text-xs text-gray-700';nameSpan.textContent=symbol.name;div.appendChild(nameSpan);if(this.lodManager){const lodIndicator=document.createElement('span');lodIndicator.className='text-xs text-blue-500 mt-1';lodIndicator.textContent=`LOD: ${this.lodManager.getCurrentLODLevel()}`;div.appendChild(lodIndicator);}
div.addEventListener('dragstart',e=>this.handleDragStart(e,symbol));div.addEventListener('dragend',e=>this.handleDragEnd(e));this.list.appendChild(div);});this.updateSymbolPreviews();}
setupFilterEvents(){if(this.searchInput)this.searchInput.addEventListener('input',()=>this.renderSymbols());if(this.categoryFilter)this.categoryFilter.addEventListener('change',()=>this.renderSymbols());}
setupDragDrop(){const svgContainer=document.getElementById('svg-container');if(!svgContainer)return;svgContainer.addEventListener('dragover',e=>{e.preventDefault();svgContainer.classList.add('svg-drop-hover');});svgContainer.addEventListener('dragleave',e=>{svgContainer.classList.remove('svg-drop-hover');});svgContainer.addEventListener('drop',e=>this.handleDrop(e,svgContainer));}
handleDragStart(e,symbol){this.isDragging=true;this.draggedSymbol=symbol;e.dataTransfer.effectAllowed='copy';e.dataTransfer.setData('application/json',JSON.stringify(symbol));}
handleDragEnd(e){this.isDragging=false;this.draggedSymbol=null;const svgContainer=document.getElementById('svg-container');if(svgContainer)svgContainer.classList.remove('svg-drop-hover');}
handleDrop(e,svgContainer){e.preventDefault();svgContainer.classList.remove('svg-drop-hover');let symbol=this.draggedSymbol;if(!symbol){try{symbol=JSON.parse(e.dataTransfer.getData('application/json'));}catch(err){return;}}
if(!symbol)return;const svg=svgContainer.querySelector('svg');if(!svg)return;const coordinates=this.getDropCoordinates(e,svg);let realWorldCoords=null;if(this.viewportManager&&this.viewportManager.scaleFactors.x!==1.0){realWorldCoords=this.viewportManager.svgToRealWorld(coordinates.x,coordinates.y);window.arxLogger.info(`Symbol placed at real-world coordinates: (${realWorldCoords.x.toFixed(2)}, ${realWorldCoords.y.toFixed(2)}) ${this.viewportManager.currentUnit}`,{file:'symbol_library.js'});}
this.placeSymbol(svg,symbol,coordinates.x,coordinates.y,realWorldCoords);}
getDropCoordinates(e,svg){if(window.viewportManager&&window.viewportManager.screenToSVG){return window.viewportManager.screenToSVG(e.clientX,e.clientY);}
const pt=svg.createSVGPoint();pt.x=e.clientX;pt.y=e.clientY;const svgP=pt.matrixTransform(svg.getScreenCTM().inverse());return{x:svgP.x,y:svgP.y};}
placeSymbol(svg,symbol,x,y,realWorldCoords){const objectId=`${symbol.id}_${Date.now()}_${Math.floor(Math.random()*10000)}`;const symbolElement=document.createElementNS('http://www.w3.org/2000/svg','g');symbolElement.setAttribute('id',objectId);symbolElement.setAttribute('class','placed-symbol');symbolElement.setAttribute('data-id',objectId);symbolElement.setAttribute('data-symbol-id',symbol.id);symbolElement.setAttribute('data-symbol-name',symbol.name);symbolElement.setAttribute('data-category',symbol.category);symbolElement.setAttribute('data-base-scale','1.0');symbolElement.setAttribute('data-x',x.toString());symbolElement.setAttribute('data-y',y.toString());symbolElement.setAttribute('data-rotation','0');symbolElement.setAttribute('data-type','symbol');symbolElement.setAttribute('data-system','electrical');symbolElement.setAttribute('data-status','active');symbolElement.setAttribute('data-priority','normal');symbolElement.setAttribute('data-lod-level','medium');symbolElement.setAttribute('data-lod-complexity','0.7');symbolElement.setAttribute('data-lod-enabled','true');if(this.viewportManager&&this.viewportManager.scaleFactors.x!==1.0){symbolElement.setAttribute('data-scale-x',this.viewportManager.scaleFactors.x.toString());symbolElement.setAttribute('data-scale-y',this.viewportManager.scaleFactors.y.toString());symbolElement.setAttribute('data-coordinate-system','real_world');symbolElement.setAttribute('data-unit',this.viewportManager.currentUnit);symbolElement.setAttribute('data-svg-x',x.toString());symbolElement.setAttribute('data-svg-y',y.toString());}
if(realWorldCoords){symbolElement.setAttribute('data-real-world-x',realWorldCoords.x.toString());symbolElement.setAttribute('data-real-world-y',realWorldCoords.y.toString());symbolElement.setAttribute('data-unit',this.viewportManager.currentUnit);}
const symbolSvg=document.createElementNS('http://www.w3.org/2000/svg','svg');symbolSvg.setAttribute('width','40');symbolSvg.setAttribute('height','40');symbolSvg.setAttribute('viewBox','0 0 20 20');if(this.lodManager){const lodData=this.lodManager.getSymbolLODData(symbol.id);if(lodData){const currentLODLevel=this.lodManager.getCurrentLODLevel();const lodSVG=this.lodManager.getLODSVG(lodData,currentLODLevel);if(lodSVG){symbolSvg.innerHTML=lodSVG;}else{symbolSvg.innerHTML=symbol.svg||'';}}else{symbolSvg.innerHTML=symbol.svg||'';}}else{symbolSvg.innerHTML=symbol.svg||'';}
if(this.symbolScaler){this.symbolScaler.applyBaseScaling(symbolSvg,1.0);}
symbolElement.appendChild(symbolSvg);symbolElement.setAttribute('transform',`translate(${x}, ${y})`);svg.appendChild(symbolElement);symbolElement.classList.add('placing');setTimeout(()=>{symbolElement.classList.remove('placing');},400);if(realWorldCoords){window.arxLogger.debug(`Symbol "${symbol.name}" placed at:`,{symbol,file:'symbol_library.js'});}else{window.arxLogger.debug(`Symbol "${symbol.name}" placed at SVG coordinates: (${x.toFixed(2)}, ${y.toFixed(2)})`,{file:'symbol_library.js'});}
this.triggerSymbolPlacedEvent(symbol,x,y,realWorldCoords,symbolElement);return symbolElement;}
updateSymbolPositions(){if(!window.viewportManager)return;const placedSymbols=document.querySelectorAll('.placed-symbol[data-placed-symbol="true"]');placedSymbols.forEach(symbol=>{const x=parseFloat(symbol.getAttribute('data-x'));const y=parseFloat(symbol.getAttribute('data-y'));const rotation=parseFloat(symbol.getAttribute('data-rotation')||'0');const transform=`translate(${x},${y}) rotate(${rotation})`;symbol.setAttribute('transform',transform);});}
getSymbolPosition(symbolElement){const x=parseFloat(symbolElement.getAttribute('data-x'));const y=parseFloat(symbolElement.getAttribute('data-y'));return{x,y};}
setSymbolPosition(symbolElement,x,y){symbolElement.setAttribute('data-x',x);symbolElement.setAttribute('data-y',y);const rotation=parseFloat(symbolElement.getAttribute('data-rotation')||'0');const transform=`translate(${x},${y}) rotate(${rotation})`;symbolElement.setAttribute('transform',transform);if(window.viewportManager){window.viewportManager.triggerEvent('objectMoved',{objectId:symbolElement.getAttribute('data-id'),x:x,y:y,element:symbolElement});}}
screenToSVGCoordinates(screenX,screenY){if(window.viewportManager&&window.viewportManager.screenToSVG){return window.viewportManager.screenToSVG(screenX,screenY);}
return{x:screenX,y:screenY};}
svgToScreenCoordinates(svgX,svgY){if(window.viewportManager&&window.viewportManager.svgToScreen){return window.viewportManager.svgToScreen(svgX,svgY);}
return{x:svgX,y:svgY};}
setupUpload(){if(!this.uploadForm)return;this.uploadForm.addEventListener('submit',async(e)=>{e.preventDefault();if(!this.uploadForm.symbolFile||!this.uploadForm.symbolFile.files[0])return;const formData=new FormData();formData.append('file',this.uploadForm.symbolFile.files[0]);formData.append('name',this.uploadForm.symbolName.value);formData.append('category',this.uploadForm.symbolCategory.value);formData.append('meta',this.uploadForm.symbolMeta.value);this.uploadStatus.textContent='Uploading...';try{const res=await fetch('/api/symbols',{method:'POST',body:formData});if(!res.ok)throw new Error('Upload failed');this.uploadStatus.textContent='Upload successful!';await this.fetchSymbols();this.renderSymbols();this.uploadForm.reset();}catch(err){this.uploadStatus.textContent='Upload failed.';}});}
updateSymbolPreviews(){if(!this.list)return;const previews=this.list.querySelectorAll('.symbol-preview');previews.forEach(preview=>{const symbolId=preview.getAttribute('data-symbol-id');const baseScale=parseFloat(preview.getAttribute('data-base-scale'))||1.0;if(this.symbolScaler){this.symbolScaler.scaleSymbolPreview(preview,baseScale);}
if(this.lodManager&&symbolId){const svg=preview.querySelector('svg');if(svg){const lodData=this.lodManager.getSymbolLODData(symbolId);if(lodData){const currentLODLevel=this.lodManager.getCurrentLODLevel();const lodSVG=this.lodManager.getLODSVG(lodData,currentLODLevel);if(lodSVG){svg.innerHTML=lodSVG;}}}}});const lodIndicators=this.list.querySelectorAll('.text-blue-500');lodIndicators.forEach(indicator=>{if(this.lodManager){indicator.textContent=`LOD: ${this.lodManager.getCurrentLODLevel()}`;}});}
setSymbolPreviewScale(symbolId,baseScale){const symbolItem=this.list?.querySelector(`[data-symbol-id="${symbolId}"]`);if(!symbolItem)return;const preview=symbolItem.querySelector('.symbol-preview');if(!preview)return;preview.setAttribute('data-base-scale',baseScale);if(this.symbolScaler){this.symbolScaler.updateSymbolScale(preview,baseScale);}}
triggerSymbolPlacedEvent(symbol,x,y,realWorldCoords,symbolElement){if(window.svgObjectInteraction){window.svgObjectInteraction.selectObject(symbolElement);}
if(window.viewportManager){window.viewportManager.triggerEvent('objectPlaced',{objectId:symbolElement.id,symbolId:symbol.id,x:x,y:y,realWorldCoords:realWorldCoords,element:symbolElement});}
const event=new CustomEvent('symbolPlaced',{detail:{symbol:symbol,svgCoords:{x,y},realWorldCoords:realWorldCoords,element:symbolElement}});document.dispatchEvent(event);}}
document.addEventListener('DOMContentLoaded',()=>{window.symbolLibrary=new SymbolLibrary();});class SymbolScaler{constructor(){this.baseSize=20;this.minSize=8;this.maxSize=100;this.scaleFactors={tiny:0.5,small:0.75,normal:1.0,large:1.5,huge:2.0};this.zoomThresholds={min:0.1,max:10.0};this.viewportManager=null;this.scaleCache=new Map();this.init();}
init(){this.connectToViewportManager();this.setupEventListeners();}
connectToViewportManager(){const checkViewportManager=()=>{if(window.viewportManager){this.viewportManager=window.viewportManager;window.arxLogger.info('SymbolScaler connected to ViewportManager',{file:'symbol_scaler.js'});this.viewportManager.addEventListener('zoomChanged',()=>{this.updateAllSymbolScales();});this.viewportManager.addEventListener('viewReset',()=>{this.updateAllSymbolScales();});}else{setTimeout(checkViewportManager,100);}};checkViewportManager();}
setupEventListeners(){document.addEventListener('symbolScaleChanged',(e)=>{this.updateSymbolScale(e.detail.symbolId,e.detail.scale);});document.addEventListener('globalScaleChanged',(e)=>{this.updateGlobalScale(e.detail.scale);});}
calculateOptimalSize(zoomLevel=1.0,baseScale=1.0){const clampedZoom=Math.max(this.zoomThresholds.min,Math.min(this.zoomThresholds.max,zoomLevel));const optimalSize=this.baseSize*baseScale/clampedZoom;return Math.max(this.minSize,Math.min(this.maxSize,optimalSize));}
getScaleFactor(zoomLevel,baseScale=1.0){const cacheKey=`${zoomLevel}_${baseScale}`;if(this.scaleCache.has(cacheKey)){return this.scaleCache.get(cacheKey);}
const optimalSize=this.calculateOptimalSize(zoomLevel,baseScale);const scaleFactor=optimalSize/this.baseSize;this.scaleCache.set(cacheKey,scaleFactor);if(this.scaleCache.size>1000){const firstKey=this.scaleCache.keys().next().value;this.scaleCache.delete(firstKey);}
return scaleFactor;}
scaleSymbol(symbolElement,scaleFactor,options={}){if(!symbolElement)return;const{maintainAspectRatio=true,centerTransform=true,animate=false}=options;const currentTransform=symbolElement.getAttribute('transform')||'';const x=parseFloat(symbolElement.getAttribute('data-x'))||0;const y=parseFloat(symbolElement.getAttribute('data-y'))||0;const rotation=parseFloat(symbolElement.getAttribute('data-rotation'))||0;let newTransform='';if(centerTransform){newTransform=`translate(${x},${y}) scale(${scaleFactor}) rotate(${rotation})`;}else{newTransform=`translate(${x},${y}) rotate(${rotation}) scale(${scaleFactor})`;}
if(animate){symbolElement.style.transition='transform 0.3s ease';symbolElement.setAttribute('transform',newTransform);setTimeout(()=>{symbolElement.style.transition='';},300);}else{symbolElement.setAttribute('transform',newTransform);}
symbolElement.setAttribute('data-scale',scaleFactor);const newSize=this.baseSize*scaleFactor;symbolElement.setAttribute('data-size',newSize);this.triggerScaleChangeEvent(symbolElement,scaleFactor);}
updateSymbolScale(symbolElement,baseScale=1.0){if(!symbolElement||!this.viewportManager)return;const zoomLevel=this.viewportManager.currentZoom||1.0;const scaleFactor=this.getScaleFactor(zoomLevel,baseScale);this.scaleSymbol(symbolElement,scaleFactor,{animate:true,centerTransform:true});}
updateAllSymbolScales(){if(!this.viewportManager)return;const placedSymbols=document.querySelectorAll('.placed-symbol');const zoomLevel=this.viewportManager.currentZoom||1.0;placedSymbols.forEach(symbol=>{const baseScale=parseFloat(symbol.getAttribute('data-base-scale'))||1.0;this.updateSymbolScale(symbol,baseScale);});}
setBaseScale(symbolElement,baseScale){if(!symbolElement)return;symbolElement.setAttribute('data-base-scale',baseScale);this.updateSymbolScale(symbolElement,baseScale);}
getCurrentScale(symbolElement){if(!symbolElement)return 1.0;return parseFloat(symbolElement.getAttribute('data-scale'))||1.0;}
getBaseScale(symbolElement){if(!symbolElement)return 1.0;return parseFloat(symbolElement.getAttribute('data-base-scale'))||1.0;}
scaleSymbolPreview(previewElement,scaleFactor,options={}){if(!previewElement)return;const{maintainAspectRatio=true,animate=false}=options;const svg=previewElement.querySelector('svg');if(!svg)return;const currentWidth=parseFloat(svg.getAttribute('width'))||32;const currentHeight=parseFloat(svg.getAttribute('height'))||32;const newWidth=currentWidth*scaleFactor;const newHeight=maintainAspectRatio?currentHeight*scaleFactor:currentHeight;if(animate){svg.style.transition='width 0.3s ease, height 0.3s ease';}
svg.setAttribute('width',newWidth);svg.setAttribute('height',newHeight);if(animate){setTimeout(()=>{svg.style.transition='';},300);}
previewElement.setAttribute('data-scale',scaleFactor);}
updateSymbolPreviews(){if(!this.viewportManager)return;const previews=document.querySelectorAll('.symbol-preview');const zoomLevel=this.viewportManager.currentZoom||1.0;previews.forEach(preview=>{const baseScale=parseFloat(preview.getAttribute('data-base-scale'))||1.0;const scaleFactor=this.getScaleFactor(zoomLevel,baseScale);this.scaleSymbolPreview(preview,scaleFactor,{animate:true});});}
createScaledSymbol(symbol,x,y,baseScale=1.0){const zoomLevel=this.viewportManager?this.viewportManager.currentZoom||1.0:1.0;const scaleFactor=this.getScaleFactor(zoomLevel,baseScale);const g=document.createElementNS('http://www.w3.org/2000/svg','g');g.classList.add('placed-symbol');g.setAttribute('data-x',x);g.setAttribute('data-y',y);g.setAttribute('data-rotation','0');g.setAttribute('data-base-scale',baseScale);g.setAttribute('data-scale',scaleFactor);g.setAttribute('data-size',this.baseSize*scaleFactor);const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');const size=this.baseSize*scaleFactor;svg.setAttribute('width',size);svg.setAttribute('height',size);svg.setAttribute('viewBox','0 0 20 20');svg.innerHTML=symbol.svg||'';g.appendChild(svg);const transform=`translate(${x},${y}) scale(${scaleFactor})`;g.setAttribute('transform',transform);return g;}
testSymbolScaling(){if(!this.viewportManager){console.warn('Viewport manager not available for scaling test');return;}
console.log('=== Testing Symbol Scaling Consistency ===');const testZoomLevels=[0.25,0.5,1.0,2.0,4.0];const testBaseScales=[0.5,1.0,1.5,2.0];testZoomLevels.forEach(zoomLevel=>{console.log(`\n--- Testing at Zoom Level ${zoomLevel} ---`);testBaseScales.forEach(baseScale=>{const scaleFactor=this.getScaleFactor(zoomLevel,baseScale);const actualSize=this.baseSize*scaleFactor;console.log(`  Base Scale ${baseScale}:`);console.log(`    Scale Factor: ${scaleFactor.toFixed(3)}`);console.log(`    Actual Size: ${actualSize.toFixed(1)}px`);console.log(`    Optimal Size: ${this.calculateOptimalSize(zoomLevel, baseScale).toFixed(1)}px`);});});console.log('\nScaling test complete!');}
getScalingStats(){const placedSymbols=document.querySelectorAll('.placed-symbol');const stats={totalSymbols:placedSymbols.length,averageScale:0,minScale:Infinity,maxScale:-Infinity,scaleDistribution:{}};let totalScale=0;placedSymbols.forEach(symbol=>{const scale=this.getCurrentScale(symbol);totalScale+=scale;stats.minScale=Math.min(stats.minScale,scale);stats.maxScale=Math.max(stats.maxScale,scale);const scaleRange=scale<0.5?'tiny':scale<0.75?'small':scale<1.25?'normal':scale<1.75?'large':'huge';stats.scaleDistribution[scaleRange]=(stats.scaleDistribution[scaleRange]||0)+1;});if(placedSymbols.length>0){stats.averageScale=totalScale/placedSymbols.length;}
return stats;}
triggerScaleChangeEvent(symbolElement,scaleFactor){const event=new CustomEvent('symbolScaleChanged',{detail:{symbolId:symbolElement.getAttribute('data-id'),scale:scaleFactor,element:symbolElement}});document.dispatchEvent(event);}
clearScaleCache(){this.scaleCache.clear();console.log('Symbol scale cache cleared');}
resetAllScales(){const placedSymbols=document.querySelectorAll('.placed-symbol');placedSymbols.forEach(symbol=>{this.setBaseScale(symbol,1.0);});console.log('All symbol scales reset to default');}}
document.addEventListener('DOMContentLoaded',()=>{window.symbolScaler=new SymbolScaler();});class ThrottledUpdateManager{constructor(options={}){this.targetFPS=options.targetFPS||60;this.frameInterval=1000/this.targetFPS;this.maxBatchSize=options.maxBatchSize||100;this.batchTimeout=options.batchTimeout||16;this.isRunning=false;this.lastFrameTime=0;this.pendingUpdates=new Map();this.updateQueue=[];this.animationFrameId=null;this.frameCount=0;this.lastFPSUpdate=0;this.currentFPS=0;this.frameTimes=[];this.maxFrameTimeHistory=60;this.devicePerformance=this.detectDevicePerformance();this.adaptiveThrottling=options.adaptiveThrottling!==false;this.eventHandlers=new Map();this.updateTypes={'viewport':{priority:1,throttle:16},'zoom':{priority:1,throttle:16},'pan':{priority:1,throttle:16},'culling':{priority:2,throttle:50},'symbols':{priority:3,throttle:100},'ui':{priority:4,throttle:200},'batch':{priority:0,throttle:0}};this.initialize();}
initialize(){if(window.arxLogger){window.arxLogger.info('ThrottledUpdateManager initialized',{component:'throttled_update_manager',device_performance:this.devicePerformance,target_fps:this.targetFPS});}
this.adaptToDevicePerformance();this.start();}
detectDevicePerformance(){const performance=window.performance;const memory=performance.memory;const hardwareConcurrency=navigator.hardwareConcurrency||1;const refreshRate=this.detectRefreshRate();const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl')||canvas.getContext('experimental-webgl');const hasHardwareAcceleration=gl&&gl.getExtension('WEBGL_debug_renderer_info');let score=0;if(hardwareConcurrency>=8)score+=3;else if(hardwareConcurrency>=4)score+=2;else if(hardwareConcurrency>=2)score+=1;if(memory){const totalMemory=memory.totalJSHeapSizeLimit;if(totalMemory>=2147483648)score+=3;else if(totalMemory>=1073741824)score+=2;else if(totalMemory>=536870912)score+=1;}
if(refreshRate>=120)score+=2;else if(refreshRate>=60)score+=1;if(hasHardwareAcceleration)score+=1;if(score>=8)return'high';else if(score>=5)return'medium';else return'low';}
detectRefreshRate(){let lastTime=performance.now();let frameCount=0;let refreshRate=60;const detectFrame=(currentTime)=>{frameCount++;if(frameCount>=60){const elapsed=currentTime-lastTime;refreshRate=Math.round((frameCount/elapsed)*1000);return;}
requestAnimationFrame(detectFrame);};requestAnimationFrame(detectFrame);return refreshRate||60;}
adaptToDevicePerformance(){if(!this.adaptiveThrottling)return;switch(this.devicePerformance){case'high':this.targetFPS=120;this.frameInterval=1000/this.targetFPS;this.maxBatchSize=200;this.batchTimeout=8;break;case'medium':this.targetFPS=60;this.frameInterval=1000/this.targetFPS;this.maxBatchSize=100;this.batchTimeout=16;break;case'low':this.targetFPS=30;this.frameInterval=1000/this.targetFPS;this.maxBatchSize=50;this.batchTimeout=32;break;}
if(window.arxLogger){window.arxLogger.info('Adapted settings for device performance',{component:'throttled_update_manager',device_performance:this.devicePerformance,target_fps:this.targetFPS,max_batch_size:this.maxBatchSize,batch_timeout_ms:this.batchTimeout});}}
start(){if(this.isRunning)return;this.isRunning=true;this.lastFrameTime=performance.now();this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this));if(window.arxLogger){window.arxLogger.info('ThrottledUpdateManager: Update loop started',{component:'throttled_update_manager',status:'started'});}}
stop(){if(!this.isRunning)return;this.isRunning=false;if(this.animationFrameId){cancelAnimationFrame(this.animationFrameId);this.animationFrameId=null;}
if(window.arxLogger){window.arxLogger.info('ThrottledUpdateManager: Update loop stopped',{component:'throttled_update_manager',status:'stopped'});}}
updateLoop(currentTime){if(!this.isRunning)return;const frameTime=currentTime-this.lastFrameTime;this.lastFrameTime=currentTime;this.frameTimes.push(frameTime);if(this.frameTimes.length>this.maxFrameTimeHistory){this.frameTimes.shift();}
this.frameCount++;if(currentTime-this.lastFPSUpdate>=1000){this.currentFPS=this.frameCount;this.frameCount=0;this.lastFPSUpdate=currentTime;}
if(frameTime>=this.frameInterval){this.processUpdates(currentTime);}
this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this));}
processUpdates(currentTime){const sortedUpdates=Array.from(this.pendingUpdates.entries()).sort((a,b)=>{const typeA=a[0];const typeB=b[0];const priorityA=this.updateTypes[typeA]?.priority||5;const priorityB=this.updateTypes[typeB]?.priority||5;return priorityA-priorityB;});let processedCount=0;const processedTypes=new Set();for(const[updateType,updateData]of sortedUpdates){if(processedCount>=this.maxBatchSize)break;const updateConfig=this.updateTypes[updateType];if(!updateConfig)continue;const lastUpdate=updateData.lastUpdate||0;if(currentTime-lastUpdate<updateConfig.throttle)continue;this.executeUpdate(updateType,updateData);processedTypes.add(updateType);processedCount++;updateData.lastUpdate=currentTime;}
for(const updateType of processedTypes){this.pendingUpdates.delete(updateType);}
this.processBatchedUpdates();this.triggerEvent('updateProcessed',{processedCount,currentFPS:this.currentFPS,frameTime:this.frameTimes[this.frameTimes.length-1]||0,pendingUpdates:this.pendingUpdates.size});}
queueUpdate(updateType,updateData={},options={}){if(!this.updateTypes[updateType]){console.warn(`ThrottledUpdateManager: Unknown update type: ${updateType}`);return;}
const{priority=this.updateTypes[updateType].priority,immediate=false,batch=false}=options;if(immediate){this.executeUpdate(updateType,updateData);return;}
if(batch){this.queueBatchedUpdate(updateType,updateData);return;}
this.pendingUpdates.set(updateType,{...updateData,priority,timestamp:performance.now()});}
queueBatchedUpdate(updateType,updateData){this.updateQueue.push({type:updateType,data:updateData,timestamp:performance.now()});setTimeout(()=>{this.processBatchedUpdates();},this.batchTimeout);}
processBatchedUpdates(){if(this.updateQueue.length===0)return;const groupedUpdates=new Map();for(const update of this.updateQueue){if(!groupedUpdates.has(update.type)){groupedUpdates.set(update.type,[]);}
groupedUpdates.get(update.type).push(update);}
for(const[updateType,updates]of groupedUpdates){if(updates.length===1){this.executeUpdate(updateType,updates[0].data);}else{this.executeBatchedUpdate(updateType,updates);}}
this.updateQueue=[];}
executeUpdate(updateType,updateData){try{this.triggerEvent('update',{type:updateType,data:updateData,timestamp:performance.now()});this.triggerEvent(`${updateType}Update`,updateData);}catch(error){console.error(`ThrottledUpdateManager: Error executing ${updateType} update:`,error);}}
executeBatchedUpdate(updateType,updates){try{const batchedData={updates:updates.map(u=>u.data),count:updates.length,timestamp:performance.now()};this.triggerEvent('batchedUpdate',{type:updateType,data:batchedData});this.triggerEvent(`${updateType}BatchedUpdate`,batchedData);}catch(error){console.error(`ThrottledUpdateManager: Error executing batched ${updateType} update:`,error);}}
throttle(func,delay){let lastCall=0;return function(...args){const now=performance.now();if(now-lastCall>=delay){lastCall=now;return func.apply(this,args);}};}
debounce(func,delay){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>{func.apply(this,args);},delay);};}
getPerformanceMetrics(){const avgFrameTime=this.frameTimes.length>0?this.frameTimes.reduce((a,b)=>a+b,0)/this.frameTimes.length:0;return{currentFPS:this.currentFPS,targetFPS:this.targetFPS,averageFrameTime:avgFrameTime,devicePerformance:this.devicePerformance,pendingUpdates:this.pendingUpdates.size,queuedUpdates:this.updateQueue.length,frameTimeHistory:[...this.frameTimes]};}
setUpdateTypeConfig(updateType,config){this.updateTypes[updateType]={...this.updateTypes[updateType],...config};}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in throttled update event handler for ${event}:`,error);}});}}
clearPendingUpdates(){this.pendingUpdates.clear();this.updateQueue=[];}
forceProcessUpdates(){const currentTime=performance.now();this.processUpdates(currentTime);}
destroy(){this.stop();this.clearPendingUpdates();this.eventHandlers.clear();if(window.arxLogger){window.arxLogger.info('ThrottledUpdateManager: Destroyed',{component:'throttled_update_manager',status:'destroyed'});}}}
if(typeof module!=='undefined'&&module.exports){module.exports=ThrottledUpdateManager;}else if(typeof window!=='undefined'){window.ThrottledUpdateManager=ThrottledUpdateManager;}
class ThrottledUpdateTester{constructor(options={}){this.testDuration=options.testDuration||5000;this.updateInterval=options.updateInterval||16;this.batchSizes=options.batchSizes||[1,10,50,100];this.deviceTypes=['low','medium','high'];this.isRunning=false;this.currentTest=null;this.testResults=[];this.performanceMetrics=[];this.frameCount=0;this.lastFPSUpdate=0;this.currentFPS=0;this.frameTimes=[];this.maxFrameTimeHistory=120;this.eventHandlers=new Map();this.initialize();}
initialize(){window.arxLogger.info('ThrottledUpdateTester initialized',{file:'throttled_update_tester.js'});this.startPerformanceMonitoring();}
startPerformanceMonitoring(){let lastTime=performance.now();const monitorFrame=(currentTime)=>{const frameTime=currentTime-lastTime;lastTime=currentTime;this.frameTimes.push(frameTime);if(this.frameTimes.length>this.maxFrameTimeHistory){this.frameTimes.shift();}
this.frameCount++;if(currentTime-this.lastFPSUpdate>=1000){this.currentFPS=this.frameCount;this.frameCount=0;this.lastFPSUpdate=currentTime;}
requestAnimationFrame(monitorFrame);};requestAnimationFrame(monitorFrame);}
async runTest(testType='comprehensive'){if(this.isRunning){console.warn('Test already running');return;}
window.arxLogger.info(`=== Running Throttled Update Test: ${testType} ===`,{file:'throttled_update_tester.js'});this.isRunning=true;this.currentTest=testType;try{let results;switch(testType){case'zoom':results=await this.runZoomTest();break;case'pan':results=await this.runPanTest();break;case'batch':results=await this.runBatchTest();break;case'device':results=await this.runDeviceTest();break;case'comprehensive':default:results=await this.runComprehensiveTest();break;}
this.testResults.push({type:testType,timestamp:new Date().toISOString(),results:results});window.arxLogger.info('Test completed:',{results,file:'throttled_update_tester.js'});return results;}catch(error){console.error('Test failed:',error);throw error;}finally{this.isRunning=false;this.currentTest=null;}}
async runZoomTest(){const results={testType:'zoom',duration:this.testDuration,zoomLevels:[],frameRates:[],smoothness:0};const startTime=performance.now();const endTime=startTime+this.testDuration;while(performance.now()<endTime){const zoomLevel=0.5+Math.random()*2;const centerX=Math.random()*window.innerWidth;const centerY=Math.random()*window.innerHeight;this.triggerZoomEvent(zoomLevel,centerX,centerY);results.zoomLevels.push(zoomLevel);results.frameRates.push(this.currentFPS);await this.sleep(this.updateInterval);}
results.smoothness=this.calculateSmoothnessScore(results.frameRates);return results;}
async runPanTest(){const results={testType:'pan',duration:this.testDuration,panDistances:[],frameRates:[],smoothness:0};const startTime=performance.now();const endTime=startTime+this.testDuration;while(performance.now()<endTime){const deltaX=(Math.random()-0.5)*100;const deltaY=(Math.random()-0.5)*100;this.triggerPanEvent(deltaX,deltaY);results.panDistances.push(Math.sqrt(deltaX*deltaX+deltaY*deltaY));results.frameRates.push(this.currentFPS);await this.sleep(this.updateInterval);}
results.smoothness=this.calculateSmoothnessScore(results.frameRates);return results;}
async runBatchTest(){const results={testType:'batch',batchSizes:this.batchSizes,batchResults:[]};for(const batchSize of this.batchSizes){const batchResult=await this.testBatchSize(batchSize);results.batchResults.push(batchResult);}
return results;}
async testBatchSize(batchSize){const results={batchSize:batchSize,frameRates:[],processingTimes:[],smoothness:0};const testDuration=Math.min(this.testDuration,2000);const startTime=performance.now();const endTime=startTime+testDuration;while(performance.now()<endTime){const processingStart=performance.now();this.triggerBatchUpdate(batchSize);const processingTime=performance.now()-processingStart;results.frameRates.push(this.currentFPS);results.processingTimes.push(processingTime);await this.sleep(this.updateInterval);}
results.smoothness=this.calculateSmoothnessScore(results.frameRates);results.averageProcessingTime=results.processingTimes.reduce((a,b)=>a+b,0)/results.processingTimes.length;return results;}
async runDeviceTest(){const results={testType:'device',deviceTypes:this.deviceTypes,deviceResults:[]};for(const deviceType of this.deviceTypes){const deviceResult=await this.testDevicePerformance(deviceType);results.deviceResults.push(deviceResult);}
return results;}
async testDevicePerformance(deviceType){const results={deviceType:deviceType,frameRates:[],smoothness:0,recommendations:[]};const performanceSettings=this.getDevicePerformanceSettings(deviceType);const testDuration=Math.min(this.testDuration,3000);const startTime=performance.now();const endTime=startTime+testDuration;while(performance.now()<endTime){this.triggerZoomEvent(1.1,window.innerWidth/2,window.innerHeight/2);this.triggerPanEvent(10,10);this.triggerBatchUpdate(10);results.frameRates.push(this.currentFPS);await this.sleep(performanceSettings.updateInterval);}
results.smoothness=this.calculateSmoothnessScore(results.frameRates);results.recommendations=this.generateDeviceRecommendations(deviceType,results);return results;}
async runComprehensiveTest(){const results={testType:'comprehensive',zoomTest:null,panTest:null,batchTest:null,deviceTest:null,overallScore:0};results.zoomTest=await this.runZoomTest();results.panTest=await this.runPanTest();results.batchTest=await this.runBatchTest();results.deviceTest=await this.runDeviceTest();results.overallScore=this.calculateOverallScore(results);return results;}
triggerZoomEvent(zoomFactor,centerX,centerY){if(window.viewportManager){window.viewportManager.zoomAtPoint(zoomFactor,centerX,centerY,false);}
this.triggerEvent('zoomTest',{zoomFactor:zoomFactor,centerX:centerX,centerY:centerY,timestamp:performance.now()});}
triggerPanEvent(deltaX,deltaY){if(window.viewportManager){const currentPan=window.viewportManager.getPan();const newPanX=currentPan.x+deltaX;const newPanY=currentPan.y+deltaY;window.viewportManager.setPan(newPanX,newPanY);}
this.triggerEvent('panTest',{deltaX:deltaX,deltaY:deltaY,timestamp:performance.now()});}
triggerBatchUpdate(batchSize){if(window.throttledUpdateManager){for(let i=0;i<batchSize;i++){window.throttledUpdateManager.queueUpdate('symbols',{id:i,x:Math.random()*1000,y:Math.random()*1000},{batch:true});}}
this.triggerEvent('batchTest',{batchSize:batchSize,timestamp:performance.now()});}
calculateSmoothnessScore(frameRates){if(frameRates.length===0)return 0;const avgFPS=frameRates.reduce((a,b)=>a+b,0)/frameRates.length;const variance=frameRates.reduce((sum,fps)=>sum+Math.pow(fps-avgFPS,2),0)/frameRates.length;const stdDev=Math.sqrt(variance);const fpsScore=Math.min(avgFPS/60,1);const consistencyScore=Math.max(0,1-(stdDev/30));return(fpsScore*0.7+consistencyScore*0.3)*100;}
calculateOverallScore(results){const scores=[results.zoomTest.smoothness,results.panTest.smoothness,results.batchTest.batchResults.reduce((sum,r)=>sum+r.smoothness,0)/results.batchTest.batchResults.length,results.deviceTest.deviceResults.reduce((sum,r)=>sum+r.smoothness,0)/results.deviceTest.deviceResults.length];return scores.reduce((a,b)=>a+b,0)/scores.length;}
getDevicePerformanceSettings(deviceType){switch(deviceType){case'high':return{updateInterval:8,targetFPS:120};case'medium':return{updateInterval:16,targetFPS:60};case'low':return{updateInterval:32,targetFPS:30};default:return{updateInterval:16,targetFPS:60};}}
generateDeviceRecommendations(deviceType,results){const recommendations=[];if(results.smoothness<50){recommendations.push('Consider reducing update frequency');recommendations.push('Enable viewport culling for better performance');}
if(results.smoothness<30){recommendations.push('Switch to low-performance mode');recommendations.push('Reduce batch sizes for smoother updates');}
if(results.smoothness>=80){recommendations.push('System can handle high refresh rates');recommendations.push('Consider enabling advanced features');}
return recommendations;}
getTestResultsSummary(){if(this.testResults.length===0){return{message:'No tests have been run yet'};}
const latestTest=this.testResults[this.testResults.length-1];const results=latestTest.results;return{lastTest:latestTest.type,timestamp:latestTest.timestamp,overallScore:results.overallScore||0,zoomSmoothness:results.zoomTest?.smoothness||0,panSmoothness:results.panTest?.smoothness||0,averageFPS:this.currentFPS,totalTests:this.testResults.length};}
getPerformanceMetrics(){const avgFrameTime=this.frameTimes.length>0?this.frameTimes.reduce((a,b)=>a+b,0)/this.frameTimes.length:0;return{currentFPS:this.currentFPS,averageFrameTime:avgFrameTime,frameTimeHistory:[...this.frameTimes],isRunning:this.isRunning,currentTest:this.currentTest};}
sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms));}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in throttled update tester event handler for ${event}:`,error);}});}}
clearTestResults(){this.testResults=[];window.arxLogger.info('Test results cleared',{file:'throttled_update_tester.js'});}
destroy(){this.isRunning=false;this.eventHandlers.clear();window.arxLogger.info('ThrottledUpdateTester: Destroyed',{file:'throttled_update_tester.js'});}}
if(typeof module!=='undefined'&&module.exports){module.exports=ThrottledUpdateTester;}else if(typeof window!=='undefined'){window.ThrottledUpdateTester=ThrottledUpdateTester;}
class VersionControlManager{constructor(){this.baseUrl='/v1/version-control';this.eventListeners={'version_created':[],'branch_created':[],'merge_request_created':[],'conflict_resolved':[],'merge_executed':[],'annotation_added':[],'comment_added':[],'branch_graph_updated':[]};this.utils=window.sharedUtilities||new SharedUtilities();}
addEventListener(event,callback){if(!this.eventListeners[event])this.eventListeners[event]=[];this.eventListeners[event].push(callback);}
emit(event,data){if(this.eventListeners[event]){this.eventListeners[event].forEach(cb=>{try{cb(data);}catch(e){console.error(e);}});}}
async createVersion(floorData,floorId,buildingId,branchName,commitMessage,author,options={}){const res=await fetch(`${this.baseUrl}/version`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({floor_data:floorData,floor_id:floorId,building_id:buildingId,branch_name:branchName,commit_message:commitMessage,author:author,parent_version_id:options.parentVersionId,version_type:options.versionType||'minor'})});const result=await res.json();this.emit('version_created',result);return result;}
async getVersionHistory(buildingId,floorId,branchName=null){const url=branchName?`${this.baseUrl}/versions/${buildingId}/${floorId}?branch_name=${branchName}`:`${this.baseUrl}/versions/${buildingId}/${floorId}`;const res=await fetch(url);return await res.json();}
async getVersionData(versionId){const res=await fetch(`${this.baseUrl}/version/${versionId}`);return await res.json();}
async createBranch(branchName,floorId,buildingId,baseVersionId,createdBy,description=''){const res=await fetch(`${this.baseUrl}/branch`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({branch_name:branchName,floor_id:floorId,building_id:buildingId,base_version_id:baseVersionId,created_by:createdBy,description:description})});const result=await res.json();this.emit('branch_created',result);return result;}
async getBranches(buildingId,floorId){const res=await fetch(`${this.baseUrl}/branches/${buildingId}/${floorId}`);return await res.json();}
async createMergeRequest(sourceBranch,targetBranch,floorId,buildingId,createdBy,description=''){const res=await fetch(`${this.baseUrl}/merge-request`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({source_branch:sourceBranch,target_branch:targetBranch,floor_id:floorId,building_id:buildingId,created_by:createdBy,description:description})});const result=await res.json();this.emit('merge_request_created',result);return result;}
async resolveConflict(mergeId,conflictId,resolution,resolvedBy){const res=await fetch(`${this.baseUrl}/merge/${mergeId}/resolve-conflict`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conflict_id:conflictId,resolution:resolution,resolved_by:resolvedBy})});const result=await res.json();this.emit('conflict_resolved',result);return result;}
async executeMerge(mergeId,executedBy){const res=await fetch(`${this.baseUrl}/merge/${mergeId}/execute`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({executed_by:executedBy})});const result=await res.json();this.emit('merge_executed',result);return result;}
async addAnnotation(versionId,floorId,buildingId,title,content,author,options={}){const res=await fetch(`${this.baseUrl}/annotation`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({version_id:versionId,floor_id:floorId,building_id:buildingId,title:title,content:content,author:author,object_id:options.objectId,position_x:options.positionX,position_y:options.positionY,annotation_type:options.annotationType||'note'})});const result=await res.json();this.emit('annotation_added',result);return result;}
async getAnnotations(versionId){const res=await fetch(`${this.baseUrl}/annotations/${versionId}`);return await res.json();}
async searchAnnotations(buildingId,floorId,query){const res=await fetch(`${this.baseUrl}/annotations/search/${buildingId}/${floorId}?query=${encodeURIComponent(query)}`);return await res.json();}
async addComment(parentId,parentType,content,author){const res=await fetch(`${this.baseUrl}/comment`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({parent_id:parentId,parent_type:parentType,content:content,author:author})});const result=await res.json();this.emit('comment_added',result);return result;}
async getComments(parentId,parentType){const res=await fetch(`${this.baseUrl}/comments/${parentId}?parent_type=${parentType}`);return await res.json();}
async getBranchGraph(buildingId,floorId){const res=await fetch(`${this.baseUrl}/branch-graph/${buildingId}/${floorId}`);const result=await res.json();this.emit('branch_graph_updated',result);return result;}
async exportVersionData(buildingId,floorId,options={}){const url=`${this.baseUrl}/export/${buildingId}/${floorId}?include_annotations=${options.includeAnnotations !== false}&include_comments=${options.includeComments !== false}`;const res=await fetch(url);return await res.json();}
renderBranchGraph(graphData,container){if(!container||!graphData.success)return;container.innerHTML='';const graph=graphData.graph;const timeline=document.createElement('div');timeline.className='branch-timeline';const branchVersions={};graph.versions.forEach(version=>{if(!branchVersions[version.branch]){branchVersions[version.branch]=[];}
branchVersions[version.branch].push(version);});Object.keys(branchVersions).forEach(branchName=>{const branchLane=document.createElement('div');branchLane.className='branch-lane';branchLane.innerHTML=`
                <div class="branch-header">${branchName}</div>
                <div class="version-timeline">
                    ${branchVersions[branchName].map(version => `<div class="version-node"data-version-id="${version.version_id}"><div class="version-number">${version.version_number}</div><div class="version-author">${version.author}</div><div class="version-date">${new Date(version.created_at).toLocaleDateString()}</div></div>`).join('')}
                </div>
            `;timeline.appendChild(branchLane);});container.appendChild(timeline);}
renderMergeConflicts(conflicts,container){if(!container)return;container.innerHTML='';const conflictsList=document.createElement('div');conflictsList.className='conflicts-list';conflicts.forEach(conflict=>{const conflictItem=document.createElement('div');conflictItem.className='conflict-item';conflictItem.innerHTML=`
                <div class="conflict-header">
                    <span class="conflict-type">${conflict.type}</span>
                    <span class="object-id">${conflict.object_id || 'N/A'}</span>
                </div>
                <div class="conflict-content">
                    <div class="source-value">
                        <strong>Source:</strong> ${JSON.stringify(conflict.source_value)}
                    </div>
                    <div class="target-value">
                        <strong>Target:</strong> ${JSON.stringify(conflict.target_value)}
                    </div>
                </div>
                <div class="conflict-resolution">
                    <select class="resolution-select" data-conflict-id="${conflict.conflict_id}">
                        <option value="">Choose resolution...</option>
                        <option value="source">Use Source</option>
                        <option value="target">Use Target</option>
                        <option value="manual">Manual Edit</option>
                    </select>
                </div>
            `;conflictsList.appendChild(conflictItem);});container.appendChild(conflictsList);}
renderAnnotations(annotations,container){if(!container)return;container.innerHTML='';const annotationsList=document.createElement('div');annotationsList.className='annotations-list';annotations.forEach(annotation=>{const annotationItem=document.createElement('div');annotationItem.className='annotation-item';annotationItem.innerHTML=`
                <div class="annotation-header">
                    <span class="annotation-title">${annotation.title}</span>
                    <span class="annotation-type">${annotation.annotation_type}</span>
                </div>
                <div class="annotation-content">${annotation.content}</div>
                <div class="annotation-meta">
                    <span class="annotation-author">${annotation.author}</span>
                    <span class="annotation-date">${new Date(annotation.created_at).toLocaleDateString()}</span>
                </div>
                <div class="annotation-actions">
                    <button class="btn-comment" data-annotation-id="${annotation.annotation_id}">Add Comment</button>
                </div>
            `;annotationsList.appendChild(annotationItem);});container.appendChild(annotationsList);}
renderComments(comments,container){if(!container)return;container.innerHTML='';const commentsList=document.createElement('div');commentsList.className='comments-list';comments.forEach(comment=>{const commentItem=document.createElement('div');commentItem.className='comment-item';commentItem.innerHTML=`
                <div class="comment-content">${comment.content}</div>
                <div class="comment-meta">
                    <span class="comment-author">${comment.author}</span>
                    <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                </div>
            `;commentsList.appendChild(commentItem);});container.appendChild(commentsList);}
showConflictResolutionDialog(conflicts,onResolve){const dialog=document.createElement('div');dialog.className='conflict-resolution-dialog';dialog.innerHTML=`
            <div class="dialog-content">
                <h3>Resolve Merge Conflicts</h3>
                <div class="conflicts-container"></div>
                <div class="dialog-actions">
                    <button class="btn-cancel">Cancel</button>
                    <button class="btn-resolve">Resolve All</button>
                </div>
            </div>
        `;this.renderMergeConflicts(conflicts,dialog.querySelector('.conflicts-container'));dialog.querySelector('.btn-cancel').addEventListener('click',()=>{document.body.removeChild(dialog);});dialog.querySelector('.btn-resolve').addEventListener('click',()=>{const resolutions={};dialog.querySelectorAll('.resolution-select').forEach(select=>{if(select.value){resolutions[select.dataset.conflictId]=select.value;}});onResolve(resolutions);document.body.removeChild(dialog);});document.body.appendChild(dialog);}
downloadExport(data,filename){this.utils.downloadJSON(data,filename);}
formatVersionNumber(versionNumber){return versionNumber.replace(/_/g,' ').replace(/-/g,' ');}
getVersionTypeColor(versionType){const colors={'major':'#dc3545','minor':'#007bff','patch':'#28a745','branch':'#6c757d'};return colors[versionType]||'#6c757d';}}
window.versionControlManager=new VersionControlManager();if(typeof module!=='undefined'&&module.exports){module.exports=VersionControlManager;}
class VersionControlPanel{constructor(containerId,options={}){this.containerId=containerId;this.container=document.getElementById(containerId);this.options={floorId:null,showCreateButton:true,showUndoRedo:true,showSearch:true,showFilter:true,maxHeight:'400px',onVersionSelect:null,onVersionRestore:null,onVersionCompare:null,...options};this.versions=[];this.selectedVersion=null;this.isCollapsed=false;this.render();this.initializeEventListeners();this.loadVersions();}
render(){this.container.innerHTML=`
            <div class="version-control-panel bg-white rounded-lg shadow-md border">
                <!-- Header -->
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-history text-blue-600"></i>
                            <h3 class="text-lg font-semibold text-gray-900">Version History</h3>
                            <span class="text-sm text-gray-500">(${this.versions.length})</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${this.options.showCreateButton ? `<button class="create-version-btn bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded-md transition-colors"><i class="fas fa-camera mr-1"></i>Snapshot</button>` : ''}
                            <button class="collapse-btn text-gray-400 hover:text-gray-600">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>

                    ${this.options.showUndoRedo ? `<div class="undo-redo-controls mt-3 flex items-center space-x-2"><button class="undo-btn bg-gray-500 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded disabled:opacity-50"disabled><i class="fas fa-undo mr-1"></i>Undo</button><button class="redo-btn bg-gray-500 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded disabled:opacity-50"disabled><i class="fas fa-redo mr-1"></i>Redo</button></div>` : ''}

                    ${(this.options.showSearch || this.options.showFilter) ? `<div class="version-controls mt-3 flex items-center space-x-2">${this.options.showSearch?`
                                <input type="text" class="version-search border border-gray-300 rounded px-2 py-1 text-sm flex-1"
                                       placeholder="Search versions...">
                            `:''}
${this.options.showFilter?`
                                <select class="version-filter border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="all">All</option>
                                    <option value="manual">Manual</option>
                                    <option value="auto-save">Auto-save</option>
                                    <option value="branch">Branches</option>
                                </select>
                            `:''}</div>` : ''}
                </div>

                <!-- Version List -->
                <div class="version-list-container" style="max-height: ${this.options.maxHeight}; overflow-y: auto;">
                    <div class="version-list divide-y divide-gray-200">
                        <div class="p-4 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-lg mb-2"></i>
                            <p class="text-sm">Loading versions...</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="p-3 border-t border-gray-200 bg-gray-50">
                    <div class="flex items-center justify-between text-xs text-gray-600">
                        <span>Select a version to view details</span>
                        <div class="flex items-center space-x-2">
                            <button class="refresh-btn text-blue-600 hover:text-blue-800">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                            <button class="expand-btn text-blue-600 hover:text-blue-800">
                                <i class="fas fa-expand mr-1"></i>Expand
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;}
initializeEventListeners(){this.container.querySelector('.collapse-btn').addEventListener('click',()=>{this.toggleCollapse();});if(this.options.showCreateButton){this.container.querySelector('.create-version-btn').addEventListener('click',()=>{this.showCreateVersionModal();});}
if(this.options.showUndoRedo){this.container.querySelector('.undo-btn').addEventListener('click',()=>{this.undo();});this.container.querySelector('.redo-btn').addEventListener('click',()=>{this.redo();});}
if(this.options.showSearch){this.container.querySelector('.version-search').addEventListener('input',(e)=>{this.filterVersions(e.target.value);});}
if(this.options.showFilter){this.container.querySelector('.version-filter').addEventListener('change',(e)=>{this.filterVersionsByType(e.target.value);});}
this.container.querySelector('.refresh-btn').addEventListener('click',()=>{this.loadVersions();});this.container.querySelector('.expand-btn').addEventListener('click',()=>{this.expandToFullView();});}
toggleCollapse(){this.isCollapsed=!this.isCollapsed;const listContainer=this.container.querySelector('.version-list-container');const collapseBtn=this.container.querySelector('.collapse-btn i');if(this.isCollapsed){listContainer.style.display='none';collapseBtn.className='fas fa-chevron-down';}else{listContainer.style.display='block';collapseBtn.className='fas fa-chevron-up';}}
async loadVersions(){if(!this.options.floorId){this.showEmptyState('No floor selected');return;}
try{const response=await fetch(`/api/floors/${this.options.floorId}/versions`);if(response.ok){this.versions=await response.json();this.renderVersionList();this.updateVersionCount();}else{throw new Error('Failed to load versions');}}catch(error){this.showEmptyState('Error loading versions');}}
renderVersionList(){const container=this.container.querySelector('.version-list');if(this.versions.length===0){this.showEmptyState('No versions found');return;}
container.innerHTML=this.versions.map(version=>this.createVersionItem(version)).join('');container.querySelectorAll('.version-item').forEach((item,index)=>{item.addEventListener('click',()=>this.selectVersion(this.versions[index]));});}
createVersionItem(version){const date=new Date(version.created_at).toLocaleDateString();const time=new Date(version.created_at).toLocaleTimeString();const tags=this.getVersionTags(version);return`
            <div class="version-item p-3 cursor-pointer hover:bg-gray-50 transition-colors ${version.type}" data-version-id="${version.id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center mb-1">
                            <h4 class="font-medium text-gray-900 text-sm truncate">${version.description || 'Untitled Version'}</h4>
                            ${tags}
                        </div>
                        <div class="text-xs text-gray-600 mb-1">
                            <span class="font-medium">${version.created_by}</span>  ${date} ${time}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${version.changes_count || 0} changes
                        </div>
                    </div>

                    <div class="version-actions ml-2 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="compare-btn text-purple-600 hover:text-purple-800 p-1"
                                onclick="event.stopPropagation(); this.closest('.version-control-panel').versionControlPanel.compareVersion('${version.id}')">
                            <i class="fas fa-exchange-alt text-xs"></i>
                        </button>
                        <button class="restore-btn text-blue-600 hover:text-blue-800 p-1"
                                onclick="event.stopPropagation(); this.closest('.version-control-panel').versionControlPanel.restoreVersion('${version.id}')">
                            <i class="fas fa-undo text-xs"></i>
                        </button>
                        <button class="export-btn text-green-600 hover:text-green-800 p-1"
                                onclick="event.stopPropagation(); this.closest('.version-control-panel').versionControlPanel.exportVersion('${version.id}')">
                            <i class="fas fa-download text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;}
getVersionTags(version){const tags=[];if(version.type==='auto-save'){tags.push('<span class="version-tag tag-auto-save text-xs px-1 py-0.5 rounded bg-gray-100 text-gray-600 ml-1">Auto</span>');}
if(version.type==='branch'){tags.push('<span class="version-tag tag-branch text-xs px-1 py-0.5 rounded bg-green-100 text-green-700 ml-1">Branch</span>');}
if(version.is_restored){tags.push('<span class="version-tag tag-restored text-xs px-1 py-0.5 rounded bg-yellow-100 text-yellow-700 ml-1">Restored</span>');}
return tags.join('');}
showEmptyState(message){const container=this.container.querySelector('.version-list');container.innerHTML=`
            <div class="p-4 text-center text-gray-500">
                <i class="fas fa-inbox text-lg mb-2"></i>
                <p class="text-sm">${message}</p>
            </div>
        `;}
updateVersionCount(){const countElement=this.container.querySelector('h3 + span');if(countElement){countElement.textContent=`(${this.versions.length})`;}}
selectVersion(version){this.selectedVersion=version;this.container.querySelectorAll('.version-item').forEach(item=>{item.classList.remove('selected','bg-blue-50','border-l-4','border-blue-500');});const selectedItem=this.container.querySelector(`[data-version-id="${version.id}"]`);if(selectedItem){selectedItem.classList.add('selected','bg-blue-50','border-l-4','border-blue-500');}
if(this.options.onVersionSelect){this.options.onVersionSelect(version);}}
filterVersions(searchTerm){const items=this.container.querySelectorAll('.version-item');const term=searchTerm.toLowerCase();items.forEach(item=>{const text=item.textContent.toLowerCase();item.style.display=text.includes(term)?'block':'none';});}
filterVersionsByType(type){const items=this.container.querySelectorAll('.version-item');items.forEach(item=>{if(type==='all'||item.classList.contains(type)){item.style.display='block';}else{item.style.display='none';}});}
showCreateVersionModal(){const modal=document.createElement('div');modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';modal.innerHTML=`
            <div class="bg-white rounded-lg p-6 w-96">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Create Version</h3>
                    <button class="close-modal text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form class="create-version-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                                  rows="3" placeholder="Describe this version..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2">
                            <span class="text-sm text-gray-700">Auto-save version</span>
                        </label>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" class="cancel-create bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            Create Version
                        </button>
                    </div>
                </form>
            </div>
        `;document.body.appendChild(modal);modal.querySelector('.close-modal').addEventListener('click',()=>{document.body.removeChild(modal);});modal.querySelector('.cancel-create').addEventListener('click',()=>{document.body.removeChild(modal);});modal.querySelector('.create-version-form').addEventListener('submit',(e)=>{e.preventDefault();this.createVersion(modal);});}
async createVersion(modal){const description=modal.querySelector('textarea').value;const isAutoSave=modal.querySelector('input[type="checkbox"]').checked;try{const response=await fetch(`/api/floors/${this.options.floorId}/versions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({description,type:isAutoSave?'auto-save':'manual'})});if(response.ok){const newVersion=await response.json();this.versions.unshift(newVersion);this.renderVersionList();this.updateVersionCount();document.body.removeChild(modal);this.showNotification('Version created successfully','success');}else{throw new Error('Failed to create version');}}catch(error){this.showNotification('Error creating version','error');}}
async compareVersion(versionId){if(this.options.onVersionCompare){this.options.onVersionCompare(versionId);}else{window.open(`/floor_version_control.html?compare=${versionId}`,'_blank');}}
async restoreVersion(versionId){if(this.options.onVersionRestore){this.options.onVersionRestore(versionId);}else{if(confirm('Are you sure you want to restore this version?')){try{const response=await fetch(`/api/floors/${this.options.floorId}/versions/${versionId}/restore`,{method:'POST'});if(response.ok){this.showNotification('Version restored successfully','success');this.loadVersions();}else{throw new Error('Failed to restore version');}}catch(error){this.showNotification('Error restoring version','error');}}}}
async exportVersion(versionId){try{const response=await fetch(`/api/floors/${this.options.floorId}/versions/${versionId}/export`);if(response.ok){const blob=await response.blob();const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`version-${versionId}.json`;a.click();window.URL.revokeObjectURL(url);this.showNotification('Version exported successfully','success');}else{throw new Error('Failed to export version');}}catch(error){this.showNotification('Error exporting version','error');}}
undo(){this.showNotification('Undo functionality not implemented','warning');}
redo(){this.showNotification('Redo functionality not implemented','warning');}
expandToFullView(){window.open('/floor_version_control.html','_blank');}
showNotification(message,type='info'){const toast=document.createElement('div');toast.className=`fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg text-white text-sm ${
            type === 'success' ? 'bg-green-600' :
            type === 'error' ? 'bg-red-600' :
            type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
        }`;toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>{if(toast.parentElement){document.body.removeChild(toast);}},3000);}
updateFloorId(floorId){this.options.floorId=floorId;this.loadVersions();}
getSelectedVersion(){return this.selectedVersion;}
getVersions(){return this.versions;}
destroy(){if(this.container){this.container.innerHTML='';}}}
if(typeof module!=='undefined'&&module.exports){module.exports=VersionControlPanel;}
class ViewportManager{constructor(svgElement,options={}){this.svg=svgElement;this.container=svgElement.parentElement;this.currentZoom=options.initialZoom||1.0;this.panX=options.initialPanX||0;this.panY=options.initialPanY||0;this.minZoom=options.minZoom||0.1;this.maxZoom=options.maxZoom||5.0;this.zoomStep=options.zoomStep||0.1;this.wheelZoomSpeed=options.wheelZoomSpeed||0.001;this.wheelZoomSmooth=options.wheelZoomSmooth!==false;this.wheelZoomDuration=options.wheelZoomDuration||150;this.panEnabled=options.panEnabled!==false;this.panInertia=options.panInertia!==false;this.panInertiaDecay=options.panInertiaDecay||0.95;this.panInertiaDuration=options.panInertiaDuration||300;this.panBoundaries=options.panBoundaries||{enabled:true,padding:100,maxDistance:2000};this.zoomHistory=[];this.maxHistorySize=options.maxHistorySize||50;this.historyIndex=-1;this.isUpdating=false;this.updateQueue=[];this.lastUpdateTime=0;this.updateThrottle=options.updateThrottle||16;this.throttledUpdateManager=null;this.enableThrottledUpdates=options.enableThrottledUpdates!==false;this.isAnimating=false;this.targetZoom=null;this.targetPanX=null;this.targetPanY=null;this.eventHandlers=new Map();this.isPanning=false;this.panStartX=0;this.panStartY=0;this.panStartViewX=0;this.panStartViewY=0;this.panVelocityX=0;this.panVelocityY=0;this.panInertiaAnimation=null;this.hasShownPanIndicator=false;this.lastPanTime=null;this.scaleFactors={x:1.0,y:1.0};this.currentUnit='pixels';this.cullingEnabled=options.cullingEnabled!==false;this.cullingMargin=options.cullingMargin||100;this.cullingUpdateThrottle=options.cullingUpdateThrottle||50;this.lastCullingUpdate=0;this.visibleObjects=new Set();this.totalObjects=0;this.cullingStats={totalObjects:0,visibleObjects:0,culledObjects:0,cullingTime:0,lastUpdate:0};this.objectBoundsCache=new Map();this.boundsCacheExpiry=options.boundsCacheExpiry||5000;this.lastBoundsCacheCleanup=0;this.touchEnabled=options.touchEnabled!==false;this.touchZoomEnabled=options.touchZoomEnabled!==false;this.touchPanEnabled=options.touchPanEnabled!==false;this.touchGestureEnabled=options.touchGestureEnabled!==false;this.touchState={isTouching:false,touchCount:0,startTouches:[],currentTouches:[],startDistance:0,startCenter:{x:0,y:0},lastDistance:0,lastCenter:{x:0,y:0},startTime:0,lastMoveTime:0,velocity:{x:0,y:0},gestureType:null};this.touchConfig={pinchSensitivity:options.pinchSensitivity||0.01,panSensitivity:options.panSensitivity||1.0,tapThreshold:options.tapThreshold||10,tapTimeout:options.tapTimeout||300,doubleTapTimeout:options.doubleTapTimeout||300,swipeThreshold:options.swipeThreshold||50,swipeVelocity:options.swipeVelocity||0.3,longPressTimeout:options.longPressTimeout||500,touchInertia:options.touchInertia!==false,touchInertiaDecay:options.touchInertiaDecay||0.95};this.touchGestureHistory=[];this.maxGestureHistory=options.maxGestureHistory||10;this.initialize();}
initialize(){if(!this.svg||!this.container){console.error('ViewportManager: SVG element or container not found');return;}
this.container.classList.add('pan-enabled');this.connectToThrottledUpdateManager();this.updateViewport();this.setupEventListeners();this.saveZoomState();this.triggerEvent('initialized',{zoom:this.currentZoom,panX:this.panX,panY:this.panY});if(window.arxLogger){window.arxLogger.info('ViewportManager initialized',{component:'viewport_manager',version:'1.0.0'});}}
connectToThrottledUpdateManager(){if(!this.enableThrottledUpdates){if(window.arxLogger){window.arxLogger.info('ViewportManager: Throttled updates disabled',{component:'viewport_manager',feature:'throttled_updates',status:'disabled'});}
return;}
const checkThrottledUpdateManager=()=>{if(window.throttledUpdateManager){this.throttledUpdateManager=window.throttledUpdateManager;if(window.arxLogger){window.arxLogger.info('ViewportManager connected to ThrottledUpdateManager',{component:'viewport_manager',integration:'throttled_update_manager',status:'connected'});}
this.throttledUpdateManager.addEventListener('update',(data)=>{this.handleThrottledUpdate(data);});this.throttledUpdateManager.addEventListener('batchedUpdate',(data)=>{this.handleBatchedUpdate(data);});this.throttledUpdateManager.addEventListener('updateProcessed',(data)=>{this.handleUpdateProcessed(data);});}else{setTimeout(checkThrottledUpdateManager,100);}};checkThrottledUpdateManager();}
setupEventListeners(){this.container.addEventListener('wheel',this.handleWheel.bind(this),{passive:false});this.container.addEventListener('mousedown',this.handleMouseDown.bind(this));document.addEventListener('mousemove',this.handleMouseMove.bind(this));document.addEventListener('mouseup',this.handleMouseUp.bind(this));this.container.addEventListener('contextmenu',(e)=>{if(this.isPanning){e.preventDefault();}});if(this.touchEnabled){this.setupTouchEventListeners();}
document.addEventListener('keydown',this.handleKeyDown.bind(this));window.addEventListener('resize',this.handleResize.bind(this));}
setupTouchEventListeners(){this.container.addEventListener('touchstart',this.handleTouchStart.bind(this),{passive:false});this.container.addEventListener('touchmove',this.handleTouchMove.bind(this),{passive:false});this.container.addEventListener('touchend',this.handleTouchEnd.bind(this),{passive:false});this.container.addEventListener('touchcancel',this.handleTouchCancel.bind(this),{passive:false});this.container.addEventListener('touchstart',(e)=>{if(this.touchState.isTouching){e.preventDefault();}},{passive:false});this.container.addEventListener('touchmove',(e)=>{if(this.touchState.isTouching){e.preventDefault();}},{passive:false});}
handleTouchStart(event){event.preventDefault();const touches=Array.from(event.touches);this.touchState.touchCount=touches.length;this.touchState.startTouches=touches.map(touch=>({id:touch.identifier,x:touch.clientX,y:touch.clientY}));this.touchState.currentTouches=[...this.touchState.startTouches];this.touchState.startTime=performance.now();this.touchState.lastMoveTime=this.touchState.startTime;this.touchState.isTouching=true;this.touchState.gestureType=null;if(touches.length===2){this.touchState.startDistance=this.calculateTouchDistance(touches[0],touches[1]);this.touchState.startCenter=this.calculateTouchCenter(touches[0],touches[1]);this.touchState.lastDistance=this.touchState.startDistance;this.touchState.lastCenter={...this.touchState.startCenter};}
this.container.classList.add('touching');this.triggerEvent('touchStart',{touchCount:this.touchState.touchCount,touches:this.touchState.startTouches});}
handleTouchMove(event){event.preventDefault();if(!this.touchState.isTouching)return;const touches=Array.from(event.touches);this.touchState.currentTouches=touches.map(touch=>({id:touch.identifier,x:touch.clientX,y:touch.clientY}));const currentTime=performance.now();const timeDelta=currentTime-this.touchState.lastMoveTime;if(touches.length===1&&this.touchPanEnabled){this.handleSingleTouchMove(touches[0],timeDelta);}else if(touches.length===2&&this.touchZoomEnabled){this.handlePinchZoom(touches[0],touches[1],timeDelta);}
this.touchState.lastMoveTime=currentTime;this.triggerEvent('touchMove',{touchCount:touches.length,touches:this.touchState.currentTouches,gestureType:this.touchState.gestureType});}
handleTouchEnd(event){event.preventDefault();if(!this.touchState.isTouching)return;const currentTime=performance.now();const touchDuration=currentTime-this.touchState.startTime;this.determineTouchGesture(touchDuration);if(this.touchState.gestureType==='pan'&&this.touchConfig.touchInertia){this.startTouchInertia();}
this.saveZoomState();this.touchState.isTouching=false;this.touchState.touchCount=0;this.touchState.gestureType=null;this.container.classList.remove('touching');this.triggerEvent('touchEnd',{gestureType:this.touchState.gestureType,duration:touchDuration,velocity:this.touchState.velocity});}
handleTouchCancel(event){event.preventDefault();this.touchState.isTouching=false;this.touchState.touchCount=0;this.touchState.gestureType=null;this.container.classList.remove('touching');this.triggerEvent('touchCancel');}
handleSingleTouchMove(touch,timeDelta){const startTouch=this.touchState.startTouches[0];if(!startTouch)return;const deltaX=touch.clientX-startTouch.x;const deltaY=touch.clientY-startTouch.y;const distance=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(distance>this.touchConfig.tapThreshold){this.touchState.gestureType='pan';const panDeltaX=deltaX/this.currentZoom*this.touchConfig.panSensitivity;const panDeltaY=deltaY/this.currentZoom*this.touchConfig.panSensitivity;const newPanX=this.panX+panDeltaX;const newPanY=this.panY+panDeltaY;const constrainedPan=this.applyPanBoundaries(newPanX,newPanY);this.panX=constrainedPan.x;this.panY=constrainedPan.y;if(timeDelta>0){this.touchState.velocity.x=deltaX/timeDelta;this.touchState.velocity.y=deltaY/timeDelta;}
if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('touchPan',{panX:this.panX,panY:this.panY,deltaX:deltaX,deltaY:deltaY});}else{this.updateViewport();}
this.touchState.startTouches[0]={id:startTouch.id,x:touch.clientX,y:touch.clientY};}}
handlePinchZoom(touch1,touch2,timeDelta){const currentDistance=this.calculateTouchDistance(touch1,touch2);const currentCenter=this.calculateTouchCenter(touch1,touch2);const distanceRatio=currentDistance/this.touchState.startDistance;const zoomFactor=Math.pow(distanceRatio,this.touchConfig.pinchSensitivity);const rect=this.container.getBoundingClientRect();const centerX=currentCenter.x-rect.left;const centerY=currentCenter.y-rect.top;this.zoomAtPoint(zoomFactor,centerX,centerY,true);const centerDeltaX=currentCenter.x-this.touchState.startCenter.x;const centerDeltaY=currentCenter.y-this.touchState.startCenter.y;if(Math.abs(centerDeltaX)>5||Math.abs(centerDeltaY)>5){const panDeltaX=centerDeltaX/this.currentZoom*this.touchConfig.panSensitivity;const panDeltaY=centerDeltaY/this.currentZoom*this.touchConfig.panSensitivity;const newPanX=this.panX+panDeltaX;const newPanY=this.panY+panDeltaY;const constrainedPan=this.applyPanBoundaries(newPanX,newPanY);this.panX=constrainedPan.x;this.panY=constrainedPan.y;}
this.touchState.lastDistance=currentDistance;this.touchState.lastCenter={...currentCenter};this.touchState.gestureType='pinch';if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('touchZoom',{zoom:this.currentZoom,zoomFactor:zoomFactor,centerX:centerX,centerY:centerY});}else{this.updateViewport();}}
calculateTouchDistance(touch1,touch2){const dx=touch1.clientX-touch2.clientX;const dy=touch1.clientY-touch2.clientY;return Math.sqrt(dx*dx+dy*dy);}
calculateTouchCenter(touch1,touch2){return{x:(touch1.clientX+touch2.clientX)/2,y:(touch1.clientY+touch2.clientY)/2};}
determineTouchGesture(touchDuration){const startTouch=this.touchState.startTouches[0];const currentTouch=this.touchState.currentTouches[0];if(!startTouch||!currentTouch)return;const deltaX=currentTouch.x-startTouch.x;const deltaY=currentTouch.y-startTouch.y;const distance=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(distance<this.touchConfig.tapThreshold){if(touchDuration<this.touchConfig.tapTimeout){this.touchState.gestureType='tap';this.handleTapGesture();}else{this.touchState.gestureType='long-press';this.handleLongPressGesture();}}else if(distance>this.touchConfig.swipeThreshold){const velocity=distance/touchDuration;if(velocity>this.touchConfig.swipeVelocity){this.touchState.gestureType='swipe';this.handleSwipeGesture(deltaX,deltaY,velocity);}else{this.touchState.gestureType='pan';}}else{this.touchState.gestureType='pan';}
this.addToGestureHistory(this.touchState.gestureType);}
handleTapGesture(){const startTouch=this.touchState.startTouches[0];if(!startTouch)return;const lastGesture=this.touchGestureHistory[this.touchGestureHistory.length-1];if(lastGesture&&lastGesture.type==='tap'){const timeSinceLastTap=performance.now()-lastGesture.timestamp;if(timeSinceLastTap<this.touchConfig.doubleTapTimeout){this.touchState.gestureType='double-tap';this.handleDoubleTapGesture();return;}}
this.triggerEvent('tap',{x:startTouch.x,y:startTouch.y,timestamp:performance.now()});}
handleDoubleTapGesture(){const startTouch=this.touchState.startTouches[0];if(!startTouch)return;this.resetView();this.triggerEvent('doubleTap',{x:startTouch.x,y:startTouch.y,timestamp:performance.now()});}
handleLongPressGesture(){const startTouch=this.touchState.startTouches[0];if(!startTouch)return;this.triggerEvent('longPress',{x:startTouch.x,y:startTouch.y,timestamp:performance.now()});}
handleSwipeGesture(deltaX,deltaY,velocity){const startTouch=this.touchState.startTouches[0];if(!startTouch)return;const angle=Math.atan2(deltaY,deltaX)*180/Math.PI;let direction='unknown';if(angle>=-45&&angle<=45)direction='right';else if(angle>=45&&angle<=135)direction='down';else if(angle>=135||angle<=-135)direction='left';else direction='up';this.triggerEvent('swipe',{direction:direction,deltaX:deltaX,deltaY:deltaY,velocity:velocity,x:startTouch.x,y:startTouch.y,timestamp:performance.now()});}
startTouchInertia(){if(!this.touchConfig.touchInertia||(Math.abs(this.touchState.velocity.x)<0.1&&Math.abs(this.touchState.velocity.y)<0.1)){return;}
const startTime=performance.now();const startPanX=this.panX;const startPanY=this.panY;const startVelocityX=this.touchState.velocity.x/this.currentZoom;const startVelocityY=this.touchState.velocity.y/this.currentZoom;const animate=(currentTime)=>{const elapsed=currentTime-startTime;const progress=elapsed/this.panInertiaDuration;if(progress>=1){return;}
const decay=Math.pow(this.touchConfig.touchInertiaDecay,progress*10);const currentVelocityX=startVelocityX*decay;const currentVelocityY=startVelocityY*decay;const newPanX=startPanX+currentVelocityX*progress*10;const newPanY=startPanY+currentVelocityY*progress*10;const constrainedPan=this.applyPanBoundaries(newPanX,newPanY);this.panX=constrainedPan.x;this.panY=constrainedPan.y;if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('touchInertia',{panX:this.panX,panY:this.panY,velocityX:currentVelocityX,velocityY:currentVelocityY});}else{this.updateViewport();}
if(Math.abs(currentVelocityX)>0.1||Math.abs(currentVelocityY)>0.1){requestAnimationFrame(animate);}};requestAnimationFrame(animate);}
addToGestureHistory(gestureType){this.touchGestureHistory.push({type:gestureType,timestamp:performance.now()});if(this.touchGestureHistory.length>this.maxGestureHistory){this.touchGestureHistory.shift();}}
enableTouch(){this.touchEnabled=true;this.setupTouchEventListeners();}
disableTouch(){this.touchEnabled=false;}
getTouchConfig(){return{...this.touchConfig};}
updateTouchConfig(newConfig){Object.assign(this.touchConfig,newConfig);}
handleWheel(event){event.preventDefault();const isCtrlZoom=event.ctrlKey||event.metaKey;if(isCtrlZoom){this.handleZoomWheel(event);}else{this.handleScrollWheel(event);}}
handleZoomWheel(event){const delta=event.deltaY;const zoomSpeed=this.wheelZoomSpeed;const zoomFactor=1-(delta*zoomSpeed);const rect=this.container.getBoundingClientRect();const mouseX=event.clientX-rect.left;const mouseY=event.clientY-rect.top;this.zoomAtPoint(zoomFactor,mouseX,mouseY,this.wheelZoomSmooth);this.showZoomFeedback(event);}
handleScrollWheel(event){event.preventDefault();}
showZoomFeedback(event){this.container.classList.add('zooming');setTimeout(()=>{this.container.classList.remove('zooming');},200);if(this.currentZoom<=this.minZoom||this.currentZoom>=this.maxZoom){this.showZoomConstraint();}}
showZoomConstraint(){let constraintElement=document.getElementById('zoom-constraint');if(!constraintElement){constraintElement=document.createElement('div');constraintElement.id='zoom-constraint';constraintElement.className='zoom-constraint';this.container.appendChild(constraintElement);}
const message=this.currentZoom<=this.minZoom?`Min zoom: ${Math.round(this.minZoom * 100)}%`:`Max zoom: ${Math.round(this.maxZoom * 100)}%`;constraintElement.textContent=message;constraintElement.classList.add('show');setTimeout(()=>{constraintElement.classList.remove('show');},2000);}
isAtZoomConstraint(){return this.currentZoom<=this.minZoom||this.currentZoom>=this.maxZoom;}
getZoomConstraintMessage(){if(this.currentZoom<=this.minZoom){return`Min zoom: ${Math.round(this.minZoom * 100)}%`;}else if(this.currentZoom>=this.maxZoom){return`Max zoom: ${Math.round(this.maxZoom * 100)}%`;}
return null;}
applyZoomWithConstraints(newZoom,newPanX,newPanY,smooth=false){const wasAtConstraint=this.isAtZoomConstraint();if(smooth){this.applySmoothZoom(newZoom,newPanX,newPanY);}else{this.currentZoom=newZoom;this.panX=newPanX;this.panY=newPanY;this.queueViewportUpdate();}
const isAtConstraint=this.isAtZoomConstraint();if(isAtConstraint&&!wasAtConstraint){this.showZoomConstraint();}
this.updateZoomButtonStates();}
updateZoomButtonStates(){const zoomInBtn=document.getElementById('zoom-in');const zoomOutBtn=document.getElementById('zoom-out');if(zoomInBtn){zoomInBtn.disabled=this.currentZoom>=this.maxZoom;zoomInBtn.title=this.currentZoom>=this.maxZoom?`Max zoom: ${Math.round(this.maxZoom * 100)}%`:'Zoom In (Ctrl + +)';}
if(zoomOutBtn){zoomOutBtn.disabled=this.currentZoom<=this.minZoom;zoomOutBtn.title=this.currentZoom<=this.minZoom?`Min zoom: ${Math.round(this.minZoom * 100)}%`:'Zoom Out (Ctrl + -)';}}
handleMouseDown(event){if(event.button===1&&this.panEnabled){event.preventDefault();this.startPan(event);}}
startPan(event){this.isPanning=true;this.panStartX=event.clientX;this.panStartY=event.clientY;this.panStartViewX=this.panX;this.panStartViewY=this.panY;this.panVelocityX=0;this.panVelocityY=0;if(this.panInertiaAnimation){cancelAnimationFrame(this.panInertiaAnimation);this.panInertiaAnimation=null;}
this.container.classList.add('panning');this.container.style.cursor='grabbing';if(!this.hasShownPanIndicator){this.showPanModeIndicator();this.hasShownPanIndicator=true;}
this.triggerEvent('panStart',{x:this.panStartX,y:this.panStartY});}
handleMouseMove(event){if(!this.isPanning)return;const deltaX=event.clientX-this.panStartX;const deltaY=event.clientY-this.panStartY;const newPanX=this.panStartViewX+deltaX/this.currentZoom;const newPanY=this.panStartViewY+deltaY/this.currentZoom;const boundedPan=this.applyPanBoundaries(newPanX,newPanY);this.panX=boundedPan.x;this.panY=boundedPan.y;if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('pan',{panX:this.panX,panY:this.panY,deltaX:deltaX,deltaY:deltaY});}else{this.updateViewport();}
const currentTime=performance.now();if(this.lastPanTime){const timeDelta=currentTime-this.lastPanTime;if(timeDelta>0){this.panVelocityX=deltaX/timeDelta;this.panVelocityY=deltaY/timeDelta;}}
this.lastPanTime=currentTime;this.showPanModeIndicator();}
handleMouseUp(event){if(this.isPanning){this.endPan();}}
endPan(){this.isPanning=false;this.container.classList.remove('panning');this.container.style.cursor='';if(Math.abs(this.panVelocityX)>0.5||Math.abs(this.panVelocityY)>0.5){this.showPanVelocityIndicator();}
if(this.panInertia&&(Math.abs(this.panVelocityX)>0.1||Math.abs(this.panVelocityY)>0.1)){this.showPanInertiaIndicator();this.startPanInertia();}
this.saveZoomState();this.triggerEvent('panEnd',{x:this.panX,y:this.panY,velocityX:this.panVelocityX,velocityY:this.panVelocityY});}
applyPanBoundaries(panX,panY){if(!this.panBoundaries.enabled){return{x:panX,y:panY};}
const rect=this.container.getBoundingClientRect();const containerWidth=rect.width;const containerHeight=rect.height;const maxPanX=Math.max(0,(containerWidth*this.currentZoom-containerWidth)/2+this.panBoundaries.padding);const maxPanY=Math.max(0,(containerHeight*this.currentZoom-containerHeight)/2+this.panBoundaries.padding);const minPanX=-maxPanX;const minPanY=-maxPanY;const maxDistance=this.panBoundaries.maxDistance;const distanceFromCenter=Math.sqrt(panX*panX+panY*panY);if(distanceFromCenter>maxDistance){const scale=maxDistance/distanceFromCenter;panX*=scale;panY*=scale;}
const boundaryResistance=0.3;if(panX>maxPanX){const overflow=panX-maxPanX;panX=maxPanX+overflow*boundaryResistance;}else if(panX<minPanX){const overflow=minPanX-panX;panX=minPanX-overflow*boundaryResistance;}
if(panY>maxPanY){const overflow=panY-maxPanY;panY=maxPanY+overflow*boundaryResistance;}else if(panY<minPanY){const overflow=minPanY-panY;panY=minPanY-overflow*boundaryResistance;}
return{x:panX,y:panY};}
startPanInertia(){const startTime=performance.now();const startPanX=this.panX;const startPanY=this.panY;const startVelocityX=this.panVelocityX;const startVelocityY=this.panVelocityY;const animate=(currentTime)=>{const elapsed=currentTime-startTime;const progress=elapsed/this.panInertiaDuration;if(progress>=1){this.panInertiaAnimation=null;return;}
const decay=Math.pow(this.panInertiaDecay,progress*10);const currentVelocityX=startVelocityX*decay;const currentVelocityY=startVelocityY*decay;const newPanX=startPanX+currentVelocityX*progress*10;const newPanY=startPanY+currentVelocityY*progress*10;const constrainedPan=this.applyPanBoundaries(newPanX,newPanY);this.panX=constrainedPan.x;this.panY=constrainedPan.y;this.queueViewportUpdate();if(Math.abs(currentVelocityX)>0.1||Math.abs(currentVelocityY)>0.1){this.panInertiaAnimation=requestAnimationFrame(animate);}else{this.panInertiaAnimation=null;}};this.panInertiaAnimation=requestAnimationFrame(animate);}
stopPanInertia(){if(this.panInertiaAnimation){cancelAnimationFrame(this.panInertiaAnimation);this.panInertiaAnimation=null;}
this.panVelocityX=0;this.panVelocityY=0;}
showPanBoundaryFeedback(){let feedbackElement=document.getElementById('pan-boundary-feedback');if(!feedbackElement){feedbackElement=document.createElement('div');feedbackElement.id='pan-boundary-feedback';feedbackElement.className='pan-boundary-feedback';this.container.appendChild(feedbackElement);}
feedbackElement.classList.add('show');setTimeout(()=>{feedbackElement.classList.remove('show');},1000);}
showPanInertiaIndicator(){let indicatorElement=document.getElementById('pan-inertia-indicator');if(!indicatorElement){indicatorElement=document.createElement('div');indicatorElement.id='pan-inertia-indicator';indicatorElement.className='pan-inertia-indicator';this.container.appendChild(indicatorElement);}
indicatorElement.classList.add('show');setTimeout(()=>{indicatorElement.classList.remove('show');},1000);}
showPanVelocityIndicator(){let indicatorElement=document.getElementById('pan-velocity-indicator');if(!indicatorElement){indicatorElement=document.createElement('div');indicatorElement.id='pan-velocity-indicator';indicatorElement.className='pan-velocity-indicator';this.container.appendChild(indicatorElement);}
const velocityX=Math.round(this.panVelocityX*100)/100;const velocityY=Math.round(this.panVelocityY*100)/100;const speed=Math.sqrt(velocityX*velocityX+velocityY*velocityY);indicatorElement.textContent=`V: (${velocityX}, ${velocityY}) | S: ${speed.toFixed(2)}`;indicatorElement.classList.add('show');setTimeout(()=>{indicatorElement.classList.remove('show');},2000);}
showPanModeIndicator(){let indicatorElement=document.getElementById('pan-mode-indicator');if(!indicatorElement){indicatorElement=document.createElement('div');indicatorElement.id='pan-mode-indicator';indicatorElement.className='pan-mode-indicator';indicatorElement.textContent='Middle mouse to pan';this.container.appendChild(indicatorElement);}
indicatorElement.classList.add('show');setTimeout(()=>{indicatorElement.classList.remove('show');},3000);}
showPanBoundaryWarning(){let warningElement=document.getElementById('pan-boundary-warning');if(!warningElement){warningElement=document.createElement('div');warningElement.id='pan-boundary-warning';warningElement.className='pan-boundary-warning';warningElement.textContent='Pan boundary reached';this.container.appendChild(warningElement);}
warningElement.classList.add('show');setTimeout(()=>{warningElement.classList.remove('show');},1500);}
isAtPanBoundary(){if(!this.panBoundaries.enabled)return false;const rect=this.container.getBoundingClientRect();const containerWidth=rect.width;const containerHeight=rect.height;const maxPanX=Math.max(0,(containerWidth*this.currentZoom-containerWidth)/2+this.panBoundaries.padding);const maxPanY=Math.max(0,(containerHeight*this.currentZoom-containerHeight)/2+this.panBoundaries.padding);const minPanX=-maxPanX;const minPanY=-maxPanY;return this.panX>=maxPanX||this.panX<=minPanX||this.panY>=maxPanY||this.panY<=minPanY;}
enablePan(){this.panEnabled=true;this.container.classList.add('pan-enabled');this.triggerEvent('panEnabled');}
disablePan(){this.panEnabled=false;this.container.classList.remove('pan-enabled');if(this.isPanning){this.endPan();}
this.triggerEvent('panDisabled');}
togglePan(){if(this.panEnabled){this.disablePan();}else{this.enablePan();}}
isPanEnabled(){return this.panEnabled;}
setPanBoundaries(boundaries){this.panBoundaries={...this.panBoundaries,...boundaries};this.triggerEvent('panBoundariesChanged',this.panBoundaries);}
getPanBoundaries(){return{...this.panBoundaries};}
handleKeyDown(event){if(event.target.tagName==='INPUT'||event.target.tagName==='TEXTAREA'||event.target.contentEditable==='true'){return;}
if((event.ctrlKey||event.metaKey)&&(event.key==='+'||event.key==='=')){event.preventDefault();this.zoomIn();this.showKeyboardShortcutFeedback('Zoom In','Ctrl + +');}else if((event.ctrlKey||event.metaKey)&&event.key==='-'){event.preventDefault();this.zoomOut();this.showKeyboardShortcutFeedback('Zoom Out','Ctrl + -');}else if((event.ctrlKey||event.metaKey)&&event.key==='0'){event.preventDefault();this.resetView();this.showKeyboardShortcutFeedback('Reset View','Ctrl + 0');}else if((event.ctrlKey||event.metaKey)&&event.key==='f'){event.preventDefault();this.fitToView();this.showKeyboardShortcutFeedback('Fit to View','Ctrl + F');}
if((event.ctrlKey||event.metaKey)&&event.key==='z'&&!event.shiftKey){event.preventDefault();this.undoZoom();this.showKeyboardShortcutFeedback('Undo Zoom','Ctrl + Z');}else if((event.ctrlKey||event.metaKey)&&event.key==='z'&&event.shiftKey){event.preventDefault();this.redoZoom();this.showKeyboardShortcutFeedback('Redo Zoom','Ctrl + Shift + Z');}else if((event.ctrlKey||event.metaKey)&&event.key==='y'){event.preventDefault();this.redoZoom();this.showKeyboardShortcutFeedback('Redo Zoom','Ctrl + Y');}
if(event.key==='ArrowUp'||event.key==='ArrowDown'||event.key==='ArrowLeft'||event.key==='ArrowRight'){if(event.shiftKey){event.preventDefault();const panStep=50;let deltaX=0;let deltaY=0;switch(event.key){case'ArrowUp':deltaY=-panStep;break;case'ArrowDown':deltaY=panStep;break;case'ArrowLeft':deltaX=-panStep;break;case'ArrowRight':deltaX=panStep;break;}
this.panX+=deltaX;this.panY+=deltaY;this.queueViewportUpdate();this.saveZoomState();this.showKeyboardShortcutFeedback('Pan',`Shift + ${event.key}`);}}
if((event.ctrlKey||event.metaKey)&&event.key>='1'&&event.key<='9'){event.preventDefault();const zoomLevel=parseInt(event.key)/10;this.setZoom(zoomLevel);this.showKeyboardShortcutFeedback(`Zoom ${Math.round(zoomLevel * 100)}%`,`Ctrl + ${event.key}`);}
if(event.key==='p'&&!event.ctrlKey&&!event.metaKey){event.preventDefault();this.togglePan();const status=this.isPanEnabled()?'Enabled':'Disabled';this.showKeyboardShortcutFeedback(`Pan ${status}`,'P');}
if(event.key==='F1'||((event.ctrlKey||event.metaKey)&&event.key==='h')){event.preventDefault();this.toggleHelpOverlay();}
if(event.key==='Escape'){event.preventDefault();this.cancelOperations();}}
showKeyboardShortcutFeedback(action,shortcut){let feedbackElement=document.getElementById('keyboard-shortcut-feedback');if(!feedbackElement){feedbackElement=document.createElement('div');feedbackElement.id='keyboard-shortcut-feedback';feedbackElement.className='keyboard-shortcut-feedback';this.container.appendChild(feedbackElement);}
feedbackElement.innerHTML=`
            <div class="shortcut-action">${action}</div>
            <div class="shortcut-keys">${shortcut}</div>
        `;feedbackElement.classList.add('show');setTimeout(()=>{feedbackElement.classList.remove('show');},2000);}
toggleHelpOverlay(){let helpOverlay=document.getElementById('help-overlay');if(!helpOverlay){helpOverlay=this.createHelpOverlay();}
if(helpOverlay.classList.contains('show')){helpOverlay.classList.remove('show');}else{helpOverlay.classList.add('show');}}
createHelpOverlay(){const helpOverlay=document.createElement('div');helpOverlay.id='help-overlay';helpOverlay.className='help-overlay';const helpContent=document.createElement('div');helpContent.className='help-content';helpContent.innerHTML=`
            <div class="help-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="help-close" onclick="this.closest('.help-overlay').classList.remove('show')">&times;</button>
            </div>
            <div class="help-grid">
                <div class="help-section">
                    <h3>Zoom Controls</h3>
                    <div class="space-y-1">
                        <div><kbd>Ctrl</kbd> + <kbd>+</kbd> Zoom In</div>
                        <div><kbd>Ctrl</kbd> + <kbd>-</kbd> Zoom Out</div>
                        <div><kbd>Ctrl</kbd> + <kbd>0</kbd> Reset View</div>
                        <div><kbd>Ctrl</kbd> + <kbd>F</kbd> Fit to View</div>
                        <div><kbd>Ctrl</kbd> + <kbd>1-9</kbd> Zoom Presets (10%-90%)</div>
                    </div>
                </div>
                <div class="help-section">
                    <h3>Pan Controls</h3>
                    <div class="space-y-1">
                        <div><kbd>Shift</kbd> + <kbd></kbd> Pan View</div>
                        <div><kbd>P</kbd> Toggle Pan Mode</div>
                        <div><kbd>Middle Mouse</kbd> Drag to Pan</div>
                    </div>
                </div>
                <div class="help-section">
                    <h3>History</h3>
                    <div class="space-y-1">
                        <div><kbd>Ctrl</kbd> + <kbd>Z</kbd> Undo Zoom</div>
                        <div><kbd>Ctrl</kbd> + <kbd>Y</kbd> Redo Zoom</div>
                        <div><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>Z</kbd> Redo Zoom</div>
                    </div>
                </div>
                <div class="help-section">
                    <h3>General</h3>
                    <div class="space-y-1">
                        <div><kbd>F1</kbd> or <kbd>Ctrl</kbd> + <kbd>H</kbd> Show/Hide Help</div>
                        <div><kbd>Esc</kbd> Cancel Operations</div>
                    </div>
                </div>
            </div>
        `;helpOverlay.appendChild(helpContent);document.body.appendChild(helpOverlay);helpOverlay.addEventListener('click',(e)=>{if(e.target===helpOverlay){helpOverlay.classList.remove('show');}});return helpOverlay;}
cancelOperations(){this.stopPanInertia();if(this.isPanning){this.endPan();}
const helpOverlay=document.getElementById('help-overlay');if(helpOverlay&&helpOverlay.classList.contains('show')){helpOverlay.classList.remove('show');}
this.container.style.cursor='';this.container.classList.remove('panning');this.showKeyboardShortcutFeedback('Operations Cancelled','Esc');}
handleResize(){clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(()=>{this.updateViewport();},100);}
zoomIn(){this.zoomAtPoint(1+this.zoomStep);}
zoomOut(){this.zoomAtPoint(1-this.zoomStep);}
zoomAtPoint(zoomFactor,centerX=null,centerY=null,smooth=false){const newZoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.currentZoom*zoomFactor));if(Math.abs(newZoom-this.currentZoom)<0.001)return;const center=centerX!==null&&centerY!==null?this.screenToSVG(centerX,centerY):{x:this.container.clientWidth/2,y:this.container.clientHeight/2};const zoomRatio=newZoom/this.currentZoom;const newPanX=center.x-(center.x-this.panX)*zoomRatio;const newPanY=center.y-(center.y-this.panY)*zoomRatio;this.applyZoomWithConstraints(newZoom,newPanX,newPanY,smooth);if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('zoom',{zoom:this.currentZoom,zoomFactor:zoomFactor,centerX:center.x,centerY:center.y});}}
applyZoomWithConstraints(newZoom,newPanX,newPanY,smooth=false){const constrainedPan=this.applyPanBoundaries(newPanX,newPanY);this.currentZoom=newZoom;this.panX=constrainedPan.x;this.panY=constrainedPan.y;if(smooth){this.applySmoothZoom(newZoom,this.panX,this.panY);}else{if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('viewport',{zoom:this.currentZoom,panX:this.panX,panY:this.panY});}else{this.updateViewport();}}
this.saveZoomState();this.triggerEvent('zoomChanged',{zoom:this.currentZoom,panX:this.panX,panY:this.panY});}
applySmoothZoom(targetZoom,targetPanX,targetPanY){if(this.isAnimating)return;this.isAnimating=true;this.targetZoom=targetZoom;this.targetPanX=targetPanX;this.targetPanY=targetPanY;const startZoom=this.currentZoom;const startPanX=this.panX;const startPanY=this.panY;const startTime=performance.now();const duration=this.wheelZoomDuration;const animate=(currentTime)=>{if(!this.isAnimating)return;const elapsed=currentTime-startTime;const progress=Math.min(elapsed/duration,1);const easeProgress=this.easeInOutCubic(progress);this.currentZoom=startZoom+(targetZoom-startZoom)*easeProgress;this.panX=startPanX+(targetPanX-startPanX)*easeProgress;this.panY=startPanY+(targetPanY-startPanY)*easeProgress;if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('viewport',{zoom:this.currentZoom,panX:this.panX,panY:this.panY});}else{this.updateViewport();}
if(progress<1){requestAnimationFrame(animate);}else{this.isAnimating=false;this.targetZoom=null;this.targetPanX=null;this.targetPanY=null;}};requestAnimationFrame(animate);}
easeInOutCubic(t){return t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;}
resetView(){this.currentZoom=1.0;this.panX=0;this.panY=0;this.updateViewport();this.saveZoomState();this.triggerEvent('viewReset');}
fitToView(){const objects=this.svg.querySelectorAll('[data-placed-symbol="true"], .bim-object');if(objects.length===0)return;let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;objects.forEach(obj=>{const bbox=obj.getBBox();minX=Math.min(minX,bbox.x);minY=Math.min(minY,bbox.y);maxX=Math.max(maxX,bbox.x+bbox.width);maxY=Math.max(maxY,bbox.y+bbox.height);});const padding=50;minX-=padding;minY-=padding;maxX+=padding;maxY+=padding;const containerRect=this.container.getBoundingClientRect();const scaleX=containerRect.width/(maxX-minX);const scaleY=containerRect.height/(maxY-minY);const scale=Math.min(scaleX,scaleY,this.maxZoom);const centerX=(minX+maxX)/2;const centerY=(minY+maxY)/2;this.currentZoom=scale;this.panX=containerRect.width/2-centerX*scale;this.panY=containerRect.height/2-centerY*scale;this.updateViewport();this.saveZoomState();this.triggerEvent('fitToView');}
screenToSVG(screenX,screenY){const pt=this.svg.createSVGPoint();pt.x=screenX;pt.y=screenY;const svgPoint=pt.matrixTransform(this.svg.getScreenCTM().inverse());return{x:svgPoint.x,y:svgPoint.y};}
svgToScreen(svgX,svgY){const pt=this.svg.createSVGPoint();pt.x=svgX;pt.y=svgY;const screenPoint=pt.matrixTransform(this.svg.getScreenCTM());return{x:screenPoint.x,y:screenPoint.y};}
getViewportTransform(){return{translateX:this.panX,translateY:this.panY,scale:this.currentZoom};}
updateViewport(){if(this.isUpdating)return;if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('viewport',{zoom:this.currentZoom,panX:this.panX,panY:this.panY});return;}
this.performViewportUpdate();}
performViewportUpdate(){this.isUpdating=true;try{const transform=`translate(${this.panX},${this.panY}) scale(${this.currentZoom})`;const viewport=this.svg.querySelector('#svg-viewport');if(viewport){viewport.setAttribute('transform',transform);}
this.updateZoomDisplay();this.updateZoomButtonStates();this.triggerEvent('viewportChanged',{zoom:this.currentZoom,panX:this.panX,panY:this.panY,transform:transform});}catch(error){console.error('Error updating viewport:',error);}finally{this.isUpdating=false;}}
updateZoomDisplay(){const zoomDisplay=document.getElementById('zoom-level');if(zoomDisplay){zoomDisplay.textContent=`${Math.round(this.currentZoom * 100)}%`;}}
saveZoomState(){const state={zoom:this.currentZoom,panX:this.panX,panY:this.panY,timestamp:Date.now()};this.zoomHistory=this.zoomHistory.slice(0,this.historyIndex+1);this.zoomHistory.push(state);this.historyIndex++;if(this.zoomHistory.length>this.maxHistorySize){this.zoomHistory.shift();this.historyIndex--;}}
undoZoom(){if(this.historyIndex>0){this.historyIndex--;const state=this.zoomHistory[this.historyIndex];this.restoreZoomState(state);}}
redoZoom(){if(this.historyIndex<this.zoomHistory.length-1){this.historyIndex++;const state=this.zoomHistory[this.historyIndex];this.restoreZoomState(state);}}
restoreZoomState(state){this.currentZoom=state.zoom;this.panX=state.panX;this.panY=state.panY;this.updateViewport();this.triggerEvent('zoomRestored',state);}
getZoom(){return this.currentZoom;}
setZoom(zoom){const newZoom=Math.max(this.minZoom,Math.min(this.maxZoom,zoom));if(newZoom!==this.currentZoom){this.currentZoom=newZoom;this.updateViewport();this.saveZoomState();}}
getPan(){return{x:this.panX,y:this.panY};}
setPan(x,y){this.panX=x;this.panY=y;this.updateViewport();this.triggerEvent('panChanged',{x:this.panX,y:this.panY});}
setScaleFactors(scaleX,scaleY,unit='pixels'){this.scaleFactors.x=scaleX;this.scaleFactors.y=scaleY;this.currentUnit=unit;this.triggerEvent('scaleFactorsChanged',{x:this.scaleFactors.x,y:this.scaleFactors.y,unit:this.currentUnit});if(window.arxLogger){window.arxLogger.info('ViewportManager: Scale factors updated',{component:'viewport_manager',scale_x:scaleX,scale_y:scaleY,unit:unit});}}
getScaleFactors(){return{x:this.scaleFactors.x,y:this.scaleFactors.y,unit:this.currentUnit};}
screenToRealWorld(screenX,screenY){const svgCoords=this.screenToSVG(screenX,screenY);return this.svgToRealWorld(svgCoords.x,svgCoords.y);}
realWorldToScreen(realWorldX,realWorldY){const svgCoords=this.realWorldToSVG(realWorldX,realWorldY);return this.svgToScreen(svgCoords.x,svgCoords.y);}
svgToRealWorld(svgX,svgY){return{x:svgX*this.scaleFactors.x,y:svgY*this.scaleFactors.y};}
realWorldToSVG(realWorldX,realWorldY){return{x:realWorldX/this.scaleFactors.x,y:realWorldY/this.scaleFactors.y};}
getRealWorldDistance(point1,point2){const dx=(point2.x-point1.x)*this.scaleFactors.x;const dy=(point2.y-point1.y)*this.scaleFactors.y;return Math.sqrt(dx*dx+dy*dy);}
getRealWorldArea(width,height){const realWidth=width*this.scaleFactors.x;const realHeight=height*this.scaleFactors.y;return realWidth*realHeight;}
isUniformScale(){const tolerance=0.01;return Math.abs(this.scaleFactors.x-this.scaleFactors.y)<tolerance;}
getScaleRatio(){if(this.isUniformScale()){const ratio=1/this.scaleFactors.x;return`1:${ratio.toFixed(2)}`;}else{const ratioX=1/this.scaleFactors.x;const ratioY=1/this.scaleFactors.y;return`X:1:${ratioX.toFixed(2)} Y:1:${ratioY.toFixed(2)}`;}}
addEventListener(event,handler){if(!this.eventHandlers.has(event)){this.eventHandlers.set(event,[]);}
this.eventHandlers.get(event).push(handler);}
removeEventListener(event,handler){if(this.eventHandlers.has(event)){const handlers=this.eventHandlers.get(event);const index=handlers.indexOf(handler);if(index>-1){handlers.splice(index,1);}}}
triggerEvent(event,data={}){if(this.eventHandlers.has(event)){this.eventHandlers.get(event).forEach(handler=>{try{handler(data);}catch(error){console.error(`Error in event handler for ${event}:`,error);}});}}
getViewportBounds(){const rect=this.container.getBoundingClientRect();const margin=this.cullingMargin;return{left:-this.panX/this.currentZoom-margin,top:-this.panY/this.currentZoom-margin,right:(-this.panX+rect.width)/this.currentZoom+margin,bottom:(-this.panY+rect.height)/this.currentZoom+margin,width:rect.width/this.currentZoom+(margin*2),height:rect.height/this.currentZoom+(margin*2)};}
getObjectBounds(object){const objectId=object.getAttribute('data-object-id')||object.id||object.dataset.placedSymbol;if(!objectId){return this.calculateObjectBounds(object);}
const cached=this.objectBoundsCache.get(objectId);if(cached&&Date.now()-cached.timestamp<this.boundsCacheExpiry){return cached.bounds;}
const bounds=this.calculateObjectBounds(object);this.objectBoundsCache.set(objectId,{bounds:bounds,timestamp:Date.now()});return bounds;}
calculateObjectBounds(object){try{const bbox=object.getBBox();const transform=object.transform.baseVal;let x=bbox.x;let y=bbox.y;let width=bbox.width;let height=bbox.height;if(transform.numberOfItems>0){const matrix=transform.consolidate().matrix;const points=[{x:bbox.x,y:bbox.y},{x:bbox.x+bbox.width,y:bbox.y},{x:bbox.x,y:bbox.y+bbox.height},{x:bbox.x+bbox.width,y:bbox.y+bbox.height}];const transformedPoints=points.map(point=>({x:matrix.a*point.x+matrix.c*point.y+matrix.e,y:matrix.b*point.x+matrix.d*point.y+matrix.f}));const minX=Math.min(...transformedPoints.map(p=>p.x));const maxX=Math.max(...transformedPoints.map(p=>p.x));const minY=Math.min(...transformedPoints.map(p=>p.y));const maxY=Math.max(...transformedPoints.map(p=>p.y));x=minX;y=minY;width=maxX-minX;height=maxY-minY;}
return{x,y,width,height};}catch(error){const rect=object.getBoundingClientRect();const svgPoint=this.svg.createSVGPoint();svgPoint.x=rect.left;svgPoint.y=rect.top;const transformed=svgPoint.matrixTransform(this.svg.getScreenCTM().inverse());return{x:transformed.x,y:transformed.y,width:rect.width/this.currentZoom,height:rect.height/this.currentZoom};}}
isObjectVisible(object){if(!this.cullingEnabled){return true;}
const viewportBounds=this.getViewportBounds();const objectBounds=this.getObjectBounds(object);return!(objectBounds.x+objectBounds.width<viewportBounds.left||objectBounds.x>viewportBounds.right||objectBounds.y+objectBounds.height<viewportBounds.top||objectBounds.y>viewportBounds.bottom);}
updateObjectVisibility(object){const isVisible=this.isObjectVisible(object);const wasVisible=!object.classList.contains('culled');if(isVisible!==wasVisible){if(isVisible){object.classList.remove('culled');object.style.display='';this.visibleObjects.add(object);}else{object.classList.add('culled');object.style.display='none';this.visibleObjects.delete(object);}}
return isVisible;}
performViewportCulling(){if(!this.cullingEnabled){return;}
const startTime=performance.now();const objects=this.svg.querySelectorAll('.placed-symbol, .bim-object, [data-placed-symbol="true"]');this.totalObjects=objects.length;this.visibleObjects.clear();let visibleCount=0;let culledCount=0;objects.forEach(object=>{const isVisible=this.updateObjectVisibility(object);if(isVisible){visibleCount++;}else{culledCount++;}});const cullingTime=performance.now()-startTime;this.cullingStats={totalObjects:this.totalObjects,visibleObjects:visibleCount,culledObjects:culledCount,cullingTime:cullingTime,lastUpdate:Date.now()};this.cleanupBoundsCache();this.triggerEvent('cullingUpdated',this.cullingStats);if(window.arxLogger){window.arxLogger.performance('viewport_culling',cullingTime,{component:'viewport_manager',visible_count:visibleCount,total_objects:this.totalObjects,culled_count:culledCount,culling_time_ms:cullingTime.toFixed(2)});}}
cleanupBoundsCache(){const now=Date.now();if(now-this.lastBoundsCacheCleanup<10000){return;}
this.lastBoundsCacheCleanup=now;let cleanedCount=0;for(const[id,entry]of this.objectBoundsCache.entries()){if(now-entry.timestamp>this.boundsCacheExpiry){this.objectBoundsCache.delete(id);cleanedCount++;}}
if(cleanedCount>0){if(window.arxLogger){window.arxLogger.info('ViewportCulling: Cleaned up expired bounds cache entries',{component:'viewport_manager',cleaned_count:cleanedCount,cache_type:'bounds_cache'});}}}
queueCullingUpdate(){if(!this.cullingEnabled)return;if(this.throttledUpdateManager){this.throttledUpdateManager.queueUpdate('culling',{viewportBounds:this.getViewportBounds(),totalObjects:this.totalObjects});}else{this.performViewportCulling();}}
enableCulling(){this.cullingEnabled=true;this.performViewportCulling();if(window.arxLogger){window.arxLogger.info('ViewportCulling: Enabled',{component:'viewport_manager',feature:'viewport_culling',status:'enabled'});}}
disableCulling(){this.cullingEnabled=false;const objects=this.svg.querySelectorAll('.culled');objects.forEach(object=>{object.classList.remove('culled');object.style.display='';});this.visibleObjects.clear();if(window.arxLogger){window.arxLogger.info('ViewportCulling: Disabled',{component:'viewport_manager',feature:'viewport_culling',status:'disabled'});}}
toggleCulling(){if(this.cullingEnabled){this.disableCulling();}else{this.enableCulling();}}
getCullingStats(){return{...this.cullingStats};}
setCullingMargin(margin){this.cullingMargin=margin;this.performViewportCulling();if(window.arxLogger){window.arxLogger.info('ViewportCulling: Margin set',{component:'viewport_manager',feature:'viewport_culling',margin_px:margin});}}
setCullingThrottle(throttle){this.cullingUpdateThrottle=throttle;if(window.arxLogger){window.arxLogger.info('ViewportCulling: Throttle set',{component:'viewport_manager',feature:'viewport_culling',throttle_ms:throttle});}}
forceCullingUpdate(){this.performViewportCulling();}
destroy(){this.stopPanInertia();if(this.cullingAnimationFrame){cancelAnimationFrame(this.cullingAnimationFrame);this.cullingAnimationFrame=null;}
this.visibleObjects.clear();this.objectBoundsCache.clear();this.container.removeEventListener('wheel',this.handleWheel);this.container.removeEventListener('mousedown',this.handleMouseDown);document.removeEventListener('mousemove',this.handleMouseMove);document.removeEventListener('mouseup',this.handleMouseUp);document.removeEventListener('keydown',this.handleKeyDown);window.removeEventListener('resize',this.handleResize);if(this.updateTimeout){clearTimeout(this.updateTimeout);this.updateTimeout=null;}
this.isPanning=false;this.panVelocityX=0;this.panVelocityY=0;this.lastPanTime=null;this.eventHandlers.clear();this.container.classList.remove('panning','zooming','pan-enabled');this.container.style.cursor='';const elementsToRemove=['zoom-constraint','pan-boundary-feedback','pan-inertia-indicator','pan-velocity-indicator','pan-mode-indicator','pan-boundary-warning','keyboard-shortcut-feedback','help-overlay'];elementsToRemove.forEach(id=>{const element=document.getElementById(id);if(element){element.remove();}});}
handleThrottledUpdate(data){const{type,data:updateData}=data;switch(type){case'viewport':this.updateViewport();break;case'zoom':this.updateZoomDisplay();this.updateZoomButtonStates();break;case'pan':this.updateViewport();break;case'culling':this.performViewportCulling();break;case'symbols':this.updateSymbolPositions();break;case'ui':this.updateUIElements();break;}}
handleBatchedUpdate(data){const{type,data:batchedData}=data;switch(type){case'viewport':this.updateViewport();break;case'symbols':this.updateSymbolPositionsBatch(batchedData.updates);break;case'culling':this.performViewportCulling();break;}}
handleUpdateProcessed(data){const{processedCount,currentFPS,frameTime,pendingUpdates}=data;this.updatePerformanceMetrics({processedUpdates:processedCount,currentFPS:currentFPS,frameTime:frameTime,pendingUpdates:pendingUpdates});this.triggerEvent('performanceUpdate',{processedUpdates:processedCount,currentFPS:currentFPS,frameTime:frameTime,pendingUpdates:pendingUpdates});}
updatePerformanceMetrics(metrics){this.performanceMetrics={...this.performanceMetrics,...metrics,lastUpdate:performance.now()};}
updateSymbolPositionsBatch(updates){if(!updates||updates.length===0)return;const symbols=document.querySelectorAll('.placed-symbol');symbols.forEach(symbol=>{const x=parseFloat(symbol.getAttribute('data-x'));const y=parseFloat(symbol.getAttribute('data-y'));const rotation=parseFloat(symbol.getAttribute('data-rotation')||'0');const transform=`translate(${x},${y}) rotate(${rotation})`;symbol.setAttribute('transform',transform);});}
updateUIElements(){this.updateZoomDisplay();this.updateZoomButtonStates();const zoomLevel=document.getElementById('zoom-level');if(zoomLevel){zoomLevel.textContent=`${(this.currentZoom * 100).toFixed(0)}%`;}}
getZoomPercent(){return Math.round(this.currentZoom*100);}
setZoomPercent(percent){const zoom=Math.max(this.minZoom,Math.min(this.maxZoom,percent/100));this.setZoom(zoom);}
getMinZoom(){return this.minZoom;}
getMaxZoom(){return this.maxZoom;}
zoomToFullExtent(){const svg=this.svg;if(!svg)return;let bbox;try{bbox=svg.getBBox();}catch(e){return;}
const containerRect=this.container.getBoundingClientRect();const scaleX=containerRect.width/bbox.width;const scaleY=containerRect.height/bbox.height;const scale=Math.min(scaleX,scaleY,this.maxZoom);const centerX=bbox.x+bbox.width/2;const centerY=bbox.y+bbox.height/2;this.currentZoom=scale;this.panX=containerRect.width/2-centerX*scale;this.panY=containerRect.height/2-centerY*scale;this.updateViewport();this.saveZoomState();this.triggerEvent('zoomToFullExtent');}
zoomToSelection(bbox){if(!bbox||bbox.width===0||bbox.height===0)return;const containerRect=this.container.getBoundingClientRect();const scaleX=containerRect.width/bbox.width;const scaleY=containerRect.height/bbox.height;const scale=Math.min(scaleX,scaleY,this.maxZoom);const centerX=bbox.x+bbox.width/2;const centerY=bbox.y+bbox.height/2;this.currentZoom=scale;this.panX=containerRect.width/2-centerX*scale;this.panY=containerRect.height/2-centerY*scale;this.updateViewport();this.saveZoomState();this.triggerEvent('zoomToSelection',bbox);}}
if(typeof module!=='undefined'&&module.exports){module.exports=ViewportManager;}else if(typeof window!=='undefined'){window.ViewportManager=ViewportManager;}
