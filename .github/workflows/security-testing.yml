name: Security Testing & Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scanning:
    name: Security Scanning & Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety semgrep
        
    - name: Run SAST (Static Application Security Testing)
      run: |
        echo "Running SAST with Bandit..."
        bandit -r . -f json -o bandit-report.json
        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Bandit found security issues. Review the report."
        fi
        
        echo "Running Semgrep..."
        semgrep --config=auto --json --output semgrep-report.json
        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Semgrep found security issues. Review the report."
        fi
        
    - name: Run dependency vulnerability scanning
      run: |
        echo "Running Safety check..."
        safety check --json --output safety-report.json
        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Safety found vulnerabilities. Review the report."
        fi
        
    - name: Run comprehensive security testing
      run: |
        echo "Running comprehensive security tests..."
        python scripts/security_testing.py --verbose --output security-test-report.json
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          semgrep-report.json
          safety-report.json
          security-test-report.json
          
    - name: Comment on PR with security findings
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## üîí Security Testing Results\n\n';
          
          // Read security test report
          if (fs.existsSync('security-test-report.json')) {
            const report = JSON.parse(fs.readFileSync('security-test-report.json', 'utf8'));
            const summary = report.test_summary;
            
            comment += `### üìä Summary\n`;
            comment += `- **Duration**: ${summary.duration_seconds.toFixed(2)} seconds\n`;
            comment += `- **Tests Run**: ${summary.total_tests}\n`;
            comment += `- **Vulnerabilities Found**: ${summary.vulnerabilities_found}\n`;
            comment += `- **Overall Severity**: ${summary.overall_severity}\n\n`;
            
            if (summary.vulnerabilities_found > 0) {
              comment += `### ‚ö†Ô∏è Vulnerabilities Found\n\n`;
              const vulnerabilities = report.vulnerabilities.slice(0, 10); // Show first 10
              
              for (const vuln of vulnerabilities) {
                comment += `- **${vuln.severity.toUpperCase()}**: ${vuln.description}\n`;
                if (vuln.file) {
                  comment += `  - File: \`${vuln.file}\`\n`;
                }
                comment += `  - Recommendation: ${vuln.recommendation}\n\n`;
              }
              
              if (report.vulnerabilities.length > 10) {
                comment += `*... and ${report.vulnerabilities.length - 10} more vulnerabilities*\n\n`;
              }
            } else {
              comment += `### ‚úÖ No Security Vulnerabilities Found\n\n`;
            }
            
            if (report.recommendations && report.recommendations.length > 0) {
              comment += `### üí° Recommendations\n\n`;
              for (const rec of report.recommendations) {
                comment += `- ${rec}\n`;
              }
            }
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  compliance-checking:
    name: Compliance & Standards Validation
    runs-on: ubuntu-latest
    needs: security-scanning
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run OWASP Top 10 validation
      run: |
        echo "Validating against OWASP Top 10..."
        python -c "
        from svgx_engine.security.validation import SecurityValidator
        validator = SecurityValidator()
        print('OWASP Top 10 validation completed')
        "
        
    - name: Run compliance framework validation
      run: |
        echo "Running compliance framework validation..."
        python -c "
        from svgx_engine.security.compliance import ComplianceManager
        from svgx_engine.security.monitoring import AuditLogger
        import json
        from datetime import datetime, timedelta
        
        # Initialize compliance manager
        audit_logger = AuditLogger()
        compliance_manager = ComplianceManager(audit_logger)
        
        # Generate compliance report
        start_date = datetime.utcnow() - timedelta(days=30)
        end_date = datetime.utcnow()
        report = compliance_manager.generate_comprehensive_report(start_date, end_date)
        
        # Save report
        with open('compliance-report.json', 'w') as f:
            json.dump(report, f, indent=2)
            
        print('Compliance validation completed')
        "
        
    - name: Upload compliance report
      uses: actions/upload-artifact@v3
      with:
        name: compliance-reports
        path: compliance-report.json

  secrets-scanning:
    name: Secrets & Credentials Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run TruffleHog for secrets scanning
      run: |
        echo "Installing TruffleHog..."
        pip install trufflehog
        
        echo "Running secrets scan..."
        trufflehog --json --output trufflehog-report.json . || true
        
    - name: Run GitGuardian scan (if configured)
      run: |
        echo "Running GitGuardian scan..."
        # This would require GitGuardian API key
        # gitguardian scan --json --output gitguardian-report.json || true
        
    - name: Upload secrets scan reports
      uses: actions/upload-artifact@v3
      with:
        name: secrets-reports
        path: trufflehog-report.json

  container-security:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        docker build -t arxos-security-test .
        
    - name: Run Trivy vulnerability scanner
      run: |
        echo "Installing Trivy..."
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        echo "Running Trivy scan..."
        trivy image --format json --output trivy-report.json arxos-security-test
        
    - name: Upload container security reports
      uses: actions/upload-artifact@v3
      with:
        name: container-reports
        path: trivy-report.json

  security-gates:
    name: Security Quality Gates
    runs-on: ubuntu-latest
    needs: [security-scanning, compliance-checking, secrets-scanning, container-security]
    
    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v3
      with:
        path: security-reports/
        
    - name: Evaluate security gates
      run: |
        echo "Evaluating security quality gates..."
        
        # Check if security test report exists
        if [ -f "security-reports/security-test-report.json" ]; then
          python -c "
        import json
        import sys
        
        with open('security-reports/security-test-report.json', 'r') as f:
            report = json.load(f)
            
        summary = report['test_summary']
        vulnerabilities = report['vulnerabilities']
        
        # Security gates
        critical_vulns = [v for v in vulnerabilities if v.get('severity') == 'critical']
        high_vulns = [v for v in vulnerabilities if v.get('severity') == 'high']
        
        print(f'Critical vulnerabilities: {len(critical_vulns)}')
        print(f'High vulnerabilities: {len(high_vulns)}')
        print(f'Total vulnerabilities: {len(vulnerabilities)}')
        
        # Fail if critical vulnerabilities found
        if len(critical_vulns) > 0:
            print('‚ùå CRITICAL VULNERABILITIES FOUND - SECURITY GATE FAILED')
            sys.exit(1)
            
        # Fail if too many high vulnerabilities
        if len(high_vulns) > 5:
            print('‚ùå TOO MANY HIGH SEVERITY VULNERABILITIES - SECURITY GATE FAILED')
            sys.exit(1)
            
        print('‚úÖ Security gates passed')
        "
        else:
          echo "‚ùå Security test report not found"
          exit 1
          
    - name: Security gate result
      run: |
        echo "üéâ All security quality gates passed!"
        echo "‚úÖ No critical vulnerabilities"
        echo "‚úÖ Acceptable number of high severity issues"
        echo "‚úÖ Security testing completed successfully"

  security-dashboard:
    name: Security Dashboard Update
    runs-on: ubuntu-latest
    needs: [security-scanning, compliance-checking, secrets-scanning, container-security]
    if: always()
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v3
      with:
        path: reports/
        
    - name: Generate security dashboard
      run: |
        echo "Generating security dashboard..."
        python -c "
        import json
        import os
        from datetime import datetime
        
        dashboard = {
            'last_updated': datetime.utcnow().isoformat(),
            'security_metrics': {},
            'compliance_status': {},
            'vulnerability_summary': {},
            'recommendations': []
        }
        
        # Process security test report
        if os.path.exists('reports/security-test-report.json'):
            with open('reports/security-test-report.json', 'r') as f:
                security_report = json.load(f)
                dashboard['security_metrics'] = security_report['test_summary']
                dashboard['vulnerability_summary'] = {
                    'total': len(security_report['vulnerabilities']),
                    'critical': len([v for v in security_report['vulnerabilities'] if v.get('severity') == 'critical']),
                    'high': len([v for v in security_report['vulnerabilities'] if v.get('severity') == 'high']),
                    'medium': len([v for v in security_report['vulnerabilities'] if v.get('severity') == 'medium']),
                    'low': len([v for v in security_report['vulnerabilities'] if v.get('severity') == 'low'])
                }
                dashboard['recommendations'] = security_report.get('recommendations', [])
        
        # Process compliance report
        if os.path.exists('reports/compliance-report.json'):
            with open('reports/compliance-report.json', 'r') as f:
                compliance_report = json.load(f)
                dashboard['compliance_status'] = {
                    'gdpr': compliance_report.get('gdpr', {}).get('compliance_status', 'unknown'),
                    'hipaa': compliance_report.get('hipaa', {}).get('compliance_status', 'unknown'),
                    'soc2': compliance_report.get('soc2', {}).get('compliance_status', 'unknown')
                }
        
        # Save dashboard
        with open('security-dashboard.json', 'w') as f:
            json.dump(dashboard, f, indent=2)
            
        print('Security dashboard generated successfully')
        "
        
    - name: Upload security dashboard
      uses: actions/upload-artifact@v3
      with:
        name: security-dashboard
        path: security-dashboard.json 