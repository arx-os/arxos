<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Version Control - Arxos</title>
    <link rel="stylesheet" href="static/css/version_control.css">
    <link rel="stylesheet" href="static/css/shared.css">
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
</head>
<body>
    <div class="version-control-container">
        <!-- Header -->
        <div class="page-header">
            <h1>Advanced Version Control</h1>
            <p>Manage branches, versions, merges, annotations, and comments for your floor data</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" data-tab="branches">Branches</button>
            <button class="tab-btn" data-tab="versions">Version History</button>
            <button class="tab-btn" data-tab="merges">Merge Requests</button>
            <button class="tab-btn" data-tab="visualization">Branch Graph</button>
            <button class="tab-btn" data-tab="annotations">Annotations</button>
            <button class="tab-btn" data-tab="comments">Comments</button>
        </div>

        <!-- Branch Management Tab -->
        <div class="tab-content active" id="branches-tab">
            <div class="branch-management">
                <div class="branch-header">
                    <h2>Branch Management</h2>
                    <button class="btn btn-primary" id="create-branch-btn">Create Branch</button>
                </div>
                
                <div class="search-filter">
                    <input type="text" class="search-input" placeholder="Search branches..." id="branch-search">
                    <select class="filter-select" id="branch-status-filter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="merged">Merged</option>
                        <option value="deleted">Deleted</option>
                    </select>
                </div>

                <div class="branch-list" id="branch-list">
                    <!-- Branches will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Version History Tab -->
        <div class="tab-content" id="versions-tab">
            <div class="version-history">
                <div class="version-header">
                    <h2>Version History</h2>
                    <div class="version-controls">
                        <select id="version-branch-filter">
                            <option value="">All Branches</option>
                        </select>
                        <button class="btn btn-primary" id="create-version-btn">Create Version</button>
                    </div>
                </div>

                <div class="version-timeline" id="version-timeline">
                    <!-- Version history will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Merge Requests Tab -->
        <div class="tab-content" id="merges-tab">
            <div class="merge-management">
                <div class="merge-header">
                    <h2>Merge Requests</h2>
                    <button class="btn btn-primary" id="create-merge-btn">Create Merge Request</button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" placeholder="Search merge requests..." id="merge-search">
                    <select class="filter-select" id="merge-status-filter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="conflict">Conflict</option>
                    </select>
                </div>

                <div class="merge-requests-list" id="merge-requests-list">
                    <!-- Merge requests will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Branch Visualization Tab -->
        <div class="tab-content" id="visualization-tab">
            <div class="branch-visualization">
                <div class="visualization-header">
                    <h2>Branch Graph</h2>
                    <div class="visualization-controls">
                        <button class="btn btn-secondary" id="refresh-graph-btn">Refresh</button>
                        <button class="btn btn-secondary" id="export-graph-btn">Export</button>
                    </div>
                </div>

                <div class="branch-graph-container" id="branch-graph-container">
                    <!-- Branch graph will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Annotations Tab -->
        <div class="tab-content" id="annotations-tab">
            <div class="annotations-section">
                <div class="annotations-header">
                    <h2>Annotations</h2>
                    <div class="annotations-controls">
                        <input type="text" class="search-input" placeholder="Search annotations..." id="annotation-search">
                        <button class="btn btn-primary" id="add-annotation-btn">Add Annotation</button>
                    </div>
                </div>

                <div class="annotations-list" id="annotations-list">
                    <!-- Annotations will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Comments Tab -->
        <div class="tab-content" id="comments-tab">
            <div class="comments-section">
                <div class="comments-header">
                    <h2>Comments</h2>
                    <div class="comments-controls">
                        <select id="comment-parent-filter">
                            <option value="">All Items</option>
                            <option value="version">Versions</option>
                            <option value="annotation">Annotations</option>
                        </select>
                    </div>
                </div>

                <div class="comments-list" id="comments-list">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Branch Modal -->
    <div class="modal" id="create-branch-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Branch</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-branch-form">
                    <div class="form-group">
                        <label for="branch-name">Branch Name</label>
                        <input type="text" id="branch-name" required>
                    </div>
                    <div class="form-group">
                        <label for="base-version">Base Version</label>
                        <select id="base-version" required>
                            <option value="">Select base version...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="branch-description">Description</label>
                        <textarea id="branch-description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="create-branch-submit">Create Branch</button>
            </div>
        </div>
    </div>

    <!-- Create Version Modal -->
    <div class="modal" id="create-version-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Version</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-version-form">
                    <div class="form-group">
                        <label for="version-branch">Branch</label>
                        <select id="version-branch" required>
                            <option value="">Select branch...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="version-type">Version Type</label>
                        <select id="version-type" required>
                            <option value="minor">Minor</option>
                            <option value="major">Major</option>
                            <option value="patch">Patch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="commit-message">Commit Message</label>
                        <textarea id="commit-message" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="version-author">Author</label>
                        <input type="text" id="version-author" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="create-version-submit">Create Version</button>
            </div>
        </div>
    </div>

    <!-- Create Merge Request Modal -->
    <div class="modal" id="create-merge-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Merge Request</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-merge-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="source-branch">Source Branch</label>
                            <select id="source-branch" required>
                                <option value="">Select source branch...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="target-branch">Target Branch</label>
                            <select id="target-branch" required>
                                <option value="">Select target branch...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="merge-description">Description</label>
                        <textarea id="merge-description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="merge-author">Author</label>
                        <input type="text" id="merge-author" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="create-merge-submit">Create Merge Request</button>
            </div>
        </div>
    </div>

    <!-- Add Annotation Modal -->
    <div class="modal" id="add-annotation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Annotation</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-annotation-form">
                    <div class="form-group">
                        <label for="annotation-version">Version</label>
                        <select id="annotation-version" required>
                            <option value="">Select version...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="annotation-title">Title</label>
                        <input type="text" id="annotation-title" required>
                    </div>
                    <div class="form-group">
                        <label for="annotation-content">Content</label>
                        <textarea id="annotation-content" rows="4" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annotation-type">Type</label>
                            <select id="annotation-type">
                                <option value="note">Note</option>
                                <option value="issue">Issue</option>
                                <option value="improvement">Improvement</option>
                                <option value="bug">Bug</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="annotation-author">Author</label>
                            <input type="text" id="annotation-author" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="annotation-x">Position X</label>
                            <input type="number" id="annotation-x" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="annotation-y">Position Y</label>
                            <input type="number" id="annotation-y" step="0.1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="add-annotation-submit">Add Annotation</button>
            </div>
        </div>
    </div>

    <!-- Add Comment Modal -->
    <div class="modal" id="add-comment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Comment</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-comment-form">
                    <div class="form-group">
                        <label for="comment-parent">Parent Item</label>
                        <select id="comment-parent" required>
                            <option value="">Select item...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comment-content">Comment</label>
                        <textarea id="comment-content" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="comment-author">Author</label>
                        <input type="text" id="comment-author" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="add-comment-submit">Add Comment</button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="notifications-container"></div>

    <!-- Scripts -->
    <!-- ArxLogger Script -->
    <script src="static/js/arx-logger.js"></script>
    <script>
        // Initialize ArxLogger with version control context
        document.addEventListener('DOMContentLoaded', function() {
            // Get version control context from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const buildingId = urlParams.get('building_id') || localStorage.getItem('arx_building_id') || 'unknown';
            const floorId = urlParams.get('floor_id') || localStorage.getItem('arx_floor_id') || 'unknown';
            const userId = localStorage.getItem('arx_user_id') || 'unknown';
            
            // Set context for version control operations
            if (window.arxLogger) {
                window.arxLogger.setContext({
                    buildingId: buildingId,
                    floorId: floorId,
                    userId: userId,
                    correlationId: window.arxLogger.generateCorrelationId()
                });
                
                window.arxLogger.info('Version Control page initialized with context', {
                    building_id: buildingId,
                    floor_id: floorId,
                    user_id: userId,
                    page: 'version_control'
                });
            }
        });
    </script>
    
    <script src="static/js/version_control_manager.js"></script>
    <script>
        // Safe DOM manipulation utility
        function setContainerContent(container, htmlContent) {
            // Use DOMPurify for proper XSS protection
            if (typeof htmlContent === 'string' && htmlContent.trim()) {
                // Sanitize content with DOMPurify
                const safeContent = DOMPurify.sanitize(htmlContent);
                container.innerHTML = safeContent;
            } else {
                container.textContent = '';
            }
        }

        // Initialize version control page
        document.addEventListener('DOMContentLoaded', function() {
            const vcManager = window.versionControlManager;
            
            // Configuration
            const config = {
                buildingId: 'demo-building',
                floorId: 'demo-floor',
                currentUser: 'demo-user'
            };

            // Tab navigation
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    
                    // Update active tab
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show corresponding content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabName}-tab`) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Load tab data
                    loadTabData(tabName);
                });
            });

            // Load initial data
            loadTabData('branches');

            // Modal handling
            setupModals();

            // Event listeners
            setupEventListeners();

            function loadTabData(tabName) {
                switch(tabName) {
                    case 'branches':
                        loadBranches();
                        break;
                    case 'versions':
                        loadVersions();
                        break;
                    case 'merges':
                        loadMergeRequests();
                        break;
                    case 'visualization':
                        loadBranchGraph();
                        break;
                    case 'annotations':
                        loadAnnotations();
                        break;
                    case 'comments':
                        loadComments();
                        break;
                }
            }

            async function loadBranches() {
                const container = document.getElementById('branch-list');
                setContainerContent(container, '<div class="loading">Loading branches...</div>');
                
                try {
                    const result = await vcManager.getBranches(config.buildingId, config.floorId);
                    if (result.success) {
                        renderBranches(result.branches, container);
                    } else {
                        setContainerContent(container, '<div class="empty-state">No branches found</div>');
                    }
                } catch (error) {
                    setContainerContent(container, '<div class="empty-state">Error loading branches</div>');
                }
            }

            async function loadVersions() {
                const container = document.getElementById('version-timeline');
                setContainerContent(container, '<div class="loading">Loading versions...</div>');
                
                try {
                    const result = await vcManager.getVersionHistory(config.buildingId, config.floorId);
                    if (result.success) {
                        renderVersions(result.versions, container);
                    } else {
                        setContainerContent(container, '<div class="empty-state">No versions found</div>');
                    }
                } catch (error) {
                    setContainerContent(container, '<div class="empty-state">Error loading versions</div>');
                }
            }

            async function loadMergeRequests() {
                const container = document.getElementById('merge-requests-list');
                setContainerContent(container, '<div class="loading">Loading merge requests...</div>');
                
                // This would typically load from the backend
                setContainerContent(container, '<div class="empty-state">No merge requests found</div>');
            }

            async function loadBranchGraph() {
                const container = document.getElementById('branch-graph-container');
                setContainerContent(container, '<div class="loading">Loading branch graph...</div>');
                
                try {
                    const result = await vcManager.getBranchGraph(config.buildingId, config.floorId);
                    if (result.success) {
                        vcManager.renderBranchGraph(result, container);
                    } else {
                        setContainerContent(container, '<div class="empty-state">No branch data found</div>');
                    }
                } catch (error) {
                    setContainerContent(container, '<div class="empty-state">Error loading branch graph</div>');
                }
            }

            async function loadAnnotations() {
                const container = document.getElementById('annotations-list');
                setContainerContent(container, '<div class="loading">Loading annotations...</div>');
                
                // This would typically load from the backend
                setContainerContent(container, '<div class="empty-state">No annotations found</div>');
            }

            async function loadComments() {
                const container = document.getElementById('comments-list');
                setContainerContent(container, '<div class="loading">Loading comments...</div>');
                
                // This would typically load from the backend
                setContainerContent(container, '<div class="empty-state">No comments found</div>');
            }

            function renderBranches(branches, container) {
                if (!branches || branches.length === 0) {
                    setContainerContent(container, '<div class="empty-state">No branches found</div>');
                    return;
                }

                // Clear container safely
                container.textContent = '';
                
                branches.forEach(branch => {
                    const branchCard = document.createElement('div');
                    branchCard.className = 'branch-card';
                    if (branch.status === 'active') {
                        branchCard.classList.add('active');
                    }
                    
                    const branchName = document.createElement('div');
                    branchName.className = 'branch-name';
                    branchName.textContent = branch.branch_name;
                    
                    const branchMeta = document.createElement('div');
                    branchMeta.className = 'branch-meta';
                    
                    const statusDiv = document.createElement('div');
                    statusDiv.textContent = `Status: ${branch.status}`;
                    
                    const createdByDiv = document.createElement('div');
                    createdByDiv.textContent = `Created by: ${branch.created_by}`;
                    
                    const createdDiv = document.createElement('div');
                    createdDiv.textContent = `Created: ${new Date(branch.created_at).toLocaleDateString()}`;
                    
                    branchMeta.appendChild(statusDiv);
                    branchMeta.appendChild(createdByDiv);
                    branchMeta.appendChild(createdDiv);
                    
                    const branchDescription = document.createElement('div');
                    branchDescription.className = 'branch-description';
                    branchDescription.textContent = branch.description || 'No description';
                    
                    const branchActions = document.createElement('div');
                    branchActions.className = 'branch-actions';
                    
                    const switchBtn = document.createElement('button');
                    switchBtn.className = 'btn btn-sm btn-primary';
                    switchBtn.textContent = 'Switch';
                    switchBtn.addEventListener('click', () => switchToBranch(branch.branch_name));
                    
                    const historyBtn = document.createElement('button');
                    historyBtn.className = 'btn btn-sm btn-secondary';
                    historyBtn.textContent = 'History';
                    historyBtn.addEventListener('click', () => viewBranchHistory(branch.branch_name));
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => deleteBranch(branch.branch_name));
                    
                    branchActions.appendChild(switchBtn);
                    branchActions.appendChild(historyBtn);
                    branchActions.appendChild(deleteBtn);
                    
                    branchCard.appendChild(branchName);
                    branchCard.appendChild(branchMeta);
                    branchCard.appendChild(branchDescription);
                    branchCard.appendChild(branchActions);
                    
                    container.appendChild(branchCard);
                });
            }

            function renderVersions(versions, container) {
                if (!versions || versions.length === 0) {
                    setContainerContent(container, '<div class="empty-state">No versions found</div>');
                    return;
                }

                // Clear container safely
                container.textContent = '';
                
                versions.forEach(version => {
                    const versionItem = document.createElement('div');
                    versionItem.className = `version-item ${version.version_type}`;
                    
                    const versionHeader = document.createElement('div');
                    versionHeader.className = 'version-header';
                    
                    const versionNumber = document.createElement('span');
                    versionNumber.className = 'version-number';
                    versionNumber.textContent = version.version_number;
                    
                    const versionType = document.createElement('span');
                    versionType.className = `version-type ${version.version_type}`;
                    versionType.textContent = version.version_type;
                    
                    versionHeader.appendChild(versionNumber);
                    versionHeader.appendChild(versionType);
                    
                    const versionMessage = document.createElement('div');
                    versionMessage.className = 'version-message';
                    versionMessage.textContent = version.commit_message;
                    
                    const versionMeta = document.createElement('div');
                    versionMeta.className = 'version-meta';
                    
                    const authorSpan = document.createElement('span');
                    authorSpan.textContent = `Author: ${version.author}`;
                    
                    const createdSpan = document.createElement('span');
                    createdSpan.textContent = `Created: ${new Date(version.created_at).toLocaleDateString()}`;
                    
                    versionMeta.appendChild(authorSpan);
                    versionMeta.appendChild(createdSpan);
                    
                    const versionActions = document.createElement('div');
                    versionActions.className = 'version-actions';
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'btn btn-sm btn-primary';
                    viewBtn.textContent = 'View';
                    viewBtn.addEventListener('click', () => viewVersion(version.version_id));
                    
                    const compareBtn = document.createElement('button');
                    compareBtn.className = 'btn btn-sm btn-secondary';
                    compareBtn.textContent = 'Compare';
                    compareBtn.addEventListener('click', () => compareVersion(version.version_id));
                    
                    versionActions.appendChild(viewBtn);
                    versionActions.appendChild(compareBtn);
                    
                    versionItem.appendChild(versionHeader);
                    versionItem.appendChild(versionMessage);
                    versionItem.appendChild(versionMeta);
                    versionItem.appendChild(versionActions);
                    
                    container.appendChild(versionItem);
                });
            }

            function setupModals() {
                // Modal close functionality
                document.querySelectorAll('.modal-close, [data-dismiss="modal"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.closest('.modal').style.display = 'none';
                    });
                });

                // Close modal on outside click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }

            function setupEventListeners() {
                // Create branch button
                document.getElementById('create-branch-btn').addEventListener('click', () => {
                    document.getElementById('create-branch-modal').style.display = 'flex';
                });

                // Create version button
                document.getElementById('create-version-btn').addEventListener('click', () => {
                    document.getElementById('create-version-modal').style.display = 'flex';
                });

                // Create merge button
                document.getElementById('create-merge-btn').addEventListener('click', () => {
                    document.getElementById('create-merge-modal').style.display = 'flex';
                });

                // Add annotation button
                document.getElementById('add-annotation-btn').addEventListener('click', () => {
                    document.getElementById('add-annotation-modal').style.display = 'flex';
                });

                // Form submissions
                document.getElementById('create-branch-submit').addEventListener('click', async () => {
                    const form = document.getElementById('create-branch-form');
                    const formData = new FormData(form);
                    
                    try {
                        const result = await vcManager.createBranch(
                            formData.get('branch-name'),
                            config.floorId,
                            config.buildingId,
                            formData.get('base-version'),
                            config.currentUser,
                            formData.get('branch-description')
                        );
                        
                        if (result.success) {
                            showNotification('Branch created successfully', 'success');
                            document.getElementById('create-branch-modal').style.display = 'none';
                            loadBranches();
                        } else {
                            showNotification(result.message, 'error');
                        }
                    } catch (error) {
                        showNotification('Error creating branch', 'error');
                    }
                });
            }

            function showNotification(message, type = 'info') {
                const notifications = document.getElementById('notifications');
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                
                notifications.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Global functions for button actions
            window.switchToBranch = function(branchName) {
                showNotification(`Switched to branch: ${branchName}`, 'info');
            };

            window.viewBranchHistory = function(branchName) {
                // Switch to versions tab and filter by branch
                document.querySelector('[data-tab="versions"]').click();
                document.getElementById('version-branch-filter').value = branchName;
                loadVersions();
            };

            window.deleteBranch = function(branchName) {
                if (confirm(`Are you sure you want to delete branch "${branchName}"?`)) {
                    showNotification(`Branch "${branchName}" deleted`, 'success');
                    loadBranches();
                }
            };

            window.viewVersion = function(versionId) {
                showNotification(`Viewing version: ${versionId}`, 'info');
            };

            window.compareVersion = function(versionId) {
                showNotification(`Comparing version: ${versionId}`, 'info');
            };
        });
    </script>
</body>
</html> 