<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1F2937">
    <title>BIM Viewer - Arxos</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Mobile-specific styles -->
    <style>
        /* Prevent zoom on input focus */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Custom scrollbar for mobile */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        
        /* Touch-friendly buttons */
        .touch-button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }
        
        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* SVG container styles */
        .svg-container {
            touch-action: pan-x pan-y pinch-zoom;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Layer toggle styles */
        .layer-toggle {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Object info panel */
        .object-info {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Navigation controls */
        .nav-controls {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Loading indicator */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Gesture feedback */
        .gesture-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .gesture-feedback.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden" 
      x-data="{ 
        currentView: 'bim',
        selectedObject: null,
        layerVisibility: {
          E: true, LV: true, FA: true, N: true, M: true, P: true, S: true
        },
        zoomLevel: 1,
        panOffset: { x: 0, y: 0 },
        isDragging: false,
        lastTouch: null,
        showLayerPanel: false,
        showObjectInfo: false,
        loading: false,
        error: null,
        userRole: 'viewer',
        buildingId: null,
        floorId: null
      }"
      @touchstart="handleTouchStart($event)"
      @touchmove="handleTouchMove($event)"
      @touchend="handleTouchEnd($event)"
      @gesturestart="handleGestureStart($event)"
      @gesturechange="handleGestureChange($event)"
      @gestureend="handleGestureEnd($event)">

    <!-- Loading Overlay -->
    <div x-show="loading" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="loading-spinner"></div>
            <span class="text-gray-700">Loading BIM data...</span>
        </div>
    </div>

    <!-- Error Overlay -->
    <div x-show="error" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                <h3 class="text-lg font-semibold text-gray-800">Error</h3>
            </div>
            <p class="text-gray-600 mb-4" x-text="error"></p>
            <button @click="error = null" 
                    class="w-full bg-blue-600 text-white py-2 rounded-lg touch-button">
                Dismiss
            </button>
        </div>
    </div>

    <!-- Main BIM Viewer -->
    <div class="h-full flex flex-col">
        
        <!-- Header -->
        <header class="nav-controls text-white px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <button @click="goBack()" 
                        class="touch-button text-white">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h1 class="text-lg font-semibold">BIM Viewer</h1>
                    <p class="text-sm text-gray-300" x-text="`Building: ${buildingId || 'Loading...'}`"></p>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button @click="showLayerPanel = !showLayerPanel" 
                        class="touch-button text-white p-2 rounded-lg bg-gray-700">
                    <i class="fas fa-layer-group"></i>
                </button>
                <button @click="resetView()" 
                        class="touch-button text-white p-2 rounded-lg bg-gray-700">
                    <i class="fas fa-home"></i>
                </button>
                <button @click="toggleFullscreen()" 
                        class="touch-button text-white p-2 rounded-lg bg-gray-700">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </header>

        <!-- SVG Container -->
        <div class="flex-1 relative overflow-hidden">
            <div id="svg-container" 
                 class="svg-container w-full h-full relative"
                 :style="`transform: translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoomLevel})`">
                
                <!-- SVG content will be loaded here -->
                <div id="bim-svg" class="w-full h-full"></div>
                
                <!-- Zoom Controls -->
                <div class="absolute bottom-4 right-4 flex flex-col space-y-2">
                    <button @click="zoomIn()" 
                            class="touch-button bg-white rounded-full w-12 h-12 shadow-lg flex items-center justify-center">
                        <i class="fas fa-plus text-gray-700"></i>
                    </button>
                    <button @click="zoomOut()" 
                            class="touch-button bg-white rounded-full w-12 h-12 shadow-lg flex items-center justify-center">
                        <i class="fas fa-minus text-gray-700"></i>
                    </button>
                </div>
                
                <!-- Layer Visibility Indicator -->
                <div class="absolute top-4 left-4">
                    <div class="bg-white rounded-lg p-2 shadow-lg">
                        <div class="flex space-x-1">
                            <template x-for="(visible, layer) in layerVisibility" :key="layer">
                                <div class="w-3 h-3 rounded-full" 
                                     :class="{
                                       'bg-orange-500': layer === 'E',
                                       'bg-teal-500': layer === 'LV',
                                       'bg-yellow-500': layer === 'FA',
                                       'bg-green-500': layer === 'N',
                                       'bg-pink-500': layer === 'M',
                                       'bg-mint-500': layer === 'P',
                                       'bg-red-400': layer === 'S'
                                     }"
                                     :style="`opacity: ${visible ? '1' : '0.3'}`"></div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layer Panel -->
        <div x-show="showLayerPanel" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform translate-y-full"
             x-transition:enter-end="transform translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="transform translate-y-0"
             x-transition:leave-end="transform translate-y-full"
             class="layer-toggle fixed bottom-0 left-0 right-0 p-4 rounded-t-lg">
            
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Layer Visibility</h3>
                <button @click="showLayerPanel = false" 
                        class="touch-button text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <template x-for="(visible, layer) in layerVisibility" :key="layer">
                    <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                        <input type="checkbox" 
                               x-model="layerVisibility[layer]"
                               @change="toggleLayer(layer, $event.target.checked)"
                               class="rounded border-gray-300 text-blue-600">
                        <div class="w-4 h-4 rounded-full" 
                             :class="{
                               'bg-orange-500': layer === 'E',
                               'bg-teal-500': layer === 'LV',
                               'bg-yellow-500': layer === 'FA',
                               'bg-green-500': layer === 'N',
                               'bg-pink-500': layer === 'M',
                               'bg-mint-500': layer === 'P',
                               'bg-red-400': layer === 'S'
                             }"></div>
                        <span class="text-sm font-medium text-gray-700" x-text="getLayerName(layer)"></span>
                    </label>
                </template>
            </div>
            
            <div class="mt-4 flex space-x-2">
                <button @click="showAllLayers()" 
                        class="flex-1 bg-green-600 text-white py-2 rounded-lg touch-button text-sm">
                    Show All
                </button>
                <button @click="hideAllLayers()" 
                        class="flex-1 bg-red-600 text-white py-2 rounded-lg touch-button text-sm">
                    Hide All
                </button>
            </div>
        </div>

        <!-- Object Info Panel -->
        <div x-show="showObjectInfo && selectedObject" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="transform translate-y-full"
             x-transition:enter-end="transform translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="transform translate-y-0"
             x-transition:leave-end="transform translate-y-full"
             class="object-info fixed bottom-0 left-0 right-0 p-4 rounded-t-lg max-h-96 overflow-y-auto">
            
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Object Details</h3>
                <button @click="showObjectInfo = false" 
                        class="touch-button text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <template x-if="selectedObject">
                <div class="space-y-3">
                    <div>
                        <h4 class="text-sm font-medium text-gray-600">Object ID</h4>
                        <p class="text-sm text-gray-800" x-text="selectedObject.id"></p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-600">Type</h4>
                        <p class="text-sm text-gray-800" x-text="selectedObject.type"></p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-600">Layer</h4>
                        <p class="text-sm text-gray-800" x-text="getLayerName(selectedObject.layer)"></p>
                    </div>
                    
                    <template x-if="selectedObject.properties">
                        <div>
                            <h4 class="text-sm font-medium text-gray-600">Properties</h4>
                            <div class="space-y-1">
                                <template x-for="(value, key) in selectedObject.properties" :key="key">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600" x-text="key"></span>
                                        <span class="text-gray-800" x-text="value"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="userRole !== 'viewer'">
                        <div class="pt-3 border-t border-gray-200">
                            <button @click="editObject(selectedObject)" 
                                    class="w-full bg-blue-600 text-white py-2 rounded-lg touch-button text-sm">
                                Edit Object
                            </button>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Gesture Feedback -->
    <div id="gesture-feedback" class="gesture-feedback"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="../js/gesture_handlers.js"></script>
    
    <script>
        // Initialize mobile BIM viewer
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('arx_jwt');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user role and permissions
            loadUserPermissions();
            
            // Load BIM data
            loadBIMData();
            
            // Initialize touch handlers
            initializeTouchHandlers();
            
            // Setup PWA features
            setupPWA();
        });
        
        // Load user permissions
        async function loadUserPermissions() {
            try {
                const response = await fetch('/api/user/permissions', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('arx_jwt')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    Alpine.store('userPermissions', data);
                    Alpine.store('userRole', data.role);
                }
            } catch (error) {
                console.error('Failed to load permissions:', error);
            }
        }
        
        // Load BIM data
        async function loadBIMData() {
            const buildingId = new URLSearchParams(window.location.search).get('building');
            const floorId = new URLSearchParams(window.location.search).get('floor');
            
            if (!buildingId) {
                Alpine.store('error', 'No building ID specified');
                return;
            }
            
            Alpine.store('loading', true);
            
            try {
                const response = await fetch(`/api/bim/${buildingId}/floor/${floorId || 'main'}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('arx_jwt')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderBIMData(data);
                } else {
                    Alpine.store('error', 'Failed to load BIM data');
                }
            } catch (error) {
                Alpine.store('error', 'Network error: ' + error.message);
            } finally {
                Alpine.store('loading', false);
            }
        }
        
        // Render BIM data
        function renderBIMData(data) {
            const container = document.getElementById('bim-svg');
            container.innerHTML = data.svg_content;
            
            // Add click handlers to SVG elements
            const elements = container.querySelectorAll('[data-object-id]');
            elements.forEach(element => {
                element.addEventListener('click', handleObjectClick);
                element.style.cursor = 'pointer';
            });
        }
        
        // Handle object clicks
        function handleObjectClick(event) {
            const objectId = event.currentTarget.dataset.objectId;
            const objectData = {
                id: objectId,
                type: event.currentTarget.dataset.objectType,
                layer: event.currentTarget.dataset.layer,
                properties: JSON.parse(event.currentTarget.dataset.properties || '{}')
            };
            
            Alpine.store('selectedObject', objectData);
            Alpine.store('showObjectInfo', true);
        }
        
        // Setup PWA features
        function setupPWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            }
            
            // Handle app install
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
            });
        }
        
        // Utility functions
        function getLayerName(layerCode) {
            const layerNames = {
                'E': 'Electrical',
                'LV': 'Low Voltage',
                'FA': 'Fire Alarm',
                'N': 'Network',
                'M': 'Mechanical',
                'P': 'Plumbing',
                'S': 'Security'
            };
            return layerNames[layerCode] || layerCode;
        }
        
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
        
        function resetView() {
            Alpine.store('zoomLevel', 1);
            Alpine.store('panOffset', { x: 0, y: 0 });
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html> 