<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arxos Browser CAD</title>
    
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Custom CAD Styles -->
    <link rel="stylesheet" href="../static/css/cad.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../static/images/favicon.svg">
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- CAD Application Container -->
    <div id="cad-app" class="flex flex-col h-screen">
        
        <!-- CAD Toolbar -->
        <div id="cad-toolbar" class="bg-gray-800 border-b border-gray-700 p-4">
            <div class="flex items-center justify-between">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold text-blue-400">Arxos CAD</div>
                    <div class="text-sm text-gray-400">Building Information Modeling</div>
                </div>
                
                <!-- Tool Groups -->
                <div class="flex items-center space-x-6">
                    <!-- Drawing Tools -->
                    <div class="flex items-center space-x-2">
                        <button id="select-tool" class="cad-tool-btn active" data-tool="select">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            </svg>
                            <span>Select</span>
                        </button>
                        <button id="line-tool" class="cad-tool-btn" data-tool="line">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                            <span>Line</span>
                        </button>
                        <button id="rectangle-tool" class="cad-tool-btn" data-tool="rectangle">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                            </svg>
                            <span>Rectangle</span>
                        </button>
                        <button id="circle-tool" class="cad-tool-btn" data-tool="circle">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                            </svg>
                            <span>Circle</span>
                        </button>
                    </div>
                    
                    <!-- Enhanced Precision Controls -->
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">Precision:</label>
                            <select id="precision-level" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="UI">UI (0.01")</option>
                                <option value="EDIT" selected>Edit (0.001")</option>
                                <option value="COMPUTE">Compute (0.0001")</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-400">Grid:</label>
                            <select id="grid-size" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                                <option value="0.01">0.01"</option>
                                <option value="0.1" selected>0.1"</option>
                                <option value="1">1"</option>
                                <option value="12">12"</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="grid-snap" class="rounded" checked>
                            <label for="grid-snap" class="text-sm text-gray-400">Snap</label>
                        </div>
                    </div>
                    
                    <!-- Constraint Tools -->
                    <div class="flex items-center space-x-2">
                        <button id="distance-constraint" class="cad-tool-btn" data-tool="distance-constraint">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/>
                            </svg>
                            <span>Distance</span>
                        </button>
                        <button id="parallel-constraint" class="cad-tool-btn" data-tool="parallel-constraint">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/>
                            </svg>
                            <span>Parallel</span>
                        </button>
                        <button id="perpendicular-constraint" class="cad-tool-btn" data-tool="perpendicular-constraint">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/>
                            </svg>
                            <span>Perpendicular</span>
                        </button>
                    </div>
                    
                    <!-- AI Assistant -->
                    <div class="flex items-center space-x-2">
                        <button id="ai-assistant" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-medium">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            GUS Assistant
                        </button>
                    </div>
                </div>
                
                <!-- User Controls -->
                <div class="flex items-center space-x-4">
                    <!-- Project Info -->
                    <div id="project-info" class="text-sm text-gray-400">
                        <div>No project selected</div>
                    </div>
                    
                    <!-- Collaboration Status -->
                    <div id="collaboration-status" class="text-sm text-gray-400">
                        <div>Collaboration: Inactive</div>
                    </div>
                    
                    <!-- AI Status -->
                    <div id="ai-status" class="text-sm text-gray-400">
                        <div>AI Assistant: Disconnected</div>
                    </div>
                    
                    <!-- Project Controls -->
                    <button id="new-project" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-medium">
                        New Project
                    </button>
                    <button id="save-project" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-medium">
                        Save Project
                    </button>
                    <button id="export-drawing" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm font-medium">
                        Export SVGX
                    </button>
                </div>
            </div>
        </div>
        
        <!-- CAD Workspace -->
        <div id="cad-workspace" class="flex-1 flex">
            <!-- Left Panel - Projects & ArxObjects -->
            <div class="w-64 bg-gray-800 border-r border-gray-700">
                <!-- Projects Tab -->
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Projects</h3>
                    <div id="project-list" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
                
                <!-- ArxObjects Tab -->
                <div class="p-4">
                    <h3 class="text-lg font-semibold mb-4">ArxObjects</h3>
                    <div id="arx-objects-list" class="space-y-2">
                        <!-- ArxObjects will be loaded here -->
                    </div>
                </div>
                
                <!-- Constraints Panel -->
                <div class="p-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Constraints</h3>
                    <div id="constraints-list" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- Constraints will be loaded here -->
                    </div>
                    <button id="clear-constraints" class="mt-2 w-full bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                        Clear All
                    </button>
                </div>
            </div>
            
            <!-- Center - Canvas Area -->
            <div id="canvas-container" class="flex-1 relative">
                <canvas id="cad-canvas" class="w-full h-full bg-white"></canvas>
                
                <!-- Canvas Overlay for UI -->
                <div id="canvas-overlay" class="absolute inset-0 pointer-events-none">
                    <!-- Grid lines, measurements, etc. -->
                </div>
                
                <!-- Status Bar -->
                <div id="status-bar" class="absolute bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-2">
                    <div class="flex items-center justify-between text-sm">
                        <div id="mouse-coordinates" class="text-gray-400">
                            X: 0.000" Y: 0.000" (EDIT)
                        </div>
                        <div id="drawing-info" class="text-gray-400">
                            Scale: 1:1 | Units: Inches | Grid: 0.1"
                        </div>
                        <div id="performance-info" class="text-gray-400">
                            FPS: 60 | Objects: 0 | Constraints: 0
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Properties & Collaboration -->
            <div id="properties-panel" class="w-80 bg-gray-800 border-l border-gray-700">
                <!-- Properties Tab -->
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Properties</h3>
                    <div id="properties-content">
                        <!-- Selected object properties will be shown here -->
                        <div class="text-gray-400 text-sm">Select an object to view properties</div>
                    </div>
                </div>
                
                <!-- Collaboration Tab -->
                <div class="p-4">
                    <h3 class="text-lg font-semibold mb-4">Collaboration</h3>
                    <div id="collaborators-list" class="space-y-2 mb-4">
                        <!-- Collaborators will be loaded here -->
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <h4 class="text-sm font-medium mb-2">Chat</h4>
                        <div id="chat-messages" class="h-32 overflow-y-auto mb-2 border border-gray-600 rounded p-2">
                            <!-- Chat messages will be loaded here -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Type a message..." 
                                   class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                            <button id="send-chat" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold">GUS AI Assistant</h3>
                    <button id="close-ai-modal" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                <div id="ai-chat" class="h-64 bg-gray-900 rounded p-4 mb-4 overflow-y-auto">
                    <!-- AI chat messages will appear here -->
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="ai-input" placeholder="Ask GUS to create a room, add a door, etc..." 
                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    <button id="ai-send" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <div class="text-center text-white">Loading Arxos CAD...</div>
        </div>
    </div>

    <!-- CAD Engine Scripts -->
    <script src="../static/js/cad-constraints.js"></script>
    <script src="../static/js/cad-engine.js"></script>
    <script src="../static/js/cad-workers.js"></script>
    <script src="../static/js/arx-objects.js"></script>
    <script src="../static/js/cad-api-client.js"></script>
    <script src="../static/js/cad-collaboration.js"></script>
    <script src="../static/js/cad-ai-integration.js"></script>
    <script src="../static/js/cad-ui.js"></script>
    <script src="../static/js/ai-assistant.js"></script>
    
    <!-- Initialize CAD Application -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CAD application with enhanced components
            window.cadApp = {
                cadEngine: null,
                cadUI: null,
                isInitialized: false
            };
            
            async function initializeCadApplication() {
                try {
                    console.log('Initializing Arxos CAD Application...');
                    
                    // Initialize CAD Engine with enhanced precision
                    window.cadApp.cadEngine = new CadEngine();
                    await window.cadApp.cadEngine.initialize();
                    
                    // Initialize CAD UI with enhanced integration
                    window.cadApp.cadUI = new CadUI(window.cadApp.cadEngine);
                    await window.cadApp.cadUI.initialize();
                    
                    // Set up cross-component communication
                    window.cadApp.cadEngine.addEventListener('objectSelected', (data) => {
                        window.cadApp.cadUI.updatePropertiesPanel(data.object);
                    });
                    
                    window.cadApp.cadEngine.addEventListener('constraintAdded', (data) => {
                        window.cadApp.cadUI.updateConstraintsList();
                    });
                    
                    window.cadApp.cadEngine.addEventListener('precisionChanged', (data) => {
                        window.cadApp.cadUI.updatePrecisionDisplay(data);
                    });
                    
                    // Initialize additional components
                    if (typeof ArxObjectSystem !== 'undefined') {
                        window.cadApp.arxObjectSystem = new ArxObjectSystem();
                    }
                    
                    if (typeof CadApiClient !== 'undefined') {
                        window.cadApp.apiClient = new CadApiClient();
                    }
                    
                    if (typeof AiAssistant !== 'undefined') {
                        window.cadApp.aiAssistant = new AiAssistant();
                    }
                    
                    window.cadApp.isInitialized = true;
                    console.log('Arxos CAD Application initialized successfully');
                    
                    // Hide loading indicator
                    const loadingIndicator = document.getElementById('loading');
                    if (loadingIndicator) {
                        loadingIndicator.classList.add('hidden');
                    }
                    
                } catch (error) {
                    console.error('Failed to initialize CAD Application:', error);
                    
                    // Show error message
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'fixed inset-0 bg-red-900 bg-opacity-75 flex items-center justify-center z-50';
                    errorMessage.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-6 max-w-md">
                            <div class="text-red-400 text-xl font-semibold mb-4">Initialization Error</div>
                            <div class="text-white mb-4">${error.message}</div>
                            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                                Reload Application
                            </button>
                        </div>
                    `;
                    document.body.appendChild(errorMessage);
                }
            }
            
            // Start initialization
            initializeCadApplication();
        });
    </script>
</body>
</html> 